<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<link rel="canonical" type="text/html" href="https://wdk-docs.github.io/redis-docs/blog/seckill/">
<link rel="alternate" type="application/rss&#43;xml" href="https://wdk-docs.github.io/redis-docs/blog/seckill/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/redis-docs/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/redis-docs/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/redis-docs/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/redis-docs/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/redis-docs/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/redis-docs/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/redis-docs/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/redis-docs/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/redis-docs/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/redis-docs/favicons/android-192x192.png" sizes="192x192">

<title>秒杀 | redis 文档</title>
<meta name="description" content="">
<meta property="og:title" content="秒杀" />
<meta property="og:description" content="redis 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://wdk-docs.github.io/redis-docs/blog/seckill/" /><meta property="og:site_name" content="redis 文档" />

<meta itemprop="name" content="秒杀">
<meta itemprop="description" content="redis 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="秒杀"/>
<meta name="twitter:description" content="redis 文档"/>




<link rel="preload" href="/redis-docs/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" as="style">
<link href="/redis-docs/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/redis-docs/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">redis 文档</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/redis-docs/docs/" ><span>文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/redis-docs/blog/" ><span class="active">博客</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/redis-docs/blog/seckill/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">秒杀</h1>





    <ul>
    
  
  
  
  

  
    
    
	

    <li><a href="#pg-b0f9f7fc582ae9752ea52c67eadcf30c">建立对分布式锁的系统认知 - 从 Redlock 开始</a></li>



    
  
    
    
	

    <li><a href="#pg-e6c98199bfad9c8c6ea6cfdc819b2b29">Implementation of redis distributed lock</a></li>



    
  
    
    
	

    <li><a href="#pg-60795475c0c26f209764d621c27ec700">一个使用 Node.js 的 Redlock 示例，关于如何锁定一个Redis上的密钥对</a></li>



    
  
    
    
	

    <li><a href="#pg-5a59f1b5d86ea3142288d21febb3cfd2">Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性</a></li>



    
  
    
    
	

    <li><a href="#pg-eb85bda82a8f47d580cfbdfa5b9adbda">Node.js 中实践基于 Redis 的分布式锁实现</a></li>



    
  
    
    
	

    <li><a href="#pg-8cc5c3a59964c1c4bc5b937057f92ab3">Node.js 中实践 Redis Lua 脚本</a></li>



    
  
    
    
	

    <li><a href="#pg-3218e8af9be10bd2a1e0fbc2c6d4f471">Is Redlock safe?</a></li>



    
  
    
    
	

    <li><a href="#pg-80decd05ac6a7561ffde230567bbb476">Redis分布式锁</a></li>



    
  
    
    
	

    <li><a href="#pg-08987c3452bb171ec540aa27032e730c">How to do distributed locking</a></li>



    
  
    
    
	

    <li><a href="#pg-d22409d1f210a88ff6e44c86088bbcee">Redis&#43;Lua 解决高并发场景抢购秒杀问题</a></li>



    
  
    
    
	

    <li><a href="#pg-9e637ce30dc1691a4b87ba0237805379">Redis分布式锁</a></li>



    
  
    
    
	

    <li><a href="#pg-3860dea67604bf92ab25745f4b201971">使用  搭建电商秒杀系统</a></li>



    
  
    
    
	

    <li><a href="#pg-d1f6f9f2d6e48e321571f2e996e37cc7">Redis Redlock 的争论</a></li>



    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    


  

<div class="td-content" style="">
    <h1 id="pg-b0f9f7fc582ae9752ea52c67eadcf30c">建立对分布式锁的系统认知 - 从 Redlock 开始</h1>
	
	<div class="td-byline mb-4">
		By <b>刘绍</b> |
        
		<time datetime="2021-07-15" class="text-muted">Thursday, July 15, 2021</time>
        
	</div>
	<blockquote>
<p><a href="https://xie.infoq.cn/article/50d9f8f82ba0f96d07b38032f">https://xie.infoq.cn/article/50d9f8f82ba0f96d07b38032f</a></p>
</blockquote>
<h2 id="01-前言">01 前言</h2>
<p>这是一篇解析底层原理的文章，从 Redis 官方推荐的 Redlock 算法入手，帮助你建立对分布式锁的认知，并具备判断分布式锁方案优劣的理论基础。
通过对本文的学习，你将收获以下知识：</p>
<ol>
<li>分布式锁的基本要求</li>
<li>评估简化版方案的现状</li>
<li>单实例 Redis 的锁方案</li>
<li>Redlock 算法核心思想</li>
<li>科学的失败重试机制</li>
<li>性能、故障恢复和持久化</li>
<li>让算法更可靠：续期机制</li>
</ol>
<p>什么是分布式锁？当不同的进程必须以互斥地方式访问同一个共享资源时，就要用到分布式锁。
当然，我更建议在工程实践时合理设计方案，避免用到锁，除非无法避免。
网上也有一些比较简单的设计方案，其可靠性往往得不到很好的保证。</p>
<p>很多语言都有 Redlock 分布式锁的实现，我们列举几个主流语言的实现：</p>
<ol>
<li>Ruby：Redlock-rb</li>
<li>Python：Redlock-py、Pottery、Aioredlock</li>
<li>PHP：Redlock-php、PHPRedisMutex、cheprasov/php-redis-lock、rtckit/react-redlock</li>
<li>Go：RedSync</li>
<li>Java：Redisson</li>
<li>NodeJS：node-redlock</li>
<li>C++：Redlock-cpp</li>
</ol>
<h2 id="02-分布式锁的基本要求">02 分布式锁的基本要求</h2>
<p>一个最小化、可有效使用的分布式锁至少需满足以下三个属性：</p>
<ol>
<li><strong>安全性：互斥</strong>。对于同一资源，在任何时刻，只有一个客户端可以持有锁。</li>
<li><strong>活跃性 A</strong>：死锁释放。当持有锁的客户端发生崩溃等异常而不能释放锁时，锁最终也能被其它客户端获取到。</li>
<li><strong>活跃性 B</strong>：容错。只要大多数（半数以上）Redis 节点处于启动状态，客户端就可以获取和释放锁。</li>
</ol>
<p>不能满足以上三个属性，则不是一个合格的分布式锁方案，其可靠性不足以在生产环境使用。在选择分布式锁方案时要牢记这三点。</p>
<h2 id="03-评估简化版方案的现状">03 评估简化版方案的现状</h2>
<p>比较简单的实现方式是在一个 Redis 实例中创建一个带有过期时间的 key，所以这个锁最终会被释放（满足活跃性 A 的要求）。
当客户端需要释放锁时，主动删掉这个 key 就可以了。</p>
<p>表面上看起来还不错，但存在一个问题：单点失败。大多数公司在使用 Redis 时会采用主从模式（主要指一主一从），
因为 master 到 slave 节点的数据复制是异步的，当 master 挂掉之后，互斥的安全性要求是无法得到满足。</p>
<p>具体分析如下：</p>
<ol>
<li>客户端 A 在 master 节点中获取了锁。</li>
<li>对应的 key 在被复制到 slave 节点之前，master 节点挂了。</li>
<li>slave 节点被提升为 master。</li>
<li>客户端 B 在新的 master 中获取到了 A 已经持有的相同资源的锁。违反了互斥的安全性要求！</li>
</ol>
<p>所以，不要在主从模式的 Redis 环境中实现分布式锁，即便是后文中的 Redlock 方案也是一样，NO REPLICATION！
在选择一些开源类库时也需要考察其是否对有副本的情况进行了合理地处理。事实上很难处理，可以认为这是基于 Redis 方案的缺陷。</p>
<h2 id="04-单实例-redis-的锁方案">04 单实例 Redis 的锁方案</h2>
<p>核心要点：</p>
<ol>
<li>key 不存在时设置 key，value 为全局唯一签名，一定时间后自动失效。</li>
<li>删除 key 时必须匹配签名。</li>
</ol>
<p>既然主从的 Redis 环境不适合做分布式锁，那我们来看看只有一个实例的 Redis 环境怎么实现分布式锁。</p>
<p>设置一个当前不存在的 key，并使用随机值签名，配置过期时间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">SET resource_name my_random_value NX PX <span style="color:#0000cf;font-weight:bold">30000</span>
</code></pre></div><p>只有当 resource_name 这个 key 不存在时，才设置 key。对应的值是一个全局唯一的随机数值，作为 key 的签名，并且这个 key 将会在 30000 毫秒后过期。</p>
<p>验证签名匹配后方可删除。</p>
<p>对应的 Lua 脚本如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">ARGV</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">then</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;del&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span>
<span style="color:#204a87;font-weight:bold">else</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#204a87;font-weight:bold">end</span>
</code></pre></div><p>只有签名值对应上时才允许删除，以此实现安全地释放锁，避免删掉其它客户端创建的锁。
在一些更加简陋的方案中是没有锁签名的，它们的可靠性就要更差一些了。</p>
<p>误删其它客户端的锁是不安全的，例如：</p>
<ol>
<li>客户端 A 获取到一个锁。</li>
<li>客户端 A 长时间阻塞在某些操作上，阻塞的时间超过了锁的有效时间（通过 PX 参数设置的时间）。</li>
<li>操作完成后执行锁的 DEL，但这个锁已经过期并且被客户端 B 获取到。
DEL 操作导致客户端 B 的锁被误删，客户端 C 此时可以获取 B 锁持有的锁。
违反互斥的安全性要求！</li>
</ol>
<p>我们使用全局唯一的随机值给锁进行签名，然后通过以上的脚本进行删除，就可以保证锁只能被创建者删除。
通常可以使用当前毫秒时间，拼接上客户端 id 作为锁的签名值。</p>
<p>给 key 指定的生存时间被称为“锁有效时间”，它既是锁自动释放的时间，也是客户端执行操作必需的时间，需要比最大执行时间更大一些，此时并不违反互斥的安全性要求。
但事实上我们无法保证每一次客户端操作的时间一定小于自动释放时间，就可能会出现操作还没有完成，锁已经自动过期，从而被其它客户端获取到。
这里需要配合锁的续期才能确保安全性，文章的最后一部分会讲解续期机制。</p>
<ul>
<li>方案优点：相对简单易实现。</li>
<li>方案缺点：可用性不高，一旦唯一的 Redis 节点挂掉，系统将完全不可用。</li>
</ul>
<p>不建议在可用性要求较高的场景中使用该方案！</p>
<h2 id="05-redlock-算法核心思想">05 Redlock 算法核心思想</h2>
<p>核心要点：</p>
<ol>
<li>N 个独立节点，无副本，互不依赖（非集群），N 是奇数且 N≥3。</li>
<li>在有限的时间内，客户端在半数以上节点成功设置 key，则可以获取锁。</li>
<li>客户端需提前几毫秒完成工作，作为对时钟漂移的补偿。</li>
</ol>
<p>单实例方案在面对单点故障时整个系统不可用，因此需要使用多实例来确保可用性，而单实例的方案无法直接套用在多实例环境，需要做一些改进。</p>
<p>假设有一个 N 个 Redis master 节点。这些节点是独立的、互不依赖的，没有使用主从复制或者其它的协调机制。当 N=5 时，
我们需要在不同的主机或者虚拟机上运行 5 个 Redis master 节点，以确保节点失效时独立失效，互不影响。</p>
<p>为了获取锁，客户端会执行以下操作：</p>
<ol>
<li>获取当前毫秒时间。</li>
<li>尝试顺序地从所有实例中获取锁，在每个实例中都设置同样的 key 名称和随机值。在每个实例中设置锁时，客户端会有一个超时时间，这个时间比锁的有效时间更小。
比如，自动释放时间是 10 秒，则超时时间可以是 5~50 毫秒。这可以防止客户端尝试从已经失效的 Redis 节点获取锁而长时间被阻塞。
当一个 Redis 实例不可用时，要尽可能快地转移到下一个节点进行设置。</li>
<li>客户端会计算获取锁的过程消耗了多少时间。当且仅当客户端在半数以上的 Redis 实例中设置成功，且总耗时远小于锁的有效时间时，才会让锁最终成功被获取。</li>
<li>如果在某个 Redis 实例上设置成功，则会使用在步骤 1 中获取的时间，再加上已消耗的时间，作为过期时间。</li>
<li>如果设置锁失败了（未能成功锁定半数以上 Redis 实例或者有效时间是负的），将会尝试在所有 Redis 实例上解锁，删除对应的 key。</li>
</ol>
<p>该算法依赖于一种假设：尽管进程之间没有同步时钟，但每个进程中的本地时间仍然以大致相同的速度流动，其误差与锁的自动释放时间相比是很小的。
这个假设是非常接近事实的：每台计算机都有一个本地时钟，通常这些计算机的时钟漂移是很小的，只有几毫秒。</p>
<p>基于这一点，只有当持有锁的客户端在锁有效时间达到之前完成工作，互斥性才会得到保证。提前的几毫秒用于补偿进程之间的时钟漂移。
这就跟木桶原理一样，较短的一块板子决定了最大蓄水量，最早的过期时间决定了锁的实际最大生存时长。</p>
<h2 id="06-科学的失败重试机制">06 科学的失败重试机制</h2>
<p>核心要点：</p>
<ol>
<li>先延迟一个随机时间。</li>
<li>再使用指数退避法执行重试。</li>
</ol>
<p>优秀的方案设计一定要充分考虑失败场景，即面向失败设计的思想！</p>
<p>当客户端不能成功获取到锁时，应该延迟一个随机时间后再重试。使用随机时间可以避免多个客户端同时争夺同一个资源的锁。
大量客户端同时发起重试请求的情况称为惊群效应（thundering herd），会过多消耗你的服务器资源。如果要对一个分布式锁方案进行压力测试，我必须关注的一个指标就是：重试次数/成功次数，这个指标越低越好。</p>
<h3 id="如何减少重试几率和时间">如何减少重试几率和时间？</h3>
<p>客户端尝试在半数以上 Redis 实例上加锁的速度越快，竞争的时间窗口就会越小，因此最理想的情况是客户端采用多路复用的方式，同时向 N 个实例发送 SET 命令。对于无法成功获取半数以上锁的客户端，要尽快释放已获取到的锁，不需要等待 key 自动过期，以确保锁可以尽快被再次请求。</p>
<p>当重试发生时的最佳策略：使用随机延迟+指数退避可有效地分散重试请求，削弱惊群效应的影响。</p>
<h4 id="指数退避法exponential-backoff">指数退避法（Exponential Backoff）</h4>
<pre tabindex="0"><code>//retry=1 代表当前第 1 次重试，最大重试次数是 3。
//随着重试次数的增加，延迟时间越来越大。第 1 次重试的延迟时间是 20ms，第 3 次重试的延迟时间是 80ms。
long timemillsec = (long) (Math.pow(2, Math.min(retry, 3)) \* 10);
</code></pre><p>可以使用递归调用+定时器进行重试操作，每一次重试后都计算出下一次重试的延迟时间，达到最大重试次数而依然没有成功则放弃重试，业务客户端要有对应的失败处理。</p>
<h2 id="07-性能故障恢复与持久化">07 性能、故障恢复与持久化</h2>
<p>核心要点：</p>
<ol>
<li>多路复用，更快完成加锁/解锁，提高性能。</li>
<li>实时 AOF 或者无持久化、延迟重启，确保互斥。</li>
</ol>
<p>多路复用，为了更快</p>
<p>之所以选择 Redis 做分布式锁服务，是因为想获得较高的性能，每秒能够执行大量的加锁和解锁操作。
为了满足这个诉求，可以采用多路复用的方式，同时将所有命令发送到 N 个 Redis 节点上，并同时读取命令结果（假设所有 Redis 节点的响应时间是一致的）。</p>
<h3 id="有持久化实时-aof-重启后数据不丢失确保互斥">有持久化，实时 AOF-重启后数据不丢失，确保互斥。</h3>
<p>如果我们想要系统具备故障恢复能力，就需要考虑 Redis 的持久化策略。</p>
<p>假设我们配置了 5 个没有任何持久化策略的 Redis 实例，来看看会有什么问题。
一个客户端在 3 个实例上成功设置了锁，其中一个实例被重启导致数据丢失，实际锁成功的节点只剩下 2 个（半数以下），此时其它客户端就能够获取到同一个资源的锁。
违反了互斥的安全性要求！</p>
<p>当开启 AOF 持久化后，情况会有很大改善。
例如：向 Redis Server 发送 SHUTDOWN 命令并重启，Redis 会先进行持久化然后再重启，重启后从 AOF 文件中恢复数据。
在 Server 关闭期间，锁的生存时间仍然在正常流逝，对锁的过期没有影响。
这种情况下，没有任何问题。</p>
<p>但如果是突然断电呢？假设 Redis 按照默认配置，每秒进行一次 AOF 文件的写盘，则有可能因为来不及写盘而丢失数据。
如果想在这种异常重启的情况下保证锁的安全性，就需要在持久化配置中把 fsync 设置为 always，实时写盘。
按照分布式系统的 CAP 理论，这是通过牺牲一定的可用性，保证了一致性和分区容错性。</p>
<h3 id="无持久化延迟重启-节点对应的锁全部过期自动失效确保互斥">无持久化，延迟重启-节点对应的锁全部过期自动失效，确保互斥。</h3>
<p>如果一个 Redis 实例在崩溃后重启，而且该实例中所有的锁都不属于当前正在使用的锁（当前活动锁），则算法的安全性也是可以保证的。
我们只需要在 Redis 实例崩溃后，延迟一段时间再启动就可以。延迟的时间要比最大的锁生存时间大一些，这样该实例中的锁在重启后已经全部失效并且会被自动释放。</p>
<p>当 Redis 实例没有配置任何持久化时，使用延迟重启可以在任何一种重启的情况下确保锁的安全。
这也是一种牺牲可用性的方式，例如：当半数以上的 Redis 实例崩溃后，系统会变得完全不可用，持续的时间是最大锁生存时间，在这段时间里没有任何资源可以被锁定。</p>
<h2 id="08-让算法更可靠续期机制">08 让算法更可靠：续期机制</h2>
<p>核心要点：</p>
<ol>
<li>进行基准测试，尽可能准确地预估客户端操作耗时，作为锁有效期的参考。</li>
<li>增加锁的续期机制，应对意外情况。</li>
</ol>
<p>如果客户端操作的步骤很少，耗时很短，就可以使用更小的锁有效时间。
但无论预估地多么准确，都无法避免意外，建议使用锁的续期机制对算法进行扩展，以应对不确定性。
如果客户端正在执行操作，而锁的剩余生存时间已经很小，则可以通过 Lua 脚本对已存在的锁进行有效期延长。</p>
<h2 id="09-总结">09 总结</h2>
<p>没有最完美的方案，只有最适合的。
基于 Redis 也不是分布式锁方案的唯一选项，还有基于 Zookeeper 的方案也可以考虑，最佳的方案是不需要分布式锁。</p>
<p>在实践中要考虑基础设施情况和业务要求，仔细权衡。
期望你可以通过这篇文章建立对分布式锁方案的评判标准，在实际的技术选型中能够对多种方案进行客观评价。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-e6c98199bfad9c8c6ea6cfdc819b2b29">Implementation of redis distributed lock</h1>
	
	<div class="td-byline mb-4">
		By <b>developpaper</b> |
        
		<time datetime="2021-01-08" class="text-muted">Friday, January 08, 2021</time>
        
	</div>
	<blockquote>
<p><a href="https://developpaper.com/implementation-of-redis-distributed-lock/">https://developpaper.com/implementation-of-redis-distributed-lock/</a></p>
</blockquote>
<p>Many novices will Distributed lock and Distributed transactionConfusion, personal understanding:lock
It is used to solve the concurrent contention for a shared resource by multiple programs;affair
It is used to ensure the consistency of a series of operations.
I’ve explained distributed transactions in several previous articles.
I’m going to talk about the implementation of 2pc, TCC and asynchronous assurance schemes.</p>
<h2 id="1-定义">1. 定义</h2>
<p>In the traditional monomer architecture, the most common lock is JDK lock.
Because the thread is the smallest unit that the operating system can run and schedule,
in Java multithreading development, it is inevitable that different threads compete for resources in the same process.
JDK library provides us with synchronized, lock and update java.util.concurrent . * etc.
However, they all have unified restrictions. Threads competing for resources are all running in the same JVM process.
In the distributed architecture, different JVM processes cannot use the lock.</p>
<p>In order to prevent multiple processes from interfering with each other in a distributed system,
we need a distributed coordination technology to schedule these processes.
And the core of this distributed coordination technology is to achieve thisDistributed lock。</p>
<p>Take a classic example of “oversold”.
In an e-commerce project, the logic of the interface can be simply divided into:</p>
<ol>
<li>Query whether the inventory is greater than zero;</li>
<li>When the inventory is greater than zero, purchase the goods.</li>
</ol>
<p>When there is only one piece in stock, both user a and user B execute the first step at the same time,
query that the inventory is one piece, and then both execute the purchase operation.
When they finished the purchase,they found that the inventory was – 1 piece.
We can lock the operations of “inventory query” and “inventory reduction” in Java code to ensure that the requests of users a and B cannot be executed concurrently.
But if our interface service is a cluster service, and the requests of user a and user B are respectively forwarded to different JVM processes by load balancing, it will not solve the problem.</p>
<h2 id="2-分布式锁的比较">2. 分布式锁的比较</h2>
<p>From the previous examples, we can see that the resource to coordinate and solve distributed locks must not be a resource at the level of the JVM process, but a shared external resource.</p>
<p>Three ways of implementation</p>
<p>There are three common ways to implement distributed lock: 1. Database lock; 2. Zookeeper based distributed lock; 3. Redis based distributed lock.</p>
<ol>
<li><strong>Database lock</strong>:
This way is easy to think of, put the competing resources into the database,
and use the database lock to realize the resource competition.
Please refer to the previous articleDatabase transactions and locks。
For example:
<ol>
<li>Pessimistic lock implementation: the “for update” can be added to the SQL query of inventory goods to achieve exclusive lock,
and the “inventory query” and “inventory reduction” can be packaged as a transaction commit.
Before the completion of user a’s query and purchase, user B’s request will be blocked.</li>
<li>Optimistic lock implementation: add the version number field in the inventory table to control.
Or more simply, when the inventory is less than zero after each purchase, the transaction can be rolled back.</li>
</ol>
</li>
<li><strong>Distributed lock of zookeeper</strong>:
zookeeper is professional in implementing distributed locks.
It is similar to a file system. It plays the role of distributed lock by competing for file resources on the file system.
Specific implementation, please refer to the previous articleDevelopment and application of zookeeper。</li>
<li><strong>Distributed lock of redis</strong>:
the previous article talked about the development,
application and transaction of redis, but never about the distributed lock of redis,
which is also the core content of this article. In short,
throughsetnxThe value of the competing key.
“Database lock” competes for table level resources or row level resources,
“zookeeper lock” competes for file resources, “redis lock” competes for key value resources.
They all implement distributed locks by competing for shared resources outside the program.</li>
</ol>
<h3 id="对比">对比</h3>
<p>However, in the field of distributed locks, zookeeper is more professional.
In essence, redis is also a database.
All the other two schemes are “part-time” to implement distributed locking, and the effect is not as good as zookeeper.</p>
<ul>
<li>Low performance consumption: when concurrent lock competition really occurs,
the implementation of database or redis basically obtains locks by blocking or constantly retrying,
which has a certain performance consumption. The zookeeper lock registers the listener.
When a program releases the lock, the next program gets the lock after listening to the message.</li>
<li>Perfect lock release mechanism: if the client from which redis obtains the lock is bugged or hung up,
it can only release the lock after the timeout; while for ZK,
because the temporary znode is created, as long as the client hangs up, the znode will be gone,
and the lock will be released automatically.</li>
<li>Strong consistency of cluster: as we all know,
zookeeper is a typical case of implementing CP transaction,
and the transaction request is always handled by the leader node in the cluster.
Redis actually implements AP transactions. If the master node fails and the master-slave switch occurs,
the lock may be lost.</li>
</ul>
<h3 id="锁的必要条件">锁的必要条件</h3>
<p>In addition, in order to ensure the availability of distributed locks,
we should at least ensure that the implementation of locks meets the following conditions at the same time:</p>
<ul>
<li>Mutual exclusion. At any time, only one client can hold the lock.</li>
<li>There is no deadlock. Even if one client crashes while holding the lock and does not unlock it,
it can ensure that other clients can lock.</li>
<li>It is necessary to tie the bell. Locking and unlocking must be the same client.
The client can’t unlock the lock added by others.</li>
</ul>
<h2 id="3-redis-实现分布式锁">3. Redis 实现分布式锁</h2>
<h3 id="31-锁">3.1. 锁</h3>
<p>Correct locking</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RedisTool</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">LOCK_SUCCESS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;OK&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">SET_IF_NOT_EXIST</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;NX&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">SET_WITH_EXPIRE_TIME</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;PX&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     *Attempt to acquire distributed lock
</span><span style="color:#8f5902;font-style:italic">     *@ param jedis redis client
</span><span style="color:#8f5902;font-style:italic">     *@ param lockkey lock
</span><span style="color:#8f5902;font-style:italic">     *@ param requestid request ID
</span><span style="color:#8f5902;font-style:italic">     *@ param expireTime
</span><span style="color:#8f5902;font-style:italic">     *Is @ return successful
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">tryGetDistributedLock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Jedis</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">expireTime</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#000">String</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">set</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">SET_IF_NOT_EXIST</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">SET_WITH_EXPIRE_TIME</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">expireTime</span><span style="color:#ce5c00;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">LOCK_SUCCESS</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>To see, we lock a line of code:jedis.set(String key, String value, String nxxx, String expx, int time)This set () method has five formal parameters:</p>
<ul>
<li>key: we use the key as the lock, because the key is unique.</li>
<li>value: we are passing a request ID. many children’s shoes may not understand it. It’s enough to have a key as a lock. Why use value? The reason is that when we talked about reliability above, the distributed lock needs to satisfy the fourth condition, and it needs to be released by the ringer. By assigning value to requestid, we can know which request the lock was added, and we can have a basis when unlocking. The requestid can be used UUID.randomUUID (). Tostring() method.</li>
<li>Nxxx: for this parameter, we fill in NX, which means set if not exist. That is, when the key does not exist, we perform set operation; if the key already exists, we do not perform any operation;</li>
<li>EXPX: this parameter is Px, which means that we need to add an expired setting to the key. The specific time is determined by the fifth parameter.</li>
<li>time: corresponds to the fourth parameter, representing the expiration time of the key.</li>
</ul>
<p>In general, executing the above set () method will only result in two results:</p>
<p>If there is no lock at present (the key does not exist), lock operation will be performed, and a validity period will be set for the lock. At the same time, value indicates the locked client.
There is a lock, no operation.
Not recommended locking method (not recommended!)</p>
<p>I’ve seen many blogs that use the following method to lock, that is, the combination of setnx and GetSet to manually maintain the key expiration time.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">wrongGetLock2</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Jedis</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">expireTime</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">expires</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">currentTimeMillis</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">expireTime</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#000">String</span> <span style="color:#000">expiresStr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">valueOf</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">expires</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">//If the current lock does not exist, return to lock success
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setnx</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">expiresStr</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">//If the lock exists, get the expiration time of the lock
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">String</span> <span style="color:#000">currentValueStr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">currentValueStr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">Long</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">parseLong</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">currentValueStr</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">currentTimeMillis</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">//The lock has expired. Get the expiration time of the previous lock and set the expiration time of the current lock
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">String</span> <span style="color:#000">oldValueStr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getSet</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">expiresStr</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">oldValueStr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">oldValueStr</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">currentValueStr</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">//Considering the concurrency of multiple threads, only one thread has the right to lock if its setting value is the same as the current value
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#8f5902;font-style:italic">//In other cases, the locking failure will be returned
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>On the surface, this code also implements distributed locking, and the code logic is similar to the above, but there are several problems:</p>
<p>Since the expiration time is generated by the client itself, it is mandatory that the time of each client must be synchronized in the distributed environment.
When the lock expires, if multiple clients execute it at the same time jedis.getSet () method, although only one client can lock, the expiration time of this client’s lock may be covered by other clients.
The lock does not have the owner ID, that is, any client can be unlocked.
This kind of code on the Internet may be based on the earlier versions of jedis, which had great limitations at that time. Redis 2.6.12 and above adds optional parameters to the set instruction, as mentioned abovejedis.set(String key, String value, String nxxx, String expx, int time)API, you can put theSETNXandEXPIREPackage together to execute, and release the expired key to the redis server to manage. Therefore, the actual development process, we do not use this more primitive way of locking.</p>
<h3 id="32-解锁">3.2. 解锁</h3>
<p>Correct locking</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RedisTool</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">Long</span> <span style="color:#000">RELEASE_SUCCESS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">1L</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     *Release distributed lock
</span><span style="color:#8f5902;font-style:italic">     *@ param jedis redis client
</span><span style="color:#8f5902;font-style:italic">     *@ param lockkey lock
</span><span style="color:#8f5902;font-style:italic">     *@ param requestid request ID
</span><span style="color:#8f5902;font-style:italic">     *@ return is released successfully
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">releaseDistributedLock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Jedis</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#000">String</span> <span style="color:#000">script</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#000">Object</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">eval</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Collections</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">singletonList</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">),</span> <span style="color:#000">Collections</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">singletonList</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">));</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RELEASE_SUCCESS</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>First, get the value value corresponding to the lock, check whether it is equal to the requestid, if it is equal, delete the lock (unlock). So why use Lua? Because to ensure that the operation is atomic. BeforeThread model and transaction of redisIn this paper, we ensure the atomicity of a series of operation instructions through transaction, and Lua script can also achieve similar effect.</p>
<p>Why atomic? If a request obtains the value corresponding to the lock and verifies that the requestid is equal, it will issue a delete instruction. But because of the network and other reasons, the deletion instruction is blocked. At this time, the lock is automatically unlocked because of timeout, and B requests to acquire the lock and re lock it. At this time, a requests the deletion instruction to be executed. As a result, the lock obtained by B requests is deleted.</p>
<h3 id="33-lua">3.3. lua</h3>
<p>The computing power of redis command is not very powerful, and Lua language can make up for the deficiency of redis to a great extent. In redis, the execution of Lua language is atomic, that is to say, when redis executes Lua, it will not be interrupted and has atomicity. This feature helps redis to support the consistency of concurrent data.</p>
<p>Redis supports two ways to run scripts, one is to input some Lua language program code directly, the other is to write Lua language into a file. In practical application, some simple scripts can take the first way, and generally use the second way for those with certain logic. For simple scripts, redis supports caching scripts, but it will use SHA-1 algorithm to sign the script, and then return the SHA-1 ID, as long as it runs through this ID.</p>
<h4 id="executing-lua-in-redis">Executing Lua in redis</h4>
<p>Here is a brief introduction. The way to directly input some Lua program code can be performed in redis cli as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#000">eval</span> <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">script</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">num</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">key1</span> <span style="color:#000">key2</span> <span style="color:#000">key3</span> <span style="color:#000;font-weight:bold">....]</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">value1</span> <span style="color:#000">value2</span> <span style="color:#000">value3</span> <span style="color:#000;font-weight:bold">....]</span>

<span style="color:#8f5902;font-style:italic">--Example 1</span>
<span style="color:#000">eval</span> <span style="color:#4e9a06">&#34;return &#39;Hello World&#39;&#34;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#8f5902;font-style:italic">--Example 2</span>
<span style="color:#000">eval</span> <span style="color:#4e9a06">&#34;redis.call(&#39;set&#39;,KEYS[1],ARGV[1])&#34;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">key</span> <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">value</span>
</code></pre></div><ul>
<li>evalRepresents the execution of Lua language commands.</li>
<li>lua-scriptRepresents Lua language script.</li>
<li>key-numIt indicates how many keys there are in the parameter. It should be noted that the key in redis starts from 1. If there is no key parameter, write 0.</li>
<li>[key1 key2 key3…]Key is passed to Lua as a parameter, which can be left blank, but it needs to be corresponding to the number of key num.</li>
<li>[value1 value2 value3 …]These parameters are passed to Lua language. They can be filled in or not.</li>
</ul>
<h4 id="calling-redis-in-lua">Calling redis in Lua</h4>
<p>Using in Lua redis.call Do the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">command</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">param1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">param2</span><span style="color:#a40000">…</span><span style="color:#000;font-weight:bold">])</span>

<span style="color:#8f5902;font-style:italic">--Example 1</span>
<span style="color:#000">eval</span> <span style="color:#4e9a06">&#34;return redis.call(&#39;set&#39;,&#39;foo&#39;,&#39;bar&#39;)&#34;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#8f5902;font-style:italic">--Example 2</span>
<span style="color:#000">eval</span> <span style="color:#4e9a06">&#34;return redis.call(&#39;set&#39;,KEYS[1],&#39;bar&#39;)&#34;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000">foo</span>
</code></pre></div><ul>
<li>commandIs the command, including set, get, del and so on.</li>
<li>keyIs the key to be operated.</li>
<li>param1,param2…Represents the parameter given to the key.</li>
</ul>
<p>For example, implement a Lua script for GetSet</p>
<p>getset.lua</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">newValue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ARGV</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">oldValue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;get&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;set&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newValue</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">oldValue</span>
</code></pre></div><h3 id="34-限制和改善">3.4. 限制和改善</h3>
<p>As we said earlier, there are some limitations in the implementation of distributed lock in redis cluster. It is difficult to ensure consistency when the master and slave are replaced.</p>
<h4 id="phenomenon">phenomenon</h4>
<p>In the redis sentinel cluster, we have multiple redis, and there is a master-slave relationship between them, such as one master and two slaves. The data corresponding to our set command is written to the master library, and then synchronized to the slave library. When we apply for a lock, the corresponding command is setnx MyKey myvalue. In the redis sentinel cluster, this command first falls into the main library. Suppose that the master database is down and the data has not yet been synchronized to the slave database, sentinel will elect the master database from one of the slave databases. At this time, there is no MyKey data in our new main library. If another client executes setnx MyKey hisvalue, it will also succeed, that is, it will also get the lock. This means that two clients have acquired the lock. This is not what we want to see. Although the record of this situation is very small, it will only happen when the master-slave fails over. In most cases, most systems can tolerate this flaw, but not all systems can tolerate it.</p>
<h4 id="solve">solve</h4>
<p>In order to solve the defect in the case of fail over, anterez inventedRedlock algorithm。 Using redlock algorithm, multiple redis instances are needed. When locking, it will send setex MyKey myvalue command to most nodes, as long asIf more than half of the nodes are successful, then the locking is successful。 This is very similar to the zookeeper implementation,When the leader of zookeeper cluster broadcasts the command, more than half of the followers must feed back ack to the leader before it takes effect。</p>
<p>In practical work, we can choose the existing open source implementation, which is redlock py in Python and redlock py in JavaRedisson redlock。</p>
<p>Redlock does solve the “unreliable situation” mentioned above. However, while it solves the problem, it also brings the cost. You need multiple redis instances, you need to introduce new libraries, you need to adjust the code, and the performance will be damaged. Therefore, it is true that there is no “perfect solution”. What we need more is to be able to solve the problem according to the actual situation and conditions.</p>
<h2 id="4-oversold-示例代码">4. “Oversold” 示例代码</h2>
<p>We simulate a scene of goods rush buying: a commodity has 100 pieces in stock,
and 200 people rush to buy at the same time.
Compare the rush buying situation with lock and without lock.</p>
<h3 id="41-代码">4.1. 代码</h3>
<p>The following is the code of this demo. ORM uses JPA, so the code of Dao layer and POJO is not written in this article. There is only one interface in the controller layer, which selects whether to use the lock by passing parameters.</p>
<h3 id="table-structure">Table structure</h3>
<p>Commodity listproduct</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AUTO_INCREMENT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">amount</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Purchase recordpurchase_history</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">purchase_history</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AUTO_INCREMENT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">product_name</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">purchaser</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">purchase_time</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datetime</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">amount</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>pom.xml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependencies&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!--web--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!--redis--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!--lombok--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.projectlombok<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>lombok<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!--jpa--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!--mysql--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>mysql<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>mysql-connector-java<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!-- test--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;scope&gt;</span>test<span style="color:#204a87;font-weight:bold">&lt;/scope&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>junit<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>junit<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependencies&gt;</span>
</code></pre></div><p>application.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8001</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spring</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">redis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">datasource</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">driver-class-name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">com.mysql.cj.jdbc.Driver</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jdbc:mysql://localhost:3306/demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>ProductController.java</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RestController</span>
<span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/product&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ProductController</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">String</span> <span style="color:#000">PRODUCT_APPLE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;apple&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">BuyService</span> <span style="color:#000">buyService</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ProductController</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">BuyService</span> <span style="color:#000">buyService</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">buyService</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">buyService</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Purchase goods Does @ param lock have a lock Y / N
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/buy&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">buy</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;lock&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">required</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Y&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">buyService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">buyProductWithLock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">PRODUCT_APPLE</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">buyService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">buyProduct</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">PRODUCT_APPLE</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>BuyService.java</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Service</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BuyService</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">ProductDao</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">PurchaseHistoryDao</span> <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">LockService</span> <span style="color:#000">lockService</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">BuyService</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ProductDao</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">PurchaseHistoryDao</span> <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">LockService</span> <span style="color:#000">lockService</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">productDao</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">purchaseHistoryDao</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">lockService</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lockService</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Purchase: no lock
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param productName
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">buyProduct</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">Product</span> <span style="color:#000">product</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">findOneByName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// Inventory minus 1
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#8f5902;font-style:italic">// Log
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">PurchaseHistory</span> <span style="color:#000">purchaseHistory</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PurchaseHistory</span><span style="color:#ce5c00;font-weight:bold">();</span>
            <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setProductName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Purchase: lock
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param productName
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">buyProductWithLock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">String</span> <span style="color:#000">uuid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">UUID</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">randomUUID</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">toString</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#8f5902;font-style:italic">// Lock
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">lock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">break</span><span style="color:#ce5c00;font-weight:bold">;</span>
            <span style="color:#ce5c00;font-weight:bold">}</span>
            <span style="color:#000">Thread</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">sleep</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">100</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#000">Product</span> <span style="color:#000">product</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">findOneByName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// Inventory minus 1
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#8f5902;font-style:italic">// Log
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">PurchaseHistory</span> <span style="color:#000">purchaseHistory</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PurchaseHistory</span><span style="color:#ce5c00;font-weight:bold">();</span>
            <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setProductName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#000">lockService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">unlock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>LockService.java</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Service</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LockService</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">StringRedisTemplate</span> <span style="color:#000">stringRedisTemplate</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">LockService</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StringRedisTemplate</span> <span style="color:#000">stringRedisTemplate</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">stringRedisTemplate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">stringRedisTemplate</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Lock
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param lockKey
</span><span style="color:#8f5902;font-style:italic">     * @param requestId
</span><span style="color:#8f5902;font-style:italic">     * @return
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">stringRedisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">opsForValue</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">setIfAbsent</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Duration</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">ofSeconds</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">3</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Unlocking
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param lockKey
</span><span style="color:#8f5902;font-style:italic">     * @param requestId
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">unlock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">DefaultRedisScript</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Long</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">script</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">DefaultRedisScript</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;();</span>
        <span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setResultType</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Long</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setScriptText</span><span style="color:#ce5c00;font-weight:bold">(</span>
                <span style="color:#4e9a06">&#34;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">stringRedisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">execute</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Collections</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">singletonList</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">),</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h3 id="42-测试和分析">4.2. 测试和分析</h3>
<p>In the test case, the initial inventory of the product is 100 copies, and 200 users are simulated to buy it. According to the principle, only 100 copies can be purchased in the end.</p>
<p>If we want to simulate and test the difference between “locked” and “unlocked”, we must create the condition of “high parallelism”. Here, we should remember that it is “high parallelism”, not “high concurrency”. Because the purchase interface here is fast in response to a single request, in order to simulate the situation that multiple users call the interface at the same time, we should use multithreading locally.</p>
<p>I’ve tried a lot to simulate highly parallel environments. The first time is to write JUnit test cases, starting 200 threads to call the interface. The result is that the service will hang up as soon as there are many threads. Although the reason is not clear, JUnit should not use it in this way. The second time is to use postman to do concurrent interface test, but it is found that whether postman is a fake concurrent test or a single thread calls the interface 200 times in turn, there is no implementation of multithreading. Finally, JMeter was installed, which met my expectations.</p>
<p>When we start 200 threads to call the lock free and lock interface respectively, the test results are as follows:</p>
<p>contrast No lock It’s locked
Surplus stock 68 0
Purchase records 200 100
As you can see, there will be oversold in the case of no lock. Let’s take a look at the purchase code of no lock.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> *Purchase: no lock
</span><span style="color:#8f5902;font-style:italic"> * @param productName
</span><span style="color:#8f5902;font-style:italic"> */</span>
 <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">synchronized</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">buyProduct</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">Product</span> <span style="color:#000">product</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">findOneByName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">//Inventory minus 1
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#8f5902;font-style:italic">//Log
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">PurchaseHistory</span> <span style="color:#000">purchaseHistory</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PurchaseHistory</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setProductName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>When multiple requests are called at the same timeproductDao.findOneByName(productName);
The result is the same. They all think that there is still inventory.
If they go to buy, the problem of oversold will appear.
To solve this problem, if it is a single process, through thesynchronized And so on.
If it is distributed multi node, we can consider the way of this paper and use redis distributed lock implementation.</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-60795475c0c26f209764d621c27ec700">一个使用 Node.js 的 Redlock 示例，关于如何锁定一个Redis上的密钥对</h1>
	
	<div class="td-byline mb-4">
		By <b>Roberto Bandini</b> |
        
		<time datetime="2020-11-29" class="text-muted">Sunday, November 29, 2020</time>
        
	</div>
	<blockquote>
<p><a href="https://www.robertobandini.it/2020/11/29/a-redlock-example-with-node-js-about-how-to-lock-a-key-pair-on-redis/">https://www.robertobandini.it/2020/11/29/a-redlock-example-with-node-js-about-how-to-lock-a-key-pair-on-redis/</a></p>
</blockquote>
<p>In the previous example we’ve tested with ApacheBench an application deployed using Kubernetes and Docker,
composed by a Node.js microservice to get and set key value pairs on Redis.
We saw that if we have many concurrent requests from multiple clients we can’t know before which will be the final value of the key on Redis.</p>
<p>In this post we see an example about how we can lock a key value pair on Redis, so that another client has to wait before to set a new value.
We will use the Node.js implementation of Redlock, the algorithm to have distributed locks with Redis.</p>
<p>To try this example on your PC you only need to install Docker Desktop and Node.js then follow the described steps.</p>
<p>Create a directory for this example and inside copy the two directories from the previous example, redis-server and webservice.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">mkdir node-redis-example-5
<span style="color:#204a87">cd</span> node-redis-example-5
cp -r ../node-redis-example-4/redis-server/ .
cp -r ../node-redis-example-4/webservice/ .
</code></pre></div><p>Enter the redis-server directory and build our redis-server Docker image.
If you didn’t tried the previous example, read it to know about the Redis persistence directory and how to configure it on your PC.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#204a87">cd</span> redis-server
docker build -t redis-server:1.0.0 -f Dockerfile .
</code></pre></div><p>Rename the application to “node-redis-example-5” inside the deloy.yml file and apply the redis-server Kubernetes deployment configuration.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">kubectl apply -f ./deploy.yml
</code></pre></div><p>Rename the application to “node-redis-example-5” inside the service.yml file and apply the redis-server Kubernetes service configuration.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">kubectl apply -f ./service.yml
</code></pre></div><p>Go inside the webservice directory and install the redlock package and the log-timestamp package.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#204a87">cd</span> ../webservice
npm i redlock log-timestamp
</code></pre></div><p>Edit the index.js file to import these packages and add a new endpoint, called “lockAndSetValue”.
It will use redlock to lock a key on Redis and when the lock is acquired it will set the value.
Then it will wait for 10 seconds, as if we are waiting an asyncornous job to complete.
Thanks to the retryCount options set to -1, before the 10 seconds ends,
the others clients will continue to try to acquire the lock on the key until the lock is released by the first client.
After 10 seconds the lock is released so one another client can now do the same.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// Import packages.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">express</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;express&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redlock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;redlock&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">promisify</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;util&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;log-timestamp&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Create and configure a webserver.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">express</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">use</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">express</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">());</span>

<span style="color:#8f5902;font-style:italic">// Create and configure a Redis client.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redisClient</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;6379&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">process</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">env</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">REDIS_SERVER_IP</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">redisClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">));</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redisSet</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">promisify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redisClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redisClient</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redisGet</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">promisify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redisClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redisClient</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redlock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redlock</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">redisClient</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">driftFactor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.01</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">retryCount</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">retryDelay</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">retryJitter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clientError&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A redis error has occurred:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Adding a simple function to wait some time.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sleep</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ms</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">setTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ms</span><span style="color:#000;font-weight:bold">));</span>

<span style="color:#8f5902;font-style:italic">// Create and endpoint to lock a key value paire and set the value.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/lockAndSetValue&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Request received!&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">resource</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`locks:</span><span style="color:#4e9a06">${</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">20000</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resource</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Lock acquired!&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redisSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`SET key=</span><span style="color:#4e9a06">${</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> value=</span><span style="color:#4e9a06">${</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Waiting some time...&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Time finished, key unlocked!&#34;</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">().</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">});</span>
      <span style="color:#000;font-weight:bold">});</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Sending response!&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">error</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wrong input.&#34;</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Create an endpoint to set a key value pair.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">post</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/setValue&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redisSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`SET key=</span><span style="color:#4e9a06">${</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> value=</span><span style="color:#4e9a06">${</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">error</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wrong input.&#34;</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Create an endpoint to get a key value pair.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/getValue/:key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">400</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">error</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Wrong input.&#34;</span> <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redisGet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`GET key=</span><span style="color:#4e9a06">${</span><span style="color:#000">req</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">params</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> value=</span><span style="color:#4e9a06">${</span><span style="color:#000">value</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Start the webserver.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server is up on port 3000&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>We can now build the new image of our webservice.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker build -t webservice:1.0.0 -f Dockerfile .
</code></pre></div><p>To have two identical clients on two differents ports, from the deploy.yml and service.yml files inside the webservice directory, we create two couple of files to have two differents deployments and services, always using the same webservice image.</p>
<p>deploy-1.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-redis-example-5</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">component</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-redis-example-5</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">component</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">strategy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rollingUpdate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">maxSurge</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">maxUnavailable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RollingUpdate</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-redis-example-5</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">component</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">redeploy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice:1.0.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REDIS_SERVER_IP</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;redis-server&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>deploy-2.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Deployment</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-redis-example-5</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">component</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-redis-example-5</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">component</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">strategy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">rollingUpdate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">maxSurge</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">maxUnavailable</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RollingUpdate</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-redis-example-5</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">component</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">redeploy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice:1.0.0</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">env</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">REDIS_SERVER_IP</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">value</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;redis-server&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>service-1.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-redis-example-5</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">component</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NodePort</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-redis-example-5</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">component</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">targetPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">nodePort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">30001</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>service-2.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-redis-example-5</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">component</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NodePort</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">node-redis-example-5</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">component</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webservice-2</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">targetPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">nodePort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">30002</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Apply these configurations using kubectl.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">kubectl apply -f ./deploy-1.yml
kubectl apply -f ./deploy-2.yml
kubectl apply -f ./service-1.yml
kubectl apply -f ./service-2.yml
</code></pre></div><p>Now we have the first microservice listening to the port 30001 and the second on port 30002.</p>
<p>Docker Desktop Dashboard testing Node.js Redlock
As in the previous example, we list the container’s running.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker ps -a
</code></pre></div><p>Look for the two microservice’s container ids, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">CONTAINER ID IMAGE COMMAND CREATED STATUS PORTS NAMES
3346b3569723 bcbc46957b97 <span style="color:#4e9a06">&#34;docker-entrypoint.s…&#34;</span> <span style="color:#0000cf;font-weight:bold">9</span> seconds ago Up <span style="color:#0000cf;font-weight:bold">8</span> seconds k8s_webservice-2_webservice-2-8d6cf6cc5-qg8qw_default_b624341c-313f-48fb-ab7b-caf819988b35_0
be8cb77ea5d0 bcbc46957b97 <span style="color:#4e9a06">&#34;docker-entrypoint.s…&#34;</span> <span style="color:#0000cf;font-weight:bold">12</span> seconds ago Up <span style="color:#0000cf;font-weight:bold">11</span> seconds k8s_webservice-1_webservice-1-597f4dc574-mdfmj_default_1f715022-86ef-4c45-95a7-9c1b4566f95e_0
125eab4775e6 90b173f7b4bf <span style="color:#4e9a06">&#34;sh -c /run.sh&#34;</span> <span style="color:#0000cf;font-weight:bold">3</span> minutes ago Up <span style="color:#0000cf;font-weight:bold">3</span> minutes k8s_redis-server_redis-server-7f6bb59858-k5rsd_default_981ca607-112a-4778-a076-bbea7989964d_0
</code></pre></div><p>Open a second shell window to watch logs of the webservice-1 container.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker logs -f be8cb77ea5d0
</code></pre></div><p>Open a third shell window to watch logs of the second container.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">docker logs -f 3346b3569723
</code></pre></div><p>Use Postman to call the “lockAndSetValue” on webservice-1, port 30001.</p>
<p>Testing Node.js Redlock with Postman, first webservice
And then, before 10 seconds pass, do the same with webservice-2, port 30002.</p>
<p>Testing Node.js Redlock with Postman, second webservice
You will able to check the entire sequence through the two containers logs.</p>
<p>Node.js Redlock tests logs
As you can see, the second client will wait until the first client will release the lock after the 10 seconds.</p>
<p>You can find the source code on this GitHub repository:
<a href="https://github.com/robertobandini/node-redis-example-5">https://github.com/robertobandini/node-redis-example-5</a>
It also includes the Postman collection used and a sw-version.txt file to specify the softwares used for this project and their versions.</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-5a59f1b5d86ea3142288d21febb3cfd2">Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性</h1>
	
	<div class="td-byline mb-4">
		By <b>Laravel</b> |
        
		<time datetime="2020-01-05" class="text-muted">Sunday, January 05, 2020</time>
        
	</div>
	<blockquote>
<p><a href="https://learnku.com/articles/39265">https://learnku.com/articles/39265</a></p>
</blockquote>
<h2 id="背景">背景</h2>
<p>最近公司出了一起故障，问题代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * TRUE: 触发限流，FALSE：未触发限流
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">acquire</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000">$redisHandler</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">redisInstance</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">getHandler</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000">$redisHandler</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">rateLimitKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">tokenNum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;nx&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;ex&#39;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">expireTime</span><span style="color:#000;font-weight:bold">]);</span>
            <span style="color:#000">$leftTokenNum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$redisHandler</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">decr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">rateLimitKey</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">$leftTokenNum</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">TRUE</span><span style="color:#000;font-weight:bold">;</span>
            <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">\Exception</span> <span style="color:#000">$e</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">FALSE</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>作者的目的是针对爆款商品的购买，使用 redis 来起到一个限流的作用，1 秒钟只允许 1 人购买。</p>
<p>结果上线过后不久，运营就反馈线上出故障了，该爆款商品所有人都不能购买了。</p>
<h2 id="分析">分析</h2>
<p>上面代码的思路很简单：通过 <code>$redis-&gt;set('key', '1', ['nx', 'ex'=&gt;1]); </code> 命令，设置值为 1 过期时间为 1 秒的计数器，基于该计数器的扣减来达到 1 秒钟放行 1 个请求的目的。</p>
<h2 id="测试">测试</h2>
<p>我们简化一下上面的代码，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000">$redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">$redis</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;127.0.0.1&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">$key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;test_redis_key&#39;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">$redis</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;1&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;nx&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;ex&#39;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">$left</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$redis</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">decr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$key</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">$left</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// 这里通过状态码来更方便的观察
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">header</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Is-Limited:1&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">header</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Is-Limited:0&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>简化后使用 siege 模拟 100 个用户并发压测一下。</p>
<p><img src="https://cdn.learnku.com/uploads/images/202001/05/21857/RWB6IZv9Ka.gif!large" alt="Redis 执行 Lua 脚本替代 SETNX / DECR 保证原子性"></p>
<p>非常稳啊，1 秒钟通过 1 个请求。</p>
<p>我们的开发同学也就是经过了上述测试才放心把代码发上线的，咋一上线就炸了呢？</p>
<h2 id="原因">原因</h2>
<p>我们来看下面一段操作，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#ce5c00;font-weight:bold">[</span>root@e98dffb83384 src<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ./redis-cli</span>
127.0.0.1:6379&gt; SETNX k <span style="color:#0000cf;font-weight:bold">1</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">1</span>
127.0.0.1:6379&gt; EXPIRE k <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#8f5902;font-style:italic"># 为了方便演示，这里设置 10 秒过期时间</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">1</span>
127.0.0.1:6379&gt; DECR k <span style="color:#8f5902;font-style:italic"># 在过期时间内，第一次扣减成 0</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">0</span>
127.0.0.1:6379&gt; DECR k <span style="color:#8f5902;font-style:italic"># 继续扣减成 -1</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> -1
127.0.0.1:6379&gt; DECR k <span style="color:#8f5902;font-style:italic"># 继续扣减成 -2</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> -2
127.0.0.1:6379&gt; TTL k <span style="color:#8f5902;font-style:italic"># k 还有 2 秒过期</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">2</span>
127.0.0.1:6379&gt; DECR k <span style="color:#8f5902;font-style:italic"># 继续扣减成 -3</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> -3
127.0.0.1:6379&gt; TTL k <span style="color:#8f5902;font-style:italic"># 距离设置过期时间 10 秒之后，k 已经过期</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> -2
127.0.0.1:6379&gt; DECR k <span style="color:#8f5902;font-style:italic"># 这时候再扣减发现 k 的值被扣减成 -1</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> -1
127.0.0.1:6379&gt; DECR k <span style="color:#8f5902;font-style:italic"># 继续扣减成 -2</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> -2
127.0.0.1:6379&gt; TTL k <span style="color:#8f5902;font-style:italic"># 查看 k 过期时间是永不过期</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> -1
127.0.0.1:6379&gt; SETNX k <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#8f5902;font-style:italic"># 再设置是不成功的</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">0</span>
127.0.0.1:6379&gt; DECR k <span style="color:#8f5902;font-style:italic"># 继续扣减成 -3</span>
<span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> -3
</code></pre></div><p>在 Redis key 未过期之前，DECR 命令都是正常扣减的。一旦 key 过期了，再执行 DECR 命令，会发现 key 的值和过期时间都变为 -1 了。</p>
<p>Redis 官网对 DECR 命令介绍里有这么一段：</p>
<pre tabindex="0"><code>Decrements the number stored at key by one.
If the key does not exist, it is set to 0 before performing the operation.
</code></pre><p>对于出问题的代码，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000">$redisHandler</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">rateLimitKey</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">tokenNum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;nx&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;ex&#39;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">expireTime</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000">$leftTokenNum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$redisHandler</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">decr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$this</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">rateLimitKey</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>假设在第一句 SETNX 之后第二句 DECR 之前，key 过期了，再执行 DECR 就会先生成一个永不过期值为 0 的 key。</p>
<p>之后所有请求的 SETNX 都是 fasle，一直会基于这个永不过期的 key 进行递减，所有的 $leftTokenNum 都小于 0，因此导致所有请求被限流。</p>
<h2 id="问题复现">问题复现</h2>
<p>自测时为啥发现不了问题？因为自测时设置的过期时间是 1 秒，导致 key 在两步之间过期出现的概率很小。我们只要将过期时间调的足够小，很容易复现问题。</p>
<p>把过期时间改为 5 毫秒，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000">$redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">$redis</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;127.0.0.1&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">$key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;test_redis_key&#39;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">$redis</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;3&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;nx&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;px&#39;</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">]);</span> <span style="color:#8f5902;font-style:italic">// key 设置成 5 毫秒过期
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">$left</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$redis</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">decr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$key</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">$left</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// 这里通过状态码来更方便的观察
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">header</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Is-Limited:1&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">header</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Is-Limited:0&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>依然使用 siege 压测：</p>
<p><img src="https://cdn.learnku.com/uploads/images/202001/05/21857/bRyFKd010f.gif!large" alt="Redis 执行 Lua 脚本替代 SETNX / DECR 保证原子性"></p>
<p>由于设置的 5 毫秒放行一个请求，因此前半部分基本上都是通过的请求，偶尔有几个限流的，这是正常的。
但是没过多久，所有请求都被限流了，也就复现了线上的故障。</p>
<h2 id="解决方案">解决方案</h2>
<p>如何改进代码来正确的实现限流呢？</p>
<p>Redis 的 <code>EVAL</code> 命令 执行 Lua 脚本时可以保证原子性。</p>
<pre tabindex="0"><code>Atomicity of scripts

Redis uses the same Lua interpreter to run all the commands. Also Redis guarantees that a script is executed in an atomic way: no other script or Redis command will be executed while a script is being executed.
</code></pre><p><code>EVAL</code> 命令的格式为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">EVAL script numkeys key <span style="color:#ce5c00;font-weight:bold">[</span>key ...<span style="color:#ce5c00;font-weight:bold">]</span> arg <span style="color:#ce5c00;font-weight:bold">[</span>arg ...<span style="color:#ce5c00;font-weight:bold">]</span>
</code></pre></div><p>例子：</p>
<pre tabindex="0"><code>&gt; eval &quot;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&quot; 2 key1 key2 first second

1.  &quot;key1&quot;
2.  &quot;key2&quot;
3.  &quot;first&quot;
4.  &quot;second&quot;
</code></pre><p>我们可以借助 Lua 脚本来避免 SETNX 和 DECR 之间会出现过期的尴尬情况。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#000">$redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">$redis</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">connect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;127.0.0.1&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">$key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;test_redis_key1&#39;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">$script</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&lt;&lt;&lt;</span><span style="color:#4e9a06">LUA</span><span style="color:#4e9a06">
</span><span style="color:#4e9a06">local max = tonumber(ARGV[1])
</span><span style="color:#4e9a06">local interval_milliseconds = tonumber(ARGV[2])
</span><span style="color:#4e9a06">local current = tonumber(redis.call(&#39;get&#39;, KEYS[1]) or 0)
</span><span style="color:#4e9a06">
</span><span style="color:#4e9a06">if (current + 1 &gt; max) then
</span><span style="color:#4e9a06">    return true
</span><span style="color:#4e9a06">else
</span><span style="color:#4e9a06">    redis.call(&#39;incrby&#39;, KEYS[1], 1)
</span><span style="color:#4e9a06">    if (current == 0) then
</span><span style="color:#4e9a06">        redis.call(&#39;pexpire&#39;, KEYS[1], interval_milliseconds)
</span><span style="color:#4e9a06">    end
</span><span style="color:#4e9a06">    return false
</span><span style="color:#4e9a06">end
</span><span style="color:#4e9a06"></span><span style="color:#4e9a06">LUA</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">$redis</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">script</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;load&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">$script</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">$isLimited</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$redis</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#c4a000">eval</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">$script</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">$key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// key 5 毫秒过期
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">$isLimited</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">header</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Is-Limited:1&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">header</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Is-Limited:0&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>依然使用 siege 压测，</p>
<p><img src="https://cdn.learnku.com/uploads/images/202001/05/21857/t1DULIxU6G.gif!large" alt="Redis 执行 Lua 脚本替代 SETNX / DECR 保证原子性"></p>
<p>持续压了 10 多分钟也没出现之前问题，问题得以解决。</p>
<h2 id="总结">总结</h2>
<ul>
<li>Redis 中 DECR 一个不存在的 key 会先把 key 值设置为 0 , TTL 设置为 -1 (永不过期)，再进行减 1 操作。</li>
<li>使用 SETNX 配合 DECR 实现限流，会出现 key 永不过期情况。过期时间比较小或者高并发情况下，发生概率更高。</li>
<li>在 Redis 中执行 Lua 脚本是原子操作。</li>
<li>可以通过 Redis + Lua 实现高并发下的限流。</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-eb85bda82a8f47d580cfbdfa5b9adbda">Node.js 中实践基于 Redis 的分布式锁实现</h1>
	
	<div class="td-byline mb-4">
		By <b>五月君</b> |
        
		<time datetime="2019-11-24" class="text-muted">Sunday, November 24, 2019</time>
        
	</div>
	<p>在一些分布式环境下、多线程并发编程中，如果对同一资源进行读写操作，避免不了的一个就是资源竞争问题，通过引入分布式锁这一概念，可以解决数据一致性问题。</p>
<p>作者简介：五月君，Nodejs Developer，慕课网认证作者，热爱技术、喜欢分享的 90 后青年，欢迎关注 Nodejs 技术栈 和 Github 开源项目 <a href="https://www.nodejs.red">https://www.nodejs.red</a></p>
<h2 id="认识线程进程分布式锁">认识线程、进程、分布式锁</h2>
<ul>
<li>
<p><strong>线程锁</strong>：单线程编程模式下请求是顺序的，一个好处是不需要考虑线程安全、资源竞争问题，因此当你进行 Node.js 编程时，也不会去考虑线程安全问题。
那么多线程编程模式下，例如 Java 你可能很熟悉一个词 synchronized，通常也是 Java 中解决并发编程最简单的一种方式，
synchronized 可以保证在同一时刻仅有一个线程去执行某个方法或某块代码。</p>
</li>
<li>
<p><strong>进程锁</strong>：一个服务部署于一台服务器，同时开启多个进程，Node.js 编程中为了利用操作系统资源，根据 CPU 的核心数可以开启多进程模式，
这个时候如果对一个共享资源操作还是会遇到资源竞争问题，另外每一个进程都是相互独立的，拥有自己独立的内存空间。
关于进程锁通过 Java 中的 synchronized 也很难去解决，synchronized 仅局限于在同一个 JVM 中有效。</p>
</li>
<li>
<p><strong>分布式锁</strong>：一个服务无论是单线程还是多进程模式，当多机部署、处于分布式环境下对同一共享资源进行操作还是会面临同样的问题。
此时就要去引入一个概念分布式锁。
如下图所示，由于先读数据在通过业务逻辑修改之后进行 SET 操作，这并不是一个原子操作，当多个客户端对同一资源进行先读后写操作就会引发并发问题，
这时就要引入分布式锁去解决，通常也是一个很广泛的解决方案。</p>
<p><img src="https://pic2.zhimg.com/80/v2-d7b830fc4d16750723645db7edb22ff1_1440w.jpg" alt=""></p>
</li>
</ul>
<h2 id="基于-redis-的分布式锁实现思路">基于 Redis 的分布式锁实现思路</h2>
<p>实现分布式锁的方式有很多：数据库、Redis、Zookeeper。这里主要介绍的是通过 Redis 来实现一个分布式锁，至少要保证三个特性：安全性、死锁、容错。</p>
<ul>
<li><strong>安全性</strong>：所谓一个萝卜一个坑，第一点要做的是上锁，在任意时刻要保证仅有一个客户端持有该锁。</li>
<li><strong>死锁</strong>：造成死锁可能是由于某种原因，本该释放的锁没有被释放，因此在上锁的时候可以同步的设置过期时间，
如果由于客户端自己的原因没有被释放，也要保证锁能够自动释放。</li>
<li><strong>容错</strong>：容错是在多节点的模式下需要考虑的，只要能保证 N/2+1 节点可用，客户端就可以成功获取、释放锁。</li>
</ul>
<h2 id="redis-单实例分布式锁实现">Redis 单实例分布式锁实现</h2>
<p>在 Redis 的单节点实例下实现一个简单的分布式锁，这里会借助一些简单的 Lua 脚本来实现原子性，
不了解可以参考之前的文章 <a href="https://link.zhihu.com/?target=https%3A//mp.weixin.qq.com/s/kfgiVkKZofLh6qiqUd48Cw">Node.js 中实践 Redis Lua 脚本</a></p>
<h3 id="上锁">上锁</h3>
<p>上锁的第一步就是先通过 <code>setnx</code> 命令占坑，为了防止死锁，通常在占坑之后还会设置一个过期时间 <code>expire</code>，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">setnx key value
expire key seconds
</code></pre></div><p>以上命令不是一个原子性操作，所谓原子性操作是指命令在执行过程中并不会被其它的线程或者请求打断，
以上如果 setnx 执行成功之后，出现网络闪断 <code>expire</code> 命令便不会得到执行，会导致死锁出现。</p>
<p>也许你会想到使用事物来解决，但是事物有个特点，要么成功要么失败，都是一口气执行完成的，
在我们上面的例子中，<code>expire</code> 是需要先根据 <code>setnx</code> 的结果来判断是否需要进行设置，
显然事物在这里是行不通的，社区也有很多库来解决这个问题，
现在 Redis 官方 2.8 版本之后支持 <code>set</code> 命令传入 <code>setnx</code>、<code>expire</code> 扩展参数，这样就可以一条命令一口气执行，避免了上面的问题，如下所示：</p>
<ul>
<li><strong>value</strong>：建议设置为一个随机值，在释放锁的时候会进一步讲解</li>
<li><strong>EX seconds</strong>：设置的过期时间</li>
<li><strong>PX milliseconds</strong>：也是设置过期时间，单位不一样</li>
<li><strong>NX|XX</strong>：NX 同 setnx 效果是一样的</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#204a87">set</span> key value <span style="color:#ce5c00;font-weight:bold">[</span>EX seconds<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>PX milliseconds<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>NX<span style="color:#000;font-weight:bold">|</span>XX<span style="color:#ce5c00;font-weight:bold">]</span>
</code></pre></div><h3 id="释放锁">释放锁</h3>
<p>释放锁的过程就是将原本占有的坑给删除掉，但是也并不能仅仅使用 <code>del key</code> 删除掉就万事大吉了，
这样很容易删除掉别人的锁，为什么呢？举一个例子客户端 A 获取到一把 <code>key = name1</code> 的锁（2 秒中），
紧接着处理自己的业务逻辑，但是在业务逻辑处理这块阻塞了耗时超过了锁的时间，锁是会自动被释放的，
这期间该资源又被客户端 B 获取了 <code>key = name1</code> 的锁，那么客户端 A 在自己的业务处理结束之后直接使用 del key 命令删除会把客户端 B 的锁给释放掉了，
所以释放锁的时候要做到仅释放自己占有的锁。</p>
<p>加锁的过程中建议把 value 设置为一个随机值，主要是为了更安全的释放锁，在 <code>del key</code> 之前先判断这个 key 存在且 value 等于自己指定的值才执行删除操作。
判断和删除不是一个原子性的操作，此处仍需借助 Lua 脚本实现。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">ARGV</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">then</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;del&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span>
<span style="color:#204a87;font-weight:bold">else</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#204a87;font-weight:bold">end</span>
</code></pre></div><h2 id="nodejs-单实例分布式锁实践">Node.js 单实例分布式锁实践</h2>
<p>Redis 单实例分布式锁 Node.js 实践</p>
<p>使用 Node.js 的 Redis 客户端为 ioredis，<code>npm install ioredis -S</code> 先安装该包。</p>
<h3 id="初始化自定义-redislock">初始化自定义 RedisLock</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RedisLock</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * 初始化 RedisLock
</span><span style="color:#8f5902;font-style:italic">   * @param {*} client
</span><span style="color:#8f5902;font-style:italic">   * @param {*} options
</span><span style="color:#8f5902;font-style:italic">   */</span>
  <span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">options</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;client 不存在&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#4e9a06">&#34;connecting&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;client 未正常链接&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lockLeaseTime</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lockLeaseTime</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// 默认锁过期时间 2 秒
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lockTimeout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lockTimeout</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// 默认锁超时时间 5 秒
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expiryMode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expiryMode</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#4e9a06">&#34;EX&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setMode</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">options</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setMode</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#4e9a06">&#34;NX&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="上锁-1">上锁</h3>
<p>通过 set 命令传入 setnx、expire 扩展参数开始上锁占坑，上锁成功返回，上锁失败进行重试，在 <code>lockTimeout</code> 指定时间内仍未获取到锁，则获取锁失败。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RedisLock</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * 上锁
</span><span style="color:#8f5902;font-style:italic">   * @param {*} key
</span><span style="color:#8f5902;font-style:italic">   * @param {*} val
</span><span style="color:#8f5902;font-style:italic">   * @param {*} expire
</span><span style="color:#8f5902;font-style:italic">   */</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">expire</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">self</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">intranetLock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span>
          <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expiryMode</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000">expire</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lockLeaseTime</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setMode</span>
        <span style="color:#000;font-weight:bold">);</span>

        <span style="color:#8f5902;font-style:italic">// 上锁成功
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;OK&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">val</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> 上锁成功`</span><span style="color:#000;font-weight:bold">);</span>
          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#8f5902;font-style:italic">// 锁超时
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">floor</span><span style="color:#000;font-weight:bold">((</span><span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">start</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lockTimeout</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">val</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> 上锁重试超时结束`</span><span style="color:#000;font-weight:bold">);</span>
          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#8f5902;font-style:italic">// 循环等待重试
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">val</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> 等待重试`</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">key</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> </span><span style="color:#4e9a06">${</span><span style="color:#000">val</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> 开始重试`</span><span style="color:#000;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">intranetLock</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">})();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="释放锁-1">释放锁</h3>
<p>释放锁通过 <code>redis.eval(script)</code> 执行我们定义的 redis lua 脚本。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RedisLock</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * 释放锁
</span><span style="color:#8f5902;font-style:italic">   * @param {*} key
</span><span style="color:#8f5902;font-style:italic">   * @param {*} val
</span><span style="color:#8f5902;font-style:italic">   */</span>
  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">unLock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">self</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">script</span> <span style="color:#ce5c00;font-weight:bold">=</span>
      <span style="color:#4e9a06">&#34;if redis.call(&#39;get&#39;,KEYS[1]) == ARGV[1] then&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
      <span style="color:#4e9a06">&#34;   return redis.call(&#39;del&#39;,KEYS[1]) &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
      <span style="color:#4e9a06">&#34;else&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
      <span style="color:#4e9a06">&#34;   return 0 &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span>
      <span style="color:#4e9a06">&#34;end&#34;</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">eval</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">script</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="测试">测试</h3>
<p>这里使用了 uuid 来生成唯一 ID，这个随机数 id 只要保证唯一不管用哪种方式都可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">uuidv1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;uuid/v1&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redisLock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RedisLock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">setTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">},</span> <span style="color:#000">time</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">uuidv1</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redisLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">unLock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redisLock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unLock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unLock: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unLock</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;上锁失败&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name1&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name1&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>同时调用了两次 test 方法进行上锁，只有第一个是成功的，
第二个 name1 26e02970-0532-11ea-b978-2160dffafa30 上锁的时候发现 <code>key = name1</code> 已被占坑，
开始重试，由于以上测试中设置了 3 秒钟之后自动释放锁，name1 26e02970-0532-11ea-b978-2160dffafa30 在经过两次重试之后上锁成功。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">name1</span> <span style="color:#0000cf;font-weight:bold">26e00260</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0532</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000">ea</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">b978</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2160</span><span style="color:#000">dffafa30</span> <span style="color:#000">上锁成功</span>
<span style="color:#000">name1</span> <span style="color:#0000cf;font-weight:bold">26e02970</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0532</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000">ea</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">b978</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2160</span><span style="color:#000">dffafa30</span> <span style="color:#000">等待重试</span>
<span style="color:#000">name1</span> <span style="color:#0000cf;font-weight:bold">26e02970</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0532</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000">ea</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">b978</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2160</span><span style="color:#000">dffafa30</span> <span style="color:#000">开始重试</span>
<span style="color:#000">name1</span> <span style="color:#0000cf;font-weight:bold">26e02970</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0532</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000">ea</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">b978</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2160</span><span style="color:#000">dffafa30</span> <span style="color:#000">等待重试</span>
<span style="color:#000">unLock</span><span style="color:#ce5c00;font-weight:bold">:</span>  <span style="color:#000">name1</span> <span style="color:#0000cf;font-weight:bold">26e00260</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0532</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000">ea</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">b978</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2160</span><span style="color:#000">dffafa30</span> <span style="color:#204a87;font-weight:bold">true</span>
<span style="color:#000">name1</span> <span style="color:#0000cf;font-weight:bold">26e02970</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0532</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000">ea</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">b978</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2160</span><span style="color:#000">dffafa30</span> <span style="color:#000">开始重试</span>
<span style="color:#000">name1</span> <span style="color:#0000cf;font-weight:bold">26e02970</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0532</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000">ea</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">b978</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2160</span><span style="color:#000">dffafa30</span> <span style="color:#000">上锁成功</span>
<span style="color:#000">unLock</span><span style="color:#ce5c00;font-weight:bold">:</span>  <span style="color:#000">name1</span> <span style="color:#0000cf;font-weight:bold">26e02970</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">0532</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000">ea</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">b978</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2160</span><span style="color:#000">dffafa30</span> <span style="color:#204a87;font-weight:bold">true</span>
</code></pre></div><h3 id="源码地址">源码地址</h3>
<p><a href="https://github.com/Q-Angelo/project-training/tree/master/redis/lock/redislock.js">https://github.com/Q-Angelo/project-training/tree/master/redis/lock/redislock.js</a></p>
<h2 id="redlock-算法">Redlock 算法</h2>
<p>以上是使用 Node.js 对 Redis 分布式锁的一个简单实现，在单实例中是可用的，当我们对 Redis 节点做一个扩展，在 Sentinel、Redis Cluster 下会怎么样呢？</p>
<p>以下是一个 Redis Sentinel 的故障自动转移示例图，假设我们客户端 A 在主节点 192.168.6.128 获取到锁之后，
主节点还未来得及同步信息到从节点就挂掉了，这时候 Sentinel 会选举另外一个从节点做为主节点，
那么客户端 B 此时也来申请相同的锁，就会出现同样一把锁被多个客户端持有，对数据的最终一致性有很高的要求还是不行的。</p>
<p><img src="https://pic3.zhimg.com/80/v2-4228ddede37354ed1e69bf388987647e_1440w.jpg" alt=""></p>
<h3 id="redlock-介绍">Redlock 介绍</h3>
<p>鉴于这些问题，Redis 官网 redis.io/topics/distlock 提供了一个使用 Redis 实现分布式锁的规范算法 Redlock，
中文翻译版参考 <a href="http://redis.cn/topics/distlock.html">http://redis.cn/topics/distlock.html</a></p>
<p>Redlock 在上述文档也有描述，这里简单做个总结：Redlock 在 Redis 单实例或多实例中提供了强有力的保障，
本身具备容错能力，它会从 N 个实例使用相同的 key、随机值尝试 <code>set key value [EX seconds] [PX milliseconds] [NX|XX]</code> 命令去获取锁，
在有效时间内至少 N/2+1 个 Redis 实例取到锁，此时就认为取锁成功，否则取锁失败，失败情况下客户端应该在所有的 Redis 实例上进行解锁。</p>
<h3 id="nodejs-中应用-redlock">Node.js 中应用 Redlock</h3>
<p><a href="https://github.com/mike-marcacci/node-redlock">node-redlock</a> 是 Node.js 版的 Redlock 实现，
使用起来也很简单，开始之前先安装 ioredis、redlock 包。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">npm i ioredis -S
npm i redlock -S
</code></pre></div><h3 id="编码">编码</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">client1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redlock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;redlock&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redlock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redlock</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">client1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">retryDelay</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// time in ms
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">retryCount</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// 多个 Redis 实例
</span><span style="color:#8f5902;font-style:italic">// const redlock = new Redlock(
</span><span style="color:#8f5902;font-style:italic">//     [new Redis(6379, &#34;127.0.0.1&#34;), new Redis(6379, &#34;127.0.0.2&#34;), new Redis(6379, &#34;127.0.0.3&#34;)],
</span><span style="color:#8f5902;font-style:italic">// )
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">lock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#8f5902;font-style:italic">// do something ...
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// return lock.unlock();
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;client1&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;client2&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="测试-1">测试</h3>
<p>对同一个 key name1 两次上锁，由于 client1 先取到了锁，client2 无法获取锁，
重试 5 次之后报错 LockError: Exceeded 5 attempts to lock the resource &ldquo;name1&rdquo;.</p>
<p><img src="https://pic2.zhimg.com/80/v2-419f20f85e7f078025724d52c32b8d91_1440w.jpg" alt=""></p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-8cc5c3a59964c1c4bc5b937057f92ab3">Node.js 中实践 Redis Lua 脚本</h1>
	
	<div class="td-byline mb-4">
		
        
		<time datetime="2019-11-10" class="text-muted">Sunday, November 10, 2019</time>
        
	</div>
	<blockquote>
<p><a href="https://cloud.tencent.com/developer/article/1536299">https://cloud.tencent.com/developer/article/1536299</a></p>
</blockquote>
<p>Lua 是一种轻量小巧的脚本语言，用标准 C 语言编写并以源代码形式开放，其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。
由于 Lua 语言具备原子性，其在执行的过程中不会被其它程序打断，对于并发下数据的一致性是有帮助的。</p>
<h2 id="redis-的两种-lua-脚本">Redis 的两种 Lua 脚本</h2>
<p>Redis 支持两种运行 Lua 脚本的方式，一种是直接在 Redis 中输入 Lua 代码，适合于一些简单的脚本。另一种方式是编写 Lua 脚本文件，适合于有逻辑运算的情况，Redis 使用 SHA1 算法支持对脚本签名和 Script Load 预先缓存，需要运行的时候通过签名返回的标识符即可。</p>
<p>下面会分别介绍如何应用 Redis 提供的 EVAL、EVALSHA 两个命令来实现对 Lua 脚本的应用，同时介绍一些在 Node.js 中该如何去应用 Redis 的 Lua 脚本。</p>
<h2 id="eval">EVAL</h2>
<p>Redis 2.6.0 版本开始，通过内置的 Lua 解释器，可以使用 EVAL 命令对 Lua 脚本进行求值</p>
<ul>
<li>script：执行的脚本</li>
<li>numkeys：指定键名参数个数</li>
<li>key：键名，可以多个（key1、key2），通过 KEYS[1] KEYS[2] 的形式访问</li>
<li>atg：键值，可以多个（val1、val2），通过 ARGS[1] ARGS[2] 的形式访问</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">EVAL script numkeys key <span style="color:#ce5c00;font-weight:bold">[</span>key ...<span style="color:#ce5c00;font-weight:bold">]</span> arg <span style="color:#ce5c00;font-weight:bold">[</span>arg ...<span style="color:#ce5c00;font-weight:bold">]</span>
</code></pre></div><h3 id="eval-redis-控制台实践">EVAL Redis 控制台实践</h3>
<p>按照上面命令格式，写一个实例如下，通过 KEYS[] 数组的形式访问 ARGV[]，这里下标是以 1 开始，KEYS[1] 对应的键名为 name1，ARGV[2] 对应的值为 val2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">127.0.0.1:6379&gt; EVAL <span style="color:#4e9a06">&#34;return redis.call(&#39;SET&#39;, KEYS[1], ARGV[2])&#34;</span> <span style="color:#0000cf;font-weight:bold">2</span> name1 name2 val1 val2
OK
</code></pre></div><p>执行以上命令，通过 get 查看 name1 对应的值为 val2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">127.0.0.1:6379&gt; get name1
<span style="color:#4e9a06">&#34;val2&#34;</span>
</code></pre></div><p>注意：以上命令如果不使用 return 将会返回 (nil)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">127.0.0.1:6379&gt; EVAL <span style="color:#4e9a06">&#34;redis.call(&#39;SET&#39;, KEYS[1], ARGV[2])&#34;</span> <span style="color:#0000cf;font-weight:bold">2</span> name1 name2 val1 val2
<span style="color:#ce5c00;font-weight:bold">(</span>nil<span style="color:#ce5c00;font-weight:bold">)</span>
</code></pre></div><h3 id="rediscall-vs-redispcall">redis.call VS redis.pcall</h3>
<p>redis.call 和 redis.pcall 是两个不同的 Lua 函数来调用 redis 命令，
两个命令很类似，区别是如果 redis 命令中出现错误异常，
redis.call 会直接返回一个错误信息给调用者，而 redis.pcall 会以 Lua 的形式对错误进行捕获并返回。</p>
<h4 id="使用-rediscall">使用 redis.call</h4>
<p>这里执行了两条 Redis 命令，第一条故意写了一个 SET_ 这是一个错误的命令，
可以看到出错后，错误信息被抛出给了调用者，同时你执行 get name2 会得到 (nil)，第二条命令也没有被执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">127.0.0.1:6379&gt; EVAL <span style="color:#4e9a06">&#34;redis.call(&#39;SET_&#39;, KEYS[1], ARGV[2]); redis.call(&#39;SET&#39;, KEYS[2], ARGV[3])&#34;</span> <span style="color:#0000cf;font-weight:bold">2</span> name1 name2 val1 val2 val3
<span style="color:#ce5c00;font-weight:bold">(</span>error<span style="color:#ce5c00;font-weight:bold">)</span> ERR Error running script <span style="color:#ce5c00;font-weight:bold">(</span>call to f_bf814e38e3d98242ae0c62791fa299f04e757a7d<span style="color:#ce5c00;font-weight:bold">)</span>: @user_script:1: @user_script: 1: Unknown Redis <span style="color:#204a87">command</span> called from Lua script
</code></pre></div><h4 id="使用-redispcall">使用 redis.pcall</h4>
<p>和上面同样的操作，使用 redis.pcall 可以看到输出结果为 (nil) 它的错误被 Lua 捕获了，这时我们在执行 get name2 会得到一个设置好的结果 val3，这里第二条命令是被执行了的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">EVAL <span style="color:#4e9a06">&#34;redis.pcall(&#39;SET_&#39;, KEYS[1], ARGV[2]); redis.pcall(&#39;SET&#39;, KEYS[2], ARGV[3])&#34;</span> <span style="color:#0000cf;font-weight:bold">2</span> name1 name2 val1 val2 val3
<span style="color:#ce5c00;font-weight:bold">(</span>nil<span style="color:#ce5c00;font-weight:bold">)</span>
</code></pre></div><h3 id="eval-在-nodejs-中实现">EVAL 在 Node.js 中实现</h3>
<p>ioredis 支持所有的脚本命令，比如 EVAL、EVALSHA 和 SCRIPT。但是，在现实场景中使用它是很繁琐的，
因为开发人员必须注意脚本缓存，并检测何时使用 EVAL，何时使用 EVALSHA。
ioredis 公开了一个 defineCommand 方法，使脚本更容易使用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">const <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> require<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
const <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> new Redis<span style="color:#ce5c00;font-weight:bold">(</span>6379, <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>

const <span style="color:#000">evalScript</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`</span><span style="color:#204a87;font-weight:bold">return</span> redis.call<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;SET&#39;</span>, KEYS<span style="color:#ce5c00;font-weight:bold">[</span>1<span style="color:#ce5c00;font-weight:bold">]</span>, ARGV<span style="color:#ce5c00;font-weight:bold">[</span>2<span style="color:#ce5c00;font-weight:bold">])</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>

redis.defineCommand<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;evalTest&#34;</span>, <span style="color:#ce5c00;font-weight:bold">{</span>
    numberOfKeys: 2,
    lua: evalScript,
<span style="color:#ce5c00;font-weight:bold">})</span>

async <span style="color:#204a87;font-weight:bold">function</span> eval<span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    await redis.evalTest<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;name1&#39;</span>, <span style="color:#4e9a06">&#39;name2&#39;</span>, <span style="color:#4e9a06">&#39;val1&#39;</span>, <span style="color:#4e9a06">&#39;val2&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
    const <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> await redis.get<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;name1&#39;</span><span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
    console.log<span style="color:#ce5c00;font-weight:bold">(</span>result<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span> // val2
<span style="color:#ce5c00;font-weight:bold">}</span>

eval<span style="color:#ce5c00;font-weight:bold">()</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><h2 id="evalsha">EVALSHA</h2>
<p>EVAL 命令要求你在每次执行脚本的时候都发送一次脚本主体 (script body)。
Redis 有一个内部的缓存机制，因此它不会每次都重新编译脚本，通过 EVALSHA 来实现，根据给定的 SHA1 校验码，对缓存在服务器中的脚本进行求值。
SHA1 怎么生成呢？通过 script 命令，可以对脚本缓存进行操作</p>
<ul>
<li>SCRIPT FLUSH：清除所有脚本缓存</li>
<li>SCRIPT EXISTS：检查指定的脚本是否存在于脚本缓存</li>
<li>SCRIPT LOAD：将一个脚本装入脚本缓存，但并不立即运行它</li>
<li>SCRIPT KILL：杀死当前正在运行的脚本</li>
</ul>
<h4 id="evalsha-命令格式">EVALSHA 命令格式</h4>
<p>同上面 EVAL 不同的是前面 EVAL script 换成了 EVALSHA sha1</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">EVALSHA sha1 numkeys key <span style="color:#ce5c00;font-weight:bold">[</span>key ...<span style="color:#ce5c00;font-weight:bold">]</span> arg <span style="color:#ce5c00;font-weight:bold">[</span>arg ...<span style="color:#ce5c00;font-weight:bold">]</span>
</code></pre></div><h3 id="evalsha-redis-控制台实践">EVALSHA Redis 控制台实践</h3>
<p>载入脚本缓存</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">127.0.0.1:6379&gt; SCRIPT LOAD <span style="color:#4e9a06">&#34;redis.pcall(&#39;SET&#39;, KEYS[1], ARGV[2]);&#34;</span>
<span style="color:#4e9a06">&#34;2a3b189808b36be907e26dab7ddcd8428dcd1bc8&#34;</span>
</code></pre></div><p>以上脚本执行之后会返回一个 SHA-1 签名过后的标识字符串，这个字符串用于下面命令执行签名之后的脚本</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">127.0.0.1:6379&gt; EVALSHA 2a3b189808b36be907e26dab7ddcd8428dcd1bc8 <span style="color:#0000cf;font-weight:bold">2</span> name1 name2 val1 val2
</code></pre></div><p>进行 get 操作读取 name1 的只为 val2</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">127.0.0.1:6379&gt; get name1
<span style="color:#4e9a06">&#34;val2&#34;</span>
</code></pre></div><h3 id="evalsha-在-nodejs-中实现">EVALSHA 在 Node.js 中实现</h3>
<p>分为三步：缓存脚本、执行脚本、获取数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">evalScript</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`return redis.call(&#39;SET&#39;, KEYS[1], ARGV[2])`</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">evalSHA</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// 1. 缓存脚本获取 sha1 值
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sha1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">script</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;load&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">evalScript</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sha1</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// 6bce4ade07396ba3eb2d98e461167563a868c661
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// 2. 通过 evalsha 执行脚本
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">evalsha</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sha1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;name1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;name2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;val1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;val2&#34;</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// 3. 获取数据
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name1&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// &#34;val2&#34;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">evalSHA</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><h2 id="lua-脚本文件">Lua 脚本文件</h2>
<p>有逻辑运算的脚本，可以编写 Lua 脚本文件，编写一些简单的脚本也不难，可以参考这个教程 <a href="https://www.runoob.com/lua/lua-tutorial.html">https://www.runoob.com/lua/lua-tutorial.html</a></p>
<h3 id="lua-文件">Lua 文件</h3>
<p>以下是一个测试代码，通过读取两个值比较返回不同的值，通过 Lua 脚本实现后可以多条 Redis 命令的原子性。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#8f5902;font-style:italic">-- test.lua</span>

<span style="color:#8f5902;font-style:italic">-- 先 SET</span>
<span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SET&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">ARGV</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span>
<span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;SET&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">ARGV</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span>

<span style="color:#8f5902;font-style:italic">-- GET 取值</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">key1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tonumber</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;GET&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]))</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">key2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tonumber</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;GET&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]))</span>

<span style="color:#8f5902;font-style:italic">-- 如果 key1 小于 key2 返回 0</span>
<span style="color:#8f5902;font-style:italic">-- nil 相当于 false</span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">key1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#000">key2</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#000">key1</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">key2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">then</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#204a87;font-weight:bold">else</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span>
<span style="color:#204a87;font-weight:bold">end</span>
</code></pre></div><h3 id="nodejs-中加载-lua-脚本文件">Node.js 中加载 Lua 脚本文件</h3>
<p>和上面 Node.js 中应用 Lua 差别不大，多了一步，通过 fs 模块先读取 Lua 脚本文件，在通过 eval 或者 evalsha 执行。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">fs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fs&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">test</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redisLuaScript</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">readFileSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;./test.lua&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">eval</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redisLuaScript</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;name1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;name2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">eval</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redisLuaScript</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;name1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;name2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result2</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// 1 0
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">test</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div>
</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3218e8af9be10bd2a1e0fbc2c6d4f471">Is Redlock safe?</h1>
	
	<div class="td-byline mb-4">
		
        
		<time datetime="2016-02-10" class="text-muted">Wednesday, February 10, 2016</time>
        
	</div>
	<blockquote>
<p><a href="http://antirez.com/news/101">http://antirez.com/news/101</a></p>
</blockquote>
<p>Martin Kleppmann, a distributed systems researcher, yesterday published an analysis of Redlock (<a href="http://redis.io/topics/distlock),">http://redis.io/topics/distlock),</a> that you can find here: <a href="http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html">http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html</a></p>
<p>Redlock is a client side distributed locking algorithm I designed to be used with Redis, but the algorithm orchestrates, client side, a set of nodes that implement a data store with certain capabilities, in order to create a multi-master fault tolerant, and hopefully safe, distributed lock with auto release capabilities.
You can implement Redlock using MySQL instead of Redis, for example.</p>
<p>The algorithm&rsquo;s goal was to move away people that were using a single Redis instance, or a master-slave setup with failover, in order to implement distributed locks, to something much more reliable and safe, but having a very low complexity and good performance.</p>
<p>Since I published Redlock people implemented it in multiple languages and used it for different purposes.</p>
<p>Martin&rsquo;s analysis of the algorithm concludes that Redlock is not safe. It is great that Martin published an analysis, I asked for an analysis in the original Redlock specification here: <a href="http://redis.io/topics/distlock">http://redis.io/topics/distlock</a>. So thank you Martin. However I don’t agree with the analysis. The good thing is that distributed systems are, unlike other fields of programming, pretty mathematically exact, or they are not, so a given set of properties can be guaranteed by an algorithm or the algorithm may fail to guarantee them under certain assumptions. In this analysis I’ll analyze Martin&rsquo;s analysis so that other experts in the field can check the two documents (the analysis and the counter-analysis), and eventually we can understand if Redlock can be considered safe or not.</p>
<h2 id="why-martin-thinks-redlock-is-unsafe">Why Martin thinks Redlock is unsafe</h2>
<p>The arguments in the analysis are mainly two:</p>
<ol>
<li>
<p>Distributed locks with an auto-release feature (the mutually exclusive lock property is only valid for a fixed amount of time after the lock is acquired) require a way to avoid issues when clients use a lock after the expire time, violating the mutual exclusion while accessing a shared resource. Martin says that Redlock does not have such a mechanism.</p>
</li>
<li>
<p>Martin says the algorithm is, regardless of problem “1”, inherently unsafe since it makes assumptions about the system model that cannot be guaranteed in practical systems.</p>
</li>
</ol>
<p>I’ll address the two concerns separately for clarity, starting with the first “1”.</p>
<h2 id="distributed-locks-auto-release-and-tokens">Distributed locks, auto release, and tokens</h2>
<p>A distributed lock without an auto release mechanism, where the lock owner will hold it indefinitely, is basically useless. If the client holding the lock crashes and does not recover with full state in a short amount of time, a deadlock is created where the shared resource that the distributed lock tried to protect remains forever unaccessible. This creates a liveness issue that is unacceptable in most situations, so a sane distributed lock must be able to auto release itself.</p>
<p>So practical locks are provided to clients with a maximum time to live. After the expire time, the mutual exclusion guarantee, which is the <em>main</em> property of the lock, is gone: another client may already have the lock. What happens if two clients acquire the lock at two different times, but the first one is so slow, because of GC pauses or other scheduling issues, that will try to do work in the context of the shared resource at the same time with second client that acquired the lock?</p>
<p>Martin says that this problem is avoided by having the distributed lock server to provide, with every lock, a token, which is, in his example, just a number that is guaranteed to always increment. The rationale for Martin&rsquo;s usage of a token, is that this way, when two different clients access the locked resource at the same time, we can use the token in the database write transaction (that is assumed to materialize the work the client does): only the client with the greatest lock number will be able to write to the database.</p>
<p>In Martin&rsquo;s words:</p>
<p>“The fix for this problem is actually pretty simple: you need to include a fencing token with every write request to the storage service. In this context, a fencing token is simply a number that increases (e.g. incremented by the lock service) every time a client acquires the lock”</p>
<p>… snip …</p>
<p>“Note this requires the storage server to take an active role in checking tokens, and rejecting any writes on which the token has gone backwards”.</p>
<p>I think this argument has a number of issues:</p>
<ol>
<li>
<p>Most of the times when you need a distributed lock system that can guarantee mutual exclusivity, when this property is violated you already lost. Distributed locks are very useful exactly when we have no other control in the shared resource. In his analysis, Martin assumes that you always have some other way to avoid race conditions when the mutual exclusivity of the lock is violated. I think this is a very strange way to reason about distributed locks with strong guarantees, it is not clear why you would use a lock with strong properties at all if you can resolve races in a different way. Yet I’ll continue with the other points below just for the sake of showing that Redlock can work well in this, very artificial, context.</p>
</li>
<li>
<p>If your data store can always accept the write only if your token is greater than all the past tokens, than it’s a linearizable store. If you have a linearizable store, you can just generate an incremental ID for each Redlock acquired, so this would make Redlock equivalent to another distributed lock system that provides an incremental token ID with every new lock. However in the next point I’ll show how this is not needed.</p>
</li>
<li>
<p>However “2” is not a sensible choice anyway: most of the times the result of working to a shared resource is not writing to a linearizable store, so what to do? Each Redlock is associated with a large random token (which is generated in a way that collisions can be ignored. The Redlock specification assumes textually “20 bytes from /dev/urandom”). What do you do with a unique token? For example you can implement Check and Set. When starting to work with a shared resource, we set its state to “<code>&lt;token&gt;</code>”, then we operate the read-modify-write only if the token is still the same when we write.</p>
</li>
<li>
<p>Note that in certain use cases, one could say, it’s useful anyway to have ordered tokens. While it’s hard to think at an use case, note that for the same GC pauses Martin mentions, the order in which the token was acquired, does not necessarily respects the order in which the clients will attempt to work on the shared resource, so the lock order may not be casually related to the effects of working to a shared resource.</p>
</li>
<li>
<p>Most of the times, locks are used to access resources that are updated in a way that is non transactional. Sometimes we use distributed locks to move physical objects, for example. Or to interact with another external API, and so forth.</p>
</li>
</ol>
<p>I want to mention again that, what is strange about all this, is that it is assumed that you always must have a way to handle the fact that mutual exclusion is violated. Actually if you have such a system to avoid problems during race conditions, you probably don’t need a distributed lock at all, or at least you don’t need a lock with strong guarantees, but just a weak lock to avoid, most of the times, concurrent accesses for performances reasons.</p>
<p>However even if you happen to agree with Martin about the fact the above is very useful, the bottom line is that a unique identifier for each lock can be used for the same goals, but is much more practical in terms of not requiring strong guarantees from the store.</p>
<h2 id="lets-talk-about-system-models">Let’s talk about system models</h2>
<p>The above criticism is basically common to everything which is a distributed lock with auto release, not providing a monotonically increasing counter with each lock. However the other critique of Martin is specific to Redlock. Here Martin really analyzes the algorithm, concluding it is broken.</p>
<p>Redlock assumes a semi synchronous system model where different processes can count time at more or less the same “speed”. The different processes don’t need in any way to have a bound error in the absolute time. What they need to do is just, for example, to be able to count 5 seconds with a maximum of 10% error. So one counts actual 4.5 seconds, another 5.5 seconds, and we are fine.</p>
<p>Martin also states that Redlock requires bound messages maximum delays, which is not correct as far as I can tell (I’ll explain later what’s the problem with his reasoning).</p>
<p>So let’s start with the issue of different processes being unable to count time at the same rate.</p>
<p>Martin says that the clock can randomly jump in a system because of two issues:</p>
<ol>
<li>
<p>The system administrator manually alters the clock.</p>
</li>
<li>
<p>The ntpd daemon changes the clock a lot because it receives an update.</p>
</li>
</ol>
<p>The above two problems can be avoided by “1” not doing this (otherwise even corrupting a Raft log with “echo foo &gt; /my/raft/log.bin” is a problem), and “2” using an ntpd that does not change the time by jumping directly, but by distributing the change over the course of a larger time span.</p>
<p>However I think Martin is right that Redis and Redlock implementations should switch to the monotonic time API provided by most operating systems in order to make the above issues less of a problem. This was proposed several times in the past, adds a bit of complexity inside Redis, but is a good idea: I’ll implement this in the next weeks. However while we’ll switch to monotonic time API, because there are advantages, processes running in an operating system without a software (time server) or human (system administrator) elements altering the clock, <em>can</em> count relative time with a bound error even with gettimeofday().</p>
<p>Note that there are past attempts to implement distributed systems even assuming a bound absolute time error (by using GPS units). Redlock does not require anything like that, just the ability of different processes to count 10 seconds as 9.5 or 11.2 (+/- 2 seconds max in the example), for instance.</p>
<p>So is Redlock safe or not? It depends on the above. Let’s assume we use the monotonically increasing time API, for the sake of simplicity to rule out implementation details (system administrators with a love for POKE and time servers). Can a process count relative time with a fixed percentage of maximum error? I think this is a sounding YES, and is simpler to reply yes to this than to: “can a process write a log without corrupting it”?</p>
<h2 id="network-delays--co">Network delays &amp; co</h2>
<p>Martin says that Redlock does not just depend on the fact that processes can count time at approximately the same time, he says:</p>
<p>“However, Redlock is not like this. Its safety depends on a lot of timing assumptions: it assumes that all Redis nodes hold keys for approximately the right length of time before expiring; that that the network delay is small compared to the expiry duration; and that process pauses are much shorter than the expiry duration.”</p>
<p>So let’s split the above claims into different parts:</p>
<ol>
<li>
<p>Redis nodes hold keys for approximately the right length of time.</p>
</li>
<li>
<p>Network delays are small compared to the expiry duration.</p>
</li>
<li>
<p>Process pauses are much shorter than the expiry duration.</p>
</li>
</ol>
<p>All the time Martin says that “the system clock jumps” I assume that we covered this by not poking with the system time in a way that is a problem for the algorithm, or for the sake of simplicity by using the monotonic time API. So:</p>
<p>About claim 1: This is not an issue, we assumed that we can count time approximately at the same speed, unless there is any actual argument against it.</p>
<p>About claim 2: Things are a bit more complex. Martin says:</p>
<p>“Okay, so maybe you think that a clock jump is unrealistic, because you’re very confident in having correctly configured NTP to only ever slew the clock.” (Yep we agree here ;-) he continues and says…)</p>
<p>“In that case, let’s look at an example of how a process pause may cause the algorithm to fail:
Client 1 requests lock on nodes A, B, C, D, E.
While the responses to client 1 are in flight, client 1 goes into stop-the-world GC.
Locks expire on all Redis nodes.
Client 2 acquires lock on nodes A, B, C, D, E.
Client 1 finishes GC, and receives the responses from Redis nodes indicating that it successfully acquired the lock (they were held in client 1’s kernel network buffers while the process was paused).
Clients 1 and 2 now both believe they hold the lock.”</p>
<p>If you read the Redlock specification, that I hadn&rsquo;t touched for months, you can see the steps to acquire the lock are:</p>
<ol>
<li>
<p>Get the current time.</p>
</li>
<li>
<p>… All the steps needed to acquire the lock …</p>
</li>
<li>
<p>Get the current time, again.</p>
</li>
<li>
<p>Check if we are already out of time, or if we acquired the lock fast enough.</p>
</li>
<li>
<p>Do some work with your lock.</p>
</li>
</ol>
<p>Note steps 1 and 3. Whatever delay happens in the network or in the processes involved, after acquiring the majority we <em>check again</em> that we are not out of time. The delay can only happen after steps 3, resulting into the lock to be considered ok while actually expired, that is, we are back at the first problem Martin identified of distributed locks where the client fails to stop working to the shared resource before the lock validity expires. Let me tell again how this problem is common with <em>all the distributed locks implementations</em>, and how the token as a solution is both unrealistic and can be used with Redlock as well.</p>
<p>Note that whatever happens between 1 and 3, you can add the network delays you want, the lock will always be considered not valid if too much time elapsed, so Redlock looks completely immune from messages that have unbound delays between processes. It was designed with this goal in mind, and I cannot see how the above race condition could happen.</p>
<p>Yet Martin&rsquo;s blog post was also reviewed by multiple DS experts, so I’m not sure if I’m missing something here or simply the way Redlock works was overlooked simultaneously by many. I’ll be happy to receive some clarification about this.</p>
<p>The above also addresses “process pauses” concern number 3. Pauses during the process of acquiring the lock don’t have effects on the algorithm&rsquo;s correctness. They can however, affect the ability of a client to make work within the specified lock time to live, as with any other distributed lock with auto release, as already covered above.</p>
<h2 id="digression-about-network-delays">Digression about network delays</h2>
<p>Just a quick note. In server-side implementations of a distributed lock with auto-release, the client may ask to acquire a lock, the server may allow the client to do so, but the process can stop into a GC pause or the network may be slow or whatever, so the client may receive the &ldquo;OK, the lock is your&rdquo; too late, when the lock is already expired. However you can do a lot to avoid your process sleeping for a long time, and you can&rsquo;t do much to avoid network delays, so the steps to check the time before/after the lock is acquired, to see how much time is left, should actually be common practice even when using other systems implementing locks with an expiry.</p>
<h2 id="fsync-or-not">Fsync or not?</h2>
<p>At some point Martin talks about the fact that Redlock uses delayed restarts of nodes. This requires, again, the ability to be able to wait more or less a specified amount of time, as covered above. Useless to repeat the same things again.</p>
<p>However what is important about this is that, this step is optional. You could configure each Redis node to fsync at every operation, so that when the client receives the reply, it knows the lock was already persisted on disk. This is how most other systems providing strong guarantees work. The very interesting thing about Redlock is that you can opt-out any disk involvement at all by implementing delayed restarts. This means it’s possible to process hundreds of thousands locks per second with a few Redis instances, which is something impossible to obtain with other systems.</p>
<h2 id="gps-units-versus-the-local-computer-clock">GPS units versus the local computer clock</h2>
<p>Returning to the system model, one thing that makes Redlock system model practical is that you can assume a process to never be partitioned with the system clock. Note that this is different compared to other semi synchronous models where GPS units are used, because there are two non obvious partitions that may happen in this case:</p>
<ol>
<li>
<p>The GPS is partitioned away from the GPS network, so it can’t acquire a fix.</p>
</li>
<li>
<p>The process and the GPS are not able to exchange messages or there are delays in the messages exchanged.</p>
</li>
</ol>
<p>The above problems may result into a liveness or safety violation depending on how the system is orchestrated (safety issues only happen if there is a design error, for example if the GPS updates the system time asynchronously so that, when the GPS does not work, the absolute time error may go over the maximum bound).</p>
<p>The Redlock system model does not have these complexities nor requires additional hardware, just the computer clock, and even a very cheap clock with all the obvious biases due to the crystal temperature and other things influencing the precision.</p>
<h2 id="conclusions">Conclusions</h2>
<p>I think Martin has a point about the monotonic API, Redis and Redlock implementations should use it to avoid issues due to the system clock being altered. However I can’t identify other points of the analysis affecting Redlock safety, as explained above, nor do I find his final conclusions that people should not use Redlock when the mutual exclusion guarantee is needed, justified.</p>
<p>It would be great to both receive more feedbacks from experts and to test the algorithm with Jepsen, or similar tools, to accumulate more data.</p>
<p>A big thank you to the friends of mine that helped me to review this post.
blog comments powered by Disqus</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-80decd05ac6a7561ffde230567bbb476">Redis分布式锁</h1>
	
	<div class="td-byline mb-4">
		
        
		<time datetime="2016-02-10" class="text-muted">Wednesday, February 10, 2016</time>
        
	</div>
	<blockquote>
<p><a href="http://redis.io/topics/distlock">http://redis.io/topics/distlock</a></p>
</blockquote>
<p>Distributed locks are a very useful primitive in many environments where different processes must operate with shared resources in a mutually exclusive way.</p>
<p>There are a number of libraries and blog posts describing how to implement a DLM (Distributed Lock Manager) with Redis, but every library uses a different approach, and many use a simple approach with lower guarantees compared to what can be achieved with slightly more complex designs.</p>
<p>This page is an attempt to provide a more canonical algorithm to implement distributed locks with Redis.
We propose an algorithm, called Redlock, which implements a DLM which we believe to be safer than the vanilla single instance approach.
We hope that the community will analyze it, provide feedback, and use it as a starting point for the implementations or more complex or alternative designs.</p>
<h2 id="实现">实现</h2>
<p>Before describing the algorithm, here are a few links to implementations already available that can be used for reference.</p>
<ul>
<li>Redlock-rb (Ruby implementation). There is also a fork of Redlock-rb that adds a gem for easy distribution and perhaps more.</li>
<li>Redlock-py (Python implementation).</li>
<li>Pottery (Python implementation).</li>
<li>Aioredlock (Asyncio Python implementation).</li>
<li>Redlock-php (PHP implementation).</li>
<li>PHPRedisMutex (further PHP implementation)</li>
<li>cheprasov/php-redis-lock (PHP library for locks)</li>
<li>rtckit/react-redlock (Async PHP implementation)</li>
<li>Redsync (Go implementation).</li>
<li>Redisson (Java implementation).</li>
<li>Redis::DistLock (Perl implementation).</li>
<li>Redlock-cpp (C++ implementation).</li>
<li>Redlock-cs (C#/.NET implementation).</li>
<li>RedLock.net (C#/.NET implementation). Includes async and lock extension support.</li>
<li>ScarletLock (C# .NET implementation with configurable datastore)</li>
<li>Redlock4Net (C# .NET implementation)</li>
<li>node-redlock (NodeJS implementation). Includes support for lock extension.</li>
</ul>
<h2 id="安全活力保证">安全、活力保证</h2>
<p>We are going to model our design with just three properties that, from our point of view, are the minimum guarantees needed to use distributed locks in an effective way.</p>
<ul>
<li>Safety property: Mutual exclusion. At any given moment, only one client can hold a lock.</li>
<li>Liveness property A: Deadlock free. Eventually it is always possible to acquire a lock, even if the client that locked a resource crashes or gets partitioned.</li>
<li>Liveness property B: Fault tolerance. As long as the majority of Redis nodes are up, clients are able to acquire and release locks.</li>
</ul>
<h2 id="为什么基于故障转移的实现还不够">为什么基于故障转移的实现还不够</h2>
<p>To understand what we want to improve, let’s analyze the current state of affairs with most Redis-based distributed lock libraries.</p>
<p>The simplest way to use Redis to lock a resource is to create a key in an instance. The key is usually created with a limited time to live, using the Redis expires feature, so that eventually it will get released (property 2 in our list). When the client needs to release the resource, it deletes the key.</p>
<p>Superficially this works well, but there is a problem: this is a single point of failure in our architecture. What happens if the Redis master goes down? Well, let’s add a replica! And use it if the master is unavailable. This is unfortunately not viable. By doing so we can’t implement our safety property of mutual exclusion, because Redis replication is asynchronous.</p>
<p>There is an obvious race condition with this model:</p>
<p>Client A acquires the lock in the master.
The master crashes before the write to the key is transmitted to the replica.
The replica gets promoted to master.
Client B acquires the lock to the same resource A already holds a lock for. SAFETY VIOLATION!
Sometimes it is perfectly fine that under special circumstances, like during a failure, multiple clients can hold the lock at the same time. If this is the case, you can use your replication based solution. Otherwise we suggest to implement the solution described in this document.</p>
<h2 id="使用单个实例的正确实现">使用单个实例的正确实现</h2>
<p>Before trying to overcome the limitation of the single instance setup described above,
let’s check how to do it correctly in this simple case,
since this is actually a viable solution in applications where a race condition from time to time is acceptable,
and because locking into a single instance is the foundation we’ll use for the distributed algorithm described here.</p>
<p>To acquire the lock, the way to go is the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">SET resource_name my_random_value NX PX <span style="color:#0000cf;font-weight:bold">30000</span>
</code></pre></div><p>The command will set the key only if it does not already exist (NX option),
with an expire of 30000 milliseconds (PX option).
The key is set to a value “my_random_value”.
This value must be unique across all clients and all lock requests.</p>
<p>Basically the random value is used in order to release the lock in a safe way,
with a script that tells Redis:
remove the key only if it exists and the value stored at the key is exactly the one I expect to be.
This is accomplished by the following Lua script:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">ARGV</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">then</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;del&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span>
<span style="color:#204a87;font-weight:bold">else</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#204a87;font-weight:bold">end</span>
</code></pre></div><p>This is important in order to avoid removing a lock that was created by another client.
For example a client may acquire the lock, get blocked in some operation for longer than the lock validity time (the time at which the key will expire), and later remove the lock, that was already acquired by some other client. Using just DEL is not safe as a client may remove the lock of another client. With the above script instead every lock is “signed” with a random string, so the lock will be removed only if it is still the one that was set by the client trying to remove it.</p>
<p>What should this random string be? I assume it’s 20 bytes from /dev/urandom, but you can find cheaper ways to make it unique enough for your tasks. For example a safe pick is to seed RC4 with /dev/urandom, and generate a pseudo random stream from that. A simpler solution is to use a combination of unix time with microseconds resolution, concatenating it with a client ID, it is not as safe, but probably up to the task in most environments.</p>
<p>The time we use as the key time to live, is called the “lock validity time”.
It is both the auto release time, and the time the client has in order to perform the operation required before another client may be able to acquire the lock again, without technically violating the mutual exclusion guarantee, which is only limited to a given window of time from the moment the lock is acquired.</p>
<p>So now we have a good way to acquire and release the lock.
The system, reasoning about a non-distributed system composed of a single, always available, instance, is safe.
Let’s extend the concept to a distributed system where we don’t have such guarantees.</p>
<h2 id="redlock-算法">Redlock 算法</h2>
<p>In the distributed version of the algorithm we assume we have N Redis masters.
Those nodes are totally independent, so we don’t use replication or any other implicit coordination system.
We already described how to acquire and release the lock safely in a single instance.
We take for granted that the algorithm will use this method to acquire and release the lock in a single instance.
In our examples we set N=5, which is a reasonable value, so we need to run 5 Redis masters on different computers or virtual machines in order to ensure that they’ll fail in a mostly independent way.</p>
<p>In order to acquire the lock, the client performs the following operations:</p>
<p>It gets the current time in milliseconds.
It tries to acquire the lock in all the N instances sequentially, using the same key name and random value in all the instances. During step 2, when setting the lock in each instance, the client uses a timeout which is small compared to the total lock auto-release time in order to acquire it. For example if the auto-release time is 10 seconds, the timeout could be in the ~ 5-50 milliseconds range. This prevents the client from remaining blocked for a long time trying to talk with a Redis node which is down: if an instance is not available, we should try to talk with the next instance ASAP.
The client computes how much time elapsed in order to acquire the lock, by subtracting from the current time the timestamp obtained in step 1. If and only if the client was able to acquire the lock in the majority of the instances (at least 3), and the total time elapsed to acquire the lock is less than lock validity time, the lock is considered to be acquired.
If the lock was acquired, its validity time is considered to be the initial validity time minus the time elapsed, as computed in step 3.
If the client failed to acquire the lock for some reason (either it was not able to lock N/2+1 instances or the validity time is negative), it will try to unlock all the instances (even the instances it believed it was not able to lock).
Is the algorithm asynchronous?
The algorithm relies on the assumption that while there is no synchronized clock across the processes, still the local time in every process flows approximately at the same rate, with an error which is small compared to the auto-release time of the lock. This assumption closely resembles a real-world computer: every computer has a local clock and we can usually rely on different computers to have a clock drift which is small.</p>
<p>At this point we need to better specify our mutual exclusion rule: it is guaranteed only as long as the client holding the lock will terminate its work within the lock validity time (as obtained in step 3), minus some time (just a few milliseconds in order to compensate for clock drift between processes).</p>
<p>For more information about similar systems requiring a bound clock drift, this paper is an interesting reference: Leases: an efficient fault-tolerant mechanism for distributed file cache consistency.</p>
<h2 id="重试失败">重试失败</h2>
<p>When a client is unable to acquire the lock, it should try again after a random delay in order to try to desynchronize multiple clients trying to acquire the lock for the same resource at the same time (this may result in a split brain condition where nobody wins). Also the faster a client tries to acquire the lock in the majority of Redis instances, the smaller the window for a split brain condition (and the need for a retry), so ideally the client should try to send the SET commands to the N instances at the same time using multiplexing.</p>
<p>It is worth stressing how important it is for clients that fail to acquire the majority of locks, to release the (partially) acquired locks ASAP, so that there is no need to wait for key expiry in order for the lock to be acquired again (however if a network partition happens and the client is no longer able to communicate with the Redis instances, there is an availability penalty to pay as it waits for key expiration).</p>
<h2 id="释放锁">释放锁</h2>
<p>Releasing the lock is simple and involves just releasing the lock in all instances, whether or not the client believes it was able to successfully lock a given instance.</p>
<h2 id="安全参数">安全参数</h2>
<p>Is the algorithm safe? We can try to understand what happens in different scenarios.</p>
<p>To start let’s assume that a client is able to acquire the lock in the majority of instances. All the instances will contain a key with the same time to live. However, the key was set at different times, so the keys will also expire at different times. But if the first key was set at worst at time T1 (the time we sample before contacting the first server) and the last key was set at worst at time T2 (the time we obtained the reply from the last server), we are sure that the first key to expire in the set will exist for at least MIN_VALIDITY=TTL-(T2-T1)-CLOCK_DRIFT. All the other keys will expire later, so we are sure that the keys will be simultaneously set for at least this time.</p>
<p>During the time that the majority of keys are set, another client will not be able to acquire the lock, since N/2+1 SET NX operations can’t succeed if N/2+1 keys already exist. So if a lock was acquired, it is not possible to re-acquire it at the same time (violating the mutual exclusion property).</p>
<p>However we want to also make sure that multiple clients trying to acquire the lock at the same time can’t simultaneously succeed.</p>
<p>If a client locked the majority of instances using a time near, or greater, than the lock maximum validity time (the TTL we use for SET basically), it will consider the lock invalid and will unlock the instances, so we only need to consider the case where a client was able to lock the majority of instances in a time which is less than the validity time. In this case for the argument already expressed above, for MIN_VALIDITY no client should be able to re-acquire the lock. So multiple clients will be able to lock N/2+1 instances at the same time (with &ldquo;time&rdquo; being the end of Step 2) only when the time to lock the majority was greater than the TTL time, making the lock invalid.</p>
<p>Are you able to provide a formal proof of safety, point to existing algorithms that are similar, or find a bug? That would be greatly appreciated.</p>
<h2 id="活性参数">活性参数</h2>
<p>The system liveness is based on three main features:</p>
<p>The auto release of the lock (since keys expire): eventually keys are available again to be locked.
The fact that clients, usually, will cooperate removing the locks when the lock was not acquired, or when the lock was acquired and the work terminated, making it likely that we don’t have to wait for keys to expire to re-acquire the lock.
The fact that when a client needs to retry a lock, it waits a time which is comparably greater than the time needed to acquire the majority of locks, in order to probabilistically make split brain conditions during resource contention unlikely.
However, we pay an availability penalty equal to TTL time on network partitions, so if there are continuous partitions, we can pay this penalty indefinitely. This happens every time a client acquires a lock and gets partitioned away before being able to remove the lock.</p>
<p>Basically if there are infinite continuous network partitions, the system may become not available for an infinite amount of time.</p>
<h2 id="性能崩溃恢复和-fsync">性能，崩溃恢复和 fsync</h2>
<p>Many users using Redis as a lock server need high performance in terms of both latency to acquire and release a lock, and number of acquire / release operations that it is possible to perform per second. In order to meet this requirement, the strategy to talk with the N Redis servers to reduce latency is definitely multiplexing (or poor man&rsquo;s multiplexing, which is, putting the socket in non-blocking mode, send all the commands, and read all the commands later, assuming that the RTT between the client and each instance is similar).</p>
<p>However there is another consideration to do about persistence if we want to target a crash-recovery system model.</p>
<p>Basically to see the problem here, let’s assume we configure Redis without persistence at all. A client acquires the lock in 3 of 5 instances. One of the instances where the client was able to acquire the lock is restarted, at this point there are again 3 instances that we can lock for the same resource, and another client can lock it again, violating the safety property of exclusivity of lock.</p>
<p>If we enable AOF persistence, things will improve quite a bit. For example we can upgrade a server by sending SHUTDOWN and restarting it. Because Redis expires are semantically implemented so that virtually the time still elapses when the server is off, all our requirements are fine. However everything is fine as long as it is a clean shutdown. What about a power outage? If Redis is configured, as by default, to fsync on disk every second, it is possible that after a restart our key is missing. In theory, if we want to guarantee the lock safety in the face of any kind of instance restart, we need to enable fsync=always in the persistence setting. This in turn will totally ruin performances to the same level of CP systems that are traditionally used to implement distributed locks in a safe way.</p>
<p>However things are better than what they look like at a first glance. Basically the algorithm safety is retained as long as when an instance restarts after a crash, it no longer participates to any currently active lock, so that the set of currently active locks when the instance restarts, were all obtained by locking instances other than the one which is rejoining the system.</p>
<p>To guarantee this we just need to make an instance, after a crash, unavailable for at least a bit more than the max TTL we use, which is, the time needed for all the keys about the locks that existed when the instance crashed, to become invalid and be automatically released.</p>
<p>Using delayed restarts it is basically possible to achieve safety even without any kind of Redis persistence available, however note that this may translate into an availability penalty. For example if a majority of instances crash, the system will become globally unavailable for TTL (here globally means that no resource at all will be lockable during this time).</p>
<h2 id="使算法更可靠扩展锁">使算法更可靠:扩展锁</h2>
<p>If the work performed by clients is composed of small steps, it is possible to use smaller lock validity times by default, and extend the algorithm implementing a lock extension mechanism. Basically the client, if in the middle of the computation while the lock validity is approaching a low value, may extend the lock by sending a Lua script to all the instances that extends the TTL of the key if the key exists and its value is still the random value the client assigned when the lock was acquired.</p>
<p>The client should only consider the lock re-acquired if it was able to extend the lock into the majority of instances, and within the validity time (basically the algorithm to use is very similar to the one used when acquiring the lock).</p>
<p>However this does not technically change the algorithm, so the maximum number of lock reacquisition attempts should be limited, otherwise one of the liveness properties is violated.</p>
<h2 id="想要帮助吗">想要帮助吗?</h2>
<p>If you are into distributed systems, it would be great to have your opinion / analysis.
Also reference implementations in other languages could be great.</p>
<p>Thanks in advance!</p>
<h2 id="分析-redlock">分析 Redlock</h2>
<p>Martin Kleppmann analyzed Redlock <a href="is_redlock_safe">here</a>. I disagree with the analysis and posted my reply to his analysis <a href="">here</a>.</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-08987c3452bb171ec540aa27032e730c">How to do distributed locking</h1>
	
	<div class="td-byline mb-4">
		By <b>Kleppmann</b> |
        
		<time datetime="2016-02-08" class="text-muted">Monday, February 08, 2016</time>
        
	</div>
	<blockquote>
<p><a href="https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html">https://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html</a></p>
</blockquote>
<blockquote>
<p><a href="https://martin.kleppmann.com/">https://martin.kleppmann.com/</a></p>
</blockquote>
<p>As part of the research for my book, I came across an algorithm called Redlock on the Redis website.
The algorithm claims to implement fault-tolerant distributed locks (or rather, leases [1]) on top of Redis, and the page asks for feedback from people who are into distributed systems.
The algorithm instinctively set off some alarm bells in the back of my mind, so I spent a bit of time thinking about it and writing up these notes.</p>
<p>Since there are already over 10 independent implementations of Redlock and we don’t know who is already relying on this algorithm,
I thought it would be worth sharing my notes publicly.
I won’t go into other aspects of Redis, some of which have already been critiqued elsewhere.</p>
<p>Before I go into the details of Redlock, let me say that I quite like Redis, and I have successfully used it in production in the past.
I think it’s a good fit in situations where you want to share some transient, approximate, fast-changing data between servers,
and where it’s not a big deal if you occasionally lose that data for whatever reason. For example,
a good use case is maintaining request counters per IP address (for rate limiting purposes) and sets of distinct IP addresses per user ID (for abuse detection).</p>
<p>However, Redis has been gradually making inroads into areas of data management where there are stronger consistency and durability expectations – which worries me, because this is not what Redis is designed for.
Arguably, distributed locking is one of those areas. Let’s examine it in some more detail.</p>
<h2 id="what-are-you-using-that-lock-for">What are you using that lock for?</h2>
<p>The purpose of a lock is to ensure that among several nodes that might try to do the same piece of work, only one actually does it (at least only one at a time).
That work might be to write some data to a shared storage system, to perform some computation, to call some external API, or suchlike. At a high level, there are two reasons why you might want a lock in a distributed application: for efficiency or for correctness [2]. To distinguish these cases, you can ask what would happen if the lock failed:</p>
<p>Efficiency: Taking a lock saves you from unnecessarily doing the same work twice (e.g. some expensive computation). If the lock fails and two nodes end up doing the same piece of work, the result is a minor increase in cost (you end up paying 5 cents more to AWS than you otherwise would have) or a minor inconvenience (e.g. a user ends up getting the same email notification twice).
Correctness: Taking a lock prevents concurrent processes from stepping on each others’ toes and messing up the state of your system. If the lock fails and two nodes concurrently work on the same piece of data, the result is a corrupted file, data loss, permanent inconsistency, the wrong dose of a drug administered to a patient, or some other serious problem.
Both are valid cases for wanting a lock, but you need to be very clear about which one of the two you are dealing with.</p>
<p>I will argue that if you are using locks merely for efficiency purposes, it is unnecessary to incur the cost and complexity of Redlock, running 5 Redis servers and checking for a majority to acquire your lock. You are better off just using a single Redis instance, perhaps with asynchronous replication to a secondary instance in case the primary crashes.</p>
<p>If you use a single Redis instance, of course you will drop some locks if the power suddenly goes out on your Redis node, or something else goes wrong. But if you’re only using the locks as an efficiency optimization, and the crashes don’t happen too often, that’s no big deal. This “no big deal” scenario is where Redis shines. At least if you’re relying on a single Redis instance, it is clear to everyone who looks at the system that the locks are approximate, and only to be used for non-critical purposes.</p>
<p>On the other hand, the Redlock algorithm, with its 5 replicas and majority voting, looks at first glance as though it is suitable for situations in which your locking is important for correctness. I will argue in the following sections that it is not suitable for that purpose. For the rest of this article we will assume that your locks are important for correctness, and that it is a serious bug if two different nodes concurrently believe that they are holding the same lock.</p>
<h2 id="protecting-a-resource-with-a-lock">Protecting a resource with a lock</h2>
<p>Let’s leave the particulars of Redlock aside for a moment, and discuss how a distributed lock is used in general (independent of the particular locking algorithm used). It’s important to remember that a lock in a distributed system is not like a mutex in a multi-threaded application. It’s a more complicated beast, due to the problem that different nodes and the network can all fail independently in various ways.</p>
<p>For example, say you have an application in which a client needs to update a file in shared storage (e.g. HDFS or S3). A client first acquires the lock, then reads the file, makes some changes, writes the modified file back, and finally releases the lock. The lock prevents two clients from performing this read-modify-write cycle concurrently, which would result in lost updates. The code might look something like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// THIS CODE IS BROKEN
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">writeData</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">lock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lockService</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">acquireLock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#4e9a06">&#34;Failed to acquire lock&#34;</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">readFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">updated</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">updateContents</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">file</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">storage</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">writeFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filename</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">updated</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">release</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Unfortunately, even if you have a perfect lock service, the code above is broken. The following diagram shows how you can end up with corrupted data:</p>
<p>Unsafe access to a resource protected by a distributed lock</p>
<p>In this example, the client that acquired the lock is paused for an extended period of time while holding the lock – for example because the garbage collector (GC) kicked in. The lock has a timeout (i.e. it is a lease), which is always a good idea (otherwise a crashed client could end up holding a lock forever and never releasing it). However, if the GC pause lasts longer than the lease expiry period, and the client doesn’t realise that it has expired, it may go ahead and make some unsafe change.</p>
<p>This bug is not theoretical: HBase used to have this problem [3,4]. Normally, GC pauses are quite short, but “stop-the-world” GC pauses have sometimes been known to last for several minutes [5] – certainly long enough for a lease to expire. Even so-called “concurrent” garbage collectors like the HotSpot JVM’s CMS cannot fully run in parallel with the application code – even they need to stop the world from time to time [6].</p>
<p>You cannot fix this problem by inserting a check on the lock expiry just before writing back to storage. Remember that GC can pause a running thread at any point, including the point that is maximally inconvenient for you (between the last check and the write operation).</p>
<p>And if you’re feeling smug because your programming language runtime doesn’t have long GC pauses, there are many other reasons why your process might get paused. Maybe your process tried to read an address that is not yet loaded into memory, so it gets a page fault and is paused until the page is loaded from disk. Maybe your disk is actually EBS, and so reading a variable unwittingly turned into a synchronous network request over Amazon’s congested network. Maybe there are many other processes contending for CPU, and you hit a black node in your scheduler tree. Maybe someone accidentally sent SIGSTOP to the process. Whatever. Your processes will get paused.</p>
<p>If you still don’t believe me about process pauses, then consider instead that the file-writing request may get delayed in the network before reaching the storage service. Packet networks such as Ethernet and IP may delay packets arbitrarily, and they do [7]: in a famous incident at GitHub, packets were delayed in the network for approximately 90 seconds [8]. This means that an application process may send a write request, and it may reach the storage server a minute later when the lease has already expired.</p>
<p>Even in well-managed networks, this kind of thing can happen. You simply cannot make any assumptions about timing, which is why the code above is fundamentally unsafe, no matter what lock service you use.</p>
<h2 id="making-the-lock-safe-with-fencing">Making the lock safe with fencing</h2>
<p>The fix for this problem is actually pretty simple: you need to include a fencing token with every write request to the storage service. In this context, a fencing token is simply a number that increases (e.g. incremented by the lock service) every time a client acquires the lock. This is illustrated in the following diagram:</p>
<p>Using fencing tokens to make resource access safe</p>
<p>Client 1 acquires the lease and gets a token of 33, but then it goes into a long pause and the lease expires. Client 2 acquires the lease, gets a token of 34 (the number always increases), and then sends its write to the storage service, including the token of 34. Later, client 1 comes back to life and sends its write to the storage service, including its token value 33. However, the storage server remembers that it has already processed a write with a higher token number (34), and so it rejects the request with token 33.</p>
<p>Note this requires the storage server to take an active role in checking tokens, and rejecting any writes on which the token has gone backwards. But this is not particularly hard, once you know the trick. And provided that the lock service generates strictly monotonically increasing tokens, this makes the lock safe. For example, if you are using ZooKeeper as lock service, you can use the zxid or the znode version number as fencing token, and you’re in good shape [3].</p>
<p>However, this leads us to the first big problem with Redlock: it does not have any facility for generating fencing tokens. The algorithm does not produce any number that is guaranteed to increase every time a client acquires a lock. This means that even if the algorithm were otherwise perfect, it would not be safe to use, because you cannot prevent the race condition between clients in the case where one client is paused or its packets are delayed.</p>
<p>And it’s not obvious to me how one would change the Redlock algorithm to start generating fencing tokens. The unique random value it uses does not provide the required monotonicity. Simply keeping a counter on one Redis node would not be sufficient, because that node may fail. Keeping counters on several nodes would mean they would go out of sync. It’s likely that you would need a consensus algorithm just to generate the fencing tokens. (If only incrementing a counter was simple.)</p>
<p>Using time to solve consensus
The fact that Redlock fails to generate fencing tokens should already be sufficient reason not to use it in situations where correctness depends on the lock. But there are some further problems that are worth discussing.</p>
<p>In the academic literature, the most practical system model for this kind of algorithm is the asynchronous model with unreliable failure detectors [9]. In plain English, this means that the algorithms make no assumptions about timing: processes may pause for arbitrary lengths of time, packets may be arbitrarily delayed in the network, and clocks may be arbitrarily wrong – and the algorithm is nevertheless expected to do the right thing. Given what we discussed above, these are very reasonable assumptions.</p>
<p>The only purpose for which algorithms may use clocks is to generate timeouts, to avoid waiting forever if a node is down. But timeouts do not have to be accurate: just because a request times out, that doesn’t mean that the other node is definitely down – it could just as well be that there is a large delay in the network, or that your local clock is wrong. When used as a failure detector, timeouts are just a guess that something is wrong. (If they could, distributed algorithms would do without clocks entirely, but then consensus becomes impossible [10]. Acquiring a lock is like a compare-and-set operation, which requires consensus [11].)</p>
<p>Note that Redis uses gettimeofday, not a monotonic clock, to determine the expiry of keys. The man page for gettimeofday explicitly says that the time it returns is subject to discontinuous jumps in system time – that is, it might suddenly jump forwards by a few minutes, or even jump back in time (e.g. if the clock is stepped by NTP because it differs from a NTP server by too much, or if the clock is manually adjusted by an administrator). Thus, if the system clock is doing weird things, it could easily happen that the expiry of a key in Redis is much faster or much slower than expected.</p>
<p>For algorithms in the asynchronous model this is not a big problem: these algorithms generally ensure that their safety properties always hold, without making any timing assumptions [12]. Only liveness properties depend on timeouts or some other failure detector. In plain English, this means that even if the timings in the system are all over the place (processes pausing, networks delaying, clocks jumping forwards and backwards), the performance of an algorithm might go to hell, but the algorithm will never make an incorrect decision.</p>
<p>However, Redlock is not like this. Its safety depends on a lot of timing assumptions: it assumes that all Redis nodes hold keys for approximately the right length of time before expiring; that the network delay is small compared to the expiry duration; and that process pauses are much shorter than the expiry duration.</p>
<h2 id="breaking-redlock-with-bad-timings">Breaking Redlock with bad timings</h2>
<p>Let’s look at some examples to demonstrate Redlock’s reliance on timing assumptions. Say the system has five Redis nodes (A, B, C, D and E), and two clients (1 and 2). What happens if a clock on one of the Redis nodes jumps forward?</p>
<p>Client 1 acquires lock on nodes A, B, C. Due to a network issue, D and E cannot be reached.
The clock on node C jumps forward, causing the lock to expire.
Client 2 acquires lock on nodes C, D, E. Due to a network issue, A and B cannot be reached.
Clients 1 and 2 now both believe they hold the lock.
A similar issue could happen if C crashes before persisting the lock to disk, and immediately restarts. For this reason, the Redlock documentation recommends delaying restarts of crashed nodes for at least the time-to-live of the longest-lived lock. But this restart delay again relies on a reasonably accurate measurement of time, and would fail if the clock jumps.</p>
<p>Okay, so maybe you think that a clock jump is unrealistic, because you’re very confident in having correctly configured NTP to only ever slew the clock. In that case, let’s look at an example of how a process pause may cause the algorithm to fail:</p>
<p>Client 1 requests lock on nodes A, B, C, D, E.
While the responses to client 1 are in flight, client 1 goes into stop-the-world GC.
Locks expire on all Redis nodes.
Client 2 acquires lock on nodes A, B, C, D, E.
Client 1 finishes GC, and receives the responses from Redis nodes indicating that it successfully acquired the lock (they were held in client 1’s kernel network buffers while the process was paused).
Clients 1 and 2 now both believe they hold the lock.
Note that even though Redis is written in C, and thus doesn’t have GC, that doesn’t help us here: any system in which the clients may experience a GC pause has this problem. You can only make this safe by preventing client 1 from performing any operations under the lock after client 2 has acquired the lock, for example using the fencing approach above.</p>
<p>A long network delay can produce the same effect as the process pause. It perhaps depends on your TCP user timeout – if you make the timeout significantly shorter than the Redis TTL, perhaps the delayed network packets would be ignored, but we’d have to look in detail at the TCP implementation to be sure. Also, with the timeout we’re back down to accuracy of time measurement again!</p>
<h2 id="the-synchrony-assumptions-of-redlock">The synchrony assumptions of Redlock</h2>
<p>These examples show that Redlock works correctly only if you assume a synchronous system model – that is, a system with the following properties:</p>
<p>bounded network delay (you can guarantee that packets always arrive within some guaranteed maximum delay),
bounded process pauses (in other words, hard real-time constraints, which you typically only find in car airbag systems and suchlike), and
bounded clock error (cross your fingers that you don’t get your time from a bad NTP server).
Note that a synchronous model does not mean exactly synchronised clocks: it means you are assuming a known, fixed upper bound on network delay, pauses and clock drift [12]. Redlock assumes that delays, pauses and drift are all small relative to the time-to-live of a lock; if the timing issues become as large as the time-to-live, the algorithm fails.</p>
<p>In a reasonably well-behaved datacenter environment, the timing assumptions will be satisfied most of the time – this is known as a partially synchronous system [12]. But is that good enough? As soon as those timing assumptions are broken, Redlock may violate its safety properties, e.g. granting a lease to one client before another has expired. If you’re depending on your lock for correctness, “most of the time” is not enough – you need it to always be correct.</p>
<p>There is plenty of evidence that it is not safe to assume a synchronous system model for most practical system environments [7,8]. Keep reminding yourself of the GitHub incident with the 90-second packet delay. It is unlikely that Redlock would survive a Jepsen test.</p>
<p>On the other hand, a consensus algorithm designed for a partially synchronous system model (or asynchronous model with failure detector) actually has a chance of working. Raft, Viewstamped Replication, Zab and Paxos all fall in this category. Such an algorithm must let go of all timing assumptions. That’s hard: it’s so tempting to assume networks, processes and clocks are more reliable than they really are. But in the messy reality of distributed systems, you have to be very careful with your assumptions.</p>
<h2 id="conclusion">Conclusion</h2>
<p>I think the Redlock algorithm is a poor choice because it is “neither fish nor fowl”: it is unnecessarily heavyweight and expensive for efficiency-optimization locks, but it is not sufficiently safe for situations in which correctness depends on the lock.</p>
<p>In particular, the algorithm makes dangerous assumptions about timing and system clocks (essentially assuming a synchronous system with bounded network delay and bounded execution time for operations), and it violates safety properties if those assumptions are not met. Moreover, it lacks a facility for generating fencing tokens (which protect a system against long delays in the network or in paused processes).</p>
<p>If you need locks only on a best-effort basis (as an efficiency optimization, not for correctness), I would recommend sticking with the straightforward single-node locking algorithm for Redis (conditional set-if-not-exists to obtain a lock, atomic delete-if-value-matches to release a lock), and documenting very clearly in your code that the locks are only approximate and may occasionally fail. Don’t bother with setting up a cluster of five Redis nodes.</p>
<p>On the other hand, if you need locks for correctness, please don’t use Redlock. Instead, please use a proper consensus system such as ZooKeeper, probably via one of the Curator recipes that implements a lock. (At the very least, use a database with reasonable transactional guarantees.) And please enforce use of fencing tokens on all resource accesses under the lock.</p>
<p>As I said at the beginning, Redis is an excellent tool if you use it correctly. None of the above diminishes the usefulness of Redis for its intended purposes. Salvatore has been very dedicated to the project for years, and its success is well deserved. But every tool has limitations, and it is important to know them and to plan accordingly.</p>
<p>If you want to learn more, I explain this topic in greater detail in chapters 8 and 9 of my book, now available in Early Release from O’Reilly. (The diagrams above are taken from my book.) For learning how to use ZooKeeper, I recommend Junqueira and Reed’s book [3]. For a good introduction to the theory of distributed systems, I recommend Cachin, Guerraoui and Rodrigues’ textbook [13].</p>
<p>Thank you to Kyle Kingsbury, Camille Fournier, Flavio Junqueira, and Salvatore Sanfilippo for reviewing a draft of this article. Any errors are mine, of course.</p>
<p>Update 9 Feb 2016: Salvatore, the original author of Redlock, has posted a rebuttal to this article (see also HN discussion). He makes some good points, but I stand by my conclusions. I may elaborate in a follow-up post if I have time, but please form your own opinions – and please consult the references below, many of which have received rigorous academic peer review (unlike either of our blog posts).</p>
<h2 id="references">References</h2>
<ul>
<li>[1] Cary G Gray and David R Cheriton: “Leases: An Efficient Fault-Tolerant Mechanism for Distributed File Cache Consistency,” at 12th ACM Symposium on Operating Systems Principles (SOSP), December 1989. doi:10.1145/74850.74870</li>
<li>[2] Mike Burrows: “The Chubby lock service for loosely-coupled distributed systems,” at 7th USENIX Symposium on Operating System Design and Implementation (OSDI), November 2006.</li>
<li>[3] Flavio P Junqueira and Benjamin Reed: ZooKeeper: Distributed Process Coordination. O’Reilly Media, November 2013. ISBN: 978-1-4493-6130-3</li>
<li>[4] Enis Söztutar: “HBase and HDFS: Understanding filesystem usage in HBase,” at HBaseCon, June 2013.</li>
<li>[5] Todd Lipcon: “Avoiding Full GCs in Apache HBase with MemStore-Local Allocation Buffers: Part 1,” blog.cloudera.com, 24 February 2011.</li>
<li>[6] Martin Thompson: “Java Garbage Collection Distilled,” mechanical-sympathy.blogspot.co.uk, 16 July 2013.</li>
<li>[7] Peter Bailis and Kyle Kingsbury: “The Network is Reliable,” ACM Queue, volume 12, number 7, July 2014. doi:10.1145/2639988.2639988</li>
<li>[8] Mark Imbriaco: “Downtime last Saturday,” github.com, 26 December 2012.</li>
<li>[9] Tushar Deepak Chandra and Sam Toueg: “Unreliable Failure Detectors for Reliable Distributed Systems,” Journal of the ACM, volume 43, number 2, pages 225–267, March 1996. doi:10.1145/226643.226647</li>
<li>[10] Michael J Fischer, Nancy Lynch, and Michael S Paterson: “Impossibility of Distributed Consensus with One Faulty Process,” Journal of the ACM, volume 32, number 2, pages 374–382, April 1985. doi:10.1145/3149.214121</li>
<li>[11] Maurice P Herlihy: “Wait-Free Synchronization,” ACM Transactions on Programming Languages and Systems, volume 13, number 1, pages 124–149, January 1991. doi:10.1145/114005.102808</li>
<li>[12] Cynthia Dwork, Nancy Lynch, and Larry Stockmeyer: “Consensus in the Presence of Partial Synchrony,” Journal of the ACM, volume 35, number 2, pages 288–323, April 1988. doi:10.1145/42282.42283</li>
<li>[13] Christian Cachin, Rachid Guerraoui, and Luís Rodrigues: Introduction to Reliable and Secure Distributed Programming, Second Edition. Springer, February 2011. ISBN: 978-3-642-15259-7, doi:10.1007/978-3-642-15260-3</li>
</ul>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-d22409d1f210a88ff6e44c86088bbcee">Redis&#43;Lua 解决高并发场景抢购秒杀问题</h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	<blockquote>
<p><a href="https://www.cnblogs.com/itbsl/p/15021263.html">https://www.cnblogs.com/itbsl/p/15021263.html</a></p>
</blockquote>
<p>之前写了一篇 PHP+Redis 链表解决高并发下商品超卖问题，今天介绍一些如何使用 PHP+Redis+Lua 解决高并发下商品超卖问题。</p>
<h2 id="为何要使用-lua-脚本解决商品超卖的问题呢">为何要使用 Lua 脚本解决商品超卖的问题呢？</h2>
<p>Redis 在 2.6 版本后原生支持 Lua 脚本功能，允许开发者使用 Lua 语言编写脚本传到 Redis 中执行。</p>
<p>将复杂的或者多步的 redis 操作，写为一个脚本，一次提交给 redis 执行，减少反复连接 redis 的次数，提升性能。</p>
<p>原子操作。Redis 会将整个脚本作为一个整体执行，中间不会被其他请求插入。因此在脚本运行过程中无需担心会出现竞态条件，无需使用事务。</p>
<p>复用客户端发送的脚本会永久存在 redis 中，这样其他客户端可以复用这一脚本，而不需要使用代码完成相同的逻辑。</p>
<h2 id="编写脚本">编写脚本</h2>
<h3 id="首先编写-lua-脚本脚本名为-seckilllua">首先，编写 lua 脚本，脚本名为 secKill.lua：</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#8f5902;font-style:italic">-- 接收参数</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">user_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">goods_id</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span>

<span style="color:#8f5902;font-style:italic">-- 拼接字符串</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">stock_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;secKill:&#34;</span><span style="color:#ce5c00;font-weight:bold">..</span><span style="color:#000">goods_id</span><span style="color:#ce5c00;font-weight:bold">..</span><span style="color:#4e9a06">&#34;:stock&#34;</span> <span style="color:#8f5902;font-style:italic">-- 秒杀商品库存 key</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">users_key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;secKill:&#34;</span><span style="color:#ce5c00;font-weight:bold">..</span><span style="color:#000">goods_id</span><span style="color:#ce5c00;font-weight:bold">..</span><span style="color:#4e9a06">&#34;:users&#34;</span> <span style="color:#8f5902;font-style:italic">-- 成功秒杀商品的用户集合 key</span>

<span style="color:#8f5902;font-style:italic">-- 判断用户是否已经成功秒杀过该商品，如果已经存在在集合中，说明已经成功秒杀该商品，直接返回标志 2，防止重复抢购</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">user_exists</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;sismember&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">users_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user_id</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tonumber</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">user_exists</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">then</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">2</span>
<span style="color:#204a87;font-weight:bold">end</span>

<span style="color:#8f5902;font-style:italic">-- 获取当前商品库存，如果库存小于等于 0，表名商品已经被抢购完了，否则库存-1，并将抢购成功的用户放入集合中</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">left_goods_count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;get&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stock_key</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tonumber</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">left_goods_count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#204a87;font-weight:bold">then</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#204a87;font-weight:bold">else</span>
    <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;decr&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stock_key</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;sadd&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">users_key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user_id</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">end</span>
<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span>
</code></pre></div><p>上述代码中返回的数字 0，1，2 只是一种约定，自己可以根据自己的有业务约定不同状态返回的值。示例代码 0：库存为 0，1：秒杀成功，2：已秒杀成功的用户重复抢购。</p>
<h3 id="lua-脚本编写完成后使用-redis-cli-命令生成该脚本的-sha-秘钥">lua 脚本编写完成后，使用 redis-cli 命令生成该脚本的 sha 秘钥</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">redis-cli script load <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>cat /usr/local/redis/lua/secKill.lua<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>
<span style="color:#4e9a06">&#34;63454a53284d9f6b30bdb6e5e12796a74f61f718&#34;</span>
</code></pre></div><h3 id="最后拿到-lua-脚本的-sha-秘钥我们就可以在我们的代码中使用了">最后，拿到 lua 脚本的 sha 秘钥，我们就可以在我们的代码中使用了。</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#000">$redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> new Redis<span style="color:#ce5c00;font-weight:bold">()</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">$redis</span>-&gt;connect<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;192.168.111.128&#34;</span>, 6379<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">$goodsId</span> <span style="color:#ce5c00;font-weight:bold">=</span> 11211<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">$userId</span> <span style="color:#ce5c00;font-weight:bold">=</span> mt_rand<span style="color:#ce5c00;font-weight:bold">(</span>10000, 99999<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">$res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">$redis</span>-&gt;evalSha<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#39;63454a53284d9f6b30bdb6e5e12796a74f61f718&#39;</span>, <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">$userId</span>, <span style="color:#000">$goodsId</span><span style="color:#ce5c00;font-weight:bold">]</span>, 2<span style="color:#ce5c00;font-weight:bold">)</span><span style="color:#000;font-weight:bold">;</span>
</code></pre></div><p>可以看到，我们将抢购逻辑写到 lua 脚本后，PHP 代码就变得很少了，仅仅只有 5 行代码。</p>
<h2 id="测试">测试</h2>
<p>编写好代码，接着我们开始对上述代码进行测试。</p>
<p>首先，我们需要设置商品的库存量，正常逻辑是在后台商品管理页填写具体商品的库存量，
此处假设我们的商品 ID 是 11211，商品数量为 10 个。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#000">$redis</span>-cli
&gt; <span style="color:#204a87">set</span> secKill:11211:stock <span style="color:#0000cf;font-weight:bold">10</span>
</code></pre></div><p>我们使用 ab 压测工具模拟 2000 个用户并发量 200 来模拟抢购商品 ID 为 11211 的商品。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">$ ab -n <span style="color:#0000cf;font-weight:bold">2000</span> -c <span style="color:#0000cf;font-weight:bold">200</span> http://www.master.com/index.php
</code></pre></div><p>如果没有 ab 工具需要使用 <code>yum -y install httpd-tools</code> 安装</p>
<p>压测完成后，我们通过 <code>RedisDesktopManager(RDM)</code> 软件来查看抢购结果，
可以看到即使是 200 的并发量，最终也只有 10 个用户抢购到商品，并且抢购成功的用户被写入到了 secKill:11211:users 的集合中，
我们可以另外开一个守护进程专门用于从集合中获取用户 ID 处理后续事宜(将数据落盘写入数据库、给用户发短信等)</p>
<p>使用 Redis+Lua 来解决抢购秒杀类问题是当前比较流行的一种做法，希望对正在开发秒杀抢购功能的你能产生帮助。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-9e637ce30dc1691a4b87ba0237805379">Redis分布式锁</h1>
	
	<div class="td-byline mb-4">
		By <b>donlianli  翻译</b> |
        
	</div>
	<blockquote>
<p><a href="http://www.redis.cn/topics/distlock.html">http://www.redis.cn/topics/distlock.html</a></p>
</blockquote>
<p>分布式锁在很多场景中是非常有用的原语， 不同的进程必须以独占资源的方式实现资源共享就是一个典型的例子。</p>
<p>有很多分布式锁的库和描述怎么实现分布式锁管理器（DLM)的博客,但是每个库的实现方式都不太一样，很多库的实现方式为了简单降低了可靠性，而有的使用了稍微复杂的设计。</p>
<p>这个页面试图提供一个使用 Redis 实现分布式锁的规范算法。我们提出一种算法，叫 Redlock,我们认为这种实现比普通的单实例实现更安全,我们希望 redis 社区能帮助分析一下这种实现方法，并给我们提供反馈。</p>
<h2 id="实现细节">实现细节</h2>
<p>在我们开始描述算法之前，我们已经有一些可供参考的实现库.</p>
<ul>
<li>Redlock-rb (Ruby 版). There is also a fork of Redlock-rb that adds a gem for easy distribution and perhaps more.</li>
<li>Redlock-py (Python 版).</li>
<li>Aioredlock (Asyncio Python 版).</li>
<li>Redlock-php (PHP 版).</li>
<li>PHPRedisMutex (further PHP 版)</li>
<li>cheprasov/php-redis-lock (PHP library for locks)</li>
<li>Redsync.go (Go 版).</li>
<li>Redisson (Java 版).</li>
<li>Redis-DistLock (Perl 版).</li>
<li>Redlock-cpp (C++ 版).</li>
<li>Redlock-cs (C#/.NET 版).</li>
<li>RedLock.net (C#/.NET 版). Includes async and lock extension support.</li>
<li>ScarletLock (C# .NET 版 with configurable datastore)</li>
<li>node-redlock (NodeJS 版). Includes support for lock extension.</li>
</ul>
<h2 id="安全和活性失效保障">安全和活性失效保障</h2>
<p>按照我们的思路和设计方案，算法只需具备 3 个特性就可以实现一个最低保障的分布式锁。</p>
<ol>
<li>安全属性（Safety property）: 独享（相互排斥）。在任意一个时刻，只有一个客户端持有锁。</li>
<li>活性 A(Liveness property A): 无死锁。即便持有锁的客户端崩溃（crashed)或者网络被分裂（gets partitioned)，锁仍然可以被获取。</li>
<li>活性 B(Liveness property B): 容错。 只要大部分 Redis 节点都活着，客户端就可以获取和释放锁.</li>
</ol>
<h2 id="为什么基于故障转移的实现还不够">为什么基于故障转移的实现还不够</h2>
<p>为了更好的理解我们想要改进的方面，我们先分析一下当前大多数基于 Redis 的分布式锁现状和实现方法.</p>
<p>实现 Redis 分布式锁的最简单的方法就是在 Redis 中创建一个 key，这个 key 有一个失效时间（TTL)，以保证锁最终会被自动释放掉（这个对应特性 2）。当客户端释放资源(解锁）的时候，会删除掉这个 key。</p>
<p>从表面上看，似乎效果还不错，但是这里有一个问题：这个架构中存在一个严重的单点失败问题。如果 Redis 挂了怎么办？你可能会说，可以通过增加一个 slave 节点解决这个问题。但这通常是行不通的。这样做，我们不能实现资源的独享,因为 Redis 的主从同步通常是异步的。</p>
<p>在这种场景（主从结构）中存在明显的竞态:</p>
<ol>
<li>客户端 A 从 master 获取到锁</li>
<li>在 master 将锁同步到 slave 之前，master 宕掉了。</li>
<li>slave 节点被晋级为 master 节点</li>
<li>客户端 B 取得了同一个资源被客户端 A 已经获取到的另外一个锁。安全失效！</li>
</ol>
<p>有时候程序就是这么巧，比如说正好一个节点挂掉的时候，多个客户端同时取到了锁。如果你可以接受这种小概率错误，那用这个基于复制的方案就完全没有问题。否则的话，我们建议你实现下面描述的解决方案。</p>
<h2 id="单-redis-实例实现分布式锁的正确方法">单 Redis 实例实现分布式锁的正确方法</h2>
<p>在尝试克服上述单实例设置的限制之前，让我们先讨论一下在这种简单情况下实现分布式锁的正确做法，实际上这是一种可行的方案，尽管存在竞态，结果仍然是可接受的，另外，这里讨论的单实例加锁方法也是分布式加锁算法的基础。</p>
<p>获取锁使用命令:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">    SET resource_name my_random_value NX PX <span style="color:#0000cf;font-weight:bold">30000</span>
</code></pre></div><p>这个命令仅在不存在 key 的时候才能被执行成功（NX 选项），并且这个 key 有一个 30 秒的自动失效时间（PX 属性）。这个 key 的值是“my_random_value”(一个随机值），这个值在所有的客户端必须是唯一的，所有同一 key 的获取者（竞争者）这个值都不能一样。</p>
<p>value 的值必须是随机数主要是为了更安全的释放锁，释放锁的时候使用脚本告诉 Redis:只有 key 存在并且存储的值和我指定的值一样才能告诉我删除成功。可以通过以下 Lua 脚本实现：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">ARGV</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">then</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;del&#34;</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span>
<span style="color:#204a87;font-weight:bold">else</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#204a87;font-weight:bold">end</span>
</code></pre></div><p>使用这种方式释放锁可以避免删除别的客户端获取成功的锁。举个例子：客户端 A 取得资源锁，但是紧接着被一个其他操作阻塞了，当客户端 A 运行完毕其他操作后要释放锁时，原来的锁早已超时并且被 Redis 自动释放，并且在这期间资源锁又被客户端 B 再次获取到。如果仅使用 DEL 命令将 key 删除，那么这种情况就会把客户端 B 的锁给删除掉。使用 Lua 脚本就不会存在这种情况，因为脚本仅会删除 value 等于客户端 A 的 value 的 key（value 相当于客户端的一个签名）。</p>
<p>这个随机字符串应该怎么设置？我认为它应该是从/dev/urandom 产生的一个 20 字节随机数，但是我想你可以找到比这种方法代价更小的方法，只要这个数在你的任务中是唯一的就行。例如一种安全可行的方法是使用/dev/urandom 作为 RC4 的种子和源产生一个伪随机流;一种更简单的方法是把以毫秒为单位的 unix 时间和客户端 ID 拼接起来，理论上不是完全安全，但是在多数情况下可以满足需求.</p>
<p>key 的失效时间，被称作“锁定有效期”。它不仅是 key 自动失效时间，而且还是一个客户端持有锁多长时间后可以被另外一个客户端重新获得。</p>
<p>截至到目前，我们已经有较好的方法获取锁和释放锁。基于 Redis 单实例，假设这个单实例总是可用，这种方法已经足够安全。现在让我们扩展一下，假设 Redis 没有总是可用的保障。</p>
<h2 id="redlock-算法">Redlock 算法</h2>
<p>在 Redis 的分布式环境中，我们假设有 N 个 Redis master。这些节点完全互相独立，不存在主从复制或者其他集群协调机制。之前我们已经描述了在 Redis 单实例下怎么安全地获取和释放锁。我们确保将在每（N)个实例上使用此方法获取和释放锁。在这个样例中，我们假设有 5 个 Redis master 节点，这是一个比较合理的设置，所以我们需要在 5 台机器上面或者 5 台虚拟机上面运行这些实例，这样保证他们不会同时都宕掉。</p>
<p>为了取到锁，客户端应该执行以下操作:</p>
<ol>
<li>获取当前 Unix 时间，以毫秒为单位。</li>
<li>依次尝试从 N 个实例，使用相同的 key 和随机值获取锁。在步骤 2，当向 Redis 设置锁时,客户端应该设置一个网络连接和响应超时时间，这个超时时间应该小于锁的失效时间。例如你的锁自动失效时间为 10 秒，则超时时间应该在 5-50 毫秒之间。这样可以避免服务器端 Redis 已经挂掉的情况下，客户端还在死死地等待响应结果。如果服务器端没有在规定时间内响应，客户端应该尽快尝试另外一个 Redis 实例。</li>
<li>客户端使用当前时间减去开始获取锁时间（步骤 1 记录的时间）就得到获取锁使用的时间。当且仅当从大多数（这里是 3 个节点）的 Redis 节点都取到锁，并且使用的时间小于锁失效时间时，锁才算获取成功。</li>
<li>如果取到了锁，key 的真正有效时间等于有效时间减去获取锁所使用的时间（步骤 3 计算的结果）。</li>
<li>如果因为某些原因，获取锁失败（没有在至少 N/2+1 个 Redis 实例取到锁或者取锁时间已经超过了有效时间），客户端应该在所有的 Redis 实例上进行解锁（即便某些 Redis 实例根本就没有加锁成功）。</li>
</ol>
<h2 id="这个算法是异步的么">这个算法是异步的么?</h2>
<p>算法基于这样一个假设：虽然多个进程之间没有时钟同步，但每个进程都以相同的时钟频率前进，时间差相对于失效时间来说几乎可以忽略不计。这种假设和我们的真实世界非常接近：每个计算机都有一个本地时钟，我们可以容忍多个计算机之间有较小的时钟漂移。</p>
<p>从这点来说，我们必须再次强调我们的互相排斥规则：只有在锁的有效时间（在步骤 3 计算的结果）范围内客户端能够做完它的工作，锁的安全性才能得到保证（锁的实际有效时间通常要比设置的短，因为计算机之间有时钟漂移的现象）。.</p>
<p>想要了解更多关于需要时钟漂移间隙的相似系统, 这里有一个非常有趣的参考: Leases: an efficient fault-tolerant mechanism for distributed file cache consistency.</p>
<h2 id="失败时重试">失败时重试</h2>
<p>当客户端无法取到锁时，应该在一个随机延迟后重试,防止多个客户端在同时抢夺同一资源的锁（这样会导致脑裂，没有人会取到锁）。同样，客户端取得大部分 Redis 实例锁所花费的时间越短，脑裂出现的概率就会越低（必要的重试），所以，理想情况一下，客户端应该同时（并发地）向所有 Redis 发送 SET 命令。</p>
<p>需要强调，当客户端从大多数 Redis 实例获取锁失败时，应该尽快地释放（部分）已经成功取到的锁，这样其他的客户端就不必非得等到锁过完“有效时间”才能取到（然而，如果已经存在网络分裂，客户端已经无法和 Redis 实例通信，此时就只能等待 key 的自动释放了，等于被惩罚了）。</p>
<h2 id="释放锁">释放锁</h2>
<p>释放锁比较简单，向所有的 Redis 实例发送释放锁命令即可，不用关心之前有没有从 Redis 实例成功获取到锁.</p>
<h2 id="安全争议">安全争议</h2>
<p>这个算法安全么？我们可以从不同的场景讨论一下。</p>
<p>让我们假设客户端从大多数 Redis 实例取到了锁。所有的实例都包含同样的 key，并且 key 的有效时间也一样。然而，key 肯定是在不同的时间被设置上的，所以 key 的失效时间也不是精确的相同。我们假设第一个设置的 key 时间是 T1(开始向第一个 server 发送命令前时间），最后一个设置的 key 时间是 T2(得到最后一台 server 的答复后的时间），我们可以确认，第一个 server 的 key 至少会存活 MIN_VALIDITY=TTL-(T2-T1)-CLOCK_DRIFT。所有其他的 key 的存活时间，都会比这个 key 时间晚，所以可以肯定，所有 key 的失效时间至少是 MIN_VALIDITY。</p>
<p>当大部分实例的 key 被设置后，其他的客户端将不能再取到锁，因为至少 N/2+1 个实例已经存在 key。所以，如果一个锁被（客户端）获取后，客户端自己也不能再次申请到锁(违反互相排斥属性）。</p>
<p>然而我们也想确保，当多个客户端同时抢夺一个锁时不能两个都成功。</p>
<p>如果客户端在获取到大多数 redis 实例锁，使用的时间接近或者已经大于失效时间，客户端将认为锁是失效的锁，并且将释放掉已经获取到的锁，所以我们只需要在有效时间范围内获取到大部分锁这种情况。在上面已经讨论过有争议的地方，在 MIN_VALIDITY 时间内，将没有客户端再次取得锁。所以只有一种情况，多个客户端会在相同时间取得 N/2+1 实例的锁，那就是取得锁的时间大于失效时间（TTL time)，这样取到的锁也是无效的.</p>
<p>如果你能提供关于现有的类似算法的一个正式证明（指出正确性），或者是发现这个算法的 bug？ 我们将非常感激.</p>
<h2 id="活性争议">活性争议</h2>
<p>系统的活性安全基于三个主要特性:</p>
<p>锁的自动释放（因为 key 失效了）：最终锁可以再次被使用.
客户端通常会将没有获取到的锁删除，或者锁被取到后，使用完后，客户端会主动（提前）释放锁，而不是等到锁失效另外的客户端才能取到锁。.
当客户端重试获取锁时，需要等待一段时间，这个时间必须大于从大多数 Redis 实例成功获取锁使用的时间，以最大限度地避免脑裂。.
然而，当网络出现问题时系统在失效时间(TTL)内就无法服务，这种情况下我们的程序就会为此付出代价。如果网络持续的有问题，可能就会出现死循环了。 这种情况发生在当客户端刚取到一个锁还没有来得及释放锁就被网络隔离.</p>
<p>如果网络一直没有恢复，这个算法会导致系统不可用.</p>
<h2 id="性能崩溃恢复和-redis-同步">性能，崩溃恢复和 Redis 同步</h2>
<p>很多用户把 Redis 当做分布式锁服务器，使用获取锁和释放锁的响应时间，每秒钟可用执行多少次 acquire / release 操作作为性能指标。为了达到这一要求，增加 Redis 实例当然可用降低响应延迟（没有钱买硬件的”穷人”,也可以在网络方面做优化，使用非阻塞模型，一次发送所有的命令，然后异步的读取响应结果，假设客户端和 redis 服务器之间的 RTT 都差不多。</p>
<p>然而，如果我们想使用可以从备份中恢复的 redis 模式，有另外一种持久化情况你需要考虑，.</p>
<p>我们考虑这样一种场景，假设我们的 redis 没用使用备份。一个客户端获取到了 3 个实例的锁。此时，其中一个已经被客户端取到锁的 redis 实例被重启，在这个时间点，就可能出现 3 个节点没有设置锁，此时如果有另外一个客户端来设置锁，锁就可能被再次获取到，这样锁的互相排斥的特性就被破坏掉了。</p>
<p>如果我们启用了 AOF 持久化，情况会好很多。我们可用使用 SHUTDOWN 命令关闭然后再次重启。因为 Redis 到期是语义上实现的，所以当服务器关闭时，实际上还是经过了时间，所有（保持锁）需要的条件都没有受到影响. 没有受到影响的前提是 redis 优雅的关闭。停电了怎么办？如果 redis 是每秒执行一次 fsync，那么很有可能在 redis 重启之后，key 已经丢弃。理论上，如果我们想在 Redis 重启地任何情况下都保证锁的安全，我们必须开启 fsync=always 的配置。这反过来将完全破坏与传统上用于以安全的方式实现分布式锁的同一级别的 CP 系统的性能.</p>
<p>然而情况总比一开始想象的好一些。当一个 redis 节点重启后，只要它不参与到任意当前活动的锁，没有被当做“当前存活”节点被客户端重新获取到,算法的安全性仍然是有保障的。</p>
<p>为了达到这种效果，我们只需要将新的 redis 实例，在一个 TTL 时间内，对客户端不可用即可，在这个时间内，所有客户端锁将被失效或者自动释放.</p>
<p>使用延迟重启可以在不采用持久化策略的情况下达到同样的安全，然而这样做有时会让系统转化为彻底不可用。比如大部分的 redis 实例都崩溃了，系统在 TTL 时间内任何锁都将无法加锁成功。</p>
<h2 id="使算法更加可靠锁的扩展">使算法更加可靠：锁的扩展</h2>
<p>如果你的工作可以拆分为许多小步骤，可以将有效时间设置的小一些，使用锁的一些扩展机制。在工作进行的过程中，当发现锁剩下的有效时间很短时，可以再次向 redis 的所有实例发送一个 Lua 脚本，让 key 的有效时间延长一点（前提还是 key 存在并且 value 是之前设置的 value)。</p>
<p>客户端扩展 TTL 时必须像首次取得锁一样在大多数实例上扩展成功才算再次取到锁，并且是在有效时间内再次取到锁（算法和获取锁是非常相似的）。</p>
<p>这样做从技术上将并不会改变算法的正确性，所以扩展锁的过程中仍然需要达到获取到 N/2+1 个实例这个要求，否则活性特性之一就会失效。</p>
<h2 id="想要得到帮助">想要得到帮助?</h2>
<p>如果你正在做分布式系统，你的意见和分析非常重要。其他语言实现分布式锁的算法同样非常宝贵。</p>
<p>提前感谢各位!</p>
<h2 id="redlock-分析">Redlock 分析</h2>
<p>Martin Kleppmann <a href="http://martin.kleppmann.com/2016/02/08/how-to-do-distributed-locking.html">在这儿分析了 Redlock</a>. 我不赞同他的说法，并且对他做出了回复 <a href="http://antirez.com/news/101">我的回复在这儿</a>.</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-3860dea67604bf92ab25745f4b201971">使用  搭建电商秒杀系统</h1>
	
	<div class="td-byline mb-4">
		
        
	</div>
	<blockquote>
<p><a href="https://help.aliyun.com/document_detail/63920.html">https://help.aliyun.com/document_detail/63920.html</a></p>
</blockquote>
<p>秒杀活动是绝大部分电商选择的低价促销、推广品牌的方式。不仅可以给平台带来用户量，还可以提高平台知名度。一个好的秒杀系统，可以提高平台系统的稳定性和公平性，获得更好的用户体验，提升平台的口碑，从而提升秒杀活动的最大价值。本文讨论云数据库 Redis 版缓存设计高并发的秒杀系统。</p>
<h2 id="秒杀的特征">秒杀的特征</h2>
<p>秒杀活动对稀缺或者特价的商品进行定时定量售卖，吸引成大量的消费者进行抢购，但又只有少部分消费者可以下单成功。
因此，秒杀活动将在较短时间内产生比平时大数十倍，上百倍的页面访问流量和下单请求流量。</p>
<p>秒杀活动可以分为 3 个阶段：</p>
<ul>
<li>秒杀前：用户不断刷新商品详情页，页面请求达到瞬时峰值。</li>
<li>秒杀开始：用户点击秒杀按钮，下单请求达到瞬时峰值。</li>
<li>秒杀后：一部分成功下单的用户不断刷新订单或者产生退单操作，大部分用户继续刷新商品详情页等待退单机会。</li>
</ul>
<p>消费者提交订单，一般做法是利用数据库的行级锁，只有抢到锁的请求可以进行库存查询和下单操作。
但是在高并发的情况下，数据库无法承担如此大的请求，往往会使整个服务 blocked，在消费者看来就是服务器宕机。</p>
<h2 id="秒杀系统">秒杀系统</h2>
<p><img src="https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/6288937951/p3188.png" alt=""></p>
<p>秒杀系统的流量虽然很高，但是实际有效流量是十分有限的。利用系统的层次结构，在每个阶段提前校验，拦截无效流量，可以减少大量无效的流量涌入数据库。</p>
<h3 id="利用浏览器缓存和-cdn-抗压静态页面流量">利用浏览器缓存和 CDN 抗压静态页面流量</h3>
<p>秒杀前，用户不断刷新商品详情页，造成大量的页面请求。
所以，我们需要把秒杀商品详情页与普通的商品详情页分开。
对于秒杀商品详情页尽量将能静态化的元素静态化处理，除了秒杀按钮需要服务端进行动态判断，其他的静态数据可以缓存在浏览器和 CDN 上。
这样，秒杀前刷新页面导致的流量进入服务端的流量只有很小的一部分。</p>
<h3 id="利用读写分离-redis-缓存拦截流量">利用读写分离 Redis 缓存拦截流量</h3>
<p>CDN 是第一级流量拦截，第二级流量拦截我们使用支持读写分离的 Redis。
在这一阶段我们主要读取数据，读写分离 Redis 能支持高达 60 万以上 qps，完全可以支持需求。</p>
<p>首先通过数据控制模块，提前将秒杀商品缓存到读写分离 Redis，并设置秒杀开始标记如下：</p>
<pre tabindex="0"><code>&quot;goodsId_count&quot;: 100 //总数
&quot;goodsId_start&quot;: 0 //开始标记
&quot;goodsId_access&quot;: 0 //接受下单数
</code></pre><p>秒杀开始前，服务集群读取 goodsId_Start 为 0，直接返回未开始。
数据控制模块将 goodsId_start 改为 1，标志秒杀开始。
服务集群缓存开始标记位并开始接受请求，并记录到 Redis 中 goodsId_access，商品剩余数量为（goodsId_count - goodsId_access）。</p>
<p>当接受下单数达到 goodsId_count 后，继续拦截所有请求，商品剩余数量为 0。</p>
<p>可以看出，最后成功参与下单的请求只有少部分可以被接受。在高并发的情况下，允许稍微多的流量进入。因此可以控制接受下单数的比例。</p>
<p>利用主从版 Redis 缓存加速库存扣量</p>
<p>成功参与下单后，进入下层服务，开始进行订单信息校验，库存扣量。
为了避免直接访问数据库，我们使用主从版 Redis 来进行库存扣量，主从版 Redis 提供 10 万级别的 QPS。
使用 Redis 来优化库存查询，提前拦截秒杀失败的请求，将大大提高系统的整体吞吐量。</p>
<p>通过数据控制模块提前将库存存入 Redis，将每个秒杀商品在 Redis 中用一个 hash 结构表示。</p>
<pre tabindex="0"><code>&quot;goodsId&quot; : {
    &quot;Total&quot;: 100
    &quot;Booked&quot;: 0
}
</code></pre><blockquote>
<p>说明 goodsId 表示商品 ID，Total 表示该商品的库存数量，Booked 表示该商品已被订购的数量。</p>
</blockquote>
<p>扣量时，服务器通过请求 Redis 获取下单资格，通过以下 lua 脚本实现，由于 Redis 是单线程模型，lua 可以保证多个命令的<code>原子性</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tonumber</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ARGV</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#204a87;font-weight:bold">then</span>
<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#204a87;font-weight:bold">end</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">vals</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HMGET&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#4e9a06">&#34;Total&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Booked&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">total</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tonumber</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vals</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">blocked</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tonumber</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vals</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">total</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">blocked</span> <span style="color:#204a87;font-weight:bold">then</span>
<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#204a87;font-weight:bold">end</span>
<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">blocked</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">total</span> <span style="color:#204a87;font-weight:bold">then</span>
<span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HINCRBY&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#4e9a06">&#34;Booked&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span>
 <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">end</span>
<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
</code></pre></div><p>先使用 SCRIPT LOAD 将 lua 脚本提前缓存在 Redis，然后调用 EVALSHA 调用脚本，比直接调用 EVAL 节省网络带宽，步骤如下：</p>
<ol>
<li>
<p>缓存 lua 脚本至 Redis。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">SCRIPT LOAD <span style="color:#4e9a06">&#34;lua code&#34;</span>
</code></pre></div><p>返回结果为：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#4e9a06">&#34;438dd755f3fe0d32771753eb57f075b18fed7716&#34;</span>
</code></pre></div></li>
<li>
<p>调用该 lua 脚本。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">EVALSHA 438dd755f3fe0d32771753eb57f075b18fed7716 <span style="color:#0000cf;font-weight:bold">1</span> goodsId <span style="color:#0000cf;font-weight:bold">1</span>
</code></pre></div><p>返回结果如下，表示扣减了 1 个库存：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">1</span>
</code></pre></div><blockquote>
<p>说明 此时，执行 HGET goodsId Booked 命令，可查看到返回的值为&quot;1&quot;，即该商品已被订购的数量为 1。</p>
</blockquote>
</li>
</ol>
<p>秒杀服务可通过判断 Redis 是否返回抢购个数 n，即可知道此次请求是否扣量成功。</p>
<h3 id="使用主从版-redis-实现简单的消息队列异步下单入库">使用主从版 Redis 实现简单的消息队列异步下单入库</h3>
<p>扣量完成后，需要进行订单入库。如果商品数量较少的时候，直接操作数据库即可。如果秒杀的商品是 1 万，甚至 10 万级别，那数据库锁冲突将带来很大的性能瓶颈。因此，利用消息队列组件，当秒杀服务将订单信息写入消息队列后，即可认为下单完成，避免直接操作数据库。</p>
<ol>
<li>
<p>消息队列组件依然可以使用 Redis 实现，在 R2 中用 list 数据结构表示。</p>
<pre tabindex="0"><code>orderList {
[0] = {订单内容}
[1] = {订单内容}
[2] = {订单内容}
...
}
</code></pre></li>
<li>
<p>将订单内容写入 Redis：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">LPUSH orderList <span style="color:#ce5c00;font-weight:bold">{</span>订单内容<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div></li>
<li>
<p>异步下单模块从 Redis 中顺序获取订单信息，并将订单写入数据库。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">BRPOP orderList <span style="color:#0000cf;font-weight:bold">0</span>
</code></pre></div></li>
</ol>
<p>通过使用 Redis 作为消息队列，异步处理订单入库，有效的提高了用户的下单完成速度。</p>
<p>数据控制模块管理秒杀数据同步</p>
<p>最开始，利用读写分离 Redis 进行流量限制，只让部分流量进入下单。
对于下单检验失败和退单等情况，需要让更多的流量进来。
因此，数据控制模块需要定时将数据库中的数据进行一定的计算，同步到主从版 Redis，同时再同步到读写分离的 Redis，让更多的流量进来。</p>

</div>





    
	
  
    
    
	
    


  

<div class="td-content" style="page-break-before: always">
    <h1 id="pg-d1f6f9f2d6e48e321571f2e996e37cc7">Redis Redlock 的争论</h1>
	
	<div class="td-byline mb-4">
		By <b>我妻礼弥</b> |
        
	</div>
	<blockquote>
<p><a href="https://juejin.cn/post/6976538149904678925">https://juejin.cn/post/6976538149904678925</a></p>
</blockquote>
<p>Redis 作者提出的 Redlock 方案后，马上受到英国剑桥大学、业界著名的分布式系统专家 <a href="">Martin</a> 的质疑！
认为这个 Redlock 的算法模型是有问题的，并写了篇文件对分布式锁的设计，提出了自己的看法。</p>
<p>之后，Redis 作者 <a href="">Antirez</a> 面对质疑，不甘示弱，也写了一篇文章，反驳了对方的观点，并详细剖析了 Redlock 算法模型的更多设计细节。</p>
<p>关于这个问题的争论，在当时互联网上也引起了非常激烈的讨论。双方都是分布式系统领域的专家，却对同一个问题提出很多相反的论断，而且二人思路清晰，论据充分，到底谁对谁错，让我们先来看下分布式专家 <strong>Martin</strong> 对于 Relock 的质疑</p>
<h2 id="分布式专家-martin-对于-relock-的质疑">分布式专家 <strong>Martin</strong> 对于 Relock 的质疑</h2>
<p>在他的文章中，主要阐述了 4 个论点：</p>
<h3 id="分布式锁的偏好">分布式锁的偏好</h3>
<p>Martin 表示使用分布式锁有两种偏好</p>
<ol>
<li><strong>效率</strong>：使用分布式锁的互斥能力，避免多次做重复的工作（例如一些“昂贵”的计算任务）。这种情况要求即使锁失效，也不会带来「恶性」的后果。例如多发了 1 次邮件等无伤大雅的场景。</li>
<li><strong>正确性</strong>：使用锁用来防止并发进程互相干扰。如果锁失效，会造成多个进程同时操作同一条数据，产生的后果是数据严重错误、永久性不一致、数据丢失等恶性问题。</li>
</ol>
<p>Martin 认为，如果你是为了效率，那么使用单机版 Redis 就可以了，即使偶尔发生锁失效（宕机、主从切换），都不会产生严重的后果。而使用 Redlock 太重了，没必要。</p>
<p>而如果你是为了正确性，Martin 认为 Redlock 根本达不到安全性的要求，也依旧存在锁失效的问题！</p>
<h3 id="锁在分布式系统中会遇到的问题">锁在分布式系统中会遇到的问题</h3>
<p>Martin 表示，一个分布式系统，存在着各种异常情况，这些异常场景主要包括三大块，这也是分布式系统会遇到的三座大山：<strong>NPC</strong>。</p>
<ul>
<li>N：Network Delay，网络延迟</li>
<li>P：Process Pause，进程暂停</li>
<li>C：Clock Drift，时钟漂移</li>
</ul>
<p>Martin 用一个进程暂停的例子，指出了 Redlock 安全性问题：</p>
<ol>
<li>客户端 1 请求锁定节点 A、B、C、D、E</li>
<li>客户端 1 的拿到锁后，进入进程暂停（时间比较久）</li>
<li>所有 Redis 节点上的锁都过期了</li>
<li>客户端 2 获取到了 A、B、C、D、E 上的锁</li>
<li>客户端 1 GC 结束，认为成功获取锁</li>
<li>客户端 2 也认为获取到了锁，发生「冲突」</li>
</ol>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbe61ac0e3be4f60aee223eb87be35da~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png"></p>
<p>Martin 认为，进程暂停可能发生在程序的任意时刻，而且执行时间是不可控的。</p>
<blockquote>
<p>注：当然，即使没有进程暂停，在发生网络延迟、时钟漂移时，也都有可能导致 Redlock 出现此类问题，这里 <strong>Martin</strong> 只是拿进程暂停举例</p>
</blockquote>
<h3 id="假设时钟正确是不合理的">假设时钟正确是不合理的</h3>
<p>Relock 有一个隐含条件是所有的主机时间都是正确的，如果时间不正确就会出问题，例如</p>
<ol>
<li>客户端 1 获取到节点 A、B、C 上的锁</li>
<li>节点 C 上的时钟「向前跳跃」，导致锁到期</li>
<li>客户端 2 获取节点 C、D、E 上的锁</li>
<li>客户端 1 和 2 现在都相信它们持有了锁（冲突）</li>
</ol>
<p>Martin 认为 Redlock 必须「强依赖」多个节点的时钟是保持同步的，一旦有节点时钟发生错误，那这个算法模型就失效了。而机器的时钟发生错误，是很有可能发生的，比如：</p>
<ul>
<li>系统管理员「手动修改」了机器时钟</li>
<li>机器时钟在同步 NTP 时间时，发生了大的「跳跃」</li>
</ul>
<p>总之，Martin 认为，Redlock 的算法是建立在「同步模型」基础上的，有大量资料研究表明，同步模型的假设，在分布式系统中是有问题的。在混乱的分布式系统的中，你不能假设系统时钟就是对的，所以，你必须非常小心你的假设。</p>
<h3 id="提出-fecing-token-的方案保证正确性">提出 fecing token 的方案，保证正确性</h3>
<p>相对应的，Martin 提出一种被叫作 fecing token 的方案，保证分布式锁的正确性。(这里感叹一句，大神就是大神，不光能发现、提出问题，还能给出解决方案)</p>
<p>这个模型流程如下：</p>
<ol>
<li>客户端在获取锁时，锁服务可以提供一个「递增」的 token</li>
<li>客户端拿着这个 token 去操作共享资源</li>
<li>共享资源可以根据 token 拒绝「后来者」的请求</li>
</ol>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/95423a7b261a43009d7451f0f21b0913~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png"></p>
<p>这样一来，无论 NPC 哪种异常情况发生，都可以保证分布式锁的安全性，因为它是建立在「异步模型」上的。</p>
<p>而 Redlock 无法提供类似 fecing token 的方案，所以它无法保证安全性。</p>
<p>他还表示</p>
<blockquote>
<p>一个好的分布式锁，无论 NPC 怎么发生，可以不在规定时间内给出结果，但并不会给出一个错误的结果。也就是只会影响到锁的「性能」（或称之为活性），而不会影响它的「正确性」。</p>
</blockquote>
<h3 id="martin-的结论"><strong>Martin</strong> 的结论</h3>
<ol>
<li>Redlock 不伦不类：对于偏好效率来讲，Redlock 比较重，没必要这么做，而对于偏好正确性来说，Redlock 是不够安全的。</li>
<li>时钟假设不合理：该算法对系统时钟做出了危险的假设（假设多个节点机器时钟都是一致的），如果不满足这些假设，锁就会失效。</li>
<li>无法保证正确性：Redlock 不能提供类似 fencing token 的方案，所以解决不了正确性的问题。为了正确性，请使用有「共识系统」的软件，例如 Zookeeper。</li>
</ol>
<p>以上就是 <strong>Martin</strong> 反对使用 Redlock 的观点，有理有据。接下来我们来看 Redis 作者 Antirez 是如何反驳的。</p>
<h2 id="redis-作者-antirez-的反驳">Redis 作者 Antirez 的反驳</h2>
<p>在 Redis 作者的反驳文章中，有 3 个重点</p>
<h3 id="时钟问题">时钟问题</h3>
<p>首先，Redis 作者一眼就看穿了对方提出的最为核心的问题：时钟问题。</p>
<blockquote>
<p>为什么 Redis 作者优先解释时钟问题？因为在后面的反驳过程中，需要依赖这个基础做进一步解释。</p>
</blockquote>
<p>Redis 作者表示，Redlock 并不需要完全一致的时钟，只需要大体一致就可以了，允许有「误差」，只要误差不要超过锁的租期即可，这种对于时钟的精度要求并不是很高，而且这也符合现实环境。</p>
<p>对于对方提到的「时钟修改」问题，Redis 作者反驳到：</p>
<ul>
<li>手动修改时钟：不要这么做就好了，否则你直接修改 Raft 日志，那 Raft 也会无法工作&hellip;</li>
<li>时钟跳跃：通过「恰当的运维」，保证机器时钟不会大幅度跳跃（每次通过微小的调整来完成），实际上这是可以做到的</li>
</ul>
<h3 id="解释网络延迟进程暂停问题">解释网络延迟、进程暂停问题</h3>
<p>Redis 作者对于对方提出的，网络延迟、进程暂停可能导致 Redlock 失效的问题，也做了反驳</p>
<p>我们重新回顾一下，Martin 提出的问题假设：</p>
<ol>
<li>客户端 1 请求锁定节点 A、B、C、D、E</li>
<li>客户端 1 的拿到锁后，进入进程暂停（时间比较久）</li>
<li>所有 Redis 节点上的锁都过期了</li>
<li>客户端 2 获取到了 A、B、C、D、E 上的锁</li>
<li>客户端 1 GC 结束，认为成功获取锁</li>
<li>客户端 2 也认为获取到了锁，发生「冲突」</li>
</ol>
<p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fbe61ac0e3be4f60aee223eb87be35da~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png"></p>
<p>Redis 作者反驳到，这个假设其实是有问题的，Redlock 是可以保证锁安全的。还记得前面介绍 Redlock 流程的那 5 步吗？让我们来复习一下。</p>
<ol>
<li>客户端先获取「当前时间戳 T1」</li>
<li>客户端依次向这 5 个 Redis 实例发起加锁请求（用前面讲到的 SET 命令），并设置超时时间（毫秒级），如果某一个实例加锁失败（包括网络超时、锁被其它人持有等各种异常情况），就立即向下一个 Redis 实例申请加锁</li>
<li>如果客户端从 &gt;=3 个（大多数）以上 Redis 实例加锁成功，则再次获取「当前时间戳 T2」，如果锁的租期 &gt; T2 - T1 ，此时，认为客户端加锁成功，否则认为加锁失败</li>
<li>加锁成功，去操作共享资源</li>
<li>加锁失败或操作结束，向「全部节点」发起释放锁请求（前面讲到的 Lua 脚本释放锁）</li>
</ol>
<blockquote>
<p>注意，重点是 1-3，在步骤 3，加锁成功后为什么要重新获取「当前时间戳 T2」？还用 T2 - T1 的时间，与锁的过期时间做比较？</p>
</blockquote>
<p>Redis 作者强调：如果在 1-3 发生了网络延迟、进程暂停等耗时长的异常情况，那在第 3 步 T2 - T1，是可以检测出来的，如果超出了锁设置的过期时间，那这时就认为加锁会失败，之后释放所有节点的锁就好了！</p>
<p>Redis 作者继续论述，如果对方认为，发生网络延迟、进程暂停是在步骤 3 之后，也就是客户端确认拿到了锁，去操作共享资源的途中发生了问题，导致锁失效，那这不止是 Redlock 的问题，任何其它锁服务例如 Zookeeper，都有类似的问题，这不在讨论范畴内。</p>
<p>所以 Redis 作者的结论是：</p>
<ul>
<li>客户端在拿到锁之前，无论经历什么耗时长问题，Redlock 都能够在第 3 步检测出来</li>
<li>客户端在拿到锁之后，发生 NPC，那 Redlock、Zookeeper 都无能为力</li>
</ul>
<p>所以，Redis 作者认为 Redlock 在保证时钟正确的基础上，是可以保证正确性的。</p>
<h3 id="质疑-fencing-token-机制">质疑 fencing token 机制</h3>
<p>Redis 作者对于对方提出的 <strong>fecing token</strong> 机制，也提出了质疑，主要分为 2 个问题</p>
<h4 id="第一共享资源服务器能拒绝旧-token">第一共享资源服务器能拒绝旧 token</h4>
<p>这个方案必须要求要操作的「共享资源服务器」有拒绝「旧 token」的能力。</p>
<p>假设共享资源服务器是 MySQL，我们要操作 MySQL，从锁服务拿到一个递增数字的 token，
然后客户端要带着这个 token 去改 MySQL 的某一行，这就需要利用 MySQL 的「事物隔离性」来做。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">两个客户端必须利用事物和隔离性达到目的</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">//</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">注意</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">token</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">的判断条件</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">T</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">val</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#000">new_val</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">current_token</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#000">token</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>但如果操作的不是 MySQL 而是向磁盘上写一个文件，或发起一个 HTTP 请求，那这个方案就无能为力了，这对要操作的资源服务器，提出了更高的要求。</p>
<p>再者，既然资源服务器都有了「互斥」能力，那还要分布式锁干什么？</p>
<p>所以，Redis 作者认为这个方案是站不住脚的。</p>
<h4 id="第二-redlock-已经提供了随机值">第二 Redlock 已经提供了随机值</h4>
<p>Redlock “实现” fecing token</p>
<p>退一步讲，即使 Redlock 没有提供 fecing token 的能力，但 Redlock 已经提供了随机值（就是之前讲的 UUID），利用这个随机值，也可以达到与 fecing token 同样的效果。</p>
<ol>
<li>客户端使用 Redlock 拿到锁</li>
<li>客户端在操作共享资源之前，先把这个锁的 VALUE，在要操作的共享资源上做标记</li>
<li>客户端处理业务逻辑，最后，在修改共享资源时，判断这个标记是否与之前一样，一样才修改（类似 CAS 的思路）</li>
</ol>
<p>还是以 MySQL 为例,这个实现如下</p>
<ol>
<li>客户端使用 Redlock 拿到锁</li>
<li>客户端要修改 MySQL 表中的某一行数据之前，先把锁的 VALUE 更新到这一行的某个字段中（这里假设为 current_token 字段)</li>
<li>客户端处理业务逻辑</li>
<li>客户端修改 MySQL 的这一行数据，把 VALUE 当做 WHERE 条件，再修改</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">UPDATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">T</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">val</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#000">new_val</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">WHERE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">AND</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">current_token</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">$</span><span style="color:#000">redlock_value</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>可见，这种方案通过依赖 MySQL 的事物机制，也达到对方提到的 fecing token 一样的效果。</p>
<h3 id="操作顺序">操作顺序</h3>
<p>对于上述通过 Redlock “实现” fecing token 的设计，网友提出了一个问题：两个客户端通过这种方案，先「标记」再「检查 + 修改」共享资源，那这两个客户端的操作顺序无法保证啊？
而用 <strong>Martin</strong> 提到的 fecing token，因为这个 token 是单调递增的数字，资源服务器可以拒绝小的 token 请求，保证了操作的「顺序性」！</p>
<p>Redis 作者对这问题做了不同的解释,我觉得非常有意思，他认为：分布式锁的本质，是为了「互斥」，只要能保证两个客户端在并发时，一个成功，一个失败就好了，不需要关心「顺序性」。</p>
<blockquote>
<p>前面 <strong>Martin</strong> 的质疑中，一直很关心这个顺序性问题，但 Redis 的作者的看法却不同。</p>
</blockquote>
<p>综上，Redis 作者的结论：</p>
<ol>
<li>作者同意对方关于「时钟跳跃」对 Redlock 的影响，但认为时钟跳跃是可以避免的，取决于基础设施和运维。</li>
<li>Redlock 在设计时，充分考虑了 NPC 问题，在 Redlock 步骤 3 之前出现 NPC，可以保证锁的正确性，但在步骤 3 之后发生 NPC，不止是 Redlock 有问题，其它分布式锁服务同样也有问题，所以不在讨论范畴内。</li>
</ol>
<h2 id="基于-zookeeper-的分布式锁">基于 Zookeeper 的分布式锁</h2>
<p>Martin 在他的文章中，推荐使用 Zookeeper 实现分布式锁，认为它更安全</p>
<p>Zookeeper 又是如何实现的分布式锁的呢？</p>
<ol>
<li>客户端 1 和 2 都尝试创建「临时节点」，例如 /lock</li>
<li>假设客户端 1 先到达，则加锁成功，客户端 2 加锁失败</li>
<li>客户端 1 操作共享资源</li>
<li>客户端 1 删除 /lock 节点，释放锁</li>
</ol>
<p>Zookeeper 不像 Redis 那样，需要考虑锁的过期时间问题，它是采用了「临时节点」，保证客户端 1 拿到锁后，只要连接不断，就可以一直持有锁。
如果客户端 1 异常崩溃了，那么这个临时节点会自动删除，保证了锁一定会被释放。</p>
<p>关于 Zookeeper 实现分布式锁的具体详情，参考 <a href="https://juejin.cn/post/7005487404500910116/">Zookeeper 实现分布式锁</a></p>
<h3 id="保持持有锁">保持持有锁</h3>
<p>客户端 1 创建临时节点后，Zookeeper 是如何保证让这个客户端一直持有锁呢？</p>
<p>原因就在于，客户端 1 此时会与 Zookeeper 服务器维护一个 Session，这个 Session 会依赖客户端「定时心跳」来维持连接。</p>
<p>如果 Zookeeper 长时间收不到客户端的心跳，就认为这个 Session 过期了，也会把这个临时节点删除。</p>
<p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/078a3fc5d50e437ea339493ddca39bac~tplv-k3u1fbpfcp-watermark.awebp" alt="image.png"></p>
<h3 id="zookeeper-分布式锁下的-npc-问题">Zookeeper 分布式锁下的 NPC 问题</h3>
<p>同样的 Zookeeper 的分布式锁也存在 NPC 问题，以进程暂停为例</p>
<ol>
<li>客户端 1 创建临时节点 /lock 成功，拿到了锁</li>
<li>客户端 1 发生长时间进程暂停</li>
<li>客户端 1 无法给 Zookeeper 发送心跳，Zookeeper 把临时节点「删除」</li>
<li>客户端 2 创建临时节点 /lock 成功，拿到了锁</li>
<li>客户端 1 进程暂停结束，它仍然认为自己持有锁（冲突）</li>
</ol>
<p>可见，即使是使用 Zookeeper，也无法保证进程暂停、网络延迟异常场景下的安全性。</p>
<p>这就是前面 Redis 作者在反驳的文章中提到的：如果 进程暂停、网络延迟是发生在客户端拿到锁之后，那不止 Redlock 有问题，其它锁服务都有类似的问题。</p>
<p>这里我们可以得出一个结论：</p>
<blockquote>
<p>一个分布式锁，在极端情况下，不一定是安全的。</p>
</blockquote>
<h3 id="zookeeper-分布式锁的优缺点">Zookeeper 分布式锁的优缺点</h3>
<p>Zookeeper 的优点：</p>
<ul>
<li>不需要考虑锁的过期时间</li>
<li>watch 机制，加锁失败，可以 watch 等待锁释放，实现乐观锁</li>
</ul>
<p>但它的劣势是：</p>
<ul>
<li>性能不如 Redis</li>
<li>部署和运维成本高</li>
<li>客户端与 Zookeeper 的长时间失联，锁被释放问题</li>
</ul>
<h3 id="到底要不要用-redlock">到底要不要用 Redlock？</h3>
<p>前面也分析了，Redlock 只有建立在「时钟正确」的前提下，才能正常工作，如果你可以保证这个前提，那么可以拿来使用。</p>
<p>但保证时钟正确，并不是简单</p>
<ul>
<li>第一，从硬件角度来说，时钟发生偏移是时有发生，无法避免。例如，CPU 温度、机器负载、芯片材料都是有可能导致时钟发生偏移的。</li>
<li>第二，人为错误也是很难完全避免，运维暴力修改时钟，进而影响了系统的正确性</li>
</ul>
<p>所以，我对 Redlock 的个人看法是，尽量不用它，而且它的性能不如单机版 Redis，部署成本也高，建议优先考虑使用主从 + 哨兵的模式 实现分布式锁</p>
<p>那怎么保证正确性了？</p>
<h3 id="正确使用分布式锁">正确使用分布式锁</h3>
<p>从上面我们也了解到，任何分布式锁都无法完全保证正确性，因此分布式锁时建议</p>
<ol>
<li>在上层使用分布式锁完成「互斥」目的，虽然极端情况下锁会失效，但它可以最大程度把并发请求阻挡在最上层，减轻操作资源层的压力。</li>
<li>但对于要求数据绝对正确的业务，在资源层一定要做好「兜底」，发生极端情况时，也不会对系统造成影响</li>
</ol>

</div>





    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Docsy Authors 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/redis-docs/docs/lua/about/">关于</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/redis-docs/js/tabpane-persist.js'></script>


















<script src="/redis-docs/js/main.min.f02fac3b86096c93ac415ae1c99250af1441e5769755956087385e9e3a92791a.js" integrity="sha256-8C&#43;sO4YJbJOsQVrhyZJQrxRB5XaXVZVghzhenjqSeRo=" crossorigin="anonymous"></script>




  </body>
</html>
