<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Implementation of redis distributed lock | redis 文档</title>
<meta name="description" content="
https://developpaper.com/implementation-of-redis-distributed-lock/

Many novices will Distributed lock and Distributed transactionConfusion, personal …">
<meta property="og:title" content="Implementation of redis distributed lock" />
<meta property="og:description" content="https://developpaper.com/implementation-of-redis-distributed-lock/
 Many novices will Distributed lock and Distributed transactionConfusion, personal understanding:lock It is used to solve the concurrent contention for a shared resource by multiple programs;affair It is used to ensure the consistency of a series of operations. I’ve explained distributed transactions in several previous articles. I’m going to talk about the implementation of 2pc, TCC and asynchronous assurance schemes.
1. 定义 In the traditional monomer architecture, the most common lock is JDK lock." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/2021/01/08/implementation-of-redis-distributed-lock/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-01-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-12-08T21:16:31+08:00" /><meta property="og:site_name" content="redis 文档" />

<meta itemprop="name" content="Implementation of redis distributed lock">
<meta itemprop="description" content="https://developpaper.com/implementation-of-redis-distributed-lock/
 Many novices will Distributed lock and Distributed transactionConfusion, personal understanding:lock It is used to solve the concurrent contention for a shared resource by multiple programs;affair It is used to ensure the consistency of a series of operations. I’ve explained distributed transactions in several previous articles. I’m going to talk about the implementation of 2pc, TCC and asynchronous assurance schemes.
1. 定义 In the traditional monomer architecture, the most common lock is JDK lock."><meta itemprop="datePublished" content="2021-01-08T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-12-08T21:16:31+08:00" />
<meta itemprop="wordCount" content="3401">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Implementation of redis distributed lock"/>
<meta name="twitter:description" content="https://developpaper.com/implementation-of-redis-distributed-lock/
 Many novices will Distributed lock and Distributed transactionConfusion, personal understanding:lock It is used to solve the concurrent contention for a shared resource by multiple programs;affair It is used to ensure the consistency of a series of operations. I’ve explained distributed transactions in several previous articles. I’m going to talk about the implementation of 2pc, TCC and asynchronous assurance schemes.
1. 定义 In the traditional monomer architecture, the most common lock is JDK lock."/>




<link rel="preload" href="/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" as="style">
<link href="/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">redis 文档</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/docs/" ><span>文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/blog/" ><span class="active">博客</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    <input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">

    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-blog-li">
  <a href="/blog/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-blog"><span class="">博客</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-blognews-li">
  <a href="/blog/news/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blognews"><span class="">news</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-blognewslua-li">
  <a href="/blog/news/lua/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blognewslua"><span class="">Lua News</span></a>
  <ul class="ul-3 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog101012020-2021-lua-news-li">
  <a href="/blog/1/01/01/2020-2021-lua-news/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog101012020-2021-lua-news"><span class="">2020-2021 Lua News</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog101012010-2019-lua-news-li">
  <a href="/blog/1/01/01/2010-2019-lua-news/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog101012010-2019-lua-news"><span class="">2010-2019 Lua News</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog101012000-2009-lua-news-li">
  <a href="/blog/1/01/01/2000-2009-lua-news/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog101012000-2009-lua-news"><span class="">2000-2009 Lua News</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog101011993-1999-lua-news-li">
  <a href="/blog/1/01/01/1993-1999-lua-news/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog101011993-1999-lua-news"><span class="">1993-1999 Lua News</span></a>
</li>
  </ul>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-blogseckill-li">
  <a href="/blog/seckill/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blogseckill"><span class="">秒杀</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20210715e5bbbae7ab8be5afb9e58886e5b883e5bc8fe99481e79a84e7b3bbe7bb9fe8aea4e79fa5-e4bb8e-redlock-e5bc80e5a78b-li">
  <a href="/blog/2021/07/15/%E5%BB%BA%E7%AB%8B%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%AE%A4%E7%9F%A5-%E4%BB%8E-redlock-%E5%BC%80%E5%A7%8B/" title="建立对分布式锁的系统认知 - 从 Redlock 开始" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20210715e5bbbae7ab8be5afb9e58886e5b883e5bc8fe99481e79a84e7b3bbe7bb9fe8aea4e79fa5-e4bb8e-redlock-e5bc80e5a78b"><span class="">分布式锁系统认知</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-blog20210108implementation-of-redis-distributed-lock-li">
  <a href="/blog/2021/01/08/implementation-of-redis-distributed-lock/" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id="m-blog20210108implementation-of-redis-distributed-lock"><span class="td-sidebar-nav-active-item">Implementation of redis distributed lock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20201129e4b880e4b8aae4bdbfe794a8-nodejs-e79a84-redlock-e7a4bae4be8be585b3e4ba8ee5a682e4bd95e99481e5ae9ae4b880e4b8aaredise4b88ae79a84e5af86e992a5e5afb9-li">
  <a href="/blog/2020/11/29/%E4%B8%80%E4%B8%AA%E4%BD%BF%E7%94%A8-node.js-%E7%9A%84-redlock-%E7%A4%BA%E4%BE%8B%E5%85%B3%E4%BA%8E%E5%A6%82%E4%BD%95%E9%94%81%E5%AE%9A%E4%B8%80%E4%B8%AAredis%E4%B8%8A%E7%9A%84%E5%AF%86%E9%92%A5%E5%AF%B9/" title="一个使用 Node.js 的 Redlock 示例，关于如何锁定一个Redis上的密钥对" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20201129e4b880e4b8aae4bdbfe794a8-nodejs-e79a84-redlock-e7a4bae4be8be585b3e4ba8ee5a682e4bd95e99481e5ae9ae4b880e4b8aaredise4b88ae79a84e5af86e992a5e5afb9"><span class="">Redlok 示例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20200105redis-e4bdbfe794a8-lua-e8849ae69cace69bbfe4bba3-setnx--decr-e4bf9de8af81e58e9fe5ad90e680a7-li">
  <a href="/blog/2020/01/05/redis-%E4%BD%BF%E7%94%A8-lua-%E8%84%9A%E6%9C%AC%E6%9B%BF%E4%BB%A3-setnx-/-decr-%E4%BF%9D%E8%AF%81%E5%8E%9F%E5%AD%90%E6%80%A7/" title="Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20200105redis-e4bdbfe794a8-lua-e8849ae69cace69bbfe4bba3-setnx--decr-e4bf9de8af81e58e9fe5ad90e680a7"><span class="">替代 SETNX/DECR</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20191124nodejs-e4b8ade5ae9ee8b7b5e59fbae4ba8e-redis-e79a84e58886e5b883e5bc8fe99481e5ae9ee78eb0-li">
  <a href="/blog/2019/11/24/node.js-%E4%B8%AD%E5%AE%9E%E8%B7%B5%E5%9F%BA%E4%BA%8E-redis-%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E5%AE%9E%E7%8E%B0/" title="Node.js 中实践基于 Redis 的分布式锁实现" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20191124nodejs-e4b8ade5ae9ee8b7b5e59fbae4ba8e-redis-e79a84e58886e5b883e5bc8fe99481e5ae9ee78eb0"><span class="">分布式锁实现</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20191110nodejs-e4b8ade5ae9ee8b7b5-redis-lua-e8849ae69cac-li">
  <a href="/blog/2019/11/10/node.js-%E4%B8%AD%E5%AE%9E%E8%B7%B5-redis-lua-%E8%84%9A%E6%9C%AC/" title="Node.js 中实践 Redis Lua 脚本" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20191110nodejs-e4b8ade5ae9ee8b7b5-redis-lua-e8849ae69cac"><span class="">Node.js Redis Lua</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20160210is-redlock-safe-li">
  <a href="/blog/2016/02/10/is-redlock-safe/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20160210is-redlock-safe"><span class="">Is Redlock safe?</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20160210redise58886e5b883e5bc8fe99481-li">
  <a href="/blog/2016/02/10/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20160210redise58886e5b883e5bc8fe99481"><span class="">Redis分布式锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog20160208how-to-do-distributed-locking-li">
  <a href="/blog/2016/02/08/how-to-do-distributed-locking/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog20160208how-to-do-distributed-locking"><span class="">How to do distributed locking</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog10101redis-lua-e8a7a3e586b3e9ab98e5b9b6e58f91e59cbae699afe68aa2e8b4ade7a792e69d80e997aee9a298-li">
  <a href="/blog/1/01/01/redis-lua-%E8%A7%A3%E5%86%B3%E9%AB%98%E5%B9%B6%E5%8F%91%E5%9C%BA%E6%99%AF%E6%8A%A2%E8%B4%AD%E7%A7%92%E6%9D%80%E9%97%AE%E9%A2%98/" title="Redis&#43;Lua 解决高并发场景抢购秒杀问题" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog10101redis-lua-e8a7a3e586b3e9ab98e5b9b6e58f91e59cbae699afe68aa2e8b4ade7a792e69d80e997aee9a298"><span class="">Redis&#43;Lua秒杀</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog10101redise58886e5b883e5bc8fe99481-li">
  <a href="/blog/1/01/01/redis%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog10101redise58886e5b883e5bc8fe99481"><span class="">Redis分布式锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog10101e4bdbfe794a8-e690ade5bbbae794b5e59586e7a792e69d80e7b3bbe7bb9f-li">
  <a href="/blog/1/01/01/%E4%BD%BF%E7%94%A8-%E6%90%AD%E5%BB%BA%E7%94%B5%E5%95%86%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" title="使用  搭建电商秒杀系统" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog10101e4bdbfe794a8-e690ade5bbbae794b5e59586e7a792e69d80e7b3bbe7bb9f"><span class="">Redis秒杀系统</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blog10101redis-redlock-e79a84e4ba89e8aeba-li">
  <a href="/blog/1/01/01/redis-redlock-%E7%9A%84%E4%BA%89%E8%AE%BA/" title="Redis Redlock 的争论" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blog10101redis-redlock-e79a84e4ba89e8aeba"><span class="">Redlock 争论</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
<a href="https://github.com/google/docsy-example/tree/master/content/zh-cn/blog/seckill/implementation-of-redis-distributed-lock.md" class="td-page-meta--view" target="_blank" rel="noopener"><i class="fa fa-file-alt fa-fw"></i> [i18n] post_view_this</a>
  <a href="https://github.com/google/docsy-example/edit/master/content/zh-cn/blog/seckill/implementation-of-redis-distributed-lock.md" class="td-page-meta--edit" target="_blank" rel="noopener"><i class="fa fa-edit fa-fw"></i> 编辑此页</a>
  <a href="https://github.com/google/docsy-example/new/master/content/zh-cn/blog/seckill/implementation-of-redis-distributed-lock.md?filename=change-me.md&amp;value=---%0Atitle%3A&#43;%22Long&#43;Page&#43;Title%22%0AlinkTitle%3A&#43;%22Short&#43;Nav&#43;Title%22%0Aweight%3A&#43;100%0Adescription%3A&#43;%3E-%0A&#43;&#43;&#43;&#43;&#43;Page&#43;description&#43;for&#43;heading&#43;and&#43;indexes.%0A---%0A%0A%23%23&#43;Heading%0A%0AEdit&#43;this&#43;template&#43;to&#43;create&#43;your&#43;new&#43;page.%0A%0A%2A&#43;Give&#43;it&#43;a&#43;good&#43;name%2C&#43;ending&#43;in&#43;%60.md%60&#43;-&#43;e.g.&#43;%60getting-started.md%60%0A%2A&#43;Edit&#43;the&#43;%22front&#43;matter%22&#43;section&#43;at&#43;the&#43;top&#43;of&#43;the&#43;page&#43;%28weight&#43;controls&#43;how&#43;its&#43;ordered&#43;amongst&#43;other&#43;pages&#43;in&#43;the&#43;same&#43;directory%3B&#43;lowest&#43;number&#43;first%29.%0A%2A&#43;Add&#43;a&#43;good&#43;commit&#43;message&#43;at&#43;the&#43;bottom&#43;of&#43;the&#43;page&#43;%28%3C80&#43;characters%3B&#43;use&#43;the&#43;extended&#43;description&#43;field&#43;for&#43;more&#43;detail%29.%0A%2A&#43;Create&#43;a&#43;new&#43;branch&#43;so&#43;you&#43;can&#43;preview&#43;your&#43;new&#43;file&#43;and&#43;request&#43;a&#43;review&#43;via&#43;Pull&#43;Request.%0A" class="td-page-meta--child" target="_blank" rel="noopener"><i class="fa fa-edit fa-fw"></i> 添加子页面</a>
  <a href="https://github.com/google/docsy-example/issues/new?title=Implementation%20of%20redis%20distributed%20lock" class="td-page-meta--issue" target="_blank" rel="noopener"><i class="fab fa-github fa-fw"></i> 提交文档问题</a>
  <a href="https://github.com/google/docsy/issues/new" class="td-page-meta--project-issue" target="_blank" rel="noopener"><i class="fas fa-tasks fa-fw"></i> 提交项目问题</a>
  <a id="print" href="/blog/seckill/_print/"><i class="fa fa-print fa-fw"></i> 整节打印</a>

</div>

            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-定义">1. 定义</a></li>
    <li><a href="#2-分布式锁的比较">2. 分布式锁的比较</a>
      <ul>
        <li><a href="#对比">对比</a></li>
        <li><a href="#锁的必要条件">锁的必要条件</a></li>
      </ul>
    </li>
    <li><a href="#3-redis-实现分布式锁">3. Redis 实现分布式锁</a>
      <ul>
        <li><a href="#31-锁">3.1. 锁</a></li>
        <li><a href="#32-解锁">3.2. 解锁</a></li>
        <li><a href="#33-lua">3.3. lua</a></li>
        <li><a href="#34-限制和改善">3.4. 限制和改善</a></li>
      </ul>
    </li>
    <li><a href="#4-oversold-示例代码">4. “Oversold” 示例代码</a>
      <ul>
        <li><a href="#41-代码">4.1. 代码</a></li>
        <li><a href="#table-structure">Table structure</a></li>
        <li><a href="#42-测试和分析">4.2. 测试和分析</a></li>
      </ul>
    </li>
  </ul>
</nav></div>



            

	
		
			
		
		



  
  

	
		
			
		
		



  
  

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
            <a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href="/blog/seckill/index.xml" target="_blank">
              RSS <i class="fa fa-rss ml-2 "></i>
            </a>
            
<div class="td-content">
	<h1>Implementation of redis distributed lock</h1>
	
	<div class="td-byline mb-4">
		By <b>developpaper</b> |
		<time datetime="2021-01-08" class="text-muted">Friday, January 08, 2021</time>
	</div>
	<header class="article-meta">
		
		
			
				


			
				


			
		
		
	</header>
	<blockquote>
<p><a href="https://developpaper.com/implementation-of-redis-distributed-lock/">https://developpaper.com/implementation-of-redis-distributed-lock/</a></p>
</blockquote>
<p>Many novices will Distributed lock and Distributed transactionConfusion, personal understanding:lock
It is used to solve the concurrent contention for a shared resource by multiple programs;affair
It is used to ensure the consistency of a series of operations.
I’ve explained distributed transactions in several previous articles.
I’m going to talk about the implementation of 2pc, TCC and asynchronous assurance schemes.</p>
<h2 id="1-定义">1. 定义</h2>
<p>In the traditional monomer architecture, the most common lock is JDK lock.
Because the thread is the smallest unit that the operating system can run and schedule,
in Java multithreading development, it is inevitable that different threads compete for resources in the same process.
JDK library provides us with synchronized, lock and update java.util.concurrent . * etc.
However, they all have unified restrictions. Threads competing for resources are all running in the same JVM process.
In the distributed architecture, different JVM processes cannot use the lock.</p>
<p>In order to prevent multiple processes from interfering with each other in a distributed system,
we need a distributed coordination technology to schedule these processes.
And the core of this distributed coordination technology is to achieve thisDistributed lock。</p>
<p>Take a classic example of “oversold”.
In an e-commerce project, the logic of the interface can be simply divided into:</p>
<ol>
<li>Query whether the inventory is greater than zero;</li>
<li>When the inventory is greater than zero, purchase the goods.</li>
</ol>
<p>When there is only one piece in stock, both user a and user B execute the first step at the same time,
query that the inventory is one piece, and then both execute the purchase operation.
When they finished the purchase,they found that the inventory was – 1 piece.
We can lock the operations of “inventory query” and “inventory reduction” in Java code to ensure that the requests of users a and B cannot be executed concurrently.
But if our interface service is a cluster service, and the requests of user a and user B are respectively forwarded to different JVM processes by load balancing, it will not solve the problem.</p>
<h2 id="2-分布式锁的比较">2. 分布式锁的比较</h2>
<p>From the previous examples, we can see that the resource to coordinate and solve distributed locks must not be a resource at the level of the JVM process, but a shared external resource.</p>
<p>Three ways of implementation</p>
<p>There are three common ways to implement distributed lock: 1. Database lock; 2. Zookeeper based distributed lock; 3. Redis based distributed lock.</p>
<ol>
<li><strong>Database lock</strong>:
This way is easy to think of, put the competing resources into the database,
and use the database lock to realize the resource competition.
Please refer to the previous articleDatabase transactions and locks。
For example:
<ol>
<li>Pessimistic lock implementation: the “for update” can be added to the SQL query of inventory goods to achieve exclusive lock,
and the “inventory query” and “inventory reduction” can be packaged as a transaction commit.
Before the completion of user a’s query and purchase, user B’s request will be blocked.</li>
<li>Optimistic lock implementation: add the version number field in the inventory table to control.
Or more simply, when the inventory is less than zero after each purchase, the transaction can be rolled back.</li>
</ol>
</li>
<li><strong>Distributed lock of zookeeper</strong>:
zookeeper is professional in implementing distributed locks.
It is similar to a file system. It plays the role of distributed lock by competing for file resources on the file system.
Specific implementation, please refer to the previous articleDevelopment and application of zookeeper。</li>
<li><strong>Distributed lock of redis</strong>:
the previous article talked about the development,
application and transaction of redis, but never about the distributed lock of redis,
which is also the core content of this article. In short,
throughsetnxThe value of the competing key.
“Database lock” competes for table level resources or row level resources,
“zookeeper lock” competes for file resources, “redis lock” competes for key value resources.
They all implement distributed locks by competing for shared resources outside the program.</li>
</ol>
<h3 id="对比">对比</h3>
<p>However, in the field of distributed locks, zookeeper is more professional.
In essence, redis is also a database.
All the other two schemes are “part-time” to implement distributed locking, and the effect is not as good as zookeeper.</p>
<ul>
<li>Low performance consumption: when concurrent lock competition really occurs,
the implementation of database or redis basically obtains locks by blocking or constantly retrying,
which has a certain performance consumption. The zookeeper lock registers the listener.
When a program releases the lock, the next program gets the lock after listening to the message.</li>
<li>Perfect lock release mechanism: if the client from which redis obtains the lock is bugged or hung up,
it can only release the lock after the timeout; while for ZK,
because the temporary znode is created, as long as the client hangs up, the znode will be gone,
and the lock will be released automatically.</li>
<li>Strong consistency of cluster: as we all know,
zookeeper is a typical case of implementing CP transaction,
and the transaction request is always handled by the leader node in the cluster.
Redis actually implements AP transactions. If the master node fails and the master-slave switch occurs,
the lock may be lost.</li>
</ul>
<h3 id="锁的必要条件">锁的必要条件</h3>
<p>In addition, in order to ensure the availability of distributed locks,
we should at least ensure that the implementation of locks meets the following conditions at the same time:</p>
<ul>
<li>Mutual exclusion. At any time, only one client can hold the lock.</li>
<li>There is no deadlock. Even if one client crashes while holding the lock and does not unlock it,
it can ensure that other clients can lock.</li>
<li>It is necessary to tie the bell. Locking and unlocking must be the same client.
The client can’t unlock the lock added by others.</li>
</ul>
<h2 id="3-redis-实现分布式锁">3. Redis 实现分布式锁</h2>
<h3 id="31-锁">3.1. 锁</h3>
<p>Correct locking</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RedisTool</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">LOCK_SUCCESS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;OK&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">SET_IF_NOT_EXIST</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;NX&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">String</span> <span style="color:#000">SET_WITH_EXPIRE_TIME</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;PX&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     *Attempt to acquire distributed lock
</span><span style="color:#8f5902;font-style:italic">     *@ param jedis redis client
</span><span style="color:#8f5902;font-style:italic">     *@ param lockkey lock
</span><span style="color:#8f5902;font-style:italic">     *@ param requestid request ID
</span><span style="color:#8f5902;font-style:italic">     *@ param expireTime
</span><span style="color:#8f5902;font-style:italic">     *Is @ return successful
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">tryGetDistributedLock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Jedis</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">expireTime</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#000">String</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">set</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">SET_IF_NOT_EXIST</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">SET_WITH_EXPIRE_TIME</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">expireTime</span><span style="color:#ce5c00;font-weight:bold">);</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">LOCK_SUCCESS</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>To see, we lock a line of code:jedis.set(String key, String value, String nxxx, String expx, int time)This set () method has five formal parameters:</p>
<ul>
<li>key: we use the key as the lock, because the key is unique.</li>
<li>value: we are passing a request ID. many children’s shoes may not understand it. It’s enough to have a key as a lock. Why use value? The reason is that when we talked about reliability above, the distributed lock needs to satisfy the fourth condition, and it needs to be released by the ringer. By assigning value to requestid, we can know which request the lock was added, and we can have a basis when unlocking. The requestid can be used UUID.randomUUID (). Tostring() method.</li>
<li>Nxxx: for this parameter, we fill in NX, which means set if not exist. That is, when the key does not exist, we perform set operation; if the key already exists, we do not perform any operation;</li>
<li>EXPX: this parameter is Px, which means that we need to add an expired setting to the key. The specific time is determined by the fifth parameter.</li>
<li>time: corresponds to the fourth parameter, representing the expiration time of the key.</li>
</ul>
<p>In general, executing the above set () method will only result in two results:</p>
<p>If there is no lock at present (the key does not exist), lock operation will be performed, and a validity period will be set for the lock. At the same time, value indicates the locked client.
There is a lock, no operation.
Not recommended locking method (not recommended!)</p>
<p>I’ve seen many blogs that use the following method to lock, that is, the combination of setnx and GetSet to manually maintain the key expiration time.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">wrongGetLock2</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Jedis</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">expireTime</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">expires</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">currentTimeMillis</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">expireTime</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#000">String</span> <span style="color:#000">expiresStr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">valueOf</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">expires</span><span style="color:#ce5c00;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">//If the current lock does not exist, return to lock success
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setnx</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">expiresStr</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">//If the lock exists, get the expiration time of the lock
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">String</span> <span style="color:#000">currentValueStr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">currentValueStr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">Long</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">parseLong</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">currentValueStr</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">currentTimeMillis</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">//The lock has expired. Get the expiration time of the previous lock and set the expiration time of the current lock
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">String</span> <span style="color:#000">oldValueStr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getSet</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">expiresStr</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">oldValueStr</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">oldValueStr</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">currentValueStr</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">//Considering the concurrency of multiple threads, only one thread has the right to lock if its setting value is the same as the current value
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#8f5902;font-style:italic">//In other cases, the locking failure will be returned
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">;</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>On the surface, this code also implements distributed locking, and the code logic is similar to the above, but there are several problems:</p>
<p>Since the expiration time is generated by the client itself, it is mandatory that the time of each client must be synchronized in the distributed environment.
When the lock expires, if multiple clients execute it at the same time jedis.getSet () method, although only one client can lock, the expiration time of this client’s lock may be covered by other clients.
The lock does not have the owner ID, that is, any client can be unlocked.
This kind of code on the Internet may be based on the earlier versions of jedis, which had great limitations at that time. Redis 2.6.12 and above adds optional parameters to the set instruction, as mentioned abovejedis.set(String key, String value, String nxxx, String expx, int time)API, you can put theSETNXandEXPIREPackage together to execute, and release the expired key to the redis server to manage. Therefore, the actual development process, we do not use this more primitive way of locking.</p>
<h3 id="32-解锁">3.2. 解锁</h3>
<p>Correct locking</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">RedisTool</span> <span style="color:#ce5c00;font-weight:bold">{</span>

    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">Long</span> <span style="color:#000">RELEASE_SUCCESS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">1L</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     *Release distributed lock
</span><span style="color:#8f5902;font-style:italic">     *@ param jedis redis client
</span><span style="color:#8f5902;font-style:italic">     *@ param lockkey lock
</span><span style="color:#8f5902;font-style:italic">     *@ param requestid request ID
</span><span style="color:#8f5902;font-style:italic">     *@ return is released successfully
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">releaseDistributedLock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Jedis</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>

        <span style="color:#000">String</span> <span style="color:#000">script</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#000">Object</span> <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">jedis</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">eval</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Collections</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">singletonList</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">),</span> <span style="color:#000">Collections</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">singletonList</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">));</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">RELEASE_SUCCESS</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>First, get the value value corresponding to the lock, check whether it is equal to the requestid, if it is equal, delete the lock (unlock). So why use Lua? Because to ensure that the operation is atomic. BeforeThread model and transaction of redisIn this paper, we ensure the atomicity of a series of operation instructions through transaction, and Lua script can also achieve similar effect.</p>
<p>Why atomic? If a request obtains the value corresponding to the lock and verifies that the requestid is equal, it will issue a delete instruction. But because of the network and other reasons, the deletion instruction is blocked. At this time, the lock is automatically unlocked because of timeout, and B requests to acquire the lock and re lock it. At this time, a requests the deletion instruction to be executed. As a result, the lock obtained by B requests is deleted.</p>
<h3 id="33-lua">3.3. lua</h3>
<p>The computing power of redis command is not very powerful, and Lua language can make up for the deficiency of redis to a great extent. In redis, the execution of Lua language is atomic, that is to say, when redis executes Lua, it will not be interrupted and has atomicity. This feature helps redis to support the consistency of concurrent data.</p>
<p>Redis supports two ways to run scripts, one is to input some Lua language program code directly, the other is to write Lua language into a file. In practical application, some simple scripts can take the first way, and generally use the second way for those with certain logic. For simple scripts, redis supports caching scripts, but it will use SHA-1 algorithm to sign the script, and then return the SHA-1 ID, as long as it runs through this ID.</p>
<h4 id="executing-lua-in-redis">Executing Lua in redis</h4>
<p>Here is a brief introduction. The way to directly input some Lua program code can be performed in redis cli as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#000">eval</span> <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">script</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">num</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">key1</span> <span style="color:#000">key2</span> <span style="color:#000">key3</span> <span style="color:#000;font-weight:bold">....]</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">value1</span> <span style="color:#000">value2</span> <span style="color:#000">value3</span> <span style="color:#000;font-weight:bold">....]</span>

<span style="color:#8f5902;font-style:italic">--Example 1</span>
<span style="color:#000">eval</span> <span style="color:#4e9a06">&#34;return &#39;Hello World&#39;&#34;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#8f5902;font-style:italic">--Example 2</span>
<span style="color:#000">eval</span> <span style="color:#4e9a06">&#34;redis.call(&#39;set&#39;,KEYS[1],ARGV[1])&#34;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">key</span> <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">value</span>
</code></pre></div><ul>
<li>evalRepresents the execution of Lua language commands.</li>
<li>lua-scriptRepresents Lua language script.</li>
<li>key-numIt indicates how many keys there are in the parameter. It should be noted that the key in redis starts from 1. If there is no key parameter, write 0.</li>
<li>[key1 key2 key3…]Key is passed to Lua as a parameter, which can be left blank, but it needs to be corresponding to the number of key num.</li>
<li>[value1 value2 value3 …]These parameters are passed to Lua language. They can be filled in or not.</li>
</ul>
<h4 id="calling-redis-in-lua">Calling redis in Lua</h4>
<p>Using in Lua redis.call Do the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">command</span><span style="color:#000;font-weight:bold">,</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">param1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">param2</span><span style="color:#a40000">…</span><span style="color:#000;font-weight:bold">])</span>

<span style="color:#8f5902;font-style:italic">--Example 1</span>
<span style="color:#000">eval</span> <span style="color:#4e9a06">&#34;return redis.call(&#39;set&#39;,&#39;foo&#39;,&#39;bar&#39;)&#34;</span> <span style="color:#0000cf;font-weight:bold">0</span>
<span style="color:#8f5902;font-style:italic">--Example 2</span>
<span style="color:#000">eval</span> <span style="color:#4e9a06">&#34;return redis.call(&#39;set&#39;,KEYS[1],&#39;bar&#39;)&#34;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000">foo</span>
</code></pre></div><ul>
<li>commandIs the command, including set, get, del and so on.</li>
<li>keyIs the key to be operated.</li>
<li>param1,param2…Represents the parameter given to the key.</li>
</ul>
<p>For example, implement a Lua script for GetSet</p>
<p>getset.lua</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">KEYS</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">newValue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ARGV</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
<span style="color:#204a87;font-weight:bold">local</span> <span style="color:#000">oldValue</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;get&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000">redis.call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;set&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newValue</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">oldValue</span>
</code></pre></div><h3 id="34-限制和改善">3.4. 限制和改善</h3>
<p>As we said earlier, there are some limitations in the implementation of distributed lock in redis cluster. It is difficult to ensure consistency when the master and slave are replaced.</p>
<h4 id="phenomenon">phenomenon</h4>
<p>In the redis sentinel cluster, we have multiple redis, and there is a master-slave relationship between them, such as one master and two slaves. The data corresponding to our set command is written to the master library, and then synchronized to the slave library. When we apply for a lock, the corresponding command is setnx MyKey myvalue. In the redis sentinel cluster, this command first falls into the main library. Suppose that the master database is down and the data has not yet been synchronized to the slave database, sentinel will elect the master database from one of the slave databases. At this time, there is no MyKey data in our new main library. If another client executes setnx MyKey hisvalue, it will also succeed, that is, it will also get the lock. This means that two clients have acquired the lock. This is not what we want to see. Although the record of this situation is very small, it will only happen when the master-slave fails over. In most cases, most systems can tolerate this flaw, but not all systems can tolerate it.</p>
<h4 id="solve">solve</h4>
<p>In order to solve the defect in the case of fail over, anterez inventedRedlock algorithm。 Using redlock algorithm, multiple redis instances are needed. When locking, it will send setex MyKey myvalue command to most nodes, as long asIf more than half of the nodes are successful, then the locking is successful。 This is very similar to the zookeeper implementation,When the leader of zookeeper cluster broadcasts the command, more than half of the followers must feed back ack to the leader before it takes effect。</p>
<p>In practical work, we can choose the existing open source implementation, which is redlock py in Python and redlock py in JavaRedisson redlock。</p>
<p>Redlock does solve the “unreliable situation” mentioned above. However, while it solves the problem, it also brings the cost. You need multiple redis instances, you need to introduce new libraries, you need to adjust the code, and the performance will be damaged. Therefore, it is true that there is no “perfect solution”. What we need more is to be able to solve the problem according to the actual situation and conditions.</p>
<h2 id="4-oversold-示例代码">4. “Oversold” 示例代码</h2>
<p>We simulate a scene of goods rush buying: a commodity has 100 pieces in stock,
and 200 people rush to buy at the same time.
Compare the rush buying situation with lock and without lock.</p>
<h3 id="41-代码">4.1. 代码</h3>
<p>The following is the code of this demo. ORM uses JPA, so the code of Dao layer and POJO is not written in this article. There is only one interface in the controller layer, which selects whether to use the lock by passing parameters.</p>
<h3 id="table-structure">Table structure</h3>
<p>Commodity listproduct</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AUTO_INCREMENT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">amount</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>Purchase recordpurchase_history</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">purchase_history</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">AUTO_INCREMENT</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">product_name</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">purchaser</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">varchar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">purchase_time</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">datetime</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">amount</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>pom.xml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#204a87;font-weight:bold">&lt;dependencies&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!--web--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!--redis--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!--lombok--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.projectlombok<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>lombok<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!--jpa--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!--mysql--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>mysql<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>mysql-connector-java<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#8f5902;font-style:italic">&lt;!-- test--&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;scope&gt;</span>test<span style="color:#204a87;font-weight:bold">&lt;/scope&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>junit<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
        <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>junit<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
    <span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
<span style="color:#204a87;font-weight:bold">&lt;/dependencies&gt;</span>
</code></pre></div><p>application.yml</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#204a87;font-weight:bold">server</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8001</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spring</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">redis</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">localhost</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">datasource</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">driver-class-name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">com.mysql.cj.jdbc.Driver</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">url</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">jdbc:mysql://localhost:3306/demo</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">username</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#f8f8f8;text-decoration:underline">
</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">password</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">password</span><span style="color:#f8f8f8;text-decoration:underline">
</span></code></pre></div><p>ProductController.java</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@RestController</span>
<span style="color:#5c35cc;font-weight:bold">@RequestMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/product&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ProductController</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">String</span> <span style="color:#000">PRODUCT_APPLE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;apple&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">BuyService</span> <span style="color:#000">buyService</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">ProductController</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">BuyService</span> <span style="color:#000">buyService</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">buyService</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">buyService</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Purchase goods Does @ param lock have a lock Y / N
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#5c35cc;font-weight:bold">@GetMapping</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/buy&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">buy</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#5c35cc;font-weight:bold">@RequestParam</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;lock&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">required</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">String</span> <span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Y&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">equals</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">buyService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">buyProductWithLock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">PRODUCT_APPLE</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#000">buyService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">buyProduct</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">PRODUCT_APPLE</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>BuyService.java</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Service</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">BuyService</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">ProductDao</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">PurchaseHistoryDao</span> <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">LockService</span> <span style="color:#000">lockService</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">BuyService</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ProductDao</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">PurchaseHistoryDao</span> <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">LockService</span> <span style="color:#000">lockService</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">productDao</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">purchaseHistoryDao</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">;</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">lockService</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">lockService</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Purchase: no lock
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param productName
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">buyProduct</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">Product</span> <span style="color:#000">product</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">findOneByName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// Inventory minus 1
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#8f5902;font-style:italic">// Log
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">PurchaseHistory</span> <span style="color:#000">purchaseHistory</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PurchaseHistory</span><span style="color:#ce5c00;font-weight:bold">();</span>
            <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setProductName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Purchase: lock
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param productName
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">buyProductWithLock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">String</span> <span style="color:#000">uuid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">UUID</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">randomUUID</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">toString</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#8f5902;font-style:italic">// Lock
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">lock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">{</span>
                <span style="color:#204a87;font-weight:bold">break</span><span style="color:#ce5c00;font-weight:bold">;</span>
            <span style="color:#ce5c00;font-weight:bold">}</span>
            <span style="color:#000">Thread</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">sleep</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">100</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#000">Product</span> <span style="color:#000">product</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">findOneByName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
            <span style="color:#8f5902;font-style:italic">// Inventory minus 1
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#8f5902;font-style:italic">// Log
</span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">PurchaseHistory</span> <span style="color:#000">purchaseHistory</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PurchaseHistory</span><span style="color:#ce5c00;font-weight:bold">();</span>
            <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setProductName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
            <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#ce5c00;font-weight:bold">}</span>
        <span style="color:#000">lockService</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">unlock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">uuid</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>LockService.java</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#5c35cc;font-weight:bold">@Service</span>
<span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">LockService</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">StringRedisTemplate</span> <span style="color:#000">stringRedisTemplate</span><span style="color:#ce5c00;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">LockService</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StringRedisTemplate</span> <span style="color:#000">stringRedisTemplate</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">stringRedisTemplate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">stringRedisTemplate</span><span style="color:#ce5c00;font-weight:bold">;</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Lock
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param lockKey
</span><span style="color:#8f5902;font-style:italic">     * @param requestId
</span><span style="color:#8f5902;font-style:italic">     * @return
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">lock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">stringRedisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">opsForValue</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">setIfAbsent</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Duration</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">ofSeconds</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">3</span><span style="color:#ce5c00;font-weight:bold">));</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">     * Unlocking
</span><span style="color:#8f5902;font-style:italic">     *
</span><span style="color:#8f5902;font-style:italic">     * @param lockKey
</span><span style="color:#8f5902;font-style:italic">     * @param requestId
</span><span style="color:#8f5902;font-style:italic">     */</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">unlock</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">String</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#000">DefaultRedisScript</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Long</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">script</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">DefaultRedisScript</span><span style="color:#ce5c00;font-weight:bold">&lt;&gt;();</span>
        <span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setResultType</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Long</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setScriptText</span><span style="color:#ce5c00;font-weight:bold">(</span>
                <span style="color:#4e9a06">&#34;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">stringRedisTemplate</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">execute</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Collections</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">singletonList</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">lockKey</span><span style="color:#ce5c00;font-weight:bold">),</span> <span style="color:#000">requestId</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><h3 id="42-测试和分析">4.2. 测试和分析</h3>
<p>In the test case, the initial inventory of the product is 100 copies, and 200 users are simulated to buy it. According to the principle, only 100 copies can be purchased in the end.</p>
<p>If we want to simulate and test the difference between “locked” and “unlocked”, we must create the condition of “high parallelism”. Here, we should remember that it is “high parallelism”, not “high concurrency”. Because the purchase interface here is fast in response to a single request, in order to simulate the situation that multiple users call the interface at the same time, we should use multithreading locally.</p>
<p>I’ve tried a lot to simulate highly parallel environments. The first time is to write JUnit test cases, starting 200 threads to call the interface. The result is that the service will hang up as soon as there are many threads. Although the reason is not clear, JUnit should not use it in this way. The second time is to use postman to do concurrent interface test, but it is found that whether postman is a fake concurrent test or a single thread calls the interface 200 times in turn, there is no implementation of multithreading. Finally, JMeter was installed, which met my expectations.</p>
<p>When we start 200 threads to call the lock free and lock interface respectively, the test results are as follows:</p>
<p>contrast No lock It’s locked
Surplus stock 68 0
Purchase records 200 100
As you can see, there will be oversold in the case of no lock. Let’s take a look at the purchase code of no lock.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> *Purchase: no lock
</span><span style="color:#8f5902;font-style:italic"> * @param productName
</span><span style="color:#8f5902;font-style:italic"> */</span>
 <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">synchronized</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">buyProduct</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
    <span style="color:#000">Product</span> <span style="color:#000">product</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">findOneByName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">//Inventory minus 1
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getAmount</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">productDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">product</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#8f5902;font-style:italic">//Log
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">PurchaseHistory</span> <span style="color:#000">purchaseHistory</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PurchaseHistory</span><span style="color:#ce5c00;font-weight:bold">();</span>
        <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setProductName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">productName</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setAmount</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
        <span style="color:#000">purchaseHistoryDao</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">save</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">purchaseHistory</span><span style="color:#ce5c00;font-weight:bold">);</span>
    <span style="color:#ce5c00;font-weight:bold">}</span>
<span style="color:#ce5c00;font-weight:bold">}</span>
</code></pre></div><p>When multiple requests are called at the same timeproductDao.findOneByName(productName);
The result is the same. They all think that there is still inventory.
If they go to buy, the problem of oversold will appear.
To solve this problem, if it is a single process, through thesynchronized And so on.
If it is distributed multi node, we can consider the way of this paper and use redis distributed lock implementation.</p>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/blog/2020/11/29/%E4%B8%80%E4%B8%AA%E4%BD%BF%E7%94%A8-node.js-%E7%9A%84-redlock-%E7%A4%BA%E4%BE%8B%E5%85%B3%E4%BA%8E%E5%A6%82%E4%BD%95%E9%94%81%E5%AE%9A%E4%B8%80%E4%B8%AAredis%E4%B8%8A%E7%9A%84%E5%AF%86%E9%92%A5%E5%AF%B9/" aria-label="上一页 - 一个使用 Node.js 的 Redlock 示例，关于如何锁定一个Redis上的密钥对" class="btn btn-primary"><span class="mr-1">←</span>上一页</a>
  </li>
    <a href="/blog/2021/07/15/%E5%BB%BA%E7%AB%8B%E5%AF%B9%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E7%9A%84%E7%B3%BB%E7%BB%9F%E8%AE%A4%E7%9F%A5-%E4%BB%8E-redlock-%E5%BC%80%E5%A7%8B/" aria-label="下一页 - 建立对分布式锁的系统认知 - 从 Redlock 开始" class="btn btn-primary">下一页<span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Docsy Authors 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/docs/lua/about/">关于</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.7380160122c24d59789a168af05fcec445fe4e5f2069dd9f3a0c991f10269ae0.js" integrity="sha256-c4AWASLCTVl4mhaK8F/OxEX&#43;Tl8gad2fOgyZHxAmmuA=" crossorigin="anonymous"></script>




  </body>
</html>