
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.7">
    
    
      
        <title>Node Redlock5 API - Redis 文档</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.9d5733d3.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.e6a45f82.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#acquire" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="Redis 文档" class="md-header__button md-logo" aria-label="Redis 文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Redis 文档
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Node Redlock5 API
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Redis 相关文档
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../blog/" class="md-tabs__link">
        Blog
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link md-tabs__link--active">
        Docs
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Redis 文档" class="md-nav__button md-logo" aria-label="Redis 文档" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Redis 文档
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Redis 相关文档
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../../blog/">Blog</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Blog" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" type="checkbox" id="__nav_2_2" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_2">
          News
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="News" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_2">
          <span class="md-nav__icon md-icon"></span>
          News
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/news/_index/" class="md-nav__link">
        news
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2_2" type="checkbox" id="__nav_2_2_2" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_2_2">
          Lua
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Lua" data-md-level="3">
        <label class="md-nav__title" for="__nav_2_2_2">
          <span class="md-nav__icon md-icon"></span>
          Lua
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/news/lua/1993-1999/" class="md-nav__link">
        1993-1999 Lua News
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/news/lua/2000-2009/" class="md-nav__link">
        2000-2009 Lua News
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/news/lua/2010-2019/" class="md-nav__link">
        2010-2019 Lua News
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/news/lua/2020-2021/" class="md-nav__link">
        2020-2021 Lua News
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/news/lua/_index/" class="md-nav__link">
        Lua News
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_3" type="checkbox" id="__nav_2_3" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2_3">
          Seckill
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Seckill" data-md-level="2">
        <label class="md-nav__title" for="__nav_2_3">
          <span class="md-nav__icon md-icon"></span>
          Seckill
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/_index/" class="md-nav__link">
        秒杀
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/aliyun/" class="md-nav__link">
        使用  搭建电商秒杀系统
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/distlock-cn/" class="md-nav__link">
        Redis分布式锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/distlock/" class="md-nav__link">
        Redis分布式锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/example/" class="md-nav__link">
        一个使用 Node.js 的 Redlock 示例，关于如何锁定一个Redis上的密钥对
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/how-to-do-distributed-locking/" class="md-nav__link">
        How to do distributed locking
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/implementation-of-redis-distributed-lock/" class="md-nav__link">
        Implementation of redis distributed lock
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/is_redlock_safe/" class="md-nav__link">
        Is Redlock safe?
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/nodejs-case/" class="md-nav__link">
        Node.js 中实践基于 Redis 的分布式锁实现
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/nodejs-redis-lua/" class="md-nav__link">
        Node.js 中实践 Redis Lua 脚本
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/redis_lua/" class="md-nav__link">
        Redis+Lua 解决高并发场景抢购秒杀问题
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/redlock-controversy/" class="md-nav__link">
        Redis Redlock 的争论
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/redlock-system-awareness/" class="md-nav__link">
        建立对分布式锁的系统认知 - 从 Redlock 开始
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../blog/seckill/replace_setnx/" class="md-nav__link">
        Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../">Docs</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Docs" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Docs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2" type="checkbox" id="__nav_3_2" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../bull/">Bull</a>
          
            <label for="__nav_3_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Bull" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_2">
          <span class="md-nav__icon md-icon"></span>
          Bull
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/SUMMARY/" class="md-nav__link">
        Table of contents
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/_index/" class="md-nav__link">
        Bull
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/changelog/" class="md-nav__link">
        更新日志
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/what-is-bullmq/" class="md-nav__link">
        什么是 BullMQ
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_6" type="checkbox" id="__nav_3_2_6" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_6">
          Api
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Api" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_6">
          <span class="md-nav__icon md-icon"></span>
          Api
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/api/_index/" class="md-nav__link">
        API
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_7" type="checkbox" id="__nav_3_2_7" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_7">
          Bull
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Bull" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_7">
          <span class="md-nav__icon md-icon"></span>
          Bull
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/_index/" class="md-nav__link">
        Bull
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/develop/" class="md-nav__link">
        Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/important-notes/" class="md-nav__link">
        重要的笔记
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/install/" class="md-nav__link">
        安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/introduction/" class="md-nav__link">
        介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/quick-guide/" class="md-nav__link">
        快速指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_7_7" type="checkbox" id="__nav_3_2_7_7" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_7_7">
          Patterns
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Patterns" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_7_7">
          <span class="md-nav__icon md-icon"></span>
          Patterns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/patterns/_index/" class="md-nav__link">
        模式
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/patterns/custom-backoff-strategy/" class="md-nav__link">
        自定义补偿策略
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/patterns/debugging/" class="md-nav__link">
        调试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/patterns/manually-fetching-jobs/" class="md-nav__link">
        手动抓取工作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/patterns/message-queue/" class="md-nav__link">
        消息队列
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/patterns/redis-cluster/" class="md-nav__link">
        Redis 集群
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/patterns/returning-job-completions/" class="md-nav__link">
        返回工作完成
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/patterns/reusing-redis-connections/" class="md-nav__link">
        重用 Redis 连接
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_7_8" type="checkbox" id="__nav_3_2_7_8" >
      
      
      
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_7_8">
          Reference
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Reference" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_7_8">
          <span class="md-nav__icon md-icon"></span>
          Reference
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/reference/_index/" class="md-nav__link">
        参考
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/reference/events/" class="md-nav__link">
        Events
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/reference/job/" class="md-nav__link">
        Job
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull/reference/queue/" class="md-nav__link">
        Queue
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_8" type="checkbox" id="__nav_3_2_8" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_8">
          Bull 3.x migration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Bull 3.x migration" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_8">
          <span class="md-nav__icon md-icon"></span>
          Bull 3.x migration
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull-3.x-migration/_index/" class="md-nav__link">
        迁移
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bull-3.x-migration/compatibility-class/" class="md-nav__link">
        兼容性类
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_9" type="checkbox" id="__nav_3_2_9" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_9">
          Bullmq pro
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Bullmq pro" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_9">
          <span class="md-nav__icon md-icon"></span>
          Bullmq pro
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bullmq-pro/_index/" class="md-nav__link">
        Bullmq Pro
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bullmq-pro/install/" class="md-nav__link">
        安装
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bullmq-pro/introduction/" class="md-nav__link">
        介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bullmq-pro/observables/" class="md-nav__link">
        观察
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_9_5" type="checkbox" id="__nav_3_2_9_5" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_9_5">
          Groups
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Groups" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_9_5">
          <span class="md-nav__icon md-icon"></span>
          Groups
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bullmq-pro/groups/_index/" class="md-nav__link">
        Groups
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/bullmq-pro/groups/rate-limiting/" class="md-nav__link">
        速度限制
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_10" type="checkbox" id="__nav_3_2_10" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_10">
          Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guide" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_10">
          <span class="md-nav__icon md-icon"></span>
          Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/_index/" class="md-nav__link">
        指南
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/architecture/" class="md-nav__link">
        体系结构
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/connections/" class="md-nav__link">
        连接
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/events/" class="md-nav__link">
        事件
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/introduction/" class="md-nav__link">
        介绍
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/queuescheduler/" class="md-nav__link">
        QueueScheduler
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/rate-limiting/" class="md-nav__link">
        限速
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/retrying-failing-jobs/" class="md-nav__link">
        失败重试
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/returning-job-data/" class="md-nav__link">
        返回工作数据
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/workers/" class="md-nav__link">
        工人
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_10_11" type="checkbox" id="__nav_3_2_10_11" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_10_11">
          Flows
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Flows" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_10_11">
          <span class="md-nav__icon md-icon"></span>
          Flows
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/flows/_index/" class="md-nav__link">
        流
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/flows/get-flow-tree/" class="md-nav__link">
        得到流树
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_10_12" type="checkbox" id="__nav_3_2_10_12" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_10_12">
          Jobs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Jobs" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_10_12">
          <span class="md-nav__icon md-icon"></span>
          Jobs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/_index/" class="md-nav__link">
        Jobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/adding-bulks/" class="md-nav__link">
        批量添加
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/delayed/" class="md-nav__link">
        Delayed
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/fifo/" class="md-nav__link">
        FIFO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/getters/" class="md-nav__link">
        Getters
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/job-ids/" class="md-nav__link">
        Job Ids
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/lifo/" class="md-nav__link">
        LIFO
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/prioritized/" class="md-nav__link">
        优先
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/removing-job/" class="md-nav__link">
        删除工作
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/repeatable/" class="md-nav__link">
        可重复的
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/jobs/stalled/" class="md-nav__link">
        停滞不前
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_10_13" type="checkbox" id="__nav_3_2_10_13" >
      
      
      
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_10_13">
          Queues
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Queues" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_10_13">
          <span class="md-nav__icon md-icon"></span>
          Queues
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/queues/_index/" class="md-nav__link">
        队列
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/queues/removing-jobs/" class="md-nav__link">
        Drain
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_10_14" type="checkbox" id="__nav_3_2_10_14" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_10_14">
          Workers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Workers" data-md-level="4">
        <label class="md-nav__title" for="__nav_3_2_10_14">
          <span class="md-nav__icon md-icon"></span>
          Workers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/workers/_index/" class="md-nav__link">
        Workers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/workers/concurrency/" class="md-nav__link">
        Concurrency
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/workers/graceful-shutdown/" class="md-nav__link">
        Graceful shutdown
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/workers/pausing-queues/" class="md-nav__link">
        Pausing queues
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/workers/sandboxed-processors/" class="md-nav__link">
        Sandboxed processors
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/guide/workers/stalled-jobs/" class="md-nav__link">
        Stalled Jobs
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_2_11" type="checkbox" id="__nav_3_2_11" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_2_11">
          Patterns
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Patterns" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_2_11">
          <span class="md-nav__icon md-icon"></span>
          Patterns
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/_index/" class="md-nav__link">
        Patterns
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/failing-fast-when-redis-is-down/" class="md-nav__link">
        Failing fast when Redis is down
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/flows/" class="md-nav__link">
        Flows
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/idempotent-jobs/" class="md-nav__link">
        Idempotent jobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/manually-fetching-jobs/" class="md-nav__link">
        Manually processing jobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/process-step-jobs/" class="md-nav__link">
        Process Step jobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/producer-consumer/" class="md-nav__link">
        Producer - Consumer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/real-time-updates/" class="md-nav__link">
        Real time updates
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/sender-receiver/" class="md-nav__link">
        Sender - Receiver
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/throttle-jobs/" class="md-nav__link">
        Throttle jobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../bull/patterns/working-with-batches/" class="md-nav__link">
        Working with batches
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_3" type="checkbox" id="__nav_3_3" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_3">
          Egg redis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Egg redis" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_3">
          <span class="md-nav__icon md-icon"></span>
          Egg redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../egg-redis/_index/" class="md-nav__link">
        egg redis
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_4" type="checkbox" id="__nav_3_4" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_4">
          Ioredis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Ioredis" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_4">
          <span class="md-nav__icon md-icon"></span>
          Ioredis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ioredis/TLS/" class="md-nav__link">
        TLS
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ioredis/_index/" class="md-nav__link">
        ioredis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ioredis/cluster/" class="md-nav__link">
        Cluster
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ioredis/connection/" class="md-nav__link">
        连接
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ioredis/lua/" class="md-nav__link">
        Lua 脚本
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ioredis/pipelining/" class="md-nav__link">
        Pipelining
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ioredis/pub-sub/" class="md-nav__link">
        Pub/Sub
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ioredis/quick-start/" class="md-nav__link">
        快速入门
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ioredis/sentinel/" class="md-nav__link">
        Sentinel
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../ioredis/streams/" class="md-nav__link">
        流和二进制
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5" type="checkbox" id="__nav_3_5" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_5">
          Lua
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Lua" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_5">
          <span class="md-nav__icon md-icon"></span>
          Lua
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lua/_index/" class="md-nav__link">
        lua
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lua/about/" class="md-nav__link">
        关于
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lua/community/" class="md-nav__link">
        社区
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lua/docs/" class="md-nav__link">
        文档
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lua/download/" class="md-nav__link">
        下载
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lua/start/" class="md-nav__link">
        入门
      </a>
    </li>
  

            
          
            
              
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_5_7" type="checkbox" id="__nav_3_5_7" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_5_7">
          Manual
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Manual" data-md-level="3">
        <label class="md-nav__title" for="__nav_3_5_7">
          <span class="md-nav__icon md-icon"></span>
          Manual
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../lua/manual/_index/" class="md-nav__link">
        参考手册
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_6" type="checkbox" id="__nav_3_6" >
      
      
      
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_6">
          Node redis
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Node redis" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_6">
          <span class="md-nav__icon md-icon"></span>
          Node redis
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../node-redis/_index/" class="md-nav__link">
        Node Redis
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
    
  
  
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_7" type="checkbox" id="__nav_3_7" checked>
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3_7">
          Redlock
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Redlock" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_7">
          <span class="md-nav__icon md-icon"></span>
          Redlock
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../_index/" class="md-nav__link">
        Redis 锁
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../node-redlock/" class="md-nav__link">
        Node Redlock
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Node Redlock5 API
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Node Redlock5 API
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#acquire" class="md-nav__link">
    acquire
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extend" class="md-nav__link">
    extend
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../node-redlock5/" class="md-nav__link">
        Node Redlock5
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../warlock/" class="md-nav__link">
        warlock
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
            
              
  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3_8" type="checkbox" id="__nav_3_8" >
      
      
      
        
          
            
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../streams/">Streams</a>
          
            <label for="__nav_3_8">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Streams" data-md-level="2">
        <label class="md-nav__title" for="__nav_3_8">
          <span class="md-nav__icon md-icon"></span>
          Streams
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../streams/nestjs-redis-streams/" class="md-nav__link">
        @tamimaj/nestjs-redis-streams
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../streams/streams-tutorial/" class="md-nav__link">
        Redis Streams教程
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#acquire" class="md-nav__link">
    acquire
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#extend" class="md-nav__link">
    extend
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


  <h1>Node Redlock5 API</h1>

<h2 id="acquire">acquire</h2>
<p>这个方法在 <code>duration</code> 指定的持续时间内获取资源上的锁。</p>
<h2 id="extend">extend</h2>
<p>此方法通过提供的 <code>duration</code> 扩展有效锁。</p>
<div class="highlight"><span class="filename">TypeScript</span><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><a href="#__codelineno-0-1"><span class="linenos" data-linenos="  1 "></span></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">randomBytes</span><span class="p">,</span><span class="w"> </span><span class="nx">createHash</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;crypto&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><a href="#__codelineno-0-2"><span class="linenos" data-linenos="  2 "></span></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;events&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a><a href="#__codelineno-0-3"><span class="linenos" data-linenos="  3 "></span></a>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a><a href="#__codelineno-0-4"><span class="linenos" data-linenos="  4 "></span></a><span class="c1">// AbortController became available as a global in node version 16.</span><span class="w"></span>
<a id="__codelineno-0-5" name="__codelineno-0-5"></a><a href="#__codelineno-0-5"><span class="linenos" data-linenos="  5 "></span></a><span class="c1">// Once version 14 reaches its end-of-life, this can be removed.</span><span class="w"></span>
<a id="__codelineno-0-6" name="__codelineno-0-6"></a><a href="#__codelineno-0-6"><span class="linenos" data-linenos="  6 "></span></a><span class="k">import</span><span class="w"> </span><span class="nx">PolyfillAbortController</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;node-abort-controller&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-7" name="__codelineno-0-7"></a><a href="#__codelineno-0-7"><span class="linenos" data-linenos="  7 "></span></a>
<a id="__codelineno-0-8" name="__codelineno-0-8"></a><a href="#__codelineno-0-8"><span class="linenos" data-linenos="  8 "></span></a><span class="k">import</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">Redis</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">IORedisClient</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="kr">from</span><span class="w"> </span><span class="s2">&quot;ioredis&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-9" name="__codelineno-0-9"></a><a href="#__codelineno-0-9"><span class="linenos" data-linenos="  9 "></span></a><span class="kr">type</span><span class="w"> </span><span class="nx">Client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">IORedisClient</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-10" name="__codelineno-0-10"></a><a href="#__codelineno-0-10"><span class="linenos" data-linenos=" 10 "></span></a>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><a href="#__codelineno-0-11"><span class="linenos" data-linenos=" 11 "></span></a><span class="c1">// Define script constants.</span><span class="w"></span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><a href="#__codelineno-0-12"><span class="linenos" data-linenos=" 12 "></span></a><span class="kd">const</span><span class="w"> </span><span class="nx">ACQUIRE_SCRIPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><a href="#__codelineno-0-13"><span class="linenos" data-linenos=" 13 "></span></a><span class="sb">  -- Return 0 if an entry already exists.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><a href="#__codelineno-0-14"><span class="linenos" data-linenos=" 14 "></span></a><span class="sb">  for i, key in ipairs(KEYS) do</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><a href="#__codelineno-0-15"><span class="linenos" data-linenos=" 15 "></span></a><span class="sb">    if redis.call(&quot;exists&quot;, key) == 1 then</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><a href="#__codelineno-0-16"><span class="linenos" data-linenos=" 16 "></span></a><span class="sb">      return 0</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><a href="#__codelineno-0-17"><span class="linenos" data-linenos=" 17 "></span></a><span class="sb">    end</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><a href="#__codelineno-0-18"><span class="linenos" data-linenos=" 18 "></span></a><span class="sb">  end</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><a href="#__codelineno-0-19"><span class="linenos" data-linenos=" 19 "></span></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><a href="#__codelineno-0-20"><span class="linenos" data-linenos=" 20 "></span></a><span class="sb">  -- Create an entry for each provided key.</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><a href="#__codelineno-0-21"><span class="linenos" data-linenos=" 21 "></span></a><span class="sb">  for i, key in ipairs(KEYS) do</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><a href="#__codelineno-0-22"><span class="linenos" data-linenos=" 22 "></span></a><span class="sb">    redis.call(&quot;set&quot;, key, ARGV[1], &quot;PX&quot;, ARGV[2])</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><a href="#__codelineno-0-23"><span class="linenos" data-linenos=" 23 "></span></a><span class="sb">  end</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><a href="#__codelineno-0-24"><span class="linenos" data-linenos=" 24 "></span></a>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><a href="#__codelineno-0-25"><span class="linenos" data-linenos=" 25 "></span></a><span class="sb">  -- Return the number of entries added.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><a href="#__codelineno-0-26"><span class="linenos" data-linenos=" 26 "></span></a><span class="sb">  return #KEYS</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><a href="#__codelineno-0-27"><span class="linenos" data-linenos=" 27 "></span></a><span class="sb">`</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><a href="#__codelineno-0-28"><span class="linenos" data-linenos=" 28 "></span></a>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><a href="#__codelineno-0-29"><span class="linenos" data-linenos=" 29 "></span></a><span class="kd">const</span><span class="w"> </span><span class="nx">EXTEND_SCRIPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><a href="#__codelineno-0-30"><span class="linenos" data-linenos=" 30 "></span></a><span class="sb">  -- Return 0 if an entry exists with a *different* lock value.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><a href="#__codelineno-0-31"><span class="linenos" data-linenos=" 31 "></span></a><span class="sb">  for i, key in ipairs(KEYS) do</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><a href="#__codelineno-0-32"><span class="linenos" data-linenos=" 32 "></span></a><span class="sb">    if redis.call(&quot;get&quot;, key) ~= ARGV[1] then</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><a href="#__codelineno-0-33"><span class="linenos" data-linenos=" 33 "></span></a><span class="sb">      return 0</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><a href="#__codelineno-0-34"><span class="linenos" data-linenos=" 34 "></span></a><span class="sb">    end</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><a href="#__codelineno-0-35"><span class="linenos" data-linenos=" 35 "></span></a><span class="sb">  end</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><a href="#__codelineno-0-36"><span class="linenos" data-linenos=" 36 "></span></a>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><a href="#__codelineno-0-37"><span class="linenos" data-linenos=" 37 "></span></a><span class="sb">  -- Update the entry for each provided key.</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><a href="#__codelineno-0-38"><span class="linenos" data-linenos=" 38 "></span></a><span class="sb">  for i, key in ipairs(KEYS) do</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><a href="#__codelineno-0-39"><span class="linenos" data-linenos=" 39 "></span></a><span class="sb">    redis.call(&quot;set&quot;, key, ARGV[1], &quot;PX&quot;, ARGV[2])</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><a href="#__codelineno-0-40"><span class="linenos" data-linenos=" 40 "></span></a><span class="sb">  end</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><a href="#__codelineno-0-41"><span class="linenos" data-linenos=" 41 "></span></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><a href="#__codelineno-0-42"><span class="linenos" data-linenos=" 42 "></span></a><span class="sb">  -- Return the number of entries updated.</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><a href="#__codelineno-0-43"><span class="linenos" data-linenos=" 43 "></span></a><span class="sb">  return #KEYS</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><a href="#__codelineno-0-44"><span class="linenos" data-linenos=" 44 "></span></a><span class="sb">`</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><a href="#__codelineno-0-45"><span class="linenos" data-linenos=" 45 "></span></a>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><a href="#__codelineno-0-46"><span class="linenos" data-linenos=" 46 "></span></a><span class="kd">const</span><span class="w"> </span><span class="nx">RELEASE_SCRIPT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sb">`</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><a href="#__codelineno-0-47"><span class="linenos" data-linenos=" 47 "></span></a><span class="sb">  local count = 0</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><a href="#__codelineno-0-48"><span class="linenos" data-linenos=" 48 "></span></a><span class="sb">  for i, key in ipairs(KEYS) do</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><a href="#__codelineno-0-49"><span class="linenos" data-linenos=" 49 "></span></a><span class="sb">    -- Only remove entries for *this* lock value.</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><a href="#__codelineno-0-50"><span class="linenos" data-linenos=" 50 "></span></a><span class="sb">    if redis.call(&quot;get&quot;, key) == ARGV[1] then</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><a href="#__codelineno-0-51"><span class="linenos" data-linenos=" 51 "></span></a><span class="sb">      redis.pcall(&quot;del&quot;, key)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><a href="#__codelineno-0-52"><span class="linenos" data-linenos=" 52 "></span></a><span class="sb">      count = count + 1</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><a href="#__codelineno-0-53"><span class="linenos" data-linenos=" 53 "></span></a><span class="sb">    end</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><a href="#__codelineno-0-54"><span class="linenos" data-linenos=" 54 "></span></a><span class="sb">  end</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><a href="#__codelineno-0-55"><span class="linenos" data-linenos=" 55 "></span></a>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><a href="#__codelineno-0-56"><span class="linenos" data-linenos=" 56 "></span></a><span class="sb">  -- Return the number of entries removed.</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><a href="#__codelineno-0-57"><span class="linenos" data-linenos=" 57 "></span></a><span class="sb">  return count</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><a href="#__codelineno-0-58"><span class="linenos" data-linenos=" 58 "></span></a><span class="sb">`</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><a href="#__codelineno-0-59"><span class="linenos" data-linenos=" 59 "></span></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><a href="#__codelineno-0-60"><span class="linenos" data-linenos=" 60 "></span></a><span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ClientExecutionResult</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><a href="#__codelineno-0-61"><span class="linenos" data-linenos=" 61 "></span></a><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><a href="#__codelineno-0-62"><span class="linenos" data-linenos=" 62 "></span></a><span class="w">      </span><span class="nx">client</span><span class="o">:</span><span class="w"> </span><span class="kt">Client</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><a href="#__codelineno-0-63"><span class="linenos" data-linenos=" 63 "></span></a><span class="w">      </span><span class="nx">vote</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;for&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><a href="#__codelineno-0-64"><span class="linenos" data-linenos=" 64 "></span></a><span class="w">      </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><a href="#__codelineno-0-65"><span class="linenos" data-linenos=" 65 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><a href="#__codelineno-0-66"><span class="linenos" data-linenos=" 66 "></span></a><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><a href="#__codelineno-0-67"><span class="linenos" data-linenos=" 67 "></span></a><span class="w">      </span><span class="nx">client</span><span class="o">:</span><span class="w"> </span><span class="kt">Client</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><a href="#__codelineno-0-68"><span class="linenos" data-linenos=" 68 "></span></a><span class="w">      </span><span class="nx">vote</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;against&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><a href="#__codelineno-0-69"><span class="linenos" data-linenos=" 69 "></span></a><span class="w">      </span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">Error</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><a href="#__codelineno-0-70"><span class="linenos" data-linenos=" 70 "></span></a><span class="w">    </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><a href="#__codelineno-0-71"><span class="linenos" data-linenos=" 71 "></span></a>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><a href="#__codelineno-0-72"><span class="linenos" data-linenos=" 72 "></span></a><span class="cm">/*</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><a href="#__codelineno-0-73"><span class="linenos" data-linenos=" 73 "></span></a><span class="cm"> * This object contains a summary of results.</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><a href="#__codelineno-0-74"><span class="linenos" data-linenos=" 74 "></span></a><span class="cm"> */</span><span class="w"></span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><a href="#__codelineno-0-75"><span class="linenos" data-linenos=" 75 "></span></a><span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ExecutionStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><a href="#__codelineno-0-76"><span class="linenos" data-linenos=" 76 "></span></a><span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">membershipSize</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><a href="#__codelineno-0-77"><span class="linenos" data-linenos=" 77 "></span></a><span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">quorumSize</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><a href="#__codelineno-0-78"><span class="linenos" data-linenos=" 78 "></span></a><span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">votesFor</span><span class="o">:</span><span class="w"> </span><span class="kt">Set</span><span class="o">&lt;</span><span class="nx">Client</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><a href="#__codelineno-0-79"><span class="linenos" data-linenos=" 79 "></span></a><span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">votesAgainst</span><span class="o">:</span><span class="w"> </span><span class="kt">Map</span><span class="o">&lt;</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="ne">Error</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><a href="#__codelineno-0-80"><span class="linenos" data-linenos=" 80 "></span></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><a href="#__codelineno-0-81"><span class="linenos" data-linenos=" 81 "></span></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><a href="#__codelineno-0-82"><span class="linenos" data-linenos=" 82 "></span></a><span class="cm">/*</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><a href="#__codelineno-0-83"><span class="linenos" data-linenos=" 83 "></span></a><span class="cm"> * This object contains a summary of results. Because the result of an attempt</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><a href="#__codelineno-0-84"><span class="linenos" data-linenos=" 84 "></span></a><span class="cm"> * can sometimes be determined before all requests are finished, each attempt</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><a href="#__codelineno-0-85"><span class="linenos" data-linenos=" 85 "></span></a><span class="cm"> * contains a Promise that will resolve ExecutionStats once all requests are</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><a href="#__codelineno-0-86"><span class="linenos" data-linenos=" 86 "></span></a><span class="cm"> * finished. A rejection of these promises should be considered undefined</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><a href="#__codelineno-0-87"><span class="linenos" data-linenos=" 87 "></span></a><span class="cm"> * behavior and should cause a crash.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><a href="#__codelineno-0-88"><span class="linenos" data-linenos=" 88 "></span></a><span class="cm"> */</span><span class="w"></span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><a href="#__codelineno-0-89"><span class="linenos" data-linenos=" 89 "></span></a><span class="k">export</span><span class="w"> </span><span class="kr">type</span><span class="w"> </span><span class="nx">ExecutionResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><a href="#__codelineno-0-90"><span class="linenos" data-linenos=" 90 "></span></a><span class="w">  </span><span class="nx">attempts</span><span class="o">:</span><span class="w"> </span><span class="kt">ReadonlyArray</span><span class="o">&lt;</span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExecutionStats</span><span class="o">&gt;&gt;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><a href="#__codelineno-0-91"><span class="linenos" data-linenos=" 91 "></span></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><a href="#__codelineno-0-92"><span class="linenos" data-linenos=" 92 "></span></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><a href="#__codelineno-0-93"><span class="linenos" data-linenos=" 93 "></span></a><span class="cm">/**</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><a href="#__codelineno-0-94"><span class="linenos" data-linenos=" 94 "></span></a><span class="cm"> *</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><a href="#__codelineno-0-95"><span class="linenos" data-linenos=" 95 "></span></a><span class="cm"> */</span><span class="w"></span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><a href="#__codelineno-0-96"><span class="linenos" data-linenos=" 96 "></span></a><span class="k">export</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="nx">Settings</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><a href="#__codelineno-0-97"><span class="linenos" data-linenos=" 97 "></span></a><span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">driftFactor</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><a href="#__codelineno-0-98"><span class="linenos" data-linenos=" 98 "></span></a><span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">retryCount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><a href="#__codelineno-0-99"><span class="linenos" data-linenos=" 99 "></span></a><span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">retryDelay</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><a href="#__codelineno-0-100"><span class="linenos" data-linenos="100 "></span></a><span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">retryJitter</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><a href="#__codelineno-0-101"><span class="linenos" data-linenos="101 "></span></a><span class="w">  </span><span class="k">readonly</span><span class="w"> </span><span class="nx">automaticExtensionThreshold</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><a href="#__codelineno-0-102"><span class="linenos" data-linenos="102 "></span></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><a href="#__codelineno-0-103"><span class="linenos" data-linenos="103 "></span></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a><a href="#__codelineno-0-104"><span class="linenos" data-linenos="104 "></span></a><span class="c1">// Define default settings.</span><span class="w"></span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a><a href="#__codelineno-0-105"><span class="linenos" data-linenos="105 "></span></a><span class="kd">const</span><span class="w"> </span><span class="nx">defaultSettings</span><span class="o">:</span><span class="w"> </span><span class="kt">Readonly</span><span class="o">&lt;</span><span class="nx">Settings</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a><a href="#__codelineno-0-106"><span class="linenos" data-linenos="106 "></span></a><span class="w">  </span><span class="nx">driftFactor</span><span class="o">:</span><span class="w"> </span><span class="kt">0.01</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a><a href="#__codelineno-0-107"><span class="linenos" data-linenos="107 "></span></a><span class="w">  </span><span class="nx">retryCount</span><span class="o">:</span><span class="w"> </span><span class="kt">10</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a><a href="#__codelineno-0-108"><span class="linenos" data-linenos="108 "></span></a><span class="w">  </span><span class="nx">retryDelay</span><span class="o">:</span><span class="w"> </span><span class="kt">200</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a><a href="#__codelineno-0-109"><span class="linenos" data-linenos="109 "></span></a><span class="w">  </span><span class="nx">retryJitter</span><span class="o">:</span><span class="w"> </span><span class="kt">100</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a><a href="#__codelineno-0-110"><span class="linenos" data-linenos="110 "></span></a><span class="w">  </span><span class="nx">automaticExtensionThreshold</span><span class="o">:</span><span class="w"> </span><span class="kt">500</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a><a href="#__codelineno-0-111"><span class="linenos" data-linenos="111 "></span></a><span class="p">};</span><span class="w"></span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a><a href="#__codelineno-0-112"><span class="linenos" data-linenos="112 "></span></a>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a><a href="#__codelineno-0-113"><span class="linenos" data-linenos="113 "></span></a><span class="c1">// Modifyng this object is forbidden.</span><span class="w"></span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a><a href="#__codelineno-0-114"><span class="linenos" data-linenos="114 "></span></a><span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">defaultSettings</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a><a href="#__codelineno-0-115"><span class="linenos" data-linenos="115 "></span></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a><a href="#__codelineno-0-116"><span class="linenos" data-linenos="116 "></span></a><span class="cm">/*</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a><a href="#__codelineno-0-117"><span class="linenos" data-linenos="117 "></span></a><span class="cm"> * This error indicates a failure due to the existence of another lock for one</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a><a href="#__codelineno-0-118"><span class="linenos" data-linenos="118 "></span></a><span class="cm"> * or more of the requested resources.</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a><a href="#__codelineno-0-119"><span class="linenos" data-linenos="119 "></span></a><span class="cm"> */</span><span class="w"></span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a><a href="#__codelineno-0-120"><span class="linenos" data-linenos="120 "></span></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ResourceLockedError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a><a href="#__codelineno-0-121"><span class="linenos" data-linenos="121 "></span></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="k">public</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a><a href="#__codelineno-0-122"><span class="linenos" data-linenos="122 "></span></a><span class="w">    </span><span class="k">super</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a><a href="#__codelineno-0-123"><span class="linenos" data-linenos="123 "></span></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ResourceLockedError&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a><a href="#__codelineno-0-124"><span class="linenos" data-linenos="124 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a><a href="#__codelineno-0-125"><span class="linenos" data-linenos="125 "></span></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a><a href="#__codelineno-0-126"><span class="linenos" data-linenos="126 "></span></a>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a><a href="#__codelineno-0-127"><span class="linenos" data-linenos="127 "></span></a><span class="cm">/*</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a><a href="#__codelineno-0-128"><span class="linenos" data-linenos="128 "></span></a><span class="cm"> * This error indicates a failure of an operation to pass with a quorum.</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a><a href="#__codelineno-0-129"><span class="linenos" data-linenos="129 "></span></a><span class="cm"> */</span><span class="w"></span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a><a href="#__codelineno-0-130"><span class="linenos" data-linenos="130 "></span></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">ExecutionError</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a><a href="#__codelineno-0-131"><span class="linenos" data-linenos="131 "></span></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a><a href="#__codelineno-0-132"><span class="linenos" data-linenos="132 "></span></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">message</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><a href="#__codelineno-0-133"><span class="linenos" data-linenos="133 "></span></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">attempts</span><span class="o">:</span><span class="w"> </span><span class="kt">ReadonlyArray</span><span class="o">&lt;</span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExecutionStats</span><span class="o">&gt;&gt;</span><span class="w"></span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><a href="#__codelineno-0-134"><span class="linenos" data-linenos="134 "></span></a><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><a href="#__codelineno-0-135"><span class="linenos" data-linenos="135 "></span></a><span class="w">    </span><span class="k">super</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><a href="#__codelineno-0-136"><span class="linenos" data-linenos="136 "></span></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;ExecutionError&quot;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a><a href="#__codelineno-0-137"><span class="linenos" data-linenos="137 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a><a href="#__codelineno-0-138"><span class="linenos" data-linenos="138 "></span></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><span class="filename">TypeScript</span><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><a href="#__codelineno-1-1"><span class="linenos" data-linenos=" 1 "></span></a><span class="cm">/*</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><a href="#__codelineno-1-2"><span class="linenos" data-linenos=" 2 "></span></a><span class="cm"> * An object of this type is returned when a resource is successfully locked. It</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a><a href="#__codelineno-1-3"><span class="linenos" data-linenos=" 3 "></span></a><span class="cm"> * contains convenience methods `release` and `extend` which perform the</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a><a href="#__codelineno-1-4"><span class="linenos" data-linenos=" 4 "></span></a><span class="cm"> * associated Redlock method on itself.</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a><a href="#__codelineno-1-5"><span class="linenos" data-linenos=" 5 "></span></a><span class="cm"> */</span><span class="w"></span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><a href="#__codelineno-1-6"><span class="linenos" data-linenos=" 6 "></span></a><span class="k">export</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Lock</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a><a href="#__codelineno-1-7"><span class="linenos" data-linenos=" 7 "></span></a><span class="w">  </span><span class="kr">constructor</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a><a href="#__codelineno-1-8"><span class="linenos" data-linenos=" 8 "></span></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">redlock</span><span class="o">:</span><span class="w"> </span><span class="kt">Redlock</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a><a href="#__codelineno-1-9"><span class="linenos" data-linenos=" 9 "></span></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">resources</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[],</span><span class="w"></span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a><a href="#__codelineno-1-10"><span class="linenos" data-linenos="10 "></span></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a><a href="#__codelineno-1-11"><span class="linenos" data-linenos="11 "></span></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">attempts</span><span class="o">:</span><span class="w"> </span><span class="kt">ReadonlyArray</span><span class="o">&lt;</span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExecutionStats</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a><a href="#__codelineno-1-12"><span class="linenos" data-linenos="12 "></span></a><span class="w">    </span><span class="k">public</span><span class="w"> </span><span class="nx">expiration</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="w"></span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a><a href="#__codelineno-1-13"><span class="linenos" data-linenos="13 "></span></a><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a><a href="#__codelineno-1-14"><span class="linenos" data-linenos="14 "></span></a>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a><a href="#__codelineno-1-15"><span class="linenos" data-linenos="15 "></span></a><span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">release</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExecutionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a><a href="#__codelineno-1-16"><span class="linenos" data-linenos="16 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">redlock</span><span class="p">.</span><span class="nx">release</span><span class="p">(</span><span class="k">this</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-1-17" name="__codelineno-1-17"></a><a href="#__codelineno-1-17"><span class="linenos" data-linenos="17 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-1-18" name="__codelineno-1-18"></a><a href="#__codelineno-1-18"><span class="linenos" data-linenos="18 "></span></a>
<a id="__codelineno-1-19" name="__codelineno-1-19"></a><a href="#__codelineno-1-19"><span class="linenos" data-linenos="19 "></span></a><span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">extend</span><span class="p">(</span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Lock</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-1-20" name="__codelineno-1-20"></a><a href="#__codelineno-1-20"><span class="linenos" data-linenos="20 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">redlock</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-1-21" name="__codelineno-1-21"></a><a href="#__codelineno-1-21"><span class="linenos" data-linenos="21 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-1-22" name="__codelineno-1-22"></a><a href="#__codelineno-1-22"><span class="linenos" data-linenos="22 "></span></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-1-23" name="__codelineno-1-23"></a><a href="#__codelineno-1-23"><span class="linenos" data-linenos="23 "></span></a>
<a id="__codelineno-1-24" name="__codelineno-1-24"></a><a href="#__codelineno-1-24"><span class="linenos" data-linenos="24 "></span></a><span class="kr">type</span><span class="w"> </span><span class="nx">RedlockAbortSignal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">AbortSignal</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">error?</span><span class="o">:</span><span class="w"> </span><span class="kt">Error</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><span class="filename">TypeScript</span><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><a href="#__codelineno-2-1"><span class="linenos" data-linenos="  1 "></span></a><span class="cm">/**</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a><a href="#__codelineno-2-2"><span class="linenos" data-linenos="  2 "></span></a><span class="cm"> * A redlock object is instantiated with an array of at least one redis client</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a><a href="#__codelineno-2-3"><span class="linenos" data-linenos="  3 "></span></a><span class="cm"> * and an optional `options` object. Properties of the Redlock object should NOT</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a><a href="#__codelineno-2-4"><span class="linenos" data-linenos="  4 "></span></a><span class="cm"> * be changed after it is first used, as doing so could have unintended</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a><a href="#__codelineno-2-5"><span class="linenos" data-linenos="  5 "></span></a><span class="cm"> * consequences for live locks.</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a><a href="#__codelineno-2-6"><span class="linenos" data-linenos="  6 "></span></a><span class="cm"> */</span><span class="w"></span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a><a href="#__codelineno-2-7"><span class="linenos" data-linenos="  7 "></span></a><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nx">Redlock</span><span class="w"> </span><span class="k">extends</span><span class="w"> </span><span class="nx">EventEmitter</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a><a href="#__codelineno-2-8"><span class="linenos" data-linenos="  8 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">clients</span><span class="o">:</span><span class="w"> </span><span class="kt">Set</span><span class="o">&lt;</span><span class="nx">Client</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a><a href="#__codelineno-2-9"><span class="linenos" data-linenos="  9 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">settings</span><span class="o">:</span><span class="w"> </span><span class="kt">Settings</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a><a href="#__codelineno-2-10"><span class="linenos" data-linenos=" 10 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">readonly</span><span class="w"> </span><span class="nx">scripts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a><a href="#__codelineno-2-11"><span class="linenos" data-linenos=" 11 "></span></a><span class="w">    </span><span class="k">readonly</span><span class="w"> </span><span class="nx">acquireScript</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a><a href="#__codelineno-2-12"><span class="linenos" data-linenos=" 12 "></span></a><span class="w">    </span><span class="k">readonly</span><span class="w"> </span><span class="nx">extendScript</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a><a href="#__codelineno-2-13"><span class="linenos" data-linenos=" 13 "></span></a><span class="w">    </span><span class="k">readonly</span><span class="w"> </span><span class="nx">releaseScript</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a><a href="#__codelineno-2-14"><span class="linenos" data-linenos=" 14 "></span></a><span class="w">  </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a><a href="#__codelineno-2-15"><span class="linenos" data-linenos=" 15 "></span></a>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a><a href="#__codelineno-2-16"><span class="linenos" data-linenos=" 16 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="kr">constructor</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a><a href="#__codelineno-2-17"><span class="linenos" data-linenos=" 17 "></span></a><span class="w">    </span><span class="nx">clients</span><span class="o">:</span><span class="w"> </span><span class="kt">Iterable</span><span class="o">&lt;</span><span class="nx">Client</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a><a href="#__codelineno-2-18"><span class="linenos" data-linenos=" 18 "></span></a><span class="w">    </span><span class="nx">settings</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">Settings</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{},</span><span class="w"></span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a><a href="#__codelineno-2-19"><span class="linenos" data-linenos=" 19 "></span></a><span class="w">    </span><span class="nx">scripts</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a><a href="#__codelineno-2-20"><span class="linenos" data-linenos=" 20 "></span></a><span class="w">      </span><span class="k">readonly</span><span class="w"> </span><span class="nx">acquireScript?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="nx">script</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a><a href="#__codelineno-2-21"><span class="linenos" data-linenos=" 21 "></span></a><span class="w">      </span><span class="k">readonly</span><span class="w"> </span><span class="nx">extendScript?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="nx">script</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-22" name="__codelineno-2-22"></a><a href="#__codelineno-2-22"><span class="linenos" data-linenos=" 22 "></span></a><span class="w">      </span><span class="k">readonly</span><span class="w"> </span><span class="nx">releaseScript?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="nx">script</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="kt">string</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-23" name="__codelineno-2-23"></a><a href="#__codelineno-2-23"><span class="linenos" data-linenos=" 23 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-2-24" name="__codelineno-2-24"></a><a href="#__codelineno-2-24"><span class="linenos" data-linenos=" 24 "></span></a><span class="w">  </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-25" name="__codelineno-2-25"></a><a href="#__codelineno-2-25"><span class="linenos" data-linenos=" 25 "></span></a><span class="w">    </span><span class="k">super</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-26" name="__codelineno-2-26"></a><a href="#__codelineno-2-26"><span class="linenos" data-linenos=" 26 "></span></a>
<a id="__codelineno-2-27" name="__codelineno-2-27"></a><a href="#__codelineno-2-27"><span class="linenos" data-linenos=" 27 "></span></a><span class="w">    </span><span class="c1">// Prevent crashes on error events.</span><span class="w"></span>
<a id="__codelineno-2-28" name="__codelineno-2-28"></a><a href="#__codelineno-2-28"><span class="linenos" data-linenos=" 28 "></span></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-29" name="__codelineno-2-29"></a><a href="#__codelineno-2-29"><span class="linenos" data-linenos=" 29 "></span></a><span class="w">      </span><span class="c1">// Because redlock is designed for high availability, it does not care if</span><span class="w"></span>
<a id="__codelineno-2-30" name="__codelineno-2-30"></a><a href="#__codelineno-2-30"><span class="linenos" data-linenos=" 30 "></span></a><span class="w">      </span><span class="c1">// a minority of redis instances/clusters fail at an operation.</span><span class="w"></span>
<a id="__codelineno-2-31" name="__codelineno-2-31"></a><a href="#__codelineno-2-31"><span class="linenos" data-linenos=" 31 "></span></a><span class="w">      </span><span class="c1">//</span><span class="w"></span>
<a id="__codelineno-2-32" name="__codelineno-2-32"></a><a href="#__codelineno-2-32"><span class="linenos" data-linenos=" 32 "></span></a><span class="w">      </span><span class="c1">// However, it can be helpful to monitor and log such cases. Redlock emits</span><span class="w"></span>
<a id="__codelineno-2-33" name="__codelineno-2-33"></a><a href="#__codelineno-2-33"><span class="linenos" data-linenos=" 33 "></span></a><span class="w">      </span><span class="c1">// an &quot;error&quot; event whenever it encounters an error, even if the error is</span><span class="w"></span>
<a id="__codelineno-2-34" name="__codelineno-2-34"></a><a href="#__codelineno-2-34"><span class="linenos" data-linenos=" 34 "></span></a><span class="w">      </span><span class="c1">// ignored in its normal operation.</span><span class="w"></span>
<a id="__codelineno-2-35" name="__codelineno-2-35"></a><a href="#__codelineno-2-35"><span class="linenos" data-linenos=" 35 "></span></a><span class="w">      </span><span class="c1">//</span><span class="w"></span>
<a id="__codelineno-2-36" name="__codelineno-2-36"></a><a href="#__codelineno-2-36"><span class="linenos" data-linenos=" 36 "></span></a><span class="w">      </span><span class="c1">// This function serves to prevent node&#39;s default behavior of crashing</span><span class="w"></span>
<a id="__codelineno-2-37" name="__codelineno-2-37"></a><a href="#__codelineno-2-37"><span class="linenos" data-linenos=" 37 "></span></a><span class="w">      </span><span class="c1">// when an &quot;error&quot; event is emitted in the absence of listeners.</span><span class="w"></span>
<a id="__codelineno-2-38" name="__codelineno-2-38"></a><a href="#__codelineno-2-38"><span class="linenos" data-linenos=" 38 "></span></a><span class="w">    </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-2-39" name="__codelineno-2-39"></a><a href="#__codelineno-2-39"><span class="linenos" data-linenos=" 39 "></span></a>
<a id="__codelineno-2-40" name="__codelineno-2-40"></a><a href="#__codelineno-2-40"><span class="linenos" data-linenos=" 40 "></span></a><span class="w">    </span><span class="c1">// Create a new array of client, to ensure no accidental mutation.</span><span class="w"></span>
<a id="__codelineno-2-41" name="__codelineno-2-41"></a><a href="#__codelineno-2-41"><span class="linenos" data-linenos=" 41 "></span></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Set</span><span class="p">(</span><span class="nx">clients</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-42" name="__codelineno-2-42"></a><a href="#__codelineno-2-42"><span class="linenos" data-linenos=" 42 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">size</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-43" name="__codelineno-2-43"></a><a href="#__codelineno-2-43"><span class="linenos" data-linenos=" 43 "></span></a><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-44" name="__codelineno-2-44"></a><a href="#__codelineno-2-44"><span class="linenos" data-linenos=" 44 "></span></a><span class="w">        </span><span class="s2">&quot;Redlock must be instantiated with at least one redis client.&quot;</span><span class="w"></span>
<a id="__codelineno-2-45" name="__codelineno-2-45"></a><a href="#__codelineno-2-45"><span class="linenos" data-linenos=" 45 "></span></a><span class="w">      </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-46" name="__codelineno-2-46"></a><a href="#__codelineno-2-46"><span class="linenos" data-linenos=" 46 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-47" name="__codelineno-2-47"></a><a href="#__codelineno-2-47"><span class="linenos" data-linenos=" 47 "></span></a>
<a id="__codelineno-2-48" name="__codelineno-2-48"></a><a href="#__codelineno-2-48"><span class="linenos" data-linenos=" 48 "></span></a><span class="w">    </span><span class="c1">// Customize the settings for this instance.</span><span class="w"></span>
<a id="__codelineno-2-49" name="__codelineno-2-49"></a><a href="#__codelineno-2-49"><span class="linenos" data-linenos=" 49 "></span></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-50" name="__codelineno-2-50"></a><a href="#__codelineno-2-50"><span class="linenos" data-linenos=" 50 "></span></a><span class="w">      </span><span class="nx">driftFactor</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-2-51" name="__codelineno-2-51"></a><a href="#__codelineno-2-51"><span class="linenos" data-linenos=" 51 "></span></a><span class="w">        </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">settings</span><span class="p">.</span><span class="nx">driftFactor</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="w"></span>
<a id="__codelineno-2-52" name="__codelineno-2-52"></a><a href="#__codelineno-2-52"><span class="linenos" data-linenos=" 52 "></span></a><span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">settings.driftFactor</span><span class="w"></span>
<a id="__codelineno-2-53" name="__codelineno-2-53"></a><a href="#__codelineno-2-53"><span class="linenos" data-linenos=" 53 "></span></a><span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">defaultSettings.driftFactor</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-54" name="__codelineno-2-54"></a><a href="#__codelineno-2-54"><span class="linenos" data-linenos=" 54 "></span></a><span class="w">      </span><span class="nx">retryCount</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-2-55" name="__codelineno-2-55"></a><a href="#__codelineno-2-55"><span class="linenos" data-linenos=" 55 "></span></a><span class="w">        </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">settings</span><span class="p">.</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="w"></span>
<a id="__codelineno-2-56" name="__codelineno-2-56"></a><a href="#__codelineno-2-56"><span class="linenos" data-linenos=" 56 "></span></a><span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">settings.retryCount</span><span class="w"></span>
<a id="__codelineno-2-57" name="__codelineno-2-57"></a><a href="#__codelineno-2-57"><span class="linenos" data-linenos=" 57 "></span></a><span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">defaultSettings.retryCount</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-58" name="__codelineno-2-58"></a><a href="#__codelineno-2-58"><span class="linenos" data-linenos=" 58 "></span></a><span class="w">      </span><span class="nx">retryDelay</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-2-59" name="__codelineno-2-59"></a><a href="#__codelineno-2-59"><span class="linenos" data-linenos=" 59 "></span></a><span class="w">        </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">settings</span><span class="p">.</span><span class="nx">retryDelay</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="w"></span>
<a id="__codelineno-2-60" name="__codelineno-2-60"></a><a href="#__codelineno-2-60"><span class="linenos" data-linenos=" 60 "></span></a><span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">settings.retryDelay</span><span class="w"></span>
<a id="__codelineno-2-61" name="__codelineno-2-61"></a><a href="#__codelineno-2-61"><span class="linenos" data-linenos=" 61 "></span></a><span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">defaultSettings.retryDelay</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-62" name="__codelineno-2-62"></a><a href="#__codelineno-2-62"><span class="linenos" data-linenos=" 62 "></span></a><span class="w">      </span><span class="nx">retryJitter</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-2-63" name="__codelineno-2-63"></a><a href="#__codelineno-2-63"><span class="linenos" data-linenos=" 63 "></span></a><span class="w">        </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">settings</span><span class="p">.</span><span class="nx">retryJitter</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="w"></span>
<a id="__codelineno-2-64" name="__codelineno-2-64"></a><a href="#__codelineno-2-64"><span class="linenos" data-linenos=" 64 "></span></a><span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">settings.retryJitter</span><span class="w"></span>
<a id="__codelineno-2-65" name="__codelineno-2-65"></a><a href="#__codelineno-2-65"><span class="linenos" data-linenos=" 65 "></span></a><span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">defaultSettings.retryJitter</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-66" name="__codelineno-2-66"></a><a href="#__codelineno-2-66"><span class="linenos" data-linenos=" 66 "></span></a><span class="w">      </span><span class="nx">automaticExtensionThreshold</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-2-67" name="__codelineno-2-67"></a><a href="#__codelineno-2-67"><span class="linenos" data-linenos=" 67 "></span></a><span class="w">        </span><span class="kt">typeof</span><span class="w"> </span><span class="nx">settings</span><span class="p">.</span><span class="nx">automaticExtensionThreshold</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="w"></span>
<a id="__codelineno-2-68" name="__codelineno-2-68"></a><a href="#__codelineno-2-68"><span class="linenos" data-linenos=" 68 "></span></a><span class="w">          </span><span class="o">?</span><span class="w"> </span><span class="nx">settings.automaticExtensionThreshold</span><span class="w"></span>
<a id="__codelineno-2-69" name="__codelineno-2-69"></a><a href="#__codelineno-2-69"><span class="linenos" data-linenos=" 69 "></span></a><span class="w">          </span><span class="o">:</span><span class="w"> </span><span class="kt">defaultSettings.automaticExtensionThreshold</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-70" name="__codelineno-2-70"></a><a href="#__codelineno-2-70"><span class="linenos" data-linenos=" 70 "></span></a><span class="w">    </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-71" name="__codelineno-2-71"></a><a href="#__codelineno-2-71"><span class="linenos" data-linenos=" 71 "></span></a>
<a id="__codelineno-2-72" name="__codelineno-2-72"></a><a href="#__codelineno-2-72"><span class="linenos" data-linenos=" 72 "></span></a><span class="w">    </span><span class="c1">// Use custom scripts and script modifiers.</span><span class="w"></span>
<a id="__codelineno-2-73" name="__codelineno-2-73"></a><a href="#__codelineno-2-73"><span class="linenos" data-linenos=" 73 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">acquireScript</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<a id="__codelineno-2-74" name="__codelineno-2-74"></a><a href="#__codelineno-2-74"><span class="linenos" data-linenos=" 74 "></span></a><span class="w">      </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">scripts</span><span class="p">.</span><span class="nx">acquireScript</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;function&quot;</span><span class="w"></span>
<a id="__codelineno-2-75" name="__codelineno-2-75"></a><a href="#__codelineno-2-75"><span class="linenos" data-linenos=" 75 "></span></a><span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">scripts</span><span class="p">.</span><span class="nx">acquireScript</span><span class="p">(</span><span class="nx">ACQUIRE_SCRIPT</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-2-76" name="__codelineno-2-76"></a><a href="#__codelineno-2-76"><span class="linenos" data-linenos=" 76 "></span></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="nx">ACQUIRE_SCRIPT</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-77" name="__codelineno-2-77"></a><a href="#__codelineno-2-77"><span class="linenos" data-linenos=" 77 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">extendScript</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<a id="__codelineno-2-78" name="__codelineno-2-78"></a><a href="#__codelineno-2-78"><span class="linenos" data-linenos=" 78 "></span></a><span class="w">      </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">scripts</span><span class="p">.</span><span class="nx">extendScript</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;function&quot;</span><span class="w"></span>
<a id="__codelineno-2-79" name="__codelineno-2-79"></a><a href="#__codelineno-2-79"><span class="linenos" data-linenos=" 79 "></span></a><span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">scripts</span><span class="p">.</span><span class="nx">extendScript</span><span class="p">(</span><span class="nx">EXTEND_SCRIPT</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-2-80" name="__codelineno-2-80"></a><a href="#__codelineno-2-80"><span class="linenos" data-linenos=" 80 "></span></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="nx">EXTEND_SCRIPT</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-81" name="__codelineno-2-81"></a><a href="#__codelineno-2-81"><span class="linenos" data-linenos=" 81 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">releaseScript</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<a id="__codelineno-2-82" name="__codelineno-2-82"></a><a href="#__codelineno-2-82"><span class="linenos" data-linenos=" 82 "></span></a><span class="w">      </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">scripts</span><span class="p">.</span><span class="nx">releaseScript</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;function&quot;</span><span class="w"></span>
<a id="__codelineno-2-83" name="__codelineno-2-83"></a><a href="#__codelineno-2-83"><span class="linenos" data-linenos=" 83 "></span></a><span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="nx">scripts</span><span class="p">.</span><span class="nx">releaseScript</span><span class="p">(</span><span class="nx">RELEASE_SCRIPT</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-2-84" name="__codelineno-2-84"></a><a href="#__codelineno-2-84"><span class="linenos" data-linenos=" 84 "></span></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="nx">RELEASE_SCRIPT</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-85" name="__codelineno-2-85"></a><a href="#__codelineno-2-85"><span class="linenos" data-linenos=" 85 "></span></a>
<a id="__codelineno-2-86" name="__codelineno-2-86"></a><a href="#__codelineno-2-86"><span class="linenos" data-linenos=" 86 "></span></a><span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="nx">scripts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-87" name="__codelineno-2-87"></a><a href="#__codelineno-2-87"><span class="linenos" data-linenos=" 87 "></span></a><span class="w">      </span><span class="nx">acquireScript</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-88" name="__codelineno-2-88"></a><a href="#__codelineno-2-88"><span class="linenos" data-linenos=" 88 "></span></a><span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">acquireScript</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-89" name="__codelineno-2-89"></a><a href="#__codelineno-2-89"><span class="linenos" data-linenos=" 89 "></span></a><span class="w">        </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="kt">this._hash</span><span class="p">(</span><span class="nx">acquireScript</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-2-90" name="__codelineno-2-90"></a><a href="#__codelineno-2-90"><span class="linenos" data-linenos=" 90 "></span></a><span class="w">      </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-2-91" name="__codelineno-2-91"></a><a href="#__codelineno-2-91"><span class="linenos" data-linenos=" 91 "></span></a><span class="w">      </span><span class="nx">extendScript</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-92" name="__codelineno-2-92"></a><a href="#__codelineno-2-92"><span class="linenos" data-linenos=" 92 "></span></a><span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">extendScript</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-93" name="__codelineno-2-93"></a><a href="#__codelineno-2-93"><span class="linenos" data-linenos=" 93 "></span></a><span class="w">        </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="kt">this._hash</span><span class="p">(</span><span class="nx">extendScript</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-2-94" name="__codelineno-2-94"></a><a href="#__codelineno-2-94"><span class="linenos" data-linenos=" 94 "></span></a><span class="w">      </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-2-95" name="__codelineno-2-95"></a><a href="#__codelineno-2-95"><span class="linenos" data-linenos=" 95 "></span></a><span class="w">      </span><span class="nx">releaseScript</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-96" name="__codelineno-2-96"></a><a href="#__codelineno-2-96"><span class="linenos" data-linenos=" 96 "></span></a><span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">releaseScript</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-97" name="__codelineno-2-97"></a><a href="#__codelineno-2-97"><span class="linenos" data-linenos=" 97 "></span></a><span class="w">        </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="kt">this._hash</span><span class="p">(</span><span class="nx">releaseScript</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-2-98" name="__codelineno-2-98"></a><a href="#__codelineno-2-98"><span class="linenos" data-linenos=" 98 "></span></a><span class="w">      </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-2-99" name="__codelineno-2-99"></a><a href="#__codelineno-2-99"><span class="linenos" data-linenos=" 99 "></span></a><span class="w">    </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-100" name="__codelineno-2-100"></a><a href="#__codelineno-2-100"><span class="linenos" data-linenos="100 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-101" name="__codelineno-2-101"></a><a href="#__codelineno-2-101"><span class="linenos" data-linenos="101 "></span></a>
<a id="__codelineno-2-102" name="__codelineno-2-102"></a><a href="#__codelineno-2-102"><span class="linenos" data-linenos="102 "></span></a><span class="w">  </span><span class="cm">/**</span>
<a id="__codelineno-2-103" name="__codelineno-2-103"></a><a href="#__codelineno-2-103"><span class="linenos" data-linenos="103 "></span></a><span class="cm">   * Generate a sha1 hash compatible with redis evalsha.</span>
<a id="__codelineno-2-104" name="__codelineno-2-104"></a><a href="#__codelineno-2-104"><span class="linenos" data-linenos="104 "></span></a><span class="cm">   */</span><span class="w"></span>
<a id="__codelineno-2-105" name="__codelineno-2-105"></a><a href="#__codelineno-2-105"><span class="linenos" data-linenos="105 "></span></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">_hash</span><span class="p">(</span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-106" name="__codelineno-2-106"></a><a href="#__codelineno-2-106"><span class="linenos" data-linenos="106 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">createHash</span><span class="p">(</span><span class="s2">&quot;sha1&quot;</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-107" name="__codelineno-2-107"></a><a href="#__codelineno-2-107"><span class="linenos" data-linenos="107 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-108" name="__codelineno-2-108"></a><a href="#__codelineno-2-108"><span class="linenos" data-linenos="108 "></span></a>
<a id="__codelineno-2-109" name="__codelineno-2-109"></a><a href="#__codelineno-2-109"><span class="linenos" data-linenos="109 "></span></a><span class="w">  </span><span class="cm">/**</span>
<a id="__codelineno-2-110" name="__codelineno-2-110"></a><a href="#__codelineno-2-110"><span class="linenos" data-linenos="110 "></span></a><span class="cm">   * Generate a cryptographically random string.</span>
<a id="__codelineno-2-111" name="__codelineno-2-111"></a><a href="#__codelineno-2-111"><span class="linenos" data-linenos="111 "></span></a><span class="cm">   */</span><span class="w"></span>
<a id="__codelineno-2-112" name="__codelineno-2-112"></a><a href="#__codelineno-2-112"><span class="linenos" data-linenos="112 "></span></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="nx">_random</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-113" name="__codelineno-2-113"></a><a href="#__codelineno-2-113"><span class="linenos" data-linenos="113 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">randomBytes</span><span class="p">(</span><span class="mf">16</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s2">&quot;hex&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-114" name="__codelineno-2-114"></a><a href="#__codelineno-2-114"><span class="linenos" data-linenos="114 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-115" name="__codelineno-2-115"></a><a href="#__codelineno-2-115"><span class="linenos" data-linenos="115 "></span></a>
<a id="__codelineno-2-116" name="__codelineno-2-116"></a><a href="#__codelineno-2-116"><span class="linenos" data-linenos="116 "></span></a><span class="w">  </span><span class="cm">/**</span>
<a id="__codelineno-2-117" name="__codelineno-2-117"></a><a href="#__codelineno-2-117"><span class="linenos" data-linenos="117 "></span></a><span class="cm">   * This method runs `.quit()` on all client connections.</span>
<a id="__codelineno-2-118" name="__codelineno-2-118"></a><a href="#__codelineno-2-118"><span class="linenos" data-linenos="118 "></span></a><span class="cm">   */</span><span class="w"></span>
<a id="__codelineno-2-119" name="__codelineno-2-119"></a><a href="#__codelineno-2-119"><span class="linenos" data-linenos="119 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">quit</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-120" name="__codelineno-2-120"></a><a href="#__codelineno-2-120"><span class="linenos" data-linenos="120 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"></span>
<a id="__codelineno-2-121" name="__codelineno-2-121"></a><a href="#__codelineno-2-121"><span class="linenos" data-linenos="121 "></span></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-122" name="__codelineno-2-122"></a><a href="#__codelineno-2-122"><span class="linenos" data-linenos="122 "></span></a><span class="w">      </span><span class="nx">results</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">quit</span><span class="p">());</span><span class="w"></span>
<a id="__codelineno-2-123" name="__codelineno-2-123"></a><a href="#__codelineno-2-123"><span class="linenos" data-linenos="123 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-124" name="__codelineno-2-124"></a><a href="#__codelineno-2-124"><span class="linenos" data-linenos="124 "></span></a>
<a id="__codelineno-2-125" name="__codelineno-2-125"></a><a href="#__codelineno-2-125"><span class="linenos" data-linenos="125 "></span></a><span class="w">    </span><span class="k">await</span><span class="w"> </span><span class="nb">Promise</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">results</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-126" name="__codelineno-2-126"></a><a href="#__codelineno-2-126"><span class="linenos" data-linenos="126 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-127" name="__codelineno-2-127"></a><a href="#__codelineno-2-127"><span class="linenos" data-linenos="127 "></span></a>
<a id="__codelineno-2-128" name="__codelineno-2-128"></a><a href="#__codelineno-2-128"><span class="linenos" data-linenos="128 "></span></a><span class="w">  </span><span class="cm">/**</span>
<a id="__codelineno-2-129" name="__codelineno-2-129"></a><a href="#__codelineno-2-129"><span class="linenos" data-linenos="129 "></span></a><span class="cm">   * 这个方法在 `duration` 指定的持续时间内获取资源上的锁。</span>
<a id="__codelineno-2-130" name="__codelineno-2-130"></a><a href="#__codelineno-2-130"><span class="linenos" data-linenos="130 "></span></a><span class="cm">   */</span><span class="w"></span>
<a id="__codelineno-2-131" name="__codelineno-2-131"></a><a href="#__codelineno-2-131"><span class="linenos" data-linenos="131 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">acquire</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-132" name="__codelineno-2-132"></a><a href="#__codelineno-2-132"><span class="linenos" data-linenos="132 "></span></a><span class="w">    </span><span class="nx">resources</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[],</span><span class="w"></span>
<a id="__codelineno-2-133" name="__codelineno-2-133"></a><a href="#__codelineno-2-133"><span class="linenos" data-linenos="133 "></span></a><span class="w">    </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-134" name="__codelineno-2-134"></a><a href="#__codelineno-2-134"><span class="linenos" data-linenos="134 "></span></a><span class="w">    </span><span class="nx">settings?</span><span class="o">:</span><span class="w"> </span><span class="kt">Settings</span><span class="w"></span>
<a id="__codelineno-2-135" name="__codelineno-2-135"></a><a href="#__codelineno-2-135"><span class="linenos" data-linenos="135 "></span></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Lock</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-136" name="__codelineno-2-136"></a><a href="#__codelineno-2-136"><span class="linenos" data-linenos="136 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-137" name="__codelineno-2-137"></a><a href="#__codelineno-2-137"><span class="linenos" data-linenos="137 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_random</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-138" name="__codelineno-2-138"></a><a href="#__codelineno-2-138"><span class="linenos" data-linenos="138 "></span></a>
<a id="__codelineno-2-139" name="__codelineno-2-139"></a><a href="#__codelineno-2-139"><span class="linenos" data-linenos="139 "></span></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-140" name="__codelineno-2-140"></a><a href="#__codelineno-2-140"><span class="linenos" data-linenos="140 "></span></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">attempts</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_execute</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-141" name="__codelineno-2-141"></a><a href="#__codelineno-2-141"><span class="linenos" data-linenos="141 "></span></a><span class="w">        </span><span class="k">this</span><span class="p">.</span><span class="nx">scripts</span><span class="p">.</span><span class="nx">acquireScript</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-142" name="__codelineno-2-142"></a><a href="#__codelineno-2-142"><span class="linenos" data-linenos="142 "></span></a><span class="w">        </span><span class="nx">resources</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-143" name="__codelineno-2-143"></a><a href="#__codelineno-2-143"><span class="linenos" data-linenos="143 "></span></a><span class="w">        </span><span class="p">[</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="p">],</span><span class="w"></span>
<a id="__codelineno-2-144" name="__codelineno-2-144"></a><a href="#__codelineno-2-144"><span class="linenos" data-linenos="144 "></span></a><span class="w">        </span><span class="nx">settings</span><span class="w"></span>
<a id="__codelineno-2-145" name="__codelineno-2-145"></a><a href="#__codelineno-2-145"><span class="linenos" data-linenos="145 "></span></a><span class="w">      </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-146" name="__codelineno-2-146"></a><a href="#__codelineno-2-146"><span class="linenos" data-linenos="146 "></span></a>
<a id="__codelineno-2-147" name="__codelineno-2-147"></a><a href="#__codelineno-2-147"><span class="linenos" data-linenos="147 "></span></a><span class="w">      </span><span class="c1">// Add 2 milliseconds to the drift to account for Redis expires precision,</span><span class="w"></span>
<a id="__codelineno-2-148" name="__codelineno-2-148"></a><a href="#__codelineno-2-148"><span class="linenos" data-linenos="148 "></span></a><span class="w">      </span><span class="c1">// which is 1 ms, plus the configured allowable drift factor.</span><span class="w"></span>
<a id="__codelineno-2-149" name="__codelineno-2-149"></a><a href="#__codelineno-2-149"><span class="linenos" data-linenos="149 "></span></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">drift</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<a id="__codelineno-2-150" name="__codelineno-2-150"></a><a href="#__codelineno-2-150"><span class="linenos" data-linenos="150 "></span></a><span class="w">        </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-151" name="__codelineno-2-151"></a><a href="#__codelineno-2-151"><span class="linenos" data-linenos="151 "></span></a><span class="w">          </span><span class="p">(</span><span class="nx">settings</span><span class="o">?</span><span class="p">.</span><span class="nx">driftFactor</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">driftFactor</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">duration</span><span class="w"></span>
<a id="__codelineno-2-152" name="__codelineno-2-152"></a><a href="#__codelineno-2-152"><span class="linenos" data-linenos="152 "></span></a><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-153" name="__codelineno-2-153"></a><a href="#__codelineno-2-153"><span class="linenos" data-linenos="153 "></span></a>
<a id="__codelineno-2-154" name="__codelineno-2-154"></a><a href="#__codelineno-2-154"><span class="linenos" data-linenos="154 "></span></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Lock</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-155" name="__codelineno-2-155"></a><a href="#__codelineno-2-155"><span class="linenos" data-linenos="155 "></span></a><span class="w">        </span><span class="k">this</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-156" name="__codelineno-2-156"></a><a href="#__codelineno-2-156"><span class="linenos" data-linenos="156 "></span></a><span class="w">        </span><span class="nx">resources</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-157" name="__codelineno-2-157"></a><a href="#__codelineno-2-157"><span class="linenos" data-linenos="157 "></span></a><span class="w">        </span><span class="nx">value</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-158" name="__codelineno-2-158"></a><a href="#__codelineno-2-158"><span class="linenos" data-linenos="158 "></span></a><span class="w">        </span><span class="nx">attempts</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-159" name="__codelineno-2-159"></a><a href="#__codelineno-2-159"><span class="linenos" data-linenos="159 "></span></a><span class="w">        </span><span class="nx">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">drift</span><span class="w"></span>
<a id="__codelineno-2-160" name="__codelineno-2-160"></a><a href="#__codelineno-2-160"><span class="linenos" data-linenos="160 "></span></a><span class="w">      </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-161" name="__codelineno-2-161"></a><a href="#__codelineno-2-161"><span class="linenos" data-linenos="161 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-162" name="__codelineno-2-162"></a><a href="#__codelineno-2-162"><span class="linenos" data-linenos="162 "></span></a><span class="w">      </span><span class="c1">// If there was an error acquiring the lock, release any partial lock</span><span class="w"></span>
<a id="__codelineno-2-163" name="__codelineno-2-163"></a><a href="#__codelineno-2-163"><span class="linenos" data-linenos="163 "></span></a><span class="w">      </span><span class="c1">// state that may exist on a minority of clients.</span><span class="w"></span>
<a id="__codelineno-2-164" name="__codelineno-2-164"></a><a href="#__codelineno-2-164"><span class="linenos" data-linenos="164 "></span></a><span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_execute</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">scripts</span><span class="p">.</span><span class="nx">releaseScript</span><span class="p">,</span><span class="w"> </span><span class="nx">resources</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">value</span><span class="p">],</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-165" name="__codelineno-2-165"></a><a href="#__codelineno-2-165"><span class="linenos" data-linenos="165 "></span></a><span class="w">        </span><span class="nx">retryCount</span><span class="o">:</span><span class="w"> </span><span class="kt">0</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-166" name="__codelineno-2-166"></a><a href="#__codelineno-2-166"><span class="linenos" data-linenos="166 "></span></a><span class="w">      </span><span class="p">}).</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-167" name="__codelineno-2-167"></a><a href="#__codelineno-2-167"><span class="linenos" data-linenos="167 "></span></a><span class="w">        </span><span class="c1">// Any error here will be ignored.</span><span class="w"></span>
<a id="__codelineno-2-168" name="__codelineno-2-168"></a><a href="#__codelineno-2-168"><span class="linenos" data-linenos="168 "></span></a><span class="w">      </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-2-169" name="__codelineno-2-169"></a><a href="#__codelineno-2-169"><span class="linenos" data-linenos="169 "></span></a>
<a id="__codelineno-2-170" name="__codelineno-2-170"></a><a href="#__codelineno-2-170"><span class="linenos" data-linenos="170 "></span></a><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-171" name="__codelineno-2-171"></a><a href="#__codelineno-2-171"><span class="linenos" data-linenos="171 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-172" name="__codelineno-2-172"></a><a href="#__codelineno-2-172"><span class="linenos" data-linenos="172 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-173" name="__codelineno-2-173"></a><a href="#__codelineno-2-173"><span class="linenos" data-linenos="173 "></span></a>
<a id="__codelineno-2-174" name="__codelineno-2-174"></a><a href="#__codelineno-2-174"><span class="linenos" data-linenos="174 "></span></a><span class="w">  </span><span class="cm">/**</span>
<a id="__codelineno-2-175" name="__codelineno-2-175"></a><a href="#__codelineno-2-175"><span class="linenos" data-linenos="175 "></span></a><span class="cm">   * This method unlocks the provided lock from all servers still persisting it.</span>
<a id="__codelineno-2-176" name="__codelineno-2-176"></a><a href="#__codelineno-2-176"><span class="linenos" data-linenos="176 "></span></a><span class="cm">   * It will fail with an error if it is unable to release the lock on a quorum</span>
<a id="__codelineno-2-177" name="__codelineno-2-177"></a><a href="#__codelineno-2-177"><span class="linenos" data-linenos="177 "></span></a><span class="cm">   * of nodes, but will make no attempt to restore the lock in the case of a</span>
<a id="__codelineno-2-178" name="__codelineno-2-178"></a><a href="#__codelineno-2-178"><span class="linenos" data-linenos="178 "></span></a><span class="cm">   * failure to release. It is safe to re-attempt a release or to ignore the</span>
<a id="__codelineno-2-179" name="__codelineno-2-179"></a><a href="#__codelineno-2-179"><span class="linenos" data-linenos="179 "></span></a><span class="cm">   * error, as the lock will automatically expire after its timeout.</span>
<a id="__codelineno-2-180" name="__codelineno-2-180"></a><a href="#__codelineno-2-180"><span class="linenos" data-linenos="180 "></span></a><span class="cm">   */</span><span class="w"></span>
<a id="__codelineno-2-181" name="__codelineno-2-181"></a><a href="#__codelineno-2-181"><span class="linenos" data-linenos="181 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">release</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-182" name="__codelineno-2-182"></a><a href="#__codelineno-2-182"><span class="linenos" data-linenos="182 "></span></a><span class="w">    </span><span class="nx">lock</span><span class="o">:</span><span class="w"> </span><span class="kt">Lock</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-183" name="__codelineno-2-183"></a><a href="#__codelineno-2-183"><span class="linenos" data-linenos="183 "></span></a><span class="w">    </span><span class="nx">settings?</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">Settings</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-2-184" name="__codelineno-2-184"></a><a href="#__codelineno-2-184"><span class="linenos" data-linenos="184 "></span></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExecutionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-185" name="__codelineno-2-185"></a><a href="#__codelineno-2-185"><span class="linenos" data-linenos="185 "></span></a><span class="w">    </span><span class="c1">// Immediately invalidate the lock.</span><span class="w"></span>
<a id="__codelineno-2-186" name="__codelineno-2-186"></a><a href="#__codelineno-2-186"><span class="linenos" data-linenos="186 "></span></a><span class="w">    </span><span class="nx">lock</span><span class="p">.</span><span class="nx">expiration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-187" name="__codelineno-2-187"></a><a href="#__codelineno-2-187"><span class="linenos" data-linenos="187 "></span></a>
<a id="__codelineno-2-188" name="__codelineno-2-188"></a><a href="#__codelineno-2-188"><span class="linenos" data-linenos="188 "></span></a><span class="w">    </span><span class="c1">// Attempt to release the lock.</span><span class="w"></span>
<a id="__codelineno-2-189" name="__codelineno-2-189"></a><a href="#__codelineno-2-189"><span class="linenos" data-linenos="189 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_execute</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-190" name="__codelineno-2-190"></a><a href="#__codelineno-2-190"><span class="linenos" data-linenos="190 "></span></a><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">scripts</span><span class="p">.</span><span class="nx">releaseScript</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-191" name="__codelineno-2-191"></a><a href="#__codelineno-2-191"><span class="linenos" data-linenos="191 "></span></a><span class="w">      </span><span class="nx">lock</span><span class="p">.</span><span class="nx">resources</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-192" name="__codelineno-2-192"></a><a href="#__codelineno-2-192"><span class="linenos" data-linenos="192 "></span></a><span class="w">      </span><span class="p">[</span><span class="nx">lock</span><span class="p">.</span><span class="nx">value</span><span class="p">],</span><span class="w"></span>
<a id="__codelineno-2-193" name="__codelineno-2-193"></a><a href="#__codelineno-2-193"><span class="linenos" data-linenos="193 "></span></a><span class="w">      </span><span class="nx">settings</span><span class="w"></span>
<a id="__codelineno-2-194" name="__codelineno-2-194"></a><a href="#__codelineno-2-194"><span class="linenos" data-linenos="194 "></span></a><span class="w">    </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-195" name="__codelineno-2-195"></a><a href="#__codelineno-2-195"><span class="linenos" data-linenos="195 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-196" name="__codelineno-2-196"></a><a href="#__codelineno-2-196"><span class="linenos" data-linenos="196 "></span></a>
<a id="__codelineno-2-197" name="__codelineno-2-197"></a><a href="#__codelineno-2-197"><span class="linenos" data-linenos="197 "></span></a><span class="w">  </span><span class="cm">/**</span>
<a id="__codelineno-2-198" name="__codelineno-2-198"></a><a href="#__codelineno-2-198"><span class="linenos" data-linenos="198 "></span></a><span class="cm">   * This method extends a valid lock by the provided `duration`.</span>
<a id="__codelineno-2-199" name="__codelineno-2-199"></a><a href="#__codelineno-2-199"><span class="linenos" data-linenos="199 "></span></a><span class="cm">   */</span><span class="w"></span>
<a id="__codelineno-2-200" name="__codelineno-2-200"></a><a href="#__codelineno-2-200"><span class="linenos" data-linenos="200 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">extend</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-201" name="__codelineno-2-201"></a><a href="#__codelineno-2-201"><span class="linenos" data-linenos="201 "></span></a><span class="w">    </span><span class="nx">existing</span><span class="o">:</span><span class="w"> </span><span class="kt">Lock</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-202" name="__codelineno-2-202"></a><a href="#__codelineno-2-202"><span class="linenos" data-linenos="202 "></span></a><span class="w">    </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-203" name="__codelineno-2-203"></a><a href="#__codelineno-2-203"><span class="linenos" data-linenos="203 "></span></a><span class="w">    </span><span class="nx">settings?</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">Settings</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-2-204" name="__codelineno-2-204"></a><a href="#__codelineno-2-204"><span class="linenos" data-linenos="204 "></span></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">Lock</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-205" name="__codelineno-2-205"></a><a href="#__codelineno-2-205"><span class="linenos" data-linenos="205 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-206" name="__codelineno-2-206"></a><a href="#__codelineno-2-206"><span class="linenos" data-linenos="206 "></span></a>
<a id="__codelineno-2-207" name="__codelineno-2-207"></a><a href="#__codelineno-2-207"><span class="linenos" data-linenos="207 "></span></a><span class="w">    </span><span class="c1">// The lock has already expired.</span><span class="w"></span>
<a id="__codelineno-2-208" name="__codelineno-2-208"></a><a href="#__codelineno-2-208"><span class="linenos" data-linenos="208 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">existing</span><span class="p">.</span><span class="nx">expiration</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-209" name="__codelineno-2-209"></a><a href="#__codelineno-2-209"><span class="linenos" data-linenos="209 "></span></a><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExecutionError</span><span class="p">(</span><span class="s2">&quot;Cannot extend an already-expired lock.&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]);</span><span class="w"></span>
<a id="__codelineno-2-210" name="__codelineno-2-210"></a><a href="#__codelineno-2-210"><span class="linenos" data-linenos="210 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-211" name="__codelineno-2-211"></a><a href="#__codelineno-2-211"><span class="linenos" data-linenos="211 "></span></a>
<a id="__codelineno-2-212" name="__codelineno-2-212"></a><a href="#__codelineno-2-212"><span class="linenos" data-linenos="212 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">attempts</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_execute</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-213" name="__codelineno-2-213"></a><a href="#__codelineno-2-213"><span class="linenos" data-linenos="213 "></span></a><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">scripts</span><span class="p">.</span><span class="nx">extendScript</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-214" name="__codelineno-2-214"></a><a href="#__codelineno-2-214"><span class="linenos" data-linenos="214 "></span></a><span class="w">      </span><span class="nx">existing</span><span class="p">.</span><span class="nx">resources</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-215" name="__codelineno-2-215"></a><a href="#__codelineno-2-215"><span class="linenos" data-linenos="215 "></span></a><span class="w">      </span><span class="p">[</span><span class="nx">existing</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="p">],</span><span class="w"></span>
<a id="__codelineno-2-216" name="__codelineno-2-216"></a><a href="#__codelineno-2-216"><span class="linenos" data-linenos="216 "></span></a><span class="w">      </span><span class="nx">settings</span><span class="w"></span>
<a id="__codelineno-2-217" name="__codelineno-2-217"></a><a href="#__codelineno-2-217"><span class="linenos" data-linenos="217 "></span></a><span class="w">    </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-218" name="__codelineno-2-218"></a><a href="#__codelineno-2-218"><span class="linenos" data-linenos="218 "></span></a>
<a id="__codelineno-2-219" name="__codelineno-2-219"></a><a href="#__codelineno-2-219"><span class="linenos" data-linenos="219 "></span></a><span class="w">    </span><span class="c1">// Invalidate the existing lock.</span><span class="w"></span>
<a id="__codelineno-2-220" name="__codelineno-2-220"></a><a href="#__codelineno-2-220"><span class="linenos" data-linenos="220 "></span></a><span class="w">    </span><span class="nx">existing</span><span class="p">.</span><span class="nx">expiration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-221" name="__codelineno-2-221"></a><a href="#__codelineno-2-221"><span class="linenos" data-linenos="221 "></span></a>
<a id="__codelineno-2-222" name="__codelineno-2-222"></a><a href="#__codelineno-2-222"><span class="linenos" data-linenos="222 "></span></a><span class="w">    </span><span class="c1">// Add 2 milliseconds to the drift to account for Redis expires precision,</span><span class="w"></span>
<a id="__codelineno-2-223" name="__codelineno-2-223"></a><a href="#__codelineno-2-223"><span class="linenos" data-linenos="223 "></span></a><span class="w">    </span><span class="c1">// which is 1 ms, plus the configured allowable drift factor.</span><span class="w"></span>
<a id="__codelineno-2-224" name="__codelineno-2-224"></a><a href="#__codelineno-2-224"><span class="linenos" data-linenos="224 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">drift</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<a id="__codelineno-2-225" name="__codelineno-2-225"></a><a href="#__codelineno-2-225"><span class="linenos" data-linenos="225 "></span></a><span class="w">      </span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-226" name="__codelineno-2-226"></a><a href="#__codelineno-2-226"><span class="linenos" data-linenos="226 "></span></a><span class="w">        </span><span class="p">(</span><span class="nx">settings</span><span class="o">?</span><span class="p">.</span><span class="nx">driftFactor</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">.</span><span class="nx">driftFactor</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">duration</span><span class="w"></span>
<a id="__codelineno-2-227" name="__codelineno-2-227"></a><a href="#__codelineno-2-227"><span class="linenos" data-linenos="227 "></span></a><span class="w">      </span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-228" name="__codelineno-2-228"></a><a href="#__codelineno-2-228"><span class="linenos" data-linenos="228 "></span></a>
<a id="__codelineno-2-229" name="__codelineno-2-229"></a><a href="#__codelineno-2-229"><span class="linenos" data-linenos="229 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">replacement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">Lock</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-230" name="__codelineno-2-230"></a><a href="#__codelineno-2-230"><span class="linenos" data-linenos="230 "></span></a><span class="w">      </span><span class="k">this</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-231" name="__codelineno-2-231"></a><a href="#__codelineno-2-231"><span class="linenos" data-linenos="231 "></span></a><span class="w">      </span><span class="nx">existing</span><span class="p">.</span><span class="nx">resources</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-232" name="__codelineno-2-232"></a><a href="#__codelineno-2-232"><span class="linenos" data-linenos="232 "></span></a><span class="w">      </span><span class="nx">existing</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-233" name="__codelineno-2-233"></a><a href="#__codelineno-2-233"><span class="linenos" data-linenos="233 "></span></a><span class="w">      </span><span class="nx">attempts</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-234" name="__codelineno-2-234"></a><a href="#__codelineno-2-234"><span class="linenos" data-linenos="234 "></span></a><span class="w">      </span><span class="nx">start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">drift</span><span class="w"></span>
<a id="__codelineno-2-235" name="__codelineno-2-235"></a><a href="#__codelineno-2-235"><span class="linenos" data-linenos="235 "></span></a><span class="w">    </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-236" name="__codelineno-2-236"></a><a href="#__codelineno-2-236"><span class="linenos" data-linenos="236 "></span></a>
<a id="__codelineno-2-237" name="__codelineno-2-237"></a><a href="#__codelineno-2-237"><span class="linenos" data-linenos="237 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">replacement</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-238" name="__codelineno-2-238"></a><a href="#__codelineno-2-238"><span class="linenos" data-linenos="238 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-239" name="__codelineno-2-239"></a><a href="#__codelineno-2-239"><span class="linenos" data-linenos="239 "></span></a>
<a id="__codelineno-2-240" name="__codelineno-2-240"></a><a href="#__codelineno-2-240"><span class="linenos" data-linenos="240 "></span></a><span class="w">  </span><span class="cm">/**</span>
<a id="__codelineno-2-241" name="__codelineno-2-241"></a><a href="#__codelineno-2-241"><span class="linenos" data-linenos="241 "></span></a><span class="cm">   * Execute a script on all clients. The resulting promise is resolved or</span>
<a id="__codelineno-2-242" name="__codelineno-2-242"></a><a href="#__codelineno-2-242"><span class="linenos" data-linenos="242 "></span></a><span class="cm">   * rejected as soon as this quorum is reached; the resolution or rejection</span>
<a id="__codelineno-2-243" name="__codelineno-2-243"></a><a href="#__codelineno-2-243"><span class="linenos" data-linenos="243 "></span></a><span class="cm">   * will contains a `stats` property that is resolved once all votes are in.</span>
<a id="__codelineno-2-244" name="__codelineno-2-244"></a><a href="#__codelineno-2-244"><span class="linenos" data-linenos="244 "></span></a><span class="cm">   */</span><span class="w"></span>
<a id="__codelineno-2-245" name="__codelineno-2-245"></a><a href="#__codelineno-2-245"><span class="linenos" data-linenos="245 "></span></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">_execute</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-246" name="__codelineno-2-246"></a><a href="#__codelineno-2-246"><span class="linenos" data-linenos="246 "></span></a><span class="w">    </span><span class="nx">script</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-2-247" name="__codelineno-2-247"></a><a href="#__codelineno-2-247"><span class="linenos" data-linenos="247 "></span></a><span class="w">    </span><span class="nx">keys</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[],</span><span class="w"></span>
<a id="__codelineno-2-248" name="__codelineno-2-248"></a><a href="#__codelineno-2-248"><span class="linenos" data-linenos="248 "></span></a><span class="w">    </span><span class="nx">args</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">number</span><span class="p">)[],</span><span class="w"></span>
<a id="__codelineno-2-249" name="__codelineno-2-249"></a><a href="#__codelineno-2-249"><span class="linenos" data-linenos="249 "></span></a><span class="w">    </span><span class="nx">_settings?</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">Settings</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-2-250" name="__codelineno-2-250"></a><a href="#__codelineno-2-250"><span class="linenos" data-linenos="250 "></span></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ExecutionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-251" name="__codelineno-2-251"></a><a href="#__codelineno-2-251"><span class="linenos" data-linenos="251 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">settings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">_settings</span><span class="w"></span>
<a id="__codelineno-2-252" name="__codelineno-2-252"></a><a href="#__codelineno-2-252"><span class="linenos" data-linenos="252 "></span></a><span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-253" name="__codelineno-2-253"></a><a href="#__codelineno-2-253"><span class="linenos" data-linenos="253 "></span></a><span class="w">          </span><span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-254" name="__codelineno-2-254"></a><a href="#__codelineno-2-254"><span class="linenos" data-linenos="254 "></span></a><span class="w">          </span><span class="p">...</span><span class="nx">_settings</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-255" name="__codelineno-2-255"></a><a href="#__codelineno-2-255"><span class="linenos" data-linenos="255 "></span></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-256" name="__codelineno-2-256"></a><a href="#__codelineno-2-256"><span class="linenos" data-linenos="256 "></span></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-257" name="__codelineno-2-257"></a><a href="#__codelineno-2-257"><span class="linenos" data-linenos="257 "></span></a>
<a id="__codelineno-2-258" name="__codelineno-2-258"></a><a href="#__codelineno-2-258"><span class="linenos" data-linenos="258 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">maxAttempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">settings</span><span class="p">.</span><span class="nx">retryCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-259" name="__codelineno-2-259"></a><a href="#__codelineno-2-259"><span class="linenos" data-linenos="259 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">attempts</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="nx">ExecutionStats</span><span class="o">&gt;</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"></span>
<a id="__codelineno-2-260" name="__codelineno-2-260"></a><a href="#__codelineno-2-260"><span class="linenos" data-linenos="260 "></span></a>
<a id="__codelineno-2-261" name="__codelineno-2-261"></a><a href="#__codelineno-2-261"><span class="linenos" data-linenos="261 "></span></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-262" name="__codelineno-2-262"></a><a href="#__codelineno-2-262"><span class="linenos" data-linenos="262 "></span></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">vote</span><span class="p">,</span><span class="w"> </span><span class="nx">stats</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">_attemptOperation</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span><span class="w"> </span><span class="nx">keys</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-263" name="__codelineno-2-263"></a><a href="#__codelineno-2-263"><span class="linenos" data-linenos="263 "></span></a>
<a id="__codelineno-2-264" name="__codelineno-2-264"></a><a href="#__codelineno-2-264"><span class="linenos" data-linenos="264 "></span></a><span class="w">      </span><span class="nx">attempts</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">stats</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-265" name="__codelineno-2-265"></a><a href="#__codelineno-2-265"><span class="linenos" data-linenos="265 "></span></a>
<a id="__codelineno-2-266" name="__codelineno-2-266"></a><a href="#__codelineno-2-266"><span class="linenos" data-linenos="266 "></span></a><span class="w">      </span><span class="c1">// The operation acheived a quorum in favor.</span><span class="w"></span>
<a id="__codelineno-2-267" name="__codelineno-2-267"></a><a href="#__codelineno-2-267"><span class="linenos" data-linenos="267 "></span></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">vote</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;for&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-268" name="__codelineno-2-268"></a><a href="#__codelineno-2-268"><span class="linenos" data-linenos="268 "></span></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">attempts</span><span class="w"> </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-269" name="__codelineno-2-269"></a><a href="#__codelineno-2-269"><span class="linenos" data-linenos="269 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-270" name="__codelineno-2-270"></a><a href="#__codelineno-2-270"><span class="linenos" data-linenos="270 "></span></a>
<a id="__codelineno-2-271" name="__codelineno-2-271"></a><a href="#__codelineno-2-271"><span class="linenos" data-linenos="271 "></span></a><span class="w">      </span><span class="c1">// Wait before reattempting.</span><span class="w"></span>
<a id="__codelineno-2-272" name="__codelineno-2-272"></a><a href="#__codelineno-2-272"><span class="linenos" data-linenos="272 "></span></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">attempts</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">maxAttempts</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-273" name="__codelineno-2-273"></a><a href="#__codelineno-2-273"><span class="linenos" data-linenos="273 "></span></a><span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-274" name="__codelineno-2-274"></a><a href="#__codelineno-2-274"><span class="linenos" data-linenos="274 "></span></a><span class="w">          </span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-275" name="__codelineno-2-275"></a><a href="#__codelineno-2-275"><span class="linenos" data-linenos="275 "></span></a><span class="w">            </span><span class="nx">resolve</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-276" name="__codelineno-2-276"></a><a href="#__codelineno-2-276"><span class="linenos" data-linenos="276 "></span></a><span class="w">            </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-277" name="__codelineno-2-277"></a><a href="#__codelineno-2-277"><span class="linenos" data-linenos="277 "></span></a><span class="w">              </span><span class="mf">0</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-278" name="__codelineno-2-278"></a><a href="#__codelineno-2-278"><span class="linenos" data-linenos="278 "></span></a><span class="w">              </span><span class="nx">settings</span><span class="p">.</span><span class="nx">retryDelay</span><span class="w"> </span><span class="o">+</span><span class="w"></span>
<a id="__codelineno-2-279" name="__codelineno-2-279"></a><a href="#__codelineno-2-279"><span class="linenos" data-linenos="279 "></span></a><span class="w">                </span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">((</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">settings</span><span class="p">.</span><span class="nx">retryJitter</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-2-280" name="__codelineno-2-280"></a><a href="#__codelineno-2-280"><span class="linenos" data-linenos="280 "></span></a><span class="w">            </span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-2-281" name="__codelineno-2-281"></a><a href="#__codelineno-2-281"><span class="linenos" data-linenos="281 "></span></a><span class="w">            </span><span class="kc">undefined</span><span class="w"></span>
<a id="__codelineno-2-282" name="__codelineno-2-282"></a><a href="#__codelineno-2-282"><span class="linenos" data-linenos="282 "></span></a><span class="w">          </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-283" name="__codelineno-2-283"></a><a href="#__codelineno-2-283"><span class="linenos" data-linenos="283 "></span></a><span class="w">        </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-2-284" name="__codelineno-2-284"></a><a href="#__codelineno-2-284"><span class="linenos" data-linenos="284 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-285" name="__codelineno-2-285"></a><a href="#__codelineno-2-285"><span class="linenos" data-linenos="285 "></span></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ExecutionError</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-286" name="__codelineno-2-286"></a><a href="#__codelineno-2-286"><span class="linenos" data-linenos="286 "></span></a><span class="w">          </span><span class="s2">&quot;The operation was unable to acheive a quorum during its retry window.&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-287" name="__codelineno-2-287"></a><a href="#__codelineno-2-287"><span class="linenos" data-linenos="287 "></span></a><span class="w">          </span><span class="nx">attempts</span><span class="w"></span>
<a id="__codelineno-2-288" name="__codelineno-2-288"></a><a href="#__codelineno-2-288"><span class="linenos" data-linenos="288 "></span></a><span class="w">        </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-289" name="__codelineno-2-289"></a><a href="#__codelineno-2-289"><span class="linenos" data-linenos="289 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-290" name="__codelineno-2-290"></a><a href="#__codelineno-2-290"><span class="linenos" data-linenos="290 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-291" name="__codelineno-2-291"></a><a href="#__codelineno-2-291"><span class="linenos" data-linenos="291 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-292" name="__codelineno-2-292"></a><a href="#__codelineno-2-292"><span class="linenos" data-linenos="292 "></span></a>
<a id="__codelineno-2-293" name="__codelineno-2-293"></a><a href="#__codelineno-2-293"><span class="linenos" data-linenos="293 "></span></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">_attemptOperation</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-294" name="__codelineno-2-294"></a><a href="#__codelineno-2-294"><span class="linenos" data-linenos="294 "></span></a><span class="w">    </span><span class="nx">script</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-2-295" name="__codelineno-2-295"></a><a href="#__codelineno-2-295"><span class="linenos" data-linenos="295 "></span></a><span class="w">    </span><span class="nx">keys</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[],</span><span class="w"></span>
<a id="__codelineno-2-296" name="__codelineno-2-296"></a><a href="#__codelineno-2-296"><span class="linenos" data-linenos="296 "></span></a><span class="w">    </span><span class="nx">args</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">number</span><span class="p">)[]</span><span class="w"></span>
<a id="__codelineno-2-297" name="__codelineno-2-297"></a><a href="#__codelineno-2-297"><span class="linenos" data-linenos="297 "></span></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="w"></span>
<a id="__codelineno-2-298" name="__codelineno-2-298"></a><a href="#__codelineno-2-298"><span class="linenos" data-linenos="298 "></span></a><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">vote</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;for&quot;</span><span class="p">;</span><span class="w"> </span><span class="nx">stats</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="nx">ExecutionStats</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-299" name="__codelineno-2-299"></a><a href="#__codelineno-2-299"><span class="linenos" data-linenos="299 "></span></a><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">vote</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;against&quot;</span><span class="p">;</span><span class="w"> </span><span class="nx">stats</span><span class="o">:</span><span class="w"> </span><span class="kt">Promise</span><span class="o">&lt;</span><span class="nx">ExecutionStats</span><span class="o">&gt;</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-300" name="__codelineno-2-300"></a><a href="#__codelineno-2-300"><span class="linenos" data-linenos="300 "></span></a><span class="w">  </span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-301" name="__codelineno-2-301"></a><a href="#__codelineno-2-301"><span class="linenos" data-linenos="301 "></span></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-302" name="__codelineno-2-302"></a><a href="#__codelineno-2-302"><span class="linenos" data-linenos="302 "></span></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">clientResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span><span class="w"></span>
<a id="__codelineno-2-303" name="__codelineno-2-303"></a><a href="#__codelineno-2-303"><span class="linenos" data-linenos="303 "></span></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">clients</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-304" name="__codelineno-2-304"></a><a href="#__codelineno-2-304"><span class="linenos" data-linenos="304 "></span></a><span class="w">        </span><span class="nx">clientResults</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-305" name="__codelineno-2-305"></a><a href="#__codelineno-2-305"><span class="linenos" data-linenos="305 "></span></a><span class="w">          </span><span class="k">this</span><span class="p">.</span><span class="nx">_attemptOperationOnClient</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">script</span><span class="p">,</span><span class="w"> </span><span class="nx">keys</span><span class="p">,</span><span class="w"> </span><span class="nx">args</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-2-306" name="__codelineno-2-306"></a><a href="#__codelineno-2-306"><span class="linenos" data-linenos="306 "></span></a><span class="w">        </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-307" name="__codelineno-2-307"></a><a href="#__codelineno-2-307"><span class="linenos" data-linenos="307 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-308" name="__codelineno-2-308"></a><a href="#__codelineno-2-308"><span class="linenos" data-linenos="308 "></span></a>
<a id="__codelineno-2-309" name="__codelineno-2-309"></a><a href="#__codelineno-2-309"><span class="linenos" data-linenos="309 "></span></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">stats</span><span class="o">:</span><span class="w"> </span><span class="kt">ExecutionStats</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-310" name="__codelineno-2-310"></a><a href="#__codelineno-2-310"><span class="linenos" data-linenos="310 "></span></a><span class="w">        </span><span class="nx">membershipSize</span><span class="o">:</span><span class="w"> </span><span class="kt">clientResults.length</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-311" name="__codelineno-2-311"></a><a href="#__codelineno-2-311"><span class="linenos" data-linenos="311 "></span></a><span class="w">        </span><span class="nx">quorumSize</span><span class="o">:</span><span class="w"> </span><span class="kt">Math.floor</span><span class="p">(</span><span class="nx">clientResults</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-312" name="__codelineno-2-312"></a><a href="#__codelineno-2-312"><span class="linenos" data-linenos="312 "></span></a><span class="w">        </span><span class="nx">votesFor</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Set</span><span class="o">&lt;</span><span class="nx">Client</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"></span>
<a id="__codelineno-2-313" name="__codelineno-2-313"></a><a href="#__codelineno-2-313"><span class="linenos" data-linenos="313 "></span></a><span class="w">        </span><span class="nx">votesAgainst</span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="nb">Map</span><span class="o">&lt;</span><span class="nx">Client</span><span class="p">,</span><span class="w"> </span><span class="ne">Error</span><span class="o">&gt;</span><span class="p">(),</span><span class="w"></span>
<a id="__codelineno-2-314" name="__codelineno-2-314"></a><a href="#__codelineno-2-314"><span class="linenos" data-linenos="314 "></span></a><span class="w">      </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-315" name="__codelineno-2-315"></a><a href="#__codelineno-2-315"><span class="linenos" data-linenos="315 "></span></a>
<a id="__codelineno-2-316" name="__codelineno-2-316"></a><a href="#__codelineno-2-316"><span class="linenos" data-linenos="316 "></span></a><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">done</span><span class="o">:</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">void</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-317" name="__codelineno-2-317"></a><a href="#__codelineno-2-317"><span class="linenos" data-linenos="317 "></span></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">statsPromise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">stats</span><span class="o">&gt;</span><span class="p">((</span><span class="nx">resolve</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-318" name="__codelineno-2-318"></a><a href="#__codelineno-2-318"><span class="linenos" data-linenos="318 "></span></a><span class="w">        </span><span class="nx">done</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">resolve</span><span class="p">(</span><span class="nx">stats</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-319" name="__codelineno-2-319"></a><a href="#__codelineno-2-319"><span class="linenos" data-linenos="319 "></span></a><span class="w">      </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-2-320" name="__codelineno-2-320"></a><a href="#__codelineno-2-320"><span class="linenos" data-linenos="320 "></span></a>
<a id="__codelineno-2-321" name="__codelineno-2-321"></a><a href="#__codelineno-2-321"><span class="linenos" data-linenos="321 "></span></a><span class="w">      </span><span class="c1">// This is the expected flow for all successful and unsuccessful requests.</span><span class="w"></span>
<a id="__codelineno-2-322" name="__codelineno-2-322"></a><a href="#__codelineno-2-322"><span class="linenos" data-linenos="322 "></span></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">onResultResolve</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">clientResult</span><span class="o">:</span><span class="w"> </span><span class="kt">ClientExecutionResult</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-323" name="__codelineno-2-323"></a><a href="#__codelineno-2-323"><span class="linenos" data-linenos="323 "></span></a><span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">clientResult</span><span class="p">.</span><span class="nx">vote</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-324" name="__codelineno-2-324"></a><a href="#__codelineno-2-324"><span class="linenos" data-linenos="324 "></span></a><span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;for&quot;</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-2-325" name="__codelineno-2-325"></a><a href="#__codelineno-2-325"><span class="linenos" data-linenos="325 "></span></a><span class="w">            </span><span class="nx">stats</span><span class="p">.</span><span class="nx">votesFor</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">clientResult</span><span class="p">.</span><span class="nx">client</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-326" name="__codelineno-2-326"></a><a href="#__codelineno-2-326"><span class="linenos" data-linenos="326 "></span></a><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-327" name="__codelineno-2-327"></a><a href="#__codelineno-2-327"><span class="linenos" data-linenos="327 "></span></a><span class="w">          </span><span class="k">case</span><span class="w"> </span><span class="s2">&quot;against&quot;</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-2-328" name="__codelineno-2-328"></a><a href="#__codelineno-2-328"><span class="linenos" data-linenos="328 "></span></a><span class="w">            </span><span class="nx">stats</span><span class="p">.</span><span class="nx">votesAgainst</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">clientResult</span><span class="p">.</span><span class="nx">client</span><span class="p">,</span><span class="w"> </span><span class="nx">clientResult</span><span class="p">.</span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-329" name="__codelineno-2-329"></a><a href="#__codelineno-2-329"><span class="linenos" data-linenos="329 "></span></a><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-330" name="__codelineno-2-330"></a><a href="#__codelineno-2-330"><span class="linenos" data-linenos="330 "></span></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-331" name="__codelineno-2-331"></a><a href="#__codelineno-2-331"><span class="linenos" data-linenos="331 "></span></a>
<a id="__codelineno-2-332" name="__codelineno-2-332"></a><a href="#__codelineno-2-332"><span class="linenos" data-linenos="332 "></span></a><span class="w">        </span><span class="c1">// A quorum has determined a success.</span><span class="w"></span>
<a id="__codelineno-2-333" name="__codelineno-2-333"></a><a href="#__codelineno-2-333"><span class="linenos" data-linenos="333 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">votesFor</span><span class="p">.</span><span class="nx">size</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">quorumSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-334" name="__codelineno-2-334"></a><a href="#__codelineno-2-334"><span class="linenos" data-linenos="334 "></span></a><span class="w">          </span><span class="nx">resolve</span><span class="p">({</span><span class="w"></span>
<a id="__codelineno-2-335" name="__codelineno-2-335"></a><a href="#__codelineno-2-335"><span class="linenos" data-linenos="335 "></span></a><span class="w">            </span><span class="nx">vote</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;for&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-336" name="__codelineno-2-336"></a><a href="#__codelineno-2-336"><span class="linenos" data-linenos="336 "></span></a><span class="w">            </span><span class="nx">stats</span><span class="o">:</span><span class="w"> </span><span class="kt">statsPromise</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-337" name="__codelineno-2-337"></a><a href="#__codelineno-2-337"><span class="linenos" data-linenos="337 "></span></a><span class="w">          </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-2-338" name="__codelineno-2-338"></a><a href="#__codelineno-2-338"><span class="linenos" data-linenos="338 "></span></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-339" name="__codelineno-2-339"></a><a href="#__codelineno-2-339"><span class="linenos" data-linenos="339 "></span></a>
<a id="__codelineno-2-340" name="__codelineno-2-340"></a><a href="#__codelineno-2-340"><span class="linenos" data-linenos="340 "></span></a><span class="w">        </span><span class="c1">// A quorum has determined a failure.</span><span class="w"></span>
<a id="__codelineno-2-341" name="__codelineno-2-341"></a><a href="#__codelineno-2-341"><span class="linenos" data-linenos="341 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">stats</span><span class="p">.</span><span class="nx">votesAgainst</span><span class="p">.</span><span class="nx">size</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">quorumSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-342" name="__codelineno-2-342"></a><a href="#__codelineno-2-342"><span class="linenos" data-linenos="342 "></span></a><span class="w">          </span><span class="nx">resolve</span><span class="p">({</span><span class="w"></span>
<a id="__codelineno-2-343" name="__codelineno-2-343"></a><a href="#__codelineno-2-343"><span class="linenos" data-linenos="343 "></span></a><span class="w">            </span><span class="nx">vote</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;against&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-344" name="__codelineno-2-344"></a><a href="#__codelineno-2-344"><span class="linenos" data-linenos="344 "></span></a><span class="w">            </span><span class="nx">stats</span><span class="o">:</span><span class="w"> </span><span class="kt">statsPromise</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-345" name="__codelineno-2-345"></a><a href="#__codelineno-2-345"><span class="linenos" data-linenos="345 "></span></a><span class="w">          </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-2-346" name="__codelineno-2-346"></a><a href="#__codelineno-2-346"><span class="linenos" data-linenos="346 "></span></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-347" name="__codelineno-2-347"></a><a href="#__codelineno-2-347"><span class="linenos" data-linenos="347 "></span></a>
<a id="__codelineno-2-348" name="__codelineno-2-348"></a><a href="#__codelineno-2-348"><span class="linenos" data-linenos="348 "></span></a><span class="w">        </span><span class="c1">// All votes are in.</span><span class="w"></span>
<a id="__codelineno-2-349" name="__codelineno-2-349"></a><a href="#__codelineno-2-349"><span class="linenos" data-linenos="349 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-350" name="__codelineno-2-350"></a><a href="#__codelineno-2-350"><span class="linenos" data-linenos="350 "></span></a><span class="w">          </span><span class="nx">stats</span><span class="p">.</span><span class="nx">votesFor</span><span class="p">.</span><span class="nx">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">stats</span><span class="p">.</span><span class="nx">votesAgainst</span><span class="p">.</span><span class="nx">size</span><span class="w"> </span><span class="o">===</span><span class="w"></span>
<a id="__codelineno-2-351" name="__codelineno-2-351"></a><a href="#__codelineno-2-351"><span class="linenos" data-linenos="351 "></span></a><span class="w">          </span><span class="nx">stats</span><span class="p">.</span><span class="nx">membershipSize</span><span class="w"></span>
<a id="__codelineno-2-352" name="__codelineno-2-352"></a><a href="#__codelineno-2-352"><span class="linenos" data-linenos="352 "></span></a><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-353" name="__codelineno-2-353"></a><a href="#__codelineno-2-353"><span class="linenos" data-linenos="353 "></span></a><span class="w">          </span><span class="nx">done</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-354" name="__codelineno-2-354"></a><a href="#__codelineno-2-354"><span class="linenos" data-linenos="354 "></span></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-355" name="__codelineno-2-355"></a><a href="#__codelineno-2-355"><span class="linenos" data-linenos="355 "></span></a><span class="w">      </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-356" name="__codelineno-2-356"></a><a href="#__codelineno-2-356"><span class="linenos" data-linenos="356 "></span></a>
<a id="__codelineno-2-357" name="__codelineno-2-357"></a><a href="#__codelineno-2-357"><span class="linenos" data-linenos="357 "></span></a><span class="w">      </span><span class="c1">// This is unexpected and should crash to prevent undefined behavior.</span><span class="w"></span>
<a id="__codelineno-2-358" name="__codelineno-2-358"></a><a href="#__codelineno-2-358"><span class="linenos" data-linenos="358 "></span></a><span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">onResultReject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="o">:</span><span class="w"> </span><span class="kt">Error</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-359" name="__codelineno-2-359"></a><a href="#__codelineno-2-359"><span class="linenos" data-linenos="359 "></span></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-360" name="__codelineno-2-360"></a><a href="#__codelineno-2-360"><span class="linenos" data-linenos="360 "></span></a><span class="w">      </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-361" name="__codelineno-2-361"></a><a href="#__codelineno-2-361"><span class="linenos" data-linenos="361 "></span></a>
<a id="__codelineno-2-362" name="__codelineno-2-362"></a><a href="#__codelineno-2-362"><span class="linenos" data-linenos="362 "></span></a><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">const</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="nx">clientResults</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-363" name="__codelineno-2-363"></a><a href="#__codelineno-2-363"><span class="linenos" data-linenos="363 "></span></a><span class="w">        </span><span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">onResultResolve</span><span class="p">,</span><span class="w"> </span><span class="nx">onResultReject</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-364" name="__codelineno-2-364"></a><a href="#__codelineno-2-364"><span class="linenos" data-linenos="364 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-365" name="__codelineno-2-365"></a><a href="#__codelineno-2-365"><span class="linenos" data-linenos="365 "></span></a><span class="w">    </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-2-366" name="__codelineno-2-366"></a><a href="#__codelineno-2-366"><span class="linenos" data-linenos="366 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-367" name="__codelineno-2-367"></a><a href="#__codelineno-2-367"><span class="linenos" data-linenos="367 "></span></a>
<a id="__codelineno-2-368" name="__codelineno-2-368"></a><a href="#__codelineno-2-368"><span class="linenos" data-linenos="368 "></span></a><span class="w">  </span><span class="k">private</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">_attemptOperationOnClient</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-369" name="__codelineno-2-369"></a><a href="#__codelineno-2-369"><span class="linenos" data-linenos="369 "></span></a><span class="w">    </span><span class="nx">client</span><span class="o">:</span><span class="w"> </span><span class="kt">Client</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-370" name="__codelineno-2-370"></a><a href="#__codelineno-2-370"><span class="linenos" data-linenos="370 "></span></a><span class="w">    </span><span class="nx">script</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w"> </span><span class="nx">hash</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-2-371" name="__codelineno-2-371"></a><a href="#__codelineno-2-371"><span class="linenos" data-linenos="371 "></span></a><span class="w">    </span><span class="nx">keys</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[],</span><span class="w"></span>
<a id="__codelineno-2-372" name="__codelineno-2-372"></a><a href="#__codelineno-2-372"><span class="linenos" data-linenos="372 "></span></a><span class="w">    </span><span class="nx">args</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="kt">number</span><span class="p">)[]</span><span class="w"></span>
<a id="__codelineno-2-373" name="__codelineno-2-373"></a><a href="#__codelineno-2-373"><span class="linenos" data-linenos="373 "></span></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">ClientExecutionResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-374" name="__codelineno-2-374"></a><a href="#__codelineno-2-374"><span class="linenos" data-linenos="374 "></span></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-375" name="__codelineno-2-375"></a><a href="#__codelineno-2-375"><span class="linenos" data-linenos="375 "></span></a><span class="w">      </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-376" name="__codelineno-2-376"></a><a href="#__codelineno-2-376"><span class="linenos" data-linenos="376 "></span></a><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-377" name="__codelineno-2-377"></a><a href="#__codelineno-2-377"><span class="linenos" data-linenos="377 "></span></a><span class="w">        </span><span class="c1">// Attempt to evaluate the script by its hash.</span><span class="w"></span>
<a id="__codelineno-2-378" name="__codelineno-2-378"></a><a href="#__codelineno-2-378"><span class="linenos" data-linenos="378 "></span></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">shaResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nx">evalsha</span><span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">hash</span><span class="p">,</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<a id="__codelineno-2-379" name="__codelineno-2-379"></a><a href="#__codelineno-2-379"><span class="linenos" data-linenos="379 "></span></a><span class="w">          </span><span class="p">...</span><span class="nx">keys</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-380" name="__codelineno-2-380"></a><a href="#__codelineno-2-380"><span class="linenos" data-linenos="380 "></span></a><span class="w">          </span><span class="p">...</span><span class="nx">args</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-381" name="__codelineno-2-381"></a><a href="#__codelineno-2-381"><span class="linenos" data-linenos="381 "></span></a><span class="w">        </span><span class="p">]))</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-382" name="__codelineno-2-382"></a><a href="#__codelineno-2-382"><span class="linenos" data-linenos="382 "></span></a>
<a id="__codelineno-2-383" name="__codelineno-2-383"></a><a href="#__codelineno-2-383"><span class="linenos" data-linenos="383 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">shaResult</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-384" name="__codelineno-2-384"></a><a href="#__codelineno-2-384"><span class="linenos" data-linenos="384 "></span></a><span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-385" name="__codelineno-2-385"></a><a href="#__codelineno-2-385"><span class="linenos" data-linenos="385 "></span></a><span class="w">            </span><span class="sb">`Unexpected result of type </span><span class="si">${</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">shaResult</span><span class="si">}</span><span class="sb"> returned from redis.`</span><span class="w"></span>
<a id="__codelineno-2-386" name="__codelineno-2-386"></a><a href="#__codelineno-2-386"><span class="linenos" data-linenos="386 "></span></a><span class="w">          </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-387" name="__codelineno-2-387"></a><a href="#__codelineno-2-387"><span class="linenos" data-linenos="387 "></span></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-388" name="__codelineno-2-388"></a><a href="#__codelineno-2-388"><span class="linenos" data-linenos="388 "></span></a>
<a id="__codelineno-2-389" name="__codelineno-2-389"></a><a href="#__codelineno-2-389"><span class="linenos" data-linenos="389 "></span></a><span class="w">        </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">shaResult</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-390" name="__codelineno-2-390"></a><a href="#__codelineno-2-390"><span class="linenos" data-linenos="390 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-391" name="__codelineno-2-391"></a><a href="#__codelineno-2-391"><span class="linenos" data-linenos="391 "></span></a><span class="w">        </span><span class="c1">// If the redis server does not already have the script cached,</span><span class="w"></span>
<a id="__codelineno-2-392" name="__codelineno-2-392"></a><a href="#__codelineno-2-392"><span class="linenos" data-linenos="392 "></span></a><span class="w">        </span><span class="c1">// reattempt the request with the script&#39;s raw text.</span><span class="w"></span>
<a id="__codelineno-2-393" name="__codelineno-2-393"></a><a href="#__codelineno-2-393"><span class="linenos" data-linenos="393 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-394" name="__codelineno-2-394"></a><a href="#__codelineno-2-394"><span class="linenos" data-linenos="394 "></span></a><span class="w">          </span><span class="o">!</span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"></span>
<a id="__codelineno-2-395" name="__codelineno-2-395"></a><a href="#__codelineno-2-395"><span class="linenos" data-linenos="395 "></span></a><span class="w">          </span><span class="o">!</span><span class="nx">error</span><span class="p">.</span><span class="nx">message</span><span class="p">.</span><span class="nx">startsWith</span><span class="p">(</span><span class="s2">&quot;NOSCRIPT&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-2-396" name="__codelineno-2-396"></a><a href="#__codelineno-2-396"><span class="linenos" data-linenos="396 "></span></a><span class="w">        </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-397" name="__codelineno-2-397"></a><a href="#__codelineno-2-397"><span class="linenos" data-linenos="397 "></span></a><span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="nx">error</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-398" name="__codelineno-2-398"></a><a href="#__codelineno-2-398"><span class="linenos" data-linenos="398 "></span></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-399" name="__codelineno-2-399"></a><a href="#__codelineno-2-399"><span class="linenos" data-linenos="399 "></span></a><span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">rawResult</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">await</span><span class="w"> </span><span class="nx">client</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span><span class="nx">script</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="w"></span>
<a id="__codelineno-2-400" name="__codelineno-2-400"></a><a href="#__codelineno-2-400"><span class="linenos" data-linenos="400 "></span></a><span class="w">          </span><span class="p">...</span><span class="nx">keys</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-401" name="__codelineno-2-401"></a><a href="#__codelineno-2-401"><span class="linenos" data-linenos="401 "></span></a><span class="w">          </span><span class="p">...</span><span class="nx">args</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-402" name="__codelineno-2-402"></a><a href="#__codelineno-2-402"><span class="linenos" data-linenos="402 "></span></a><span class="w">        </span><span class="p">]))</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">unknown</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-403" name="__codelineno-2-403"></a><a href="#__codelineno-2-403"><span class="linenos" data-linenos="403 "></span></a>
<a id="__codelineno-2-404" name="__codelineno-2-404"></a><a href="#__codelineno-2-404"><span class="linenos" data-linenos="404 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">rawResult</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;number&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-405" name="__codelineno-2-405"></a><a href="#__codelineno-2-405"><span class="linenos" data-linenos="405 "></span></a><span class="w">          </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-406" name="__codelineno-2-406"></a><a href="#__codelineno-2-406"><span class="linenos" data-linenos="406 "></span></a><span class="w">            </span><span class="sb">`Unexpected result of type </span><span class="si">${</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">rawResult</span><span class="si">}</span><span class="sb"> returned from redis.`</span><span class="w"></span>
<a id="__codelineno-2-407" name="__codelineno-2-407"></a><a href="#__codelineno-2-407"><span class="linenos" data-linenos="407 "></span></a><span class="w">          </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-408" name="__codelineno-2-408"></a><a href="#__codelineno-2-408"><span class="linenos" data-linenos="408 "></span></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-409" name="__codelineno-2-409"></a><a href="#__codelineno-2-409"><span class="linenos" data-linenos="409 "></span></a>
<a id="__codelineno-2-410" name="__codelineno-2-410"></a><a href="#__codelineno-2-410"><span class="linenos" data-linenos="410 "></span></a><span class="w">        </span><span class="nx">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">rawResult</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-411" name="__codelineno-2-411"></a><a href="#__codelineno-2-411"><span class="linenos" data-linenos="411 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-412" name="__codelineno-2-412"></a><a href="#__codelineno-2-412"><span class="linenos" data-linenos="412 "></span></a>
<a id="__codelineno-2-413" name="__codelineno-2-413"></a><a href="#__codelineno-2-413"><span class="linenos" data-linenos="413 "></span></a><span class="w">      </span><span class="c1">// One or more of the resources was already locked.</span><span class="w"></span>
<a id="__codelineno-2-414" name="__codelineno-2-414"></a><a href="#__codelineno-2-414"><span class="linenos" data-linenos="414 "></span></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">result</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-415" name="__codelineno-2-415"></a><a href="#__codelineno-2-415"><span class="linenos" data-linenos="415 "></span></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">ResourceLockedError</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-416" name="__codelineno-2-416"></a><a href="#__codelineno-2-416"><span class="linenos" data-linenos="416 "></span></a><span class="w">          </span><span class="sb">`The operation was applied to: </span><span class="si">${</span><span class="nx">result</span><span class="si">}</span><span class="sb"> of the </span><span class="si">${</span><span class="nx">keys</span><span class="p">.</span><span class="nx">length</span><span class="si">}</span><span class="sb"> requested resources.`</span><span class="w"></span>
<a id="__codelineno-2-417" name="__codelineno-2-417"></a><a href="#__codelineno-2-417"><span class="linenos" data-linenos="417 "></span></a><span class="w">        </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-418" name="__codelineno-2-418"></a><a href="#__codelineno-2-418"><span class="linenos" data-linenos="418 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-419" name="__codelineno-2-419"></a><a href="#__codelineno-2-419"><span class="linenos" data-linenos="419 "></span></a>
<a id="__codelineno-2-420" name="__codelineno-2-420"></a><a href="#__codelineno-2-420"><span class="linenos" data-linenos="420 "></span></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-421" name="__codelineno-2-421"></a><a href="#__codelineno-2-421"><span class="linenos" data-linenos="421 "></span></a><span class="w">        </span><span class="nx">vote</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;for&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-422" name="__codelineno-2-422"></a><a href="#__codelineno-2-422"><span class="linenos" data-linenos="422 "></span></a><span class="w">        </span><span class="nx">client</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-423" name="__codelineno-2-423"></a><a href="#__codelineno-2-423"><span class="linenos" data-linenos="423 "></span></a><span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">result</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-424" name="__codelineno-2-424"></a><a href="#__codelineno-2-424"><span class="linenos" data-linenos="424 "></span></a><span class="w">      </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-425" name="__codelineno-2-425"></a><a href="#__codelineno-2-425"><span class="linenos" data-linenos="425 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-426" name="__codelineno-2-426"></a><a href="#__codelineno-2-426"><span class="linenos" data-linenos="426 "></span></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-427" name="__codelineno-2-427"></a><a href="#__codelineno-2-427"><span class="linenos" data-linenos="427 "></span></a><span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-428" name="__codelineno-2-428"></a><a href="#__codelineno-2-428"><span class="linenos" data-linenos="428 "></span></a><span class="w">          </span><span class="sb">`Unexpected type </span><span class="si">${</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">error</span><span class="si">}</span><span class="sb"> thrown with value: </span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="w"></span>
<a id="__codelineno-2-429" name="__codelineno-2-429"></a><a href="#__codelineno-2-429"><span class="linenos" data-linenos="429 "></span></a><span class="w">        </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-430" name="__codelineno-2-430"></a><a href="#__codelineno-2-430"><span class="linenos" data-linenos="430 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-431" name="__codelineno-2-431"></a><a href="#__codelineno-2-431"><span class="linenos" data-linenos="431 "></span></a>
<a id="__codelineno-2-432" name="__codelineno-2-432"></a><a href="#__codelineno-2-432"><span class="linenos" data-linenos="432 "></span></a><span class="w">      </span><span class="c1">// Emit the error on the redlock instance for observability.</span><span class="w"></span>
<a id="__codelineno-2-433" name="__codelineno-2-433"></a><a href="#__codelineno-2-433"><span class="linenos" data-linenos="433 "></span></a><span class="w">      </span><span class="k">this</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-434" name="__codelineno-2-434"></a><a href="#__codelineno-2-434"><span class="linenos" data-linenos="434 "></span></a>
<a id="__codelineno-2-435" name="__codelineno-2-435"></a><a href="#__codelineno-2-435"><span class="linenos" data-linenos="435 "></span></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-436" name="__codelineno-2-436"></a><a href="#__codelineno-2-436"><span class="linenos" data-linenos="436 "></span></a><span class="w">        </span><span class="nx">vote</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;against&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-437" name="__codelineno-2-437"></a><a href="#__codelineno-2-437"><span class="linenos" data-linenos="437 "></span></a><span class="w">        </span><span class="nx">client</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-438" name="__codelineno-2-438"></a><a href="#__codelineno-2-438"><span class="linenos" data-linenos="438 "></span></a><span class="w">        </span><span class="nx">error</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-439" name="__codelineno-2-439"></a><a href="#__codelineno-2-439"><span class="linenos" data-linenos="439 "></span></a><span class="w">      </span><span class="p">};</span><span class="w"></span>
<a id="__codelineno-2-440" name="__codelineno-2-440"></a><a href="#__codelineno-2-440"><span class="linenos" data-linenos="440 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-441" name="__codelineno-2-441"></a><a href="#__codelineno-2-441"><span class="linenos" data-linenos="441 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-442" name="__codelineno-2-442"></a><a href="#__codelineno-2-442"><span class="linenos" data-linenos="442 "></span></a>
<a id="__codelineno-2-443" name="__codelineno-2-443"></a><a href="#__codelineno-2-443"><span class="linenos" data-linenos="443 "></span></a><span class="w">  </span><span class="cm">/**</span>
<a id="__codelineno-2-444" name="__codelineno-2-444"></a><a href="#__codelineno-2-444"><span class="linenos" data-linenos="444 "></span></a><span class="cm">   * Wrap and execute a routine in the context of an auto-extending lock,</span>
<a id="__codelineno-2-445" name="__codelineno-2-445"></a><a href="#__codelineno-2-445"><span class="linenos" data-linenos="445 "></span></a><span class="cm">   * returning a promise of the routine&#39;s value. In the case that auto-extension</span>
<a id="__codelineno-2-446" name="__codelineno-2-446"></a><a href="#__codelineno-2-446"><span class="linenos" data-linenos="446 "></span></a><span class="cm">   * fails, an AbortSignal will be updated to indicate that abortion of the</span>
<a id="__codelineno-2-447" name="__codelineno-2-447"></a><a href="#__codelineno-2-447"><span class="linenos" data-linenos="447 "></span></a><span class="cm">   * routine is in order, and to pass along the encountered error.</span>
<a id="__codelineno-2-448" name="__codelineno-2-448"></a><a href="#__codelineno-2-448"><span class="linenos" data-linenos="448 "></span></a><span class="cm">   *</span>
<a id="__codelineno-2-449" name="__codelineno-2-449"></a><a href="#__codelineno-2-449"><span class="linenos" data-linenos="449 "></span></a><span class="cm">   * @example</span>
<a id="__codelineno-2-450" name="__codelineno-2-450"></a><a href="#__codelineno-2-450"><span class="linenos" data-linenos="450 "></span></a><span class="cm">   * ```ts</span>
<a id="__codelineno-2-451" name="__codelineno-2-451"></a><a href="#__codelineno-2-451"><span class="linenos" data-linenos="451 "></span></a><span class="cm">   * await redlock.using([senderId, recipientId], 5000, { retryCount: 5 }, async (signal) =&gt; {</span>
<a id="__codelineno-2-452" name="__codelineno-2-452"></a><a href="#__codelineno-2-452"><span class="linenos" data-linenos="452 "></span></a><span class="cm">   *   const senderBalance = await getBalance(senderId);</span>
<a id="__codelineno-2-453" name="__codelineno-2-453"></a><a href="#__codelineno-2-453"><span class="linenos" data-linenos="453 "></span></a><span class="cm">   *   const recipientBalance = await getBalance(recipientId);</span>
<a id="__codelineno-2-454" name="__codelineno-2-454"></a><a href="#__codelineno-2-454"><span class="linenos" data-linenos="454 "></span></a><span class="cm">   *</span>
<a id="__codelineno-2-455" name="__codelineno-2-455"></a><a href="#__codelineno-2-455"><span class="linenos" data-linenos="455 "></span></a><span class="cm">   *   if (senderBalance &lt; amountToSend) {</span>
<a id="__codelineno-2-456" name="__codelineno-2-456"></a><a href="#__codelineno-2-456"><span class="linenos" data-linenos="456 "></span></a><span class="cm">   *     throw new Error(&quot;Insufficient balance.&quot;);</span>
<a id="__codelineno-2-457" name="__codelineno-2-457"></a><a href="#__codelineno-2-457"><span class="linenos" data-linenos="457 "></span></a><span class="cm">   *   }</span>
<a id="__codelineno-2-458" name="__codelineno-2-458"></a><a href="#__codelineno-2-458"><span class="linenos" data-linenos="458 "></span></a><span class="cm">   *</span>
<a id="__codelineno-2-459" name="__codelineno-2-459"></a><a href="#__codelineno-2-459"><span class="linenos" data-linenos="459 "></span></a><span class="cm">   *   // The abort signal will be true if:</span>
<a id="__codelineno-2-460" name="__codelineno-2-460"></a><a href="#__codelineno-2-460"><span class="linenos" data-linenos="460 "></span></a><span class="cm">   *   // 1. the above took long enough that the lock needed to be extended</span>
<a id="__codelineno-2-461" name="__codelineno-2-461"></a><a href="#__codelineno-2-461"><span class="linenos" data-linenos="461 "></span></a><span class="cm">   *   // 2. redlock was unable to extend the lock</span>
<a id="__codelineno-2-462" name="__codelineno-2-462"></a><a href="#__codelineno-2-462"><span class="linenos" data-linenos="462 "></span></a><span class="cm">   *   //</span>
<a id="__codelineno-2-463" name="__codelineno-2-463"></a><a href="#__codelineno-2-463"><span class="linenos" data-linenos="463 "></span></a><span class="cm">   *   // In such a case, exclusivity can no longer be guaranteed for further</span>
<a id="__codelineno-2-464" name="__codelineno-2-464"></a><a href="#__codelineno-2-464"><span class="linenos" data-linenos="464 "></span></a><span class="cm">   *   // operations, and should be handled as an exceptional case.</span>
<a id="__codelineno-2-465" name="__codelineno-2-465"></a><a href="#__codelineno-2-465"><span class="linenos" data-linenos="465 "></span></a><span class="cm">   *   if (signal.aborted) {</span>
<a id="__codelineno-2-466" name="__codelineno-2-466"></a><a href="#__codelineno-2-466"><span class="linenos" data-linenos="466 "></span></a><span class="cm">   *     throw signal.error;</span>
<a id="__codelineno-2-467" name="__codelineno-2-467"></a><a href="#__codelineno-2-467"><span class="linenos" data-linenos="467 "></span></a><span class="cm">   *   }</span>
<a id="__codelineno-2-468" name="__codelineno-2-468"></a><a href="#__codelineno-2-468"><span class="linenos" data-linenos="468 "></span></a><span class="cm">   *</span>
<a id="__codelineno-2-469" name="__codelineno-2-469"></a><a href="#__codelineno-2-469"><span class="linenos" data-linenos="469 "></span></a><span class="cm">   *   await setBalances([</span>
<a id="__codelineno-2-470" name="__codelineno-2-470"></a><a href="#__codelineno-2-470"><span class="linenos" data-linenos="470 "></span></a><span class="cm">   *     {id: senderId, balance: senderBalance - amountToSend},</span>
<a id="__codelineno-2-471" name="__codelineno-2-471"></a><a href="#__codelineno-2-471"><span class="linenos" data-linenos="471 "></span></a><span class="cm">   *     {id: recipientId, balance: recipientBalance + amountToSend},</span>
<a id="__codelineno-2-472" name="__codelineno-2-472"></a><a href="#__codelineno-2-472"><span class="linenos" data-linenos="472 "></span></a><span class="cm">   *   ]);</span>
<a id="__codelineno-2-473" name="__codelineno-2-473"></a><a href="#__codelineno-2-473"><span class="linenos" data-linenos="473 "></span></a><span class="cm">   * });</span>
<a id="__codelineno-2-474" name="__codelineno-2-474"></a><a href="#__codelineno-2-474"><span class="linenos" data-linenos="474 "></span></a><span class="cm">   * ```</span>
<a id="__codelineno-2-475" name="__codelineno-2-475"></a><a href="#__codelineno-2-475"><span class="linenos" data-linenos="475 "></span></a><span class="cm">   */</span><span class="w"></span>
<a id="__codelineno-2-476" name="__codelineno-2-476"></a><a href="#__codelineno-2-476"><span class="linenos" data-linenos="476 "></span></a>
<a id="__codelineno-2-477" name="__codelineno-2-477"></a><a href="#__codelineno-2-477"><span class="linenos" data-linenos="477 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">using</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-478" name="__codelineno-2-478"></a><a href="#__codelineno-2-478"><span class="linenos" data-linenos="478 "></span></a><span class="w">    </span><span class="nx">resources</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[],</span><span class="w"></span>
<a id="__codelineno-2-479" name="__codelineno-2-479"></a><a href="#__codelineno-2-479"><span class="linenos" data-linenos="479 "></span></a><span class="w">    </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-480" name="__codelineno-2-480"></a><a href="#__codelineno-2-480"><span class="linenos" data-linenos="480 "></span></a><span class="w">    </span><span class="nx">settings</span><span class="o">:</span><span class="w"> </span><span class="kt">Partial</span><span class="o">&lt;</span><span class="nx">Settings</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-481" name="__codelineno-2-481"></a><a href="#__codelineno-2-481"><span class="linenos" data-linenos="481 "></span></a><span class="w">    </span><span class="nx">routine</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">signal</span><span class="o">:</span><span class="w"> </span><span class="kt">RedlockAbortSignal</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-2-482" name="__codelineno-2-482"></a><a href="#__codelineno-2-482"><span class="linenos" data-linenos="482 "></span></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-483" name="__codelineno-2-483"></a><a href="#__codelineno-2-483"><span class="linenos" data-linenos="483 "></span></a>
<a id="__codelineno-2-484" name="__codelineno-2-484"></a><a href="#__codelineno-2-484"><span class="linenos" data-linenos="484 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">using</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-485" name="__codelineno-2-485"></a><a href="#__codelineno-2-485"><span class="linenos" data-linenos="485 "></span></a><span class="w">    </span><span class="nx">resources</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[],</span><span class="w"></span>
<a id="__codelineno-2-486" name="__codelineno-2-486"></a><a href="#__codelineno-2-486"><span class="linenos" data-linenos="486 "></span></a><span class="w">    </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-487" name="__codelineno-2-487"></a><a href="#__codelineno-2-487"><span class="linenos" data-linenos="487 "></span></a><span class="w">    </span><span class="nx">routine</span><span class="o">:</span><span class="w"> </span><span class="p">(</span><span class="nx">signal</span><span class="o">:</span><span class="w"> </span><span class="kt">RedlockAbortSignal</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-2-488" name="__codelineno-2-488"></a><a href="#__codelineno-2-488"><span class="linenos" data-linenos="488 "></span></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-489" name="__codelineno-2-489"></a><a href="#__codelineno-2-489"><span class="linenos" data-linenos="489 "></span></a>
<a id="__codelineno-2-490" name="__codelineno-2-490"></a><a href="#__codelineno-2-490"><span class="linenos" data-linenos="490 "></span></a><span class="w">  </span><span class="k">public</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="nx">using</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-491" name="__codelineno-2-491"></a><a href="#__codelineno-2-491"><span class="linenos" data-linenos="491 "></span></a><span class="w">    </span><span class="nx">resources</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">[],</span><span class="w"></span>
<a id="__codelineno-2-492" name="__codelineno-2-492"></a><a href="#__codelineno-2-492"><span class="linenos" data-linenos="492 "></span></a><span class="w">    </span><span class="nx">duration</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-493" name="__codelineno-2-493"></a><a href="#__codelineno-2-493"><span class="linenos" data-linenos="493 "></span></a><span class="w">    </span><span class="nx">settingsOrRoutine</span><span class="o">:</span><span class="w"></span>
<a id="__codelineno-2-494" name="__codelineno-2-494"></a><a href="#__codelineno-2-494"><span class="linenos" data-linenos="494 "></span></a><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="kc">undefined</span><span class="w"></span>
<a id="__codelineno-2-495" name="__codelineno-2-495"></a><a href="#__codelineno-2-495"><span class="linenos" data-linenos="495 "></span></a><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="nx">Partial</span><span class="o">&lt;</span><span class="nx">Settings</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-2-496" name="__codelineno-2-496"></a><a href="#__codelineno-2-496"><span class="linenos" data-linenos="496 "></span></a><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="p">((</span><span class="nx">signal</span><span class="o">:</span><span class="w"> </span><span class="kt">RedlockAbortSignal</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-2-497" name="__codelineno-2-497"></a><a href="#__codelineno-2-497"><span class="linenos" data-linenos="497 "></span></a><span class="w">    </span><span class="nx">optionalRoutine</span><span class="o">?:</span><span class="w"> </span><span class="p">(</span><span class="nx">signal</span><span class="o">:</span><span class="w"> </span><span class="kt">RedlockAbortSignal</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="w"></span>
<a id="__codelineno-2-498" name="__codelineno-2-498"></a><a href="#__codelineno-2-498"><span class="linenos" data-linenos="498 "></span></a><span class="w">  </span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-499" name="__codelineno-2-499"></a><a href="#__codelineno-2-499"><span class="linenos" data-linenos="499 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">settings</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<a id="__codelineno-2-500" name="__codelineno-2-500"></a><a href="#__codelineno-2-500"><span class="linenos" data-linenos="500 "></span></a><span class="w">      </span><span class="nx">settingsOrRoutine</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">settingsOrRoutine</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;function&quot;</span><span class="w"></span>
<a id="__codelineno-2-501" name="__codelineno-2-501"></a><a href="#__codelineno-2-501"><span class="linenos" data-linenos="501 "></span></a><span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-502" name="__codelineno-2-502"></a><a href="#__codelineno-2-502"><span class="linenos" data-linenos="502 "></span></a><span class="w">            </span><span class="p">...</span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-503" name="__codelineno-2-503"></a><a href="#__codelineno-2-503"><span class="linenos" data-linenos="503 "></span></a><span class="w">            </span><span class="p">...</span><span class="nx">settingsOrRoutine</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-2-504" name="__codelineno-2-504"></a><a href="#__codelineno-2-504"><span class="linenos" data-linenos="504 "></span></a><span class="w">          </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-505" name="__codelineno-2-505"></a><a href="#__codelineno-2-505"><span class="linenos" data-linenos="505 "></span></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">settings</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-506" name="__codelineno-2-506"></a><a href="#__codelineno-2-506"><span class="linenos" data-linenos="506 "></span></a>
<a id="__codelineno-2-507" name="__codelineno-2-507"></a><a href="#__codelineno-2-507"><span class="linenos" data-linenos="507 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">routine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">optionalRoutine</span><span class="w"> </span><span class="o">??</span><span class="w"> </span><span class="nx">settingsOrRoutine</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-508" name="__codelineno-2-508"></a><a href="#__codelineno-2-508"><span class="linenos" data-linenos="508 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">routine</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s2">&quot;function&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-509" name="__codelineno-2-509"></a><a href="#__codelineno-2-509"><span class="linenos" data-linenos="509 "></span></a><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="s2">&quot;INVARIANT: routine is not a function.&quot;</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-510" name="__codelineno-2-510"></a><a href="#__codelineno-2-510"><span class="linenos" data-linenos="510 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-511" name="__codelineno-2-511"></a><a href="#__codelineno-2-511"><span class="linenos" data-linenos="511 "></span></a>
<a id="__codelineno-2-512" name="__codelineno-2-512"></a><a href="#__codelineno-2-512"><span class="linenos" data-linenos="512 "></span></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">settings</span><span class="p">.</span><span class="nx">automaticExtensionThreshold</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nx">duration</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-513" name="__codelineno-2-513"></a><a href="#__codelineno-2-513"><span class="linenos" data-linenos="513 "></span></a><span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-514" name="__codelineno-2-514"></a><a href="#__codelineno-2-514"><span class="linenos" data-linenos="514 "></span></a><span class="w">        </span><span class="s2">&quot;A lock `duration` must be at least 100ms greater than the `automaticExtensionThreshold` setting.&quot;</span><span class="w"></span>
<a id="__codelineno-2-515" name="__codelineno-2-515"></a><a href="#__codelineno-2-515"><span class="linenos" data-linenos="515 "></span></a><span class="w">      </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-516" name="__codelineno-2-516"></a><a href="#__codelineno-2-516"><span class="linenos" data-linenos="516 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-517" name="__codelineno-2-517"></a><a href="#__codelineno-2-517"><span class="linenos" data-linenos="517 "></span></a>
<a id="__codelineno-2-518" name="__codelineno-2-518"></a><a href="#__codelineno-2-518"><span class="linenos" data-linenos="518 "></span></a><span class="w">    </span><span class="c1">// The AbortController/AbortSignal pattern allows the routine to be notified</span><span class="w"></span>
<a id="__codelineno-2-519" name="__codelineno-2-519"></a><a href="#__codelineno-2-519"><span class="linenos" data-linenos="519 "></span></a><span class="w">    </span><span class="c1">// of a failure to extend the lock, and subsequent expiration. In the event</span><span class="w"></span>
<a id="__codelineno-2-520" name="__codelineno-2-520"></a><a href="#__codelineno-2-520"><span class="linenos" data-linenos="520 "></span></a><span class="w">    </span><span class="c1">// of an abort, the error object will be made available at `signal.error`.</span><span class="w"></span>
<a id="__codelineno-2-521" name="__codelineno-2-521"></a><a href="#__codelineno-2-521"><span class="linenos" data-linenos="521 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">controller</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<a id="__codelineno-2-522" name="__codelineno-2-522"></a><a href="#__codelineno-2-522"><span class="linenos" data-linenos="522 "></span></a><span class="w">      </span><span class="ow">typeof</span><span class="w"> </span><span class="nx">AbortController</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;undefined&quot;</span><span class="w"></span>
<a id="__codelineno-2-523" name="__codelineno-2-523"></a><a href="#__codelineno-2-523"><span class="linenos" data-linenos="523 "></span></a><span class="w">        </span><span class="o">?</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">PolyfillAbortController</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-2-524" name="__codelineno-2-524"></a><a href="#__codelineno-2-524"><span class="linenos" data-linenos="524 "></span></a><span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">AbortController</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-525" name="__codelineno-2-525"></a><a href="#__codelineno-2-525"><span class="linenos" data-linenos="525 "></span></a>
<a id="__codelineno-2-526" name="__codelineno-2-526"></a><a href="#__codelineno-2-526"><span class="linenos" data-linenos="526 "></span></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">signal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">controller</span><span class="p">.</span><span class="nx">signal</span><span class="w"> </span><span class="kr">as</span><span class="w"> </span><span class="nx">RedlockAbortSignal</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-527" name="__codelineno-2-527"></a><a href="#__codelineno-2-527"><span class="linenos" data-linenos="527 "></span></a>
<a id="__codelineno-2-528" name="__codelineno-2-528"></a><a href="#__codelineno-2-528"><span class="linenos" data-linenos="528 "></span></a><span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">queue</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="ow">void</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-529" name="__codelineno-2-529"></a><a href="#__codelineno-2-529"><span class="linenos" data-linenos="529 "></span></a><span class="w">      </span><span class="nx">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-2-530" name="__codelineno-2-530"></a><a href="#__codelineno-2-530"><span class="linenos" data-linenos="530 "></span></a><span class="w">        </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">extension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">extend</span><span class="p">()),</span><span class="w"></span>
<a id="__codelineno-2-531" name="__codelineno-2-531"></a><a href="#__codelineno-2-531"><span class="linenos" data-linenos="531 "></span></a><span class="w">        </span><span class="nx">lock</span><span class="p">.</span><span class="nx">expiration</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">settings</span><span class="p">.</span><span class="nx">automaticExtensionThreshold</span><span class="w"></span>
<a id="__codelineno-2-532" name="__codelineno-2-532"></a><a href="#__codelineno-2-532"><span class="linenos" data-linenos="532 "></span></a><span class="w">      </span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-533" name="__codelineno-2-533"></a><a href="#__codelineno-2-533"><span class="linenos" data-linenos="533 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-534" name="__codelineno-2-534"></a><a href="#__codelineno-2-534"><span class="linenos" data-linenos="534 "></span></a>
<a id="__codelineno-2-535" name="__codelineno-2-535"></a><a href="#__codelineno-2-535"><span class="linenos" data-linenos="535 "></span></a><span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">extend</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-536" name="__codelineno-2-536"></a><a href="#__codelineno-2-536"><span class="linenos" data-linenos="536 "></span></a><span class="w">      </span><span class="nx">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-537" name="__codelineno-2-537"></a><a href="#__codelineno-2-537"><span class="linenos" data-linenos="537 "></span></a>
<a id="__codelineno-2-538" name="__codelineno-2-538"></a><a href="#__codelineno-2-538"><span class="linenos" data-linenos="538 "></span></a><span class="w">      </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-539" name="__codelineno-2-539"></a><a href="#__codelineno-2-539"><span class="linenos" data-linenos="539 "></span></a><span class="w">        </span><span class="nx">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">lock</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">duration</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-540" name="__codelineno-2-540"></a><a href="#__codelineno-2-540"><span class="linenos" data-linenos="540 "></span></a><span class="w">        </span><span class="nx">queue</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-541" name="__codelineno-2-541"></a><a href="#__codelineno-2-541"><span class="linenos" data-linenos="541 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-542" name="__codelineno-2-542"></a><a href="#__codelineno-2-542"><span class="linenos" data-linenos="542 "></span></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">lock</span><span class="p">.</span><span class="nx">expiration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-543" name="__codelineno-2-543"></a><a href="#__codelineno-2-543"><span class="linenos" data-linenos="543 "></span></a><span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="nx">extension</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">extend</span><span class="p">());</span><span class="w"></span>
<a id="__codelineno-2-544" name="__codelineno-2-544"></a><a href="#__codelineno-2-544"><span class="linenos" data-linenos="544 "></span></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-545" name="__codelineno-2-545"></a><a href="#__codelineno-2-545"><span class="linenos" data-linenos="545 "></span></a>
<a id="__codelineno-2-546" name="__codelineno-2-546"></a><a href="#__codelineno-2-546"><span class="linenos" data-linenos="546 "></span></a><span class="w">        </span><span class="nx">signal</span><span class="p">.</span><span class="nx">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="ne">Error</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">new</span><span class="w"> </span><span class="ne">Error</span><span class="p">(</span><span class="sb">`</span><span class="si">${</span><span class="nx">error</span><span class="si">}</span><span class="sb">`</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-547" name="__codelineno-2-547"></a><a href="#__codelineno-2-547"><span class="linenos" data-linenos="547 "></span></a><span class="w">        </span><span class="nx">controller</span><span class="p">.</span><span class="nx">abort</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-548" name="__codelineno-2-548"></a><a href="#__codelineno-2-548"><span class="linenos" data-linenos="548 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-549" name="__codelineno-2-549"></a><a href="#__codelineno-2-549"><span class="linenos" data-linenos="549 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-550" name="__codelineno-2-550"></a><a href="#__codelineno-2-550"><span class="linenos" data-linenos="550 "></span></a>
<a id="__codelineno-2-551" name="__codelineno-2-551"></a><a href="#__codelineno-2-551"><span class="linenos" data-linenos="551 "></span></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">timeout</span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">NodeJS</span><span class="p">.</span><span class="nx">Timeout</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-552" name="__codelineno-2-552"></a><a href="#__codelineno-2-552"><span class="linenos" data-linenos="552 "></span></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">extension</span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-553" name="__codelineno-2-553"></a><a href="#__codelineno-2-553"><span class="linenos" data-linenos="553 "></span></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="nx">acquire</span><span class="p">(</span><span class="nx">resources</span><span class="p">,</span><span class="w"> </span><span class="nx">duration</span><span class="p">,</span><span class="w"> </span><span class="nx">settings</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-554" name="__codelineno-2-554"></a><a href="#__codelineno-2-554"><span class="linenos" data-linenos="554 "></span></a><span class="w">    </span><span class="nx">queue</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-555" name="__codelineno-2-555"></a><a href="#__codelineno-2-555"><span class="linenos" data-linenos="555 "></span></a>
<a id="__codelineno-2-556" name="__codelineno-2-556"></a><a href="#__codelineno-2-556"><span class="linenos" data-linenos="556 "></span></a><span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-557" name="__codelineno-2-557"></a><a href="#__codelineno-2-557"><span class="linenos" data-linenos="557 "></span></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">routine</span><span class="p">(</span><span class="nx">signal</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-558" name="__codelineno-2-558"></a><a href="#__codelineno-2-558"><span class="linenos" data-linenos="558 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-559" name="__codelineno-2-559"></a><a href="#__codelineno-2-559"><span class="linenos" data-linenos="559 "></span></a><span class="w">      </span><span class="c1">// Clean up the timer.</span><span class="w"></span>
<a id="__codelineno-2-560" name="__codelineno-2-560"></a><a href="#__codelineno-2-560"><span class="linenos" data-linenos="560 "></span></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-561" name="__codelineno-2-561"></a><a href="#__codelineno-2-561"><span class="linenos" data-linenos="561 "></span></a><span class="w">        </span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">timeout</span><span class="p">);</span><span class="w"></span>
<a id="__codelineno-2-562" name="__codelineno-2-562"></a><a href="#__codelineno-2-562"><span class="linenos" data-linenos="562 "></span></a><span class="w">        </span><span class="nx">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">undefined</span><span class="p">;</span><span class="w"></span>
<a id="__codelineno-2-563" name="__codelineno-2-563"></a><a href="#__codelineno-2-563"><span class="linenos" data-linenos="563 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-564" name="__codelineno-2-564"></a><a href="#__codelineno-2-564"><span class="linenos" data-linenos="564 "></span></a>
<a id="__codelineno-2-565" name="__codelineno-2-565"></a><a href="#__codelineno-2-565"><span class="linenos" data-linenos="565 "></span></a><span class="w">      </span><span class="c1">// Wait for an in-flight extension to finish.</span><span class="w"></span>
<a id="__codelineno-2-566" name="__codelineno-2-566"></a><a href="#__codelineno-2-566"><span class="linenos" data-linenos="566 "></span></a><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">extension</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-567" name="__codelineno-2-567"></a><a href="#__codelineno-2-567"><span class="linenos" data-linenos="567 "></span></a><span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">extension</span><span class="p">.</span><span class="k">catch</span><span class="p">(()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-2-568" name="__codelineno-2-568"></a><a href="#__codelineno-2-568"><span class="linenos" data-linenos="568 "></span></a><span class="w">          </span><span class="c1">// An error here doesn&#39;t matter at all, because the routine has</span><span class="w"></span>
<a id="__codelineno-2-569" name="__codelineno-2-569"></a><a href="#__codelineno-2-569"><span class="linenos" data-linenos="569 "></span></a><span class="w">          </span><span class="c1">// already completed, and a release will be attempted regardless. The</span><span class="w"></span>
<a id="__codelineno-2-570" name="__codelineno-2-570"></a><a href="#__codelineno-2-570"><span class="linenos" data-linenos="570 "></span></a><span class="w">          </span><span class="c1">// only reason for waiting here is to prevent possible contention</span><span class="w"></span>
<a id="__codelineno-2-571" name="__codelineno-2-571"></a><a href="#__codelineno-2-571"><span class="linenos" data-linenos="571 "></span></a><span class="w">          </span><span class="c1">// between the extension and release.</span><span class="w"></span>
<a id="__codelineno-2-572" name="__codelineno-2-572"></a><a href="#__codelineno-2-572"><span class="linenos" data-linenos="572 "></span></a><span class="w">        </span><span class="p">});</span><span class="w"></span>
<a id="__codelineno-2-573" name="__codelineno-2-573"></a><a href="#__codelineno-2-573"><span class="linenos" data-linenos="573 "></span></a><span class="w">      </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-574" name="__codelineno-2-574"></a><a href="#__codelineno-2-574"><span class="linenos" data-linenos="574 "></span></a>
<a id="__codelineno-2-575" name="__codelineno-2-575"></a><a href="#__codelineno-2-575"><span class="linenos" data-linenos="575 "></span></a><span class="w">      </span><span class="k">await</span><span class="w"> </span><span class="nx">lock</span><span class="p">.</span><span class="nx">release</span><span class="p">();</span><span class="w"></span>
<a id="__codelineno-2-576" name="__codelineno-2-576"></a><a href="#__codelineno-2-576"><span class="linenos" data-linenos="576 "></span></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-577" name="__codelineno-2-577"></a><a href="#__codelineno-2-577"><span class="linenos" data-linenos="577 "></span></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-2-578" name="__codelineno-2-578"></a><a href="#__codelineno-2-578"><span class="linenos" data-linenos="578 "></span></a><span class="p">}</span><span class="w"></span>
</code></pre></div>

              
            </article>
          </div>
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" data-md-state="hidden">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"/></svg>
            回到页面顶部
          </a>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="页脚">
      
        
        <a href="../node-redlock/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Node Redlock" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                上一页
              </span>
              Node Redlock
            </div>
          </div>
        </a>
      
      
        
        <a href="../node-redlock5/" class="md-footer__link md-footer__link--next" aria-label="下一页: Node Redlock5" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                下一页
              </span>
              Node Redlock5
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.indexes", "navigation.top"], "search": "../../../assets/javascripts/workers/search.5e67fbfe.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.e87a5f81.min.js"></script>
      
    
  </body>
</html>