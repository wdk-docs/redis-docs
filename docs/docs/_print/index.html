<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<link rel="canonical" type="text/html" href="/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>文档 | redis 文档</title>
<meta name="description" content="">
<meta property="og:title" content="文档" />
<meta property="og:description" content="redis 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/" /><meta property="og:site_name" content="redis 文档" />

<meta itemprop="name" content="文档">
<meta itemprop="description" content="redis 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="文档"/>
<meta name="twitter:description" content="redis 文档"/>




<link rel="preload" href="/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" as="style">
<link href="/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">redis 文档</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>博客</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/docs/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">文档</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-89febb737799ee1e7aa272e0c6329d7a">lua</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-21a8608d70df92d119cd94238aea83e6">关于</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-83439823381efc633ee35c9868ec45fb">参考手册</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>1.3: <a href="#pg-d55faf052269e5c1f1835c523c70e0be">入门</a></li>


    
  
    
    
	
<li>1.4: <a href="#pg-f7b06a9ac66aa9b8f404b774cca2117b">下载</a></li>


    
  
    
    
	
<li>1.5: <a href="#pg-2010e1a4a2ee6d01e195febb8dc0c4cb">文档</a></li>


    
  
    
    
	
<li>1.6: <a href="#pg-bcdc4ca857581f54d61eee7c3efb133c">社区</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-7757a61a8d7c4abecc70a803b4d122e3">Redis 锁</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-4a08525c4153cbeb2aed69bc12a2e776">Node Redlock</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-bdae7fb0ccc7d882f43356aad27a2029">Node Redlock5</a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-4106cc913393c91ef771f1a9c0ea69d7">Node Redlock5 API</a></li>


    
  
    
    
	
<li>2.4: <a href="#pg-105d23b4f32df8923e76a7541a236534">warlock</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-a298ae59966025b11c5d3db9e5439423">ioredis</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-7dc15eb27b1a9435aa7d664e23fe3807">快速入门</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-ecde650262f1a1171dd464ff05b45476">连接</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-f69c80caa3d66b8aa309a605e9f3eac0">TLS</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-2343bd3dda769573f9bfbbd6acb0a7a0">流和二进制</a></li>


    
  
    
    
	
<li>3.5: <a href="#pg-cb6c8f83462149a16d76c4dd48656489">Lua 脚本</a></li>


    
  
    
    
	
<li>3.6: <a href="#pg-6b3e092823019df7e9d60d6a581cd606">Pipelining</a></li>


    
  
    
    
	
<li>3.7: <a href="#pg-10ea60f135a3f7ec97831781e6e8d908">Pub/Sub</a></li>


    
  
    
    
	
<li>3.8: <a href="#pg-2507e639715a46af5c576fcdae1ad5d5">Sentinel</a></li>


    
  
    
    
	
<li>3.9: <a href="#pg-01b6f9e61cef026000ac5289660fd21b">Cluster</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-6167cf947d7672083e29d66e95ef4d27">egg redis</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-e82af8709aafd470614bebb3b2c7681c">Node Redis</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>


<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-89febb737799ee1e7aa272e0c6329d7a">1 - lua</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-21a8608d70df92d119cd94238aea83e6">1.1 - 关于</h1>
    
	<h2 id="什么是-lua">什么是 Lua?</h2>
<p>Lua is a powerful, efficient, lightweight, embeddable scripting language.
It supports procedural programming, object-oriented programming, functional programming, data-driven programming, and data description.</p>
<p>Lua combines simple procedural syntax with powerful data description constructs based on associative arrays and extensible semantics.
Lua is dynamically typed, runs by interpreting bytecode with a register-based virtual machine, and has automatic memory management with incremental garbage collection, making it ideal for configuration, scripting, and rapid prototyping.</p>
<h2 id="lua-来自哪里">Lua 来自哪里?</h2>
<p>Lua is designed, implemented, and maintained by a team at PUC-Rio, the Pontifical Catholic University of Rio de Janeiro in Brazil.
Lua was born and raised in Tecgraf, formerly the Computer Graphics Technology Group of PUC-Rio.
Lua is now housed at LabLua, a laboratory of the Department of Computer Science of PUC-Rio.</p>
<h2 id="whats-in-a-name">What&rsquo;s in a name?</h2>
<p>&ldquo;Lua&rdquo; (pronounced LOO-ah) means &ldquo;Moon&rdquo; in Portuguese.
As such, it is neither an acronym nor an abbreviation, but a noun.
More specifically, &ldquo;Lua&rdquo; is a name, the name of the Earth&rsquo;s moon and the name of the language.
Like most names, it should be written in lower case with an initial capital, that is, &ldquo;Lua&rdquo;.
Please do not write it as &ldquo;LUA&rdquo;, which is both ugly and confusing, because then it becomes an acronym with different meanings for different people.
So, please, write &ldquo;Lua&rdquo; right!</p>
<h2 id="加入社区">加入社区</h2>
<p>There are several meeting places for the Lua community where you can go to learn and help others and contribute in other ways.
One of the focal points is the mailing list, which is very active and friendly.</p>
<p>You can meet part of the Lua community in person by attending a Lua Workshop.</p>
<h2 id="支持-lua">支持 Lua</h2>
<p>You can help to support the Lua project by buying a book published by Lua.org and by making a donation.</p>
<p>You can also help to spread the word about Lua by buying Lua products at Zazzle.</p>
<p>Lua.org is an Amazon Associate and we get commissions for qualifying purchases made through links in this site.</p>
<h2 id="为什么选择-lua">为什么选择 Lua?</h2>
<h3 id="lua-是一种经过验证的健壮的语言">Lua 是一种经过验证的、健壮的语言</h3>
<p>Lua has been used in many industrial applications (e.g., Adobe&rsquo;s Photoshop Lightroom), with an emphasis on embedded systems (e.g., the Ginga middleware for digital TV in Brazil) and games (e.g., World of Warcraft and Angry Birds).
Lua is currently the leading scripting language in games.
Lua has a solid reference manual and there are several books about it.
Several versions of Lua have been released and used in real applications since its creation in 1993.
Lua featured in HOPL III, the Third ACM SIGPLAN History of Programming Languages Conference, in 2007.
Lua won the Front Line Award 2011 from the Game Developers Magazine.</p>
<h3 id="lua-快速的">Lua 快速的</h3>
<p>Lua has a deserved reputation for performance.
To claim to be &ldquo;as fast as Lua&rdquo; is an aspiration of other scripting languages.
Several benchmarks show Lua as the fastest language in the realm of interpreted scripting languages.
Lua is fast not only in fine-tuned benchmark programs, but in real life too.
Substantial fractions of large applications have been written in Lua.</p>
<p>If you need even more speed, try LuaJIT, an independent implementation of Lua using a just-in-time compiler.</p>
<h3 id="lua-是可移植的">Lua 是可移植的</h3>
<p>Lua is distributed in a small package and builds out-of-the-box in all platforms that have a standard C compiler.
Lua runs on all flavors of Unix and Windows, on mobile devices (running Android, iOS, BREW, Symbian, Windows Phone), on embedded microprocessors (such as ARM and Rabbit, for applications like Lego MindStorms), on IBM mainframes, etc.</p>
<p>For specific reasons why Lua is a good choice also for constrained devices, read this summary by Mike Pall.
See also a poster created by Timm Müller.</p>
<h3 id="lua-是可嵌入的">Lua 是可嵌入的</h3>
<p>Lua is a fast language engine with small footprint that you can embed easily into your application.
Lua has a simple and well documented API that allows strong integration with code written in other languages.
It is easy to extend Lua with libraries written in other languages.
It is also easy to extend programs written in other languages with Lua.
Lua has been used to extend programs written not only in C and C++, but also in Java, C#, Smalltalk, Fortran, Ada, Erlang, and even in other scripting languages, such as Perl and Ruby.</p>
<h3 id="lua-功能强大但简单">Lua 功能强大(但简单)</h3>
<p>A fundamental concept in the design of Lua is to provide meta-mechanisms for implementing features, instead of providing a host of features directly in the language.
For example, although Lua is not a pure object-oriented language, it does provide meta-mechanisms for implementing classes and inheritance.
Lua&rsquo;s meta-mechanisms bring an economy of concepts and keep the language small, while allowing the semantics to be extended in unconventional ways.</p>
<h3 id="lua-是小的">Lua 是小的</h3>
<p>Adding Lua to an application does not bloat it.
The tarball for Lua 5.4.3, which contains source code and documentation, takes 350K compressed and 1.3M uncompressed.
The source contains around 29000 lines of C.
Under 64-bit Linux, the Lua interpreter built with all standard Lua libraries takes 278K and the Lua library takes 466K.</p>
<h3 id="lua-开源的">Lua 开源的</h3>
<p>Lua is free open-source software, distributed under a very liberal license (the well-known MIT license).
It may be used for any purpose, including commercial purposes, at absolutely no cost.
Just download it and use it.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-83439823381efc633ee35c9868ec45fb">1.2 - 参考手册</h1>
    
	<p>The reference manual is the official definition of the Lua language.
For a complete introduction to Lua programming, see the book Programming in Lua.</p>
<p>start · contents · index · other versions
Copyright © 2020–2021 Lua.org, PUC-Rio. Freely available under the terms of the Lua license.</p>
<h2 id="contents">Contents</h2>
<ol>
<li>– Introduction</li>
<li>– Basic Concepts
<ol>
<li>– Values and Types</li>
<li>– Environments and the Global Environment</li>
<li>– Error Handling</li>
<li>– Metatables and Metamethods</li>
<li>– Garbage Collection
<ol>
<li>– Incremental Garbage Collection</li>
<li>– Generational Garbage Collection</li>
<li>– Garbage-Collection Metamethods</li>
<li>– Weak Tables</li>
</ol>
</li>
<li>– Coroutines</li>
</ol>
</li>
<li>– The Language
<ol>
<li>– Lexical Conventions</li>
<li>– Variables</li>
<li>– Statements
<ol>
<li>– Blocks</li>
<li>– Chunks</li>
<li>– Assignment</li>
<li>– Control Structures</li>
<li>– For Statement</li>
<li>– Function Calls as Statements</li>
<li>– Local Declarations</li>
<li>– To-be-closed Variables</li>
</ol>
</li>
<li>– Expressions
<ol>
<li>– Arithmetic Operators</li>
<li>– Bitwise Operators</li>
<li>– Coercions and Conversions</li>
<li>– Relational Operators</li>
<li>– Logical Operators</li>
<li>– Concatenation</li>
<li>– The Length Operator</li>
<li>– Precedence</li>
<li>– Table Constructors</li>
<li>– Function Calls</li>
<li>– Function Definitions</li>
</ol>
</li>
<li>– Visibility Rules</li>
</ol>
</li>
<li>– The Application Program Interface
<ol>
<li>– The Stack
<ol>
<li>– Stack Size</li>
<li>– Valid and Acceptable Indices</li>
<li>– Pointers to strings</li>
</ol>
</li>
<li>– C Closures</li>
<li>– Registry</li>
<li>– Error Handling in C
<ol>
<li>– Status Codes</li>
</ol>
</li>
<li>– Handling Yields in C</li>
<li>– Functions and Types</li>
<li>– The Debug Interface</li>
</ol>
</li>
<li>– The Auxiliary Library
5.1 – Functions and Types</li>
<li>– The Standard Libraries
<ol>
<li>– Basic Functions</li>
<li>– Coroutine Manipulation</li>
<li>– Modules</li>
<li>– String Manipulation
<ol>
<li>– Patterns</li>
<li>– Format Strings for Pack and Unpack</li>
</ol>
</li>
<li>– UTF-8 Support</li>
<li>– Table Manipulation</li>
<li>– Mathematical Functions</li>
<li>– Input and Output Facilities</li>
<li>– Operating System Facilities</li>
<li>– The Debug Library</li>
</ol>
</li>
<li>– Lua Standalone</li>
<li>– Incompatibilities with the Previous Version
<ol>
<li>– Incompatibilities in the Language</li>
<li>– Incompatibilities in the Libraries</li>
<li>– Incompatibilities in the API</li>
</ol>
</li>
<li>– The Complete Syntax of Lua</li>
</ol>
<h2 id="index">Index</h2>
<h3 id="lua-functions">Lua functions</h3>
<p>basic
_G
_VERSION
assert
collectgarbage
dofile
error
getmetatable
ipairs
load
loadfile
next
pairs
pcall
print
rawequal
rawget
rawlen
rawset
require
select
setmetatable
tonumber
tostring
type
warn
xpcall
coroutine
coroutine.close
coroutine.create
coroutine.isyieldable
coroutine.resume
coroutine.running
coroutine.status
coroutine.wrap
coroutine.yield
debug
debug.debug
debug.gethook
debug.getinfo
debug.getlocal
debug.getmetatable
debug.getregistry
debug.getupvalue
debug.getuservalue
debug.sethook
debug.setlocal
debug.setmetatable
debug.setupvalue
debug.setuservalue
debug.traceback
debug.upvalueid
debug.upvaluejoin
io
io.close
io.flush
io.input
io.lines
io.open
io.output
io.popen
io.read
io.stderr
io.stdin
io.stdout
io.tmpfile
io.type
io.write
file:close
file:flush
file:lines
file:read
file:seek
file:setvbuf
file:write</p>
<p>math
math.abs
math.acos
math.asin
math.atan
math.ceil
math.cos
math.deg
math.exp
math.floor
math.fmod
math.huge
math.log
math.max
math.maxinteger
math.min
math.mininteger
math.modf
math.pi
math.rad
math.random
math.randomseed
math.sin
math.sqrt
math.tan
math.tointeger
math.type
math.ult
os
os.clock
os.date
os.difftime
os.execute
os.exit
os.getenv
os.remove
os.rename
os.setlocale
os.time
os.tmpname
package
package.config
package.cpath
package.loaded
package.loadlib
package.path
package.preload
package.searchers
package.searchpath
string
string.byte
string.char
string.dump
string.find
string.format
string.gmatch
string.gsub
string.len
string.lower
string.match
string.pack
string.packsize
string.rep
string.reverse
string.sub
string.unpack
string.upper
table
table.concat
table.insert
table.move
table.pack
table.remove
table.sort
table.unpack
utf8
utf8.char
utf8.charpattern
utf8.codepoint
utf8.codes
utf8.len
utf8.offset</p>
<h3 id="metamethods">metamethods</h3>
<p>**add
**band
**bnot
**bor
**bxor
**call
**close
**concat
**div
**eq
**gc
**idiv
**index
**le
**len
**lt
**metatable
**mod
**mode
**mul
**name
**newindex
**pairs
**pow
**shl
**shr
**sub
**tostring
__unm</p>
<h3 id="environment-variables">environment variables</h3>
<p>LUA_CPATH
LUA_CPATH_5_4
LUA_INIT
LUA_INIT_5_4
LUA_PATH
LUA_PATH_5_4</p>
<h3 id="c-api">C API</h3>
<p>lua_Alloc
lua_CFunction
lua_Debug
lua_Hook
lua_Integer
lua_KContext
lua_KFunction
lua_Number
lua_Reader
lua_State
lua_Unsigned
lua_WarnFunction
lua_Writer
lua_absindex
lua_arith
lua_atpanic
lua_call
lua_callk
lua_checkstack
lua_close
lua_closeslot
lua_compare
lua_concat
lua_copy
lua_createtable
lua_dump
lua_error
lua_gc
lua_getallocf
lua_getextraspace
lua_getfield
lua_getglobal
lua_gethook
lua_gethookcount
lua_gethookmask
lua_geti
lua_getinfo
lua_getiuservalue
lua_getlocal
lua_getmetatable
lua_getstack
lua_gettable
lua_gettop
lua_getupvalue
lua_insert
lua_isboolean
lua_iscfunction
lua_isfunction
lua_isinteger
lua_islightuserdata
lua_isnil
lua_isnone
lua_isnoneornil
lua_isnumber
lua_isstring
lua_istable
lua_isthread
lua_isuserdata
lua_isyieldable
lua_len
lua_load
lua_newstate
lua_newtable
lua_newthread
lua_newuserdatauv
lua_next
lua_numbertointeger
lua_pcall
lua_pcallk
lua_pop
lua_pushboolean
lua_pushcclosure
lua_pushcfunction
lua_pushfstring
lua_pushglobaltable
lua_pushinteger
lua_pushlightuserdata
lua_pushliteral
lua_pushlstring
lua_pushnil
lua_pushnumber
lua_pushstring
lua_pushthread
lua_pushvalue
lua_pushvfstring
lua_rawequal
lua_rawget
lua_rawgeti
lua_rawgetp
lua_rawlen
lua_rawset
lua_rawseti
lua_rawsetp
lua_register
lua_remove
lua_replace
lua_resetthread
lua_resume
lua_rotate
lua_setallocf
lua_setfield
lua_setglobal
lua_sethook
lua_seti
lua_setiuservalue
lua_setlocal
lua_setmetatable
lua_settable
lua_settop
lua_setupvalue
lua_setwarnf
lua_status
lua_stringtonumber
lua_toboolean
lua_tocfunction
lua_toclose
lua_tointeger
lua_tointegerx
lua_tolstring
lua_tonumber
lua_tonumberx
lua_topointer
lua_tostring
lua_tothread
lua_touserdata
lua_type
lua_typename
lua_upvalueid
lua_upvalueindex
lua_upvaluejoin
lua_version
lua_warning
lua_xmove
lua_yield
lua_yieldk</p>
<h3 id="auxiliary-library">auxiliary library</h3>
<p>luaL_Buffer
luaL_Reg
luaL_Stream
luaL_addchar
luaL_addgsub
luaL_addlstring
luaL_addsize
luaL_addstring
luaL_addvalue
luaL_argcheck
luaL_argerror
luaL_argexpected
luaL_buffaddr
luaL_buffinit
luaL_buffinitsize
luaL_bufflen
luaL_buffsub
luaL_callmeta
luaL_checkany
luaL_checkinteger
luaL_checklstring
luaL_checknumber
luaL_checkoption
luaL_checkstack
luaL_checkstring
luaL_checktype
luaL_checkudata
luaL_checkversion
luaL_dofile
luaL_dostring
luaL_error
luaL_execresult
luaL_fileresult
luaL_getmetafield
luaL_getmetatable
luaL_getsubtable
luaL_gsub
luaL_len
luaL_loadbuffer
luaL_loadbufferx
luaL_loadfile
luaL_loadfilex
luaL_loadstring
luaL_newlib
luaL_newlibtable
luaL_newmetatable
luaL_newstate
luaL_openlibs
luaL_opt
luaL_optinteger
luaL_optlstring
luaL_optnumber
luaL_optstring
luaL_prepbuffer
luaL_prepbuffsize
luaL_pushfail
luaL_pushresult
luaL_pushresultsize
luaL_ref
luaL_requiref
luaL_setfuncs
luaL_setmetatable
luaL_testudata
luaL_tolstring
luaL_traceback
luaL_typeerror
luaL_typename
luaL_unref
luaL_where
standard library
luaopen_base
luaopen_coroutine
luaopen_debug
luaopen_io
luaopen_math
luaopen_os
luaopen_package
luaopen_string
luaopen_table
luaopen_utf8
constants
LUA_ERRERR
LUA_ERRFILE
LUA_ERRMEM
LUA_ERRRUN
LUA_ERRSYNTAX
LUA_HOOKCALL
LUA_HOOKCOUNT
LUA_HOOKLINE
LUA_HOOKRET
LUA_HOOKTAILCALL
LUAL_BUFFERSIZE
LUA_MASKCALL
LUA_MASKCOUNT
LUA_MASKLINE
LUA_MASKRET
LUA_MAXINTEGER
LUA_MININTEGER
LUA_MINSTACK
LUA_MULTRET
LUA_NOREF
LUA_OK
LUA_OPADD
LUA_OPBAND
LUA_OPBNOT
LUA_OPBOR
LUA_OPBXOR
LUA_OPDIV
LUA_OPEQ
LUA_OPIDIV
LUA_OPLE
LUA_OPLT
LUA_OPMOD
LUA_OPMUL
LUA_OPPOW
LUA_OPSHL
LUA_OPSHR
LUA_OPSUB
LUA_OPUNM
LUA_REFNIL
LUA_REGISTRYINDEX
LUA_RIDX_GLOBALS
LUA_RIDX_MAINTHREAD
LUA_TBOOLEAN
LUA_TFUNCTION
LUA_TLIGHTUSERDATA
LUA_TNIL
LUA_TNONE
LUA_TNUMBER
LUA_TSTRING
LUA_TTABLE
LUA_TTHREAD
LUA_TUSERDATA
LUA_USE_APICHECK
LUA_YIELD</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d55faf052269e5c1f1835c523c70e0be">1.3 - 入门</h1>
    
	<h2 id="欢迎">欢迎!</h2>
<p>Lua is a powerful and fast programming language that is easy to learn and use and to embed into your application.</p>
<p>Lua is designed to be a lightweight embeddable scripting language.
It is used for all sorts of applications, from games to web applications and image processing.</p>
<p>See the about page for details and some reasons why you should choose Lua.</p>
<p>See what Lua programs look and feel like in the live demo.</p>
<h2 id="学习">学习</h2>
<p>A good place to start learning Lua is the book Programming in Lua, available in paperback and as an e-book.
The first edition is freely available online.
See also course notes based on this book.</p>
<p>The official definition of the Lua language is given in the reference manual.</p>
<p>See the documentation page and the wiki for more.</p>
<h2 id="获得帮助">获得帮助</h2>
<p>Our community is friendly and will most probably help you if you need.
Just visit the mailing list, the chat room, and stackoverflow.</p>
<p>If you need help in Portuguese, join the Lua BR mailing list and visit pt.stackoverflow.</p>
<p>See also the FAQ, the community-maintained wiki and LuaFaq, and the much longer uFAQ.</p>
<h2 id="工具">工具</h2>
<p>If you need to complement the standard Lua libraries to handle more complex tasks, visit LuaRocks, the main repository of Lua modules.
See also Awesome Lua, a curated list of quality Lua packages and resources.
The lua-users wiki lists many user-contributed addons for Lua.</p>
<h2 id="支持">支持</h2>
<p>You can help to support the Lua project by buying a book published by Lua.org and by making a donation.</p>
<p>You can also help to spread the word about Lua by buying Lua products at Zazzle.</p>
<h2 id="安装">安装</h2>
<p>Use the live demo to play with Lua if you don&rsquo;t want to install anything on your computer.</p>
<p>To run Lua programs on your computer, you&rsquo;ll need a standalone Lua interpreter and perhaps some additional Lua libraries.
Pre-compiled Lua libraries and executables are available at LuaBinaries.
Use your favorite text editor to write your Lua programs.
Make sure to save your programs as plain text.
If you want an IDE, try ZeroBrane Studio.</p>
<p>If you use Windows, try LuaDist, a multi-platform distribution of the Lua that includes batteries.</p>
<p>If you use Linux or Mac OS X, Lua is either already installed on your system or there is a Lua package for it.
Make sure you get the latest release of Lua (currently 5.4.3).</p>
<p>Lua is also quite easy to build from source, as explained below.</p>
<h3 id="从代码源安装">从代码源安装</h3>
<p>Lua is very easy to build and install.
Just download it and follow the instructions in the package.</p>
<p>Here is a simple terminal session that downloads the current release of Lua and builds it in a Linux system:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">curl -R -O http://www.lua.org/ftp/lua-5.4.3.tar.gz
tar zxf lua-5.4.3.tar.gz
<span style="color:#204a87">cd</span> lua-5.4.3
make all <span style="color:#204a87">test</span>
</code></pre></div><p>If you don&rsquo;t have curl, try wget.
If you use Windows and want to build Lua from source, there are detailed instructions in the wiki.</p>
<h3 id="签入">签入</h3>
<p>To embed Lua into your C or C++ program, you&rsquo;ll need the Lua headers to compile your program and a Lua library to link with it.
If you&rsquo;re getting a ready-made Lua package for your platform, you&rsquo;ll probably need the development package as well.
Otherwise, just download Lua and add its source directory to your project.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f7b06a9ac66aa9b8f404b774cca2117b">1.4 - 下载</h1>
    
	<h2 id="source">Source</h2>
<p>Lua is free software distributed in source code.
It may be used for any purpose, including commercial purposes, at absolutely no cost.</p>
<p>All versions are available for download.
The current version is Lua 5.4 and its current release is Lua 5.4.3.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">download lua-5.4.3.tar.gz
2021-03-15, 350K
md5: ef63ed2ecfb713646a7fcc583cf5f352
sha1: 1dda2ef23a9828492b4595c0197766de6e784bc7
</code></pre></div><h2 id="tools">Tools</h2>
<p>The main repository of Lua modules is LuaRocks.
See also Awesome Lua.
Pre-compiled Lua libraries and executables are available at LuaBinaries.
The lua-users wiki lists many user-contributed addons for Lua.</p>
<h2 id="giving-credit">Giving credit</h2>
<p>If you use Lua, please give us credit, according to our license.
A nice way to give us further credit is to include a Lua logo and a link to our site in a web page for your product.</p>
<h2 id="building">Building</h2>
<p>Lua is implemented in pure ANSI C and compiles unmodified in all platforms that have an ANSI C compiler.
Lua also compiles cleanly as C++.</p>
<p>Lua is very easy to build and install.
There are detailed instructions in the package but here is a simple terminal session that downloads the current release of Lua and builds it in Linux:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">curl -R -O http://www.lua.org/ftp/lua-5.4.3.tar.gz
tar zxf lua-5.4.3.tar.gz
<span style="color:#204a87">cd</span> lua-5.4.3
make all <span style="color:#204a87">test</span>
</code></pre></div><p>If you have trouble building Lua, read the FAQ.</p>
<p>If you don&rsquo;t have the time or the inclination to compile Lua yourself, get a binary or try the live demo.</p>
<p>Giving credit
If you use Lua, please give us credit, according to our license.
A nice way to give us further credit is to include a Lua logo and a link to our site in a web page for your product.</p>
<h2 id="supporting-lua">Supporting Lua</h2>
<p>You can help to support the Lua project by buying a book published by Lua.org and by making a donation.</p>
<p>You can also help to spread the word about Lua by buying Lua products at Zazzle.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2010e1a4a2ee6d01e195febb8dc0c4cb">1.5 - 文档</h1>
    
	<h2 id="reference-manual">Reference manual</h2>
<p>The official definition of the Lua language is its reference manual, which describes the syntax and the semantics of Lua, the standard libraries, and the C API.</p>
<p>The reference manual for Lua 5.4 is available online in English only.</p>
<p>The reference manual for Lua 5.3 is available online in English and Russian.</p>
<p>The reference manual for Lua 5.2 is available online in English, Portuguese, and Polish.</p>
<p>The reference manual for Lua 5.1 is available online in English, Portuguese, Spanish, German, and Polish. It is also available as a book in English.</p>
<h2 id="technical-documentation">Technical documentation</h2>
<p>For more technical information, see the Frequently Asked Questions (FAQ) and some old seminar slides. For detailed technical information on specific topics, see our old series of Lua Technical Notes and the wiki at lua-users.org, specially the tutorial. You may also browse the source code.</p>
<h2 id="papers">Papers</h2>
<p>There are many papers and theses related to Lua. Here are the main ones written by the Lua team. See also the LabLua publications.</p>
<p>The main academic paper about Lua discusses the philosophy behind its design:</p>
<p>Lua – an extensible extension language
by R. Ierusalimschy, L. H. de Figueiredo, W. Celes,
Software: Practice &amp; Experience 26 #6 (1996) 635–652. [doi]
This paper was awarded the first prize (technological category) in the II Compaq Award for Research and Development in Computer Science in 1997. This award was a joint venture of Compaq Computer in Brazil, the Brazilian Ministry of Science and Technology, and the Brazilian Academy of Sciences.</p>
<p>For an overview of how Lua is designed, see</p>
<p>A look at the design of Lua
by R. Ierusalimschy, L. H. de Figueiredo, W. Celes,
Communications of the ACM 61 #11 (2018) 114–123. [doi · video]
For a short exposition of the API design, see</p>
<p>Passing a language through the eye of a needle
by R. Ierusalimschy, L. H. de Figueiredo, W. Celes,
ACM Queue 9 #5 (May 2011) 20–29. [doi · acm]
Communications of the ACM 54 #7 (July 2011) 38–43. [doi · acm]
It is also available in Portuguese:</p>
<p>Passando uma linguagem pelo buraco de uma agulha
por R. Ierusalimschy, L. H. de Figueiredo, W. Celes,
ACM Queue 9 #5 (May 2011) 20–29.
For details on the implementation of Lua, see</p>
<p>The implementation of Lua 5.0
by R. Ierusalimschy, L. H. de Figueiredo, W. Celes,
Journal of Universal Computer Science 11 #7 (2005) 1159–1176. [doi · slides]
For details on the role of first-class functions in Lua, see</p>
<p>First-class functions in an imperative world
by R. Ierusalimschy,
Journal of Universal Computer Science 23 #1 (2017) 112–126. [doi · slides]
For a discussion of coroutines in Lua, see</p>
<p>Coroutines in Lua
by A. L. de Moura, N. Rodriguez, R. Ierusalimschy,
Journal of Universal Computer Science 10 #7 (2004) 910–925. [doi · slides]
For a complete history of Lua till 2006, see</p>
<p>The evolution of Lua
by R. Ierusalimschy, L. H. de Figueiredo, W. Celes,
Proceedings of ACM HOPL III (2007) 2-1–2-26. [doi · slides]
For a history of Lua till 2001, see</p>
<p>The evolution of an extension language: a history of Lua
by R. Ierusalimschy, L. H. de Figueiredo, W. Celes,
Proceedings of V Brazilian Symposium on Programming Languages (2001) B-14–B-28. [ps]
The first paper describing Lua has some historical interest:</p>
<p>The design and implementation of a language for extending applications
by L. H. de Figueiredo, R. Ierusalimschy, W. Celes,
Proceedings of XXI Brazilian Seminar on Software and Hardware (1994) 273–283. [ps]
For an early expository article, see</p>
<p>Lua: an extensible embedded language
by L. H. de Figueiredo, R. Ierusalimschy, W. Celes,
Dr. Dobb&rsquo;s Journal 21 #12 (Dec 1996) 26–33. [ddj]
For introductory texts in Portuguese, see</p>
<p>Uma introdução à programação em Lua
by R. Ierusalimschy, JAI 2009 (Jul 2009).</p>
<p>A linguagem Lua e suas aplicações em jogos
by W. Celes, L. H. Figueiredo, R. Ierusalimschy
WJogos 2004 (Oct 2004). [slides]</p>
<h2 id="books">Books</h2>
<p>Lua books are available at the main online stores and also as e-books at Feisty Duck. When you buy a copy of a book published by Lua.org, you help to support the Lua project.</p>
<p>Reference manual
The official definition of the Lua language:</p>
<p>Lua 5.1 Reference Manual
by R. Ierusalimschy, L. H. de Figueiredo, W. Celes,
Lua.org, August 2006
ISBN 8590379833</p>
<p>The reference manuals for later versions of Lua are available online.
Programming in Lua
A detailed and authoritative introduction to all aspects of Lua programming, by Lua&rsquo;s chief architect:</p>
<p>Programming in Lua
by R. Ierusalimschy
Lua.org, fourth edition, August 2016
ISBN 8590379868
(also available as an e-book)</p>
<p>The fourth edition is aimed at Lua 5.3 and marks a complete reorganization of the text. The first edition is available online. It was aimed at Lua 5.0 and is still largely relevant.</p>
<p>The third edition was aimed at Lua 5.2 and remains quite relevant. It is available in English, Portuguese, and Russian:</p>
<p>Programming in Lua
by Roberto Ierusalimschy
Lua.org, third edition, January 2013
ISBN 859037985X
(also available as e-book)</p>
<p>Programando em Lua
por Roberto Ierusalimschy
LTC, January 2015
ISBN 9788521626992</p>
<p>Programmirovanie na iazyke Lua
by Roberto Ierusalimschy
DMK-press, 2014
ISBN 5940747671</p>
<p>The second edition remains relevant and is available in German, Korean, Chinese, and Japanese:</p>
<p>Programmieren mit Lua
von Roberto Ierusalimschy
Open Source Press, September 2006
ISBN 3937514228</p>
<p>Programming in Lua
by Roberto Ierusalimschy
Insight, June 2007
ISBN 9788991268302</p>
<p>Programming in Lua
by Roberto Ierusalimschy
Publishing House of Electronic Industry, May 2008
ISBN 9787121061875</p>
<p>Programming in Lua
by Roberto Ierusalimschy
ASCII Media Works, Aug 2009
ISBN 9784048677974</p>
<p>Lua Programming Gems
A collection of articles recording some of the existing wisdom and practice on how to program well in Lua:</p>
<p>Lua Programming Gems
edited by L. H. de Figueiredo, W. Celes, R. Ierusalimschy, Lua.org, December 2008
ISBN 9788590379843
(also available as e-book)</p>
<p>Other books
There are also books about Lua written by other authors:</p>
<p>Coding With Roblox Lua in 24 Hours: The Official Roblox Guide
by Roblox Corporation. Sams Publishing, 2021, ISBN 9780136829423.</p>
<p>Coding Roblox Games Made Easy: The ultimate guide to creating games with Roblox Studio and Lua programming
by Zander Brumbaugh. Packt Publishing, 2021, ISBN 9781800561991.</p>
<p>Initiation à la création de jeux vidéo en Lua avec Löve2D
by Anthony Cardinale. Éditions D-BookeR, 2020, ISBN 9782822709675.</p>
<p>Lua Quick Reference (second edition)
by Mitchell. Triple Quasar Books, 2020, ISBN 9780991237951.</p>
<p>Developing Games on the Raspberry Pi: App Programming with Lua and LÖVE
by Seth Kenlon. Apress, 2019, ISBN 9781484241707.</p>
<p>Lua Programming using Roblox
by SimTek Game Development. Independently published, 2019, ISBN 9781693427443.</p>
<p>Introdução à linguagem Lua
by José Augusto N. G. Manzano. Novatec, 2018, ISBN 9788575226681.</p>
<p>Lua Quick Start Guide
by Gabor Szauer, Packt Publishing, 2018, ISBN 9781789343229.</p>
<p>Creating Solid APIs with Lua
by Tyler Neylon. O&rsquo;Reilly Media, 2017, ISBN 9781491986301.</p>
<p>Le guide de Lua et ses applications - Manuel d&rsquo;apprentissage (2e édition)
by Pierre Chapuis, Etiene Dalcol, Cyril Doillon, Sylvain Fabre, Philippe Lhoste, Hisham Muhammad, and Patrick Rapin. Éditions D-BookeR, 2016, ISBN 9782822704076.</p>
<p>Le guide de Lua et ses applications - Manuel de référence (2e édition)
by Pierre Chapuis, Cyril Doillon, Sylvain Fabre, Philippe Lhoste, and Patrick Rapin. Éditions D-BookeR, 2016, ISBN 9782822704083.</p>
<p>Lua Game Development Cookbook
by Mario Kasuba. Packt Publishing, 2015, ISBN 1849515506.</p>
<p>ROBLOX Lua: Scripting for Beginners
by Douglas Snipp. CreateSpace, 2015, ISBN 1508728313.</p>
<p>Seven More Languages in Seven Weeks: Languages That Are Shaping the Future
by Bruce Tate, Ian Dees, Frederic Daoud, Jack Moffitt. Pragmatic Bookshelf, 2014, ISBN 1941222153.</p>
<p>Learning Game AI Programming with Lua
by David Young. Packt Publishing, 2014, ISBN 1783281332.</p>
<p>Lua Programming
by Mark Otaris and others, Wikibooks, 2014.</p>
<p>Introduction to Programming with Lua and the Corona Game Lab
by Robert Cook. Cook&rsquo;s Books, 2014. ASIN B00IQGAC8A.</p>
<p>Create Mobile Games with Corona: Build with Lua on iOS and Android
by Silvia Domenech. Pragmatic Bookshelf, 2013, ISBN 1937785572.</p>
<p>CryENGINE Game Programming with C++, C#, and Lua
by Filip Lundgren and Ruan Pearce. Packt Publishing, 2013, ISBN 1849695903.</p>
<p>LÖVE for Lua Game Programming
by Darmie Akinlaja. Packt Publishing, 2013, ISBN 1782161600.</p>
<p>ComputerCraft: Lua Programming in Minecraft
by Matthew Monk and Simon Monk. CreateSpace, 2013, ISBN 1481927655.</p>
<p>Learn Lua for iOS Game Development
by Jayant Varma. Apress, 2012, ISBN 1430246626.</p>
<p>Le guide de Lua et ses applications
by Cyril Doillon, Sylvain Fabre, Philippe Lhoste, and Patrick Rapin. Éditions D-BookeR, 2012, ISBN 9782822700054.</p>
<p>Lua - Programação de Computadores
by José Augusto N. G. Manzano. self-published, 2012, ISBN 9788591311576.</p>
<p>Lua: Einsatz von Lua in Embedded Systems
by Claus Kühnel and Daniel Zwirner. Skript Verlag Kuehnel, 2012, ISBN 3907857151.</p>
<p>Basic ROBLOX Lua Programming
by Brandon John LaRouche. CreateSpace, 2012, ISBN 1475026048.</p>
<p>Numerical Methods for Nonlinear Engineering Models
by John R. Hauser. Springer, 2009, ISBN 9781402099199.</p>
<p>Lua: Einsatz von Lua zur Messwerterfassung
by Claus Kühnel and Daniel Zwirner. Skript Verlag Kuehnel, 2009, ISBN 3907857127.</p>
<p>Beginning Lua with World of Warcraft Add-ons
by Paul Emmerich. Apress, 2009, ISBN 1430223715.</p>
<p>First Lua Programming, the most popular application development lightweight script!
by Miki Shimizu. Softbank Creative, 2008, ISBN 4777514137.</p>
<p>Scripting Language for Game Development and Efficient C/C++ to Implement Embedded Lua
by Makoto Hamanaka. Softbank Creative, 2008, ISBN 4797348550.</p>
<p>World of Warcraft Programming
by James Whitehead II, Bryan McLemore, and Matthew Orlando. Wiley, 2008, ISBN 0470229810.</p>
<p>Introduction to Lua programming
by Yutaka Ueno. Softbank Creative, 2007, ISBN 4797342722.</p>
<p>Beginning Lua Programming
by Kurt Jung and Aaron Brown. Wrox, 2007, ISBN 0470069171.</p>
<p>Programming Game AI by Example
by Mat Buckland. Jones &amp; Bartlett Learning, 2005, ISBN 9781556220784.</p>
<p>Game Development with Lua
by Paul Schuytema and Mark Manyen. Charles River Media, 2005, ISBN 1584504048.</p>
<p>Game Programming with Python, Lua, and Ruby
by Tom Gutschmidt. Course Technology PTR, 2003, ISBN 1592000770.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bcdc4ca857581f54d61eee7c3efb133c">1.6 - 社区</h1>
    
	<h2 id="meeting-places">Meeting places</h2>
<p>There are several places you can go to meet other people that use Lua. A good starting point is lua-users.org, a collaborative meeting place built for and by Lua users.</p>
<p>One of the focal points of the Lua community is our mailing list, which is very active and friendly; it has over 2500 subscribers from all over the world, including several Lua experts and the Lua team.</p>
<p>Other meeting places are stackoverflow, the chat room, a Telegram group, a Discord room, and a forum. For discussions in Portuguese, join the Lua BR mailing list and visit pt.stackoverflow.</p>
<p>If you want to meet in person, join a user group, find a user group near you, attend a Lua Workshop or a LuaConf.</p>
<h2 id="contributing">Contributing</h2>
<p>You can contribute to the community in several ways: answer questions about Lua (in the mailing list, in the chat room, in stackoverflow, and elsewhere), collaborate in the lua-users wiki, answer our survey, add a Lua logo to your web page, tell us about third-party sites related to Lua and papers and theses about Lua, and write tools and libraries for Lua and add them to LuaRocks.</p>
<h2 id="supporting-lua">Supporting Lua</h2>
<p>You can help to support the Lua project by buying a book published by Lua.org and by making a donation.</p>
<p>You can help to spread the word about Lua by buying Lua products at Zazzle.</p>
<h2 id="workshop">Workshop</h2>
<p>The main goal of the Lua workshop is to allow the Lua community to get together and meet in person and talk about the Lua language, its uses, and its implementation. Another goal is to help spread the word about Lua to industry and academia, taking advantage of the location of the workshop when possible.</p>
<p>If you&rsquo;d like to organize a Lua workshop, please post a proposal in the mailing list.</p>
<h3 id="past-workshops">Past workshops</h3>
<ul>
<li>2018 – Kaunas, Lithuania</li>
<li>2017 – San Francisco, California</li>
<li>2016 – San Francisco, California</li>
<li>2015 – Stockholm, Sweden</li>
<li>2014 – Moscow, Russia</li>
<li>2013 – Toulouse, France</li>
<li>2012 – Reston, Virginia</li>
<li>2011 – Frick, Switzerland</li>
<li>2009 – Rio de Janeiro, Brazil</li>
<li>2008 – Washington, D.C.</li>
<li>2006 – Venlo, The Netherlands</li>
<li>2005 – San Jose, California</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7757a61a8d7c4abecc70a803b4d122e3">2 - Redis 锁</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-4a08525c4153cbeb2aed69bc12a2e776">2.1 - Node Redlock</h1>
    
	<p><a href="https://www.npmjs.com/package/redlock"><img src="https://badge.fury.io/js/redlock.svg" alt="npm version"></a>
<a href="https://travis-ci.org/mike-marcacci/node-redlock"><img src="https://travis-ci.org/mike-marcacci/node-redlock.svg" alt="Build Status"></a>
<a href="https://coveralls.io/r/mike-marcacci/node-redlock"><img src="https://coveralls.io/repos/mike-marcacci/node-redlock/badge.svg" alt="Coverage Status"></a></p>
<h2 id="redlock">Redlock</h2>
<p>这是分布式 redis 锁的<a href="http://redis.io/topics/distlock">redlock</a>算法的 node.js 实现。
它在单 redis 和多 redis 环境中都提供了强大的保证，并通过使用多个独立的 redis 实例或集群提供容错性。</p>
<h3 id="高可用性的建议">高可用性的建议</h3>
<ul>
<li>Use at least 3 independent servers or clusters</li>
<li>Use an odd number of independent redis <strong><em>servers</em></strong> for most installations</li>
<li>Use an odd number of independent redis <strong><em>clusters</em></strong> for massive installations</li>
<li>When possible, distribute redis nodes across different physical machines</li>
</ul>
<h3 id="使用集群哨兵">使用集群/哨兵</h3>
<p><strong><em>Please make sure to use a client with built-in cluster support, such as <a href="https://github.com/luin/ioredis">ioredis</a>.</em></strong></p>
<p>It is completely possible to use a <em>single</em> redis cluster or sentinal configuration by passing one preconfigured client to redlock. While you do gain high availability and vastly increased throughput under this scheme, the failure modes are a bit different, and it becomes theoretically possible that a lock is acquired twice:</p>
<p>Assume you are using eventually-consistent redis replication, and you acquire a lock for a resource. Immediately after acquiring your lock, the redis master for that shard crashes. Redis does its thing and fails over to the slave which hasn&rsquo;t yet synced your lock. If another process attempts to acquire a lock for the same resource, it will succeed!</p>
<p>This is why redlock allows you to specify multiple independent nodes/clusters: by requiring consensus between them, we can safely take out or fail-over a minority of nodes without invalidating active locks.</p>
<p>To learn more about the the algorithm, check out the <a href="http://redis.io/topics/distlock">redis distlock page</a>.</p>
<h3 id="我怎么检查东西是否上锁了">我怎么检查东西是否上锁了?</h3>
<p>Redlock cannot tell you <em>with certainty</em> if a resource is currently locked.
For example, if you are on the smaller side of a network partition you will fail to acquire a lock, but you don&rsquo;t know if the lock exists on the other side; all you know is that you can&rsquo;t guarantee exclusivity on yours.</p>
<p>That said, for many tasks it&rsquo;s sufficient to attempt a lock with <code>retryCount=0</code>, and treat a failure as the resource being &ldquo;locked&rdquo; or (more correctly) &ldquo;unavailable&rdquo;,</p>
<p>With <code>retryCount=-1</code> there will be unlimited retries until the lock is aquired.</p>
<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm install --save redlock
</code></pre></div><h2 id="配置">配置</h2>
<p>Redlock can use <a href="https://github.com/mranney/node_redis">node redis</a>, <a href="https://github.com/luin/ioredis">ioredis</a> or any other compatible redis library to keep its client connections.</p>
<p>A redlock object is instantiated with an array of at least one redis client and an optional <code>options</code> object. Properties of the Redlock object should NOT be changed after it is first used, as doing so could have unintended consequences for live locks.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">client1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">createClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;redis1.example.com&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">client2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">createClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;redis2.example.com&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">client3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">createClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;redis3.example.com&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">Redlock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;redlock&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">redlock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redlock</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#8f5902;font-style:italic">// you should have one client for each independent redis node
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// or cluster
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">[</span><span style="color:#000">client1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">client3</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// the expected clock drift; for more details
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// see http://redis.io/topics/distlock
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">driftFactor</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.01</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// multiplied by lock ttl to determine drift time
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// the max number of times Redlock will attempt
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// to lock a resource before erroring
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">retryCount</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span>

    <span style="color:#8f5902;font-style:italic">// the time in ms between attempts
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">retryDelay</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// time in ms
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// the max time in ms randomly added to retries
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// to improve performance under high contention
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// see https://www.awsarchitectureblog.com/2015/03/backoff.html
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">retryJitter</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// time in ms
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h2 id="错误处理">错误处理</h2>
<p>Because redlock is designed for high availability,
it does not care if a minority of redis instances/clusters fail at an operation.
If you want to write logs or take another action when a redis client fails,
you can listen for the <code>clientError</code> event:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;clientError&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A redis error has occurred:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#8f5902;font-style:italic">// ...
</span></code></pre></div><h2 id="使用承诺风格">使用(承诺风格)</h2>
<h3 id="锁定与解锁">锁定与解锁</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// the string identifier for the resource you want to lock
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">resource</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;locks:account:322456&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// the maximum amount of time you want the resource locked in milliseconds,
</span><span style="color:#8f5902;font-style:italic">// keeping in mind that you can extend the lock up until
</span><span style="color:#8f5902;font-style:italic">// the point when it expires
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resource</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// unlock your resource when you are done
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">().</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// we weren&#39;t able to reach redis; your lock will eventually
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// expire, but you probably want to log this error
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h3 id="锁定和扩展">锁定和扩展</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;locks:account:322456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// if you need more time, you can continue to extend
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// the lock as long as you never let it expire
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#8f5902;font-style:italic">// this will extend the lock so that it expires
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// approximitely 1s from when `extend` is called
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// unlock your resource when you are done
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">().</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// we weren&#39;t able to reach redis; your lock will eventually
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// expire, but you probably want to log this error
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="使用碎渣机风格">使用(碎渣机风格)</h2>
<h3 id="锁定与解锁-1">锁定与解锁</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">using</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bluebird&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">using</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// the string identifier for the resource you want to lock
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">resource</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;locks:account:322456&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// the maximum amount of time you want the resource locked,
</span><span style="color:#8f5902;font-style:italic">// keeping in mind that you can extend the lock up until
</span><span style="color:#8f5902;font-style:italic">// the point when it expires
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// if we weren&#39;t able to reach redis, your lock will eventually
</span><span style="color:#8f5902;font-style:italic">// expire, but you probably want to do something like log that
</span><span style="color:#8f5902;font-style:italic">// an error occurred; if you don&#39;t pass a handler, this error
</span><span style="color:#8f5902;font-style:italic">// will be ignored
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">unlockErrorHandler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">using</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">disposer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resource</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unlockErrorHandler</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span> <span style="color:#8f5902;font-style:italic">// &lt;-- unlock is automatically handled by bluebird
</span></code></pre></div><h3 id="锁定和扩展-1">锁定和扩展</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">using</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">disposer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;locks:account:322456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unlockErrorHandler</span><span style="color:#000;font-weight:bold">),</span>
  <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// if you need more time, you can continue to extend
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the lock as long as you never let it expire
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// this will extend the lock so that it expires
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// approximitely 1s from when `extend` is called
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">extended</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// Note that redlock modifies the original lock,
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// so the vars `lock` and `extended` point to the
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// exact same object
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// &lt;-- unlock is automatically handled by bluebird
</span></code></pre></div><h2 id="使用回调风格">使用(回调风格)</h2>
<h3 id="锁定与解锁-2">锁定与解锁</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// the string identifier for the resource you want to lock
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">resource</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;locks:account:322456&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// the maximum amount of time you want the resource locked,
</span><span style="color:#8f5902;font-style:italic">// keeping in mind that you can extend the lock up until
</span><span style="color:#8f5902;font-style:italic">// the point when it expires
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resource</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// we failed to lock the resource
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">// we have the lock
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// unlock your resource when you are done
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// we weren&#39;t able to reach redis; your lock will eventually
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// expire, but you probably want to log this error
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h3 id="锁定和扩展-2">锁定和扩展</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;locks:account:322456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// we failed to lock the resource
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#8f5902;font-style:italic">// we have the lock
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// if you need more time, you can continue to extend
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the lock as long as you never let it expire
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// this will extend the lock so that it expires
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// approximitely 1s from when `extend` is called
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// we failed to extend the lock on the resource
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// ...
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// unlock your resource when you are done
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="锁定多个资源">锁定多个资源</h2>
<p>Multiple resources can be locked by providing an <code>Array</code> of strings to <code>Redlock.prototype.lock</code> call. Internally a single attempt is made to <code>redis</code> by evaluating script which executes lock statements. For more details about atomicity of scripts please see <a href="https://redis.io/commands/eval#atomicity-of-scripts">redis reference</a>.</p>
<p>There are however some limitations of which you need to be aware of:</p>
<ul>
<li>When requesting a lock it will fail if any of requested resources is already set</li>
<li>If lock attempt fails for any resource (due to whatever reason) an attempt for removing already set resources is made. However there are no guarantees that it will succeed (<code>redis</code> doesn&rsquo;t provide them)</li>
<li>Releasing lock will fail if any of requested resources is missing</li>
<li>Extending lock will fail if any of requested resources is missing</li>
</ul>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">redlock</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;locks:account:322456&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;locks:account:322457&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;locks:account:322458&#34;</span><span style="color:#000;font-weight:bold">],</span>
    <span style="color:#0000cf;font-weight:bold">1000</span>
  <span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// if you need more time, you can continue to extend
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the lock as long as you never let it expire
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// this will extend the lock so that it expires
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// approximitely 1s from when `extend` is called
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// ...do something here...
</span><span style="color:#8f5902;font-style:italic"></span>
      <span style="color:#8f5902;font-style:italic">// unlock your resource when you are done
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">().</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// we weren&#39;t able to reach redis; your lock will eventually
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// expire, but you probably want to log this error
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="api-文档">API 文档</h2>
<h4 id="redlockprototypelockresource-ttl-callback--promiselock"><code>Redlock.prototype.lock(resource, ttl, ?callback) =&gt; Promise&lt;Lock&gt;</code></h4>
<ul>
<li><code>resource (string or string[])</code> resource(s) to be locked</li>
<li><code>ttl (number)</code> time in ms until the lock expires</li>
<li><code>callback (function)</code> callback returning:
<ul>
<li><code>err (Error)</code></li>
<li><code>lock (Lock)</code></li>
</ul>
</li>
</ul>
<h4 id="redlockprototypeunlocklock-callback--promise"><code>Redlock.prototype.unlock(lock, ?callback) =&gt; Promise</code></h4>
<ul>
<li><code>lock (Lock)</code> lock to be released</li>
<li><code>callback (function)</code> callback returning:
<ul>
<li><code>err (Error)</code></li>
</ul>
</li>
</ul>
<h4 id="redlockprototypeextendlock-ttl-callback--promiselock"><code>Redlock.prototype.extend(lock, ttl, ?callback) =&gt; Promise&lt;Lock&gt;</code></h4>
<ul>
<li><code>lock (Lock)</code> lock to be extended</li>
<li><code>ttl (number)</code> time in ms to extend the lock&rsquo;s expiration</li>
<li><code>callback (function)</code> callback returning:
<ul>
<li><code>err (Error)</code></li>
<li><code>lock (Lock)</code></li>
</ul>
</li>
</ul>
<h4 id="redlockprototypedisposerresource-ttl-unlockerrorhandler"><code>Redlock.prototype.disposer(resource, ttl, ?unlockErrorHandler)</code></h4>
<ul>
<li><code>resource (string or string[])</code> resource(s) to be locked</li>
<li><code>ttl (number)</code> time in ms to extend the lock&rsquo;s expiration</li>
<li><code>callback (function)</code> error handler called with:
<ul>
<li><code>err (Error)</code></li>
</ul>
</li>
</ul>
<h4 id="redlockprototypequitcallback--promise"><code>Redlock.prototype.quit(?callback) =&gt; Promise&lt;*[]&gt;</code></h4>
<ul>
<li><code>callback (function)</code> error handler called with:
<ul>
<li><code>err (Error)</code></li>
<li><code>*[]</code> results of calling <code>.quit()</code> on each client</li>
</ul>
</li>
</ul>
<h4 id="lockprototypeunlockcallback--promise"><code>Lock.prototype.unlock(?callback) =&gt; Promise</code></h4>
<ul>
<li><code>callback (function)</code> callback returning:
<ul>
<li><code>err (Error)</code></li>
</ul>
</li>
</ul>
<h4 id="lockprototypeextendttl-callback--promiselock"><code>Lock.prototype.extend(ttl, ?callback) =&gt; Promise&lt;Lock&gt;</code></h4>
<ul>
<li><code>ttl (number)</code> time from now in ms to set as the lock&rsquo;s new expiration</li>
<li><code>callback (function)</code> callback returning:
<ul>
<li><code>err (Error)</code></li>
<li><code>lock (Lock)</code></li>
</ul>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bdae7fb0ccc7d882f43356aad27a2029">2.2 - Node Redlock5</h1>
    
	<p><a href="https://github.com/mike-marcacci/node-redlock/actions/workflows/ci.yml"><img src="https://github.com/mike-marcacci/node-redlock/workflows/Continuous%20Integration/badge.svg" alt="Continuous Integration"></a>
<a href="https://npm.im/redlock"><img src="https://badgen.net/npm/v/redlock" alt="Current Version"></a>
<a href="https://npm.im/redlock"><img src="https://badgen.net/npm/node/redlock" alt="Supported Node.js Versions"></a></p>
<p>这是分布式 redis 锁的<a href="http://redis.io/topics/distlock">redlock</a>算法的 node.js 实现。
它在单 redis 和多 redis 环境中都提供了强大的保证，并通过使用多个独立的 redis 实例或集群提供容错性。</p>
<h2 id="高可用性的建议">高可用性的建议</h2>
<ul>
<li>至少使用 3 个独立的服务器或集群</li>
<li>大多数安装使用奇数个独立 redis <strong><em>server</em></strong></li>
<li>使用奇数个独立 redis <strong><em>clusters</em></strong> 进行大规模安装</li>
<li>如果可能的话，将 redis 节点分布到不同的物理机器上</li>
</ul>
<h2 id="使用集群哨兵">使用集群/哨兵</h2>
<p><strong><em>请确保使用内置集群支持的客户端，如<a href="https://github.com/luin/ioredis">ioredis</a>.</em></strong></p>
<p>通过传递一个预先配置的客户端到 redlock，使用<em>single</em> redis 集群或 sentinal 配置是完全可能的。
虽然在这种模式下确实获得了高可用性并极大地提高了吞吐量，但故障模式略有不同，从理论上讲，一个锁可能被获取两次:</p>
<p>假设您正在使用最终一致的 redis 复制，并且您获得了资源的锁。
在获得你的锁后，redis 的碎片主机立即崩溃。
Redis 做了它的事情，并把它的故障转移到还没有同步你的锁的 slave 上。
如果另一个进程试图获取相同资源的锁，它将成功!</p>
<p>这就是为什么 redlock 允许你指定多个独立的节点/集群:
通过要求它们之间达成一致，我们可以安全地取出或故障转移少数节点，而不会使活动锁失效。</p>
<p>要了解更多的算法，请查看<a href="http://redis.io/topics/distlock">redis distlock 页面</a>.</p>
<h2 id="我怎么检查东西是否上锁了">我怎么检查东西是否上锁了?</h2>
<p>红锁的目的是在一段时间内提供资源的独占性保证，而不是用来报告资源的所有权状态。
例如，如果您在一个网络分区的较小一端，您将无法获得锁，但您不知道另一端是否存在锁;你只知道你不能保证你的独家经营权。
重试行为使情况更加复杂，在获取多个资源上的锁时更是如此。</p>
<p>也就是说，对于许多任务来说，尝试使用 <code>retryCount=0</code> 锁定就足够了， 并将失败视为资源被 <code>locked</code> 或(更准确地说) <code>unavailable</code>。</p>
<blockquote>
<p>注意，使用' retryCount=-1 &lsquo;将有无限的重试，直到获得锁。</p>
</blockquote>
<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm install --save redlock
</code></pre></div><h2 id="配置">配置</h2>
<p>Redlock 被设计成使用<a href="https://github.com/luin/ioredis">ioredis</a> 来保持它的客户端连接和处理集群协议。</p>
<p>一个 redlock 对象实例化一个至少一个 redis 客户端和一个可选的<code>options</code>对象的数组。
Redlock 对象的属性不应该在第一次使用后更改，因为这样做可能会对活锁产生意想不到的后果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Client</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Redlock</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;./redlock&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redisA</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Client</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;a.redis.example.com&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redisB</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Client</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;b.redis.example.com&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redisC</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Client</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;c.redis.example.com&#34;</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redlock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redlock</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#8f5902;font-style:italic">// You should have one client for each independent redis node
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// or cluster.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">[</span><span style="color:#000">redisA</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redisB</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">redisC</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// The expected clock drift; for more details see:
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// http://redis.io/topics/distlock
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">driftFactor</span>: <span style="color:#204a87;font-weight:bold">0.01</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// multiplied by lock ttl to determine drift time
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// The max number of times Redlock will attempt to lock a resource
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// before erroring.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">retryCount</span>: <span style="color:#204a87;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span>

    <span style="color:#8f5902;font-style:italic">// the time in ms between attempts
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">retryDelay</span>: <span style="color:#204a87;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// time in ms
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// the max time in ms randomly added to retries
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// to improve performance under high contention
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// see https://www.awsarchitectureblog.com/2015/03/backoff.html
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">retryJitter</span>: <span style="color:#204a87;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// time in ms
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#8f5902;font-style:italic">// The minimum remaining time on a lock before an extension is automatically
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// attempted with the `using` API.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">automaticExtensionThreshold</span>: <span style="color:#204a87;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// time in ms
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h2 id="错误处理">错误处理</h2>
<p>因为 redlock 是为高可用性而设计的，所以它并不关心是否有少数 redis 实例/集群在操作中失败。</p>
<p>但是，监视和记录这种情况是很有帮助的。
当 Redlock 遇到错误时，它会触发一个 <code>error</code> 事件，即使该错误在正常操作中被忽略。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// 忽略资源在客户端显式标记为锁定的情况。
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">ResourceLockedError</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#8f5902;font-style:italic">// 日志其他所有错误.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>此外，<code>Lock</code> 和 <code>ExecutionError</code> 类的 <code>attempt</code> 属性上提供了 <code>per-attempt</code> 和 <code>per-client</code> 统计信息(包括错误)。</p>
<h2 id="使用">使用</h2>
<p><code>using</code> 方法在自动扩展锁的上下文中包装并执行例程，返回例程值的承诺。
在自动扩展失败的情况下，将更新一个 <code>AbortSignal</code> ，以表明该例程的终止是正确的，并将遇到的错误传递下去。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">using</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">senderId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">recipientId</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// Do something...
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">something</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#8f5902;font-style:italic">// 确保任何必要的锁扩展没有失败。
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">aborted</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">signal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#8f5902;font-style:italic">// Do something else...
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">somethingElse</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>或者，可以直接获取和释放锁:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#8f5902;font-style:italic">// Acquire a lock.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">lock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">acquire</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">// Do something...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">something</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#8f5902;font-style:italic">// Extend the lock.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">lock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5000</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#8f5902;font-style:italic">// Do something else...
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">somethingElse</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#8f5902;font-style:italic">// Release the lock.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">release</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><h2 id="api">API</h2>
<p>请查看(非常简洁的)源代码或 TypeScript 定义，了解 API 的详细分解。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4106cc913393c91ef771f1a9c0ea69d7">2.3 - Node Redlock5 API</h1>
    
	<h2 id="acquire">acquire</h2>
<p>这个方法在 <code>duration</code> 指定的持续时间内获取资源上的锁。</p>
<h2 id="extend">extend</h2>
<p>此方法通过提供的 <code>duration</code> 扩展有效锁。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">randomBytes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">createHash</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;crypto&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">EventEmitter</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;events&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// AbortController became available as a global in node version 16.
</span><span style="color:#8f5902;font-style:italic">// Once version 14 reaches its end-of-life, this can be removed.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">PolyfillAbortController</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;node-abort-controller&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Redis</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">IORedisClient</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Client</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">IORedisClient</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#8f5902;font-style:italic">// Define script constants.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ACQUIRE_SCRIPT</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`
</span><span style="color:#4e9a06">  -- Return 0 if an entry already exists.
</span><span style="color:#4e9a06">  for i, key in ipairs(KEYS) do
</span><span style="color:#4e9a06">    if redis.call(&#34;exists&#34;, key) == 1 then
</span><span style="color:#4e9a06">      return 0
</span><span style="color:#4e9a06">    end
</span><span style="color:#4e9a06">  end
</span><span style="color:#4e9a06">
</span><span style="color:#4e9a06">  -- Create an entry for each provided key.
</span><span style="color:#4e9a06">  for i, key in ipairs(KEYS) do
</span><span style="color:#4e9a06">    redis.call(&#34;set&#34;, key, ARGV[1], &#34;PX&#34;, ARGV[2])
</span><span style="color:#4e9a06">  end
</span><span style="color:#4e9a06">
</span><span style="color:#4e9a06">  -- Return the number of entries added.
</span><span style="color:#4e9a06">  return #KEYS
</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">EXTEND_SCRIPT</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`
</span><span style="color:#4e9a06">  -- Return 0 if an entry exists with a *different* lock value.
</span><span style="color:#4e9a06">  for i, key in ipairs(KEYS) do
</span><span style="color:#4e9a06">    if redis.call(&#34;get&#34;, key) ~= ARGV[1] then
</span><span style="color:#4e9a06">      return 0
</span><span style="color:#4e9a06">    end
</span><span style="color:#4e9a06">  end
</span><span style="color:#4e9a06">
</span><span style="color:#4e9a06">  -- Update the entry for each provided key.
</span><span style="color:#4e9a06">  for i, key in ipairs(KEYS) do
</span><span style="color:#4e9a06">    redis.call(&#34;set&#34;, key, ARGV[1], &#34;PX&#34;, ARGV[2])
</span><span style="color:#4e9a06">  end
</span><span style="color:#4e9a06">
</span><span style="color:#4e9a06">  -- Return the number of entries updated.
</span><span style="color:#4e9a06">  return #KEYS
</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">RELEASE_SCRIPT</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`
</span><span style="color:#4e9a06">  local count = 0
</span><span style="color:#4e9a06">  for i, key in ipairs(KEYS) do
</span><span style="color:#4e9a06">    -- Only remove entries for *this* lock value.
</span><span style="color:#4e9a06">    if redis.call(&#34;get&#34;, key) == ARGV[1] then
</span><span style="color:#4e9a06">      redis.pcall(&#34;del&#34;, key)
</span><span style="color:#4e9a06">      count = count + 1
</span><span style="color:#4e9a06">    end
</span><span style="color:#4e9a06">  end
</span><span style="color:#4e9a06">
</span><span style="color:#4e9a06">  -- Return the number of entries removed.
</span><span style="color:#4e9a06">  return count
</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ClientExecutionResult</span> <span style="color:#ce5c00;font-weight:bold">=</span>
  <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">client</span>: <span style="color:#204a87;font-weight:bold">Client</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000">vote</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;for&#34;</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">client</span>: <span style="color:#204a87;font-weight:bold">Client</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000">vote</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;against&#34;</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000">error</span>: <span style="color:#204a87;font-weight:bold">Error</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">};</span>

<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * This object contains a summary of results.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ExecutionStats</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">membershipSize</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">quorumSize</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">votesFor</span>: <span style="color:#204a87;font-weight:bold">Set</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Client</span><span style="color:#000;font-weight:bold">&gt;;</span>
  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">votesAgainst</span>: <span style="color:#204a87;font-weight:bold">Map</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Client</span><span style="color:#a40000">,</span> <span style="color:#c4a000">Error</span><span style="color:#000;font-weight:bold">&gt;;</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * This object contains a summary of results. Because the result of an attempt
</span><span style="color:#8f5902;font-style:italic"> * can sometimes be determined before all requests are finished, each attempt
</span><span style="color:#8f5902;font-style:italic"> * contains a Promise that will resolve ExecutionStats once all requests are
</span><span style="color:#8f5902;font-style:italic"> * finished. A rejection of these promises should be considered undefined
</span><span style="color:#8f5902;font-style:italic"> * behavior and should cause a crash.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ExecutionResult</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">attempts</span>: <span style="color:#204a87;font-weight:bold">ReadonlyArray</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Promise</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">ExecutionStats</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> *
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">Settings</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">driftFactor</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">retryCount</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">retryDelay</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">retryJitter</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">automaticExtensionThreshold</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">// Define default settings.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">defaultSettings</span>: <span style="color:#204a87;font-weight:bold">Readonly</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Settings</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">driftFactor</span>: <span style="color:#204a87;font-weight:bold">0.01</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">retryCount</span>: <span style="color:#204a87;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">retryDelay</span>: <span style="color:#204a87;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">retryJitter</span>: <span style="color:#204a87;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">automaticExtensionThreshold</span>: <span style="color:#204a87;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#8f5902;font-style:italic">// Modifyng this object is forbidden.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87">Object</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">freeze</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">defaultSettings</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * This error indicates a failure due to the existence of another lock for one
</span><span style="color:#8f5902;font-style:italic"> * or more of the requested resources.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ResourceLockedError</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#204a87">Error</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;ResourceLockedError&#34;</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * This error indicates a failure of an operation to pass with a quorum.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ExecutionError</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#204a87">Error</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">message</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">attempts</span>: <span style="color:#204a87;font-weight:bold">ReadonlyArray</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Promise</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">ExecutionStats</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;ExecutionError&#34;</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#8f5902;font-style:italic">/*
</span><span style="color:#8f5902;font-style:italic"> * An object of this type is returned when a resource is successfully locked. It
</span><span style="color:#8f5902;font-style:italic"> * contains convenience methods `release` and `extend` which perform the
</span><span style="color:#8f5902;font-style:italic"> * associated Redlock method on itself.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Lock</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">redlock</span>: <span style="color:#204a87;font-weight:bold">Redlock</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">resources</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">attempts</span>: <span style="color:#204a87;font-weight:bold">ReadonlyArray</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Promise</span><span style="color:#a40000">&lt;</span><span style="color:#c4a000">ExecutionStats</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">expiration</span>: <span style="color:#204a87;font-weight:bold">number</span>
  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">release</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">ExecutionResult</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">release</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">extend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Lock</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">duration</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">RedlockAbortSignal</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">AbortSignal</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">error?</span>: <span style="color:#204a87;font-weight:bold">Error</span> <span style="color:#000;font-weight:bold">};</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ts" data-lang="ts"><span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic"> * A redlock object is instantiated with an array of at least one redis client
</span><span style="color:#8f5902;font-style:italic"> * and an optional `options` object. Properties of the Redlock object should NOT
</span><span style="color:#8f5902;font-style:italic"> * be changed after it is first used, as doing so could have unintended
</span><span style="color:#8f5902;font-style:italic"> * consequences for live locks.
</span><span style="color:#8f5902;font-style:italic"> */</span>
<span style="color:#204a87;font-weight:bold">export</span> <span style="color:#204a87;font-weight:bold">default</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Redlock</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">EventEmitter</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">clients</span>: <span style="color:#204a87;font-weight:bold">Set</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Client</span><span style="color:#000;font-weight:bold">&gt;;</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">settings</span>: <span style="color:#204a87;font-weight:bold">Settings</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">scripts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">acquireScript</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">hash</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">extendScript</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">hash</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">releaseScript</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">hash</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">};</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">constructor</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">clients</span>: <span style="color:#204a87;font-weight:bold">Iterable</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Client</span><span style="color:#000;font-weight:bold">&gt;,</span>
    <span style="color:#000">settings</span>: <span style="color:#204a87;font-weight:bold">Partial</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Settings</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{},</span>
    <span style="color:#000">scripts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">acquireScript?</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">script</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">extendScript?</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">script</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#204a87;font-weight:bold">readonly</span> <span style="color:#000">releaseScript?</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">script</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{}</span>
  <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">super</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#8f5902;font-style:italic">// Prevent crashes on error events.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// Because redlock is designed for high availability, it does not care if
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// a minority of redis instances/clusters fail at an operation.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">//
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// However, it can be helpful to monitor and log such cases. Redlock emits
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// an &#34;error&#34; event whenever it encounters an error, even if the error is
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// ignored in its normal operation.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">//
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// This function serves to prevent node&#39;s default behavior of crashing
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// when an &#34;error&#34; event is emitted in the absence of listeners.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">});</span>

    <span style="color:#8f5902;font-style:italic">// Create a new array of client, to ensure no accidental mutation.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clients</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clients</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clients</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#4e9a06">&#34;Redlock must be instantiated with at least one redis client.&#34;</span>
      <span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">// Customize the settings for this instance.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">settings</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">driftFactor</span>:
        <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">driftFactor</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;number&#34;</span>
          <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">settings.driftFactor</span>
          : <span style="color:#204a87;font-weight:bold">defaultSettings.driftFactor</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">retryCount</span>:
        <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">retryCount</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;number&#34;</span>
          <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">settings.retryCount</span>
          : <span style="color:#204a87;font-weight:bold">defaultSettings.retryCount</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">retryDelay</span>:
        <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">retryDelay</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;number&#34;</span>
          <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">settings.retryDelay</span>
          : <span style="color:#204a87;font-weight:bold">defaultSettings.retryDelay</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">retryJitter</span>:
        <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">retryJitter</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;number&#34;</span>
          <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">settings.retryJitter</span>
          : <span style="color:#204a87;font-weight:bold">defaultSettings.retryJitter</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">automaticExtensionThreshold</span>:
        <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">automaticExtensionThreshold</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;number&#34;</span>
          <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">settings.automaticExtensionThreshold</span>
          : <span style="color:#204a87;font-weight:bold">defaultSettings.automaticExtensionThreshold</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">};</span>

    <span style="color:#8f5902;font-style:italic">// Use custom scripts and script modifiers.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">acquireScript</span> <span style="color:#ce5c00;font-weight:bold">=</span>
      <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">scripts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">acquireScript</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;function&#34;</span>
        <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">scripts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">acquireScript</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ACQUIRE_SCRIPT</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">ACQUIRE_SCRIPT</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">extendScript</span> <span style="color:#ce5c00;font-weight:bold">=</span>
      <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">scripts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extendScript</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;function&#34;</span>
        <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">scripts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extendScript</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EXTEND_SCRIPT</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">EXTEND_SCRIPT</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">releaseScript</span> <span style="color:#ce5c00;font-weight:bold">=</span>
      <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">scripts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">releaseScript</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;function&#34;</span>
        <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">scripts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">releaseScript</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">RELEASE_SCRIPT</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">RELEASE_SCRIPT</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scripts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">acquireScript</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">acquireScript</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">hash</span>: <span style="color:#204a87;font-weight:bold">this._hash</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">acquireScript</span><span style="color:#000;font-weight:bold">),</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000">extendScript</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">extendScript</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">hash</span>: <span style="color:#204a87;font-weight:bold">this._hash</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">extendScript</span><span style="color:#000;font-weight:bold">),</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000">releaseScript</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">releaseScript</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">hash</span>: <span style="color:#204a87;font-weight:bold">this._hash</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">releaseScript</span><span style="color:#000;font-weight:bold">),</span>
      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * Generate a sha1 hash compatible with redis evalsha.
</span><span style="color:#8f5902;font-style:italic">   */</span>
  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">_hash</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">createHash</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sha1&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">digest</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hex&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * Generate a cryptographically random string.
</span><span style="color:#8f5902;font-style:italic">   */</span>
  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#000">_random</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">randomBytes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hex&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * This method runs `.quit()` on all client connections.
</span><span style="color:#8f5902;font-style:italic">   */</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">quit</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[];</span>
    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">client</span> <span style="color:#204a87;font-weight:bold">of</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clients</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">results</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">quit</span><span style="color:#000;font-weight:bold">());</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">results</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * 这个方法在 `duration` 指定的持续时间内获取资源上的锁。
</span><span style="color:#8f5902;font-style:italic">   */</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">acquire</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">resources</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span>
    <span style="color:#000">duration</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">settings?</span>: <span style="color:#204a87;font-weight:bold">Settings</span>
  <span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Lock</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_random</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">attempts</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_execute</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scripts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">acquireScript</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">resources</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000;font-weight:bold">[</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">duration</span><span style="color:#000;font-weight:bold">],</span>
        <span style="color:#000">settings</span>
      <span style="color:#000;font-weight:bold">);</span>

      <span style="color:#8f5902;font-style:italic">// Add 2 milliseconds to the drift to account for Redis expires precision,
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// which is 1 ms, plus the configured allowable drift factor.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">drift</span> <span style="color:#ce5c00;font-weight:bold">=</span>
        <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span>
          <span style="color:#000;font-weight:bold">(</span><span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">driftFactor</span> <span style="color:#ce5c00;font-weight:bold">??</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">driftFactor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">duration</span>
        <span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">resources</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">attempts</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">drift</span>
      <span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// If there was an error acquiring the lock, release any partial lock
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#8f5902;font-style:italic">// state that may exist on a minority of clients.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scripts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">releaseScript</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">resources</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">retryCount</span>: <span style="color:#204a87;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">}).</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// Any error here will be ignored.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">});</span>

      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * This method unlocks the provided lock from all servers still persisting it.
</span><span style="color:#8f5902;font-style:italic">   * It will fail with an error if it is unable to release the lock on a quorum
</span><span style="color:#8f5902;font-style:italic">   * of nodes, but will make no attempt to restore the lock in the case of a
</span><span style="color:#8f5902;font-style:italic">   * failure to release. It is safe to re-attempt a release or to ignore the
</span><span style="color:#8f5902;font-style:italic">   * error, as the lock will automatically expire after its timeout.
</span><span style="color:#8f5902;font-style:italic">   */</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">release</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">lock</span>: <span style="color:#204a87;font-weight:bold">Lock</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">settings?</span>: <span style="color:#204a87;font-weight:bold">Partial</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Settings</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">ExecutionResult</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Immediately invalidate the lock.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expiration</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">// Attempt to release the lock.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_execute</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scripts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">releaseScript</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resources</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">[</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">],</span>
      <span style="color:#000">settings</span>
    <span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * This method extends a valid lock by the provided `duration`.
</span><span style="color:#8f5902;font-style:italic">   */</span>
  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">extend</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">existing</span>: <span style="color:#204a87;font-weight:bold">Lock</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">duration</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">settings?</span>: <span style="color:#204a87;font-weight:bold">Partial</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Settings</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Lock</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#8f5902;font-style:italic">// The lock has already expired.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">existing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expiration</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ExecutionError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cannot extend an already-expired lock.&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">attempts</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_execute</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scripts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extendScript</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">existing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resources</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">[</span><span style="color:#000">existing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">duration</span><span style="color:#000;font-weight:bold">],</span>
      <span style="color:#000">settings</span>
    <span style="color:#000;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">// Invalidate the existing lock.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">existing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expiration</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#8f5902;font-style:italic">// Add 2 milliseconds to the drift to account for Redis expires precision,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// which is 1 ms, plus the configured allowable drift factor.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">drift</span> <span style="color:#ce5c00;font-weight:bold">=</span>
      <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000;font-weight:bold">(</span><span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">?</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">driftFactor</span> <span style="color:#ce5c00;font-weight:bold">??</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">driftFactor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">duration</span>
      <span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">replacement</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">existing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resources</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">existing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">attempts</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">drift</span>
    <span style="color:#000;font-weight:bold">);</span>

    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">replacement</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * Execute a script on all clients. The resulting promise is resolved or
</span><span style="color:#8f5902;font-style:italic">   * rejected as soon as this quorum is reached; the resolution or rejection
</span><span style="color:#8f5902;font-style:italic">   * will contains a `stats` property that is resolved once all votes are in.
</span><span style="color:#8f5902;font-style:italic">   */</span>
  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">_execute</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">hash</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000">keys</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span>
    <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)[],</span>
    <span style="color:#000">_settings?</span>: <span style="color:#204a87;font-weight:bold">Partial</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Settings</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">ExecutionResult</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">settings</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_settings</span>
      <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">settings</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000;font-weight:bold">...</span><span style="color:#000">_settings</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">settings</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">maxAttempts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">retryCount</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">attempts</span>: <span style="color:#204a87;font-weight:bold">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">ExecutionStats</span><span style="color:#000;font-weight:bold">&gt;[]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[];</span>

    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">vote</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">stats</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_attemptOperation</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">script</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#000">attempts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stats</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#8f5902;font-style:italic">// The operation acheived a quorum in favor.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">vote</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;for&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">attempts</span> <span style="color:#000;font-weight:bold">};</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#8f5902;font-style:italic">// Wait before reattempting.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">attempts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">maxAttempts</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">setTimeout</span><span style="color:#000;font-weight:bold">(</span>
            <span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">max</span><span style="color:#000;font-weight:bold">(</span>
              <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
              <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">retryDelay</span> <span style="color:#ce5c00;font-weight:bold">+</span>
                <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">floor</span><span style="color:#000;font-weight:bold">((</span><span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">retryJitter</span><span style="color:#000;font-weight:bold">)</span>
            <span style="color:#000;font-weight:bold">),</span>
            <span style="color:#204a87;font-weight:bold">undefined</span>
          <span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">});</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ExecutionError</span><span style="color:#000;font-weight:bold">(</span>
          <span style="color:#4e9a06">&#34;The operation was unable to acheive a quorum during its retry window.&#34;</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000">attempts</span>
        <span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">_attemptOperation</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">hash</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000">keys</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span>
    <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)[]</span>
  <span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#ce5c00;font-weight:bold">&lt;</span>
    <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">vote</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;for&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">stats</span>: <span style="color:#204a87;font-weight:bold">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">ExecutionStats</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">vote</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;against&#34;</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">stats</span>: <span style="color:#204a87;font-weight:bold">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">ExecutionStats</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">clientResults</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[];</span>
      <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">client</span> <span style="color:#204a87;font-weight:bold">of</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clients</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">clientResults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">(</span>
          <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">_attemptOperationOnClient</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">script</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stats</span>: <span style="color:#204a87;font-weight:bold">ExecutionStats</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">membershipSize</span>: <span style="color:#204a87;font-weight:bold">clientResults.length</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">quorumSize</span>: <span style="color:#204a87;font-weight:bold">Math.floor</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientResults</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">votesFor</span>: <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Set</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Client</span><span style="color:#000;font-weight:bold">&gt;(),</span>
        <span style="color:#000">votesAgainst</span>: <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Map</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Client</span><span style="color:#a40000">,</span> <span style="color:#c4a000">Error</span><span style="color:#000;font-weight:bold">&gt;(),</span>
      <span style="color:#000;font-weight:bold">};</span>

      <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">done</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">statsPromise</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#c4a000">stats</span><span style="color:#000;font-weight:bold">&gt;((</span><span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">done</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stats</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">});</span>

      <span style="color:#8f5902;font-style:italic">// This is the expected flow for all successful and unsuccessful requests.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">onResultResolve</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientResult</span>: <span style="color:#204a87;font-weight:bold">ClientExecutionResult</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">vote</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;for&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span>
            <span style="color:#000">stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">votesFor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
          <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#34;against&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span>
            <span style="color:#000">stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">votesAgainst</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">clientResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">clientResult</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#8f5902;font-style:italic">// A quorum has determined a success.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">votesFor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">quorumSize</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">({</span>
            <span style="color:#000">vote</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;for&#34;</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#000">stats</span>: <span style="color:#204a87;font-weight:bold">statsPromise</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000;font-weight:bold">});</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#8f5902;font-style:italic">// A quorum has determined a failure.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">votesAgainst</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#000">stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">quorumSize</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">resolve</span><span style="color:#000;font-weight:bold">({</span>
            <span style="color:#000">vote</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;against&#34;</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#000">stats</span>: <span style="color:#204a87;font-weight:bold">statsPromise</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000;font-weight:bold">});</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#8f5902;font-style:italic">// All votes are in.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>
          <span style="color:#000">stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">votesFor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">votesAgainst</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span> <span style="color:#ce5c00;font-weight:bold">===</span>
          <span style="color:#000">stats</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">membershipSize</span>
        <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#000">done</span><span style="color:#000;font-weight:bold">();</span>
        <span style="color:#000;font-weight:bold">}</span>
      <span style="color:#000;font-weight:bold">};</span>

      <span style="color:#8f5902;font-style:italic">// This is unexpected and should crash to prevent undefined behavior.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">onResultReject</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span>: <span style="color:#204a87;font-weight:bold">Error</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">};</span>

      <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">result</span> <span style="color:#204a87;font-weight:bold">of</span> <span style="color:#000">clientResults</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">onResultResolve</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">onResultReject</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">});</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">_attemptOperationOnClient</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#000">client</span>: <span style="color:#204a87;font-weight:bold">Client</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">script</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">hash</span>: <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000">keys</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span>
    <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)[]</span>
  <span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">ClientExecutionResult</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">result</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// Attempt to evaluate the script by its hash.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">shaResult</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">evalsha</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">script</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hash</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span>
          <span style="color:#000;font-weight:bold">...</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000;font-weight:bold">...</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000;font-weight:bold">]))</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">shaResult</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#4e9a06">&#34;number&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span>
            <span style="color:#4e9a06">`Unexpected result of type </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">shaResult</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> returned from redis.`</span>
          <span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">shaResult</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// If the redis server does not already have the script cached,
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// reattempt the request with the script&#39;s raw text.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>
          <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">||</span>
          <span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startsWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;NOSCRIPT&#34;</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">rawResult</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">eval</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">script</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span>
          <span style="color:#000;font-weight:bold">...</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000;font-weight:bold">...</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000;font-weight:bold">]))</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#204a87;font-weight:bold">unknown</span><span style="color:#000;font-weight:bold">;</span>

        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">rawResult</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#4e9a06">&#34;number&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span>
            <span style="color:#4e9a06">`Unexpected result of type </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">rawResult</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> returned from redis.`</span>
          <span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rawResult</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#8f5902;font-style:italic">// One or more of the resources was already locked.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#000">keys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ResourceLockedError</span><span style="color:#000;font-weight:bold">(</span>
          <span style="color:#4e9a06">`The operation was applied to: </span><span style="color:#4e9a06">${</span><span style="color:#000">result</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> of the </span><span style="color:#4e9a06">${</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> requested resources.`</span>
        <span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">vote</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;for&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">value</span>: <span style="color:#204a87;font-weight:bold">result</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">!</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span>
          <span style="color:#4e9a06">`Unexpected type </span><span style="color:#4e9a06">${</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">error</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> thrown with value: </span><span style="color:#4e9a06">${</span><span style="color:#000">error</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span>
        <span style="color:#000;font-weight:bold">);</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#8f5902;font-style:italic">// Emit the error on the redlock instance for observability.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">emit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">error</span><span style="color:#000;font-weight:bold">);</span>

      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">vote</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;against&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">error</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#8f5902;font-style:italic">/**
</span><span style="color:#8f5902;font-style:italic">   * Wrap and execute a routine in the context of an auto-extending lock,
</span><span style="color:#8f5902;font-style:italic">   * returning a promise of the routine&#39;s value. In the case that auto-extension
</span><span style="color:#8f5902;font-style:italic">   * fails, an AbortSignal will be updated to indicate that abortion of the
</span><span style="color:#8f5902;font-style:italic">   * routine is in order, and to pass along the encountered error.
</span><span style="color:#8f5902;font-style:italic">   *
</span><span style="color:#8f5902;font-style:italic">   * @example
</span><span style="color:#8f5902;font-style:italic">   * ```ts
</span><span style="color:#8f5902;font-style:italic">   * await redlock.using([senderId, recipientId], 5000, { retryCount: 5 }, async (signal) =&gt; {
</span><span style="color:#8f5902;font-style:italic">   *   const senderBalance = await getBalance(senderId);
</span><span style="color:#8f5902;font-style:italic">   *   const recipientBalance = await getBalance(recipientId);
</span><span style="color:#8f5902;font-style:italic">   *
</span><span style="color:#8f5902;font-style:italic">   *   if (senderBalance &lt; amountToSend) {
</span><span style="color:#8f5902;font-style:italic">   *     throw new Error(&#34;Insufficient balance.&#34;);
</span><span style="color:#8f5902;font-style:italic">   *   }
</span><span style="color:#8f5902;font-style:italic">   *
</span><span style="color:#8f5902;font-style:italic">   *   // The abort signal will be true if:
</span><span style="color:#8f5902;font-style:italic">   *   // 1. the above took long enough that the lock needed to be extended
</span><span style="color:#8f5902;font-style:italic">   *   // 2. redlock was unable to extend the lock
</span><span style="color:#8f5902;font-style:italic">   *   //
</span><span style="color:#8f5902;font-style:italic">   *   // In such a case, exclusivity can no longer be guaranteed for further
</span><span style="color:#8f5902;font-style:italic">   *   // operations, and should be handled as an exceptional case.
</span><span style="color:#8f5902;font-style:italic">   *   if (signal.aborted) {
</span><span style="color:#8f5902;font-style:italic">   *     throw signal.error;
</span><span style="color:#8f5902;font-style:italic">   *   }
</span><span style="color:#8f5902;font-style:italic">   *
</span><span style="color:#8f5902;font-style:italic">   *   await setBalances([
</span><span style="color:#8f5902;font-style:italic">   *     {id: senderId, balance: senderBalance - amountToSend},
</span><span style="color:#8f5902;font-style:italic">   *     {id: recipientId, balance: recipientBalance + amountToSend},
</span><span style="color:#8f5902;font-style:italic">   *   ]);
</span><span style="color:#8f5902;font-style:italic">   * });
</span><span style="color:#8f5902;font-style:italic">   * ```
</span><span style="color:#8f5902;font-style:italic">   */</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">using</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;(</span>
    <span style="color:#000">resources</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span>
    <span style="color:#000">duration</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">settings</span>: <span style="color:#204a87;font-weight:bold">Partial</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Settings</span><span style="color:#000;font-weight:bold">&gt;,</span>
    <span style="color:#000">routine</span><span style="color:#ce5c00;font-weight:bold">?:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">signal</span>: <span style="color:#204a87;font-weight:bold">RedlockAbortSignal</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;;</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">using</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;(</span>
    <span style="color:#000">resources</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span>
    <span style="color:#000">duration</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">routine</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">signal</span>: <span style="color:#204a87;font-weight:bold">RedlockAbortSignal</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;;</span>

  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">using</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;(</span>
    <span style="color:#000">resources</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">[],</span>
    <span style="color:#000">duration</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">settingsOrRoutine</span><span style="color:#ce5c00;font-weight:bold">:</span>
      <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#204a87;font-weight:bold">undefined</span>
      <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">Partial</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">Settings</span><span style="color:#000;font-weight:bold">&gt;</span>
      <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">signal</span>: <span style="color:#204a87;font-weight:bold">RedlockAbortSignal</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;),</span>
    <span style="color:#000">optionalRoutine</span><span style="color:#ce5c00;font-weight:bold">?:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">signal</span>: <span style="color:#204a87;font-weight:bold">RedlockAbortSignal</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;</span>
  <span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">T</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">settings</span> <span style="color:#ce5c00;font-weight:bold">=</span>
      <span style="color:#000">settingsOrRoutine</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">settingsOrRoutine</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#4e9a06">&#34;function&#34;</span>
        <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">settings</span><span style="color:#000;font-weight:bold">,</span>
            <span style="color:#000;font-weight:bold">...</span><span style="color:#000">settingsOrRoutine</span><span style="color:#000;font-weight:bold">,</span>
          <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">settings</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">routine</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">optionalRoutine</span> <span style="color:#ce5c00;font-weight:bold">??</span> <span style="color:#000">settingsOrRoutine</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">routine</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#4e9a06">&#34;function&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;INVARIANT: routine is not a function.&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">automaticExtensionThreshold</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#4e9a06">&#34;A lock `duration` must be at least 100ms greater than the `automaticExtensionThreshold` setting.&#34;</span>
      <span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#8f5902;font-style:italic">// The AbortController/AbortSignal pattern allows the routine to be notified
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// of a failure to extend the lock, and subsequent expiration. In the event
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// of an abort, the error object will be made available at `signal.error`.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">controller</span> <span style="color:#ce5c00;font-weight:bold">=</span>
      <span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">AbortController</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;undefined&#34;</span>
        <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">PolyfillAbortController</span><span style="color:#000;font-weight:bold">()</span>
        <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">AbortController</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">signal</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">signal</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">RedlockAbortSignal</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">timeout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">setTimeout</span><span style="color:#000;font-weight:bold">(</span>
        <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">extension</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">extend</span><span style="color:#000;font-weight:bold">()),</span>
        <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expiration</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">automaticExtensionThreshold</span>
      <span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">extend</span><span style="color:#000;font-weight:bold">()</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">timeout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">undefined</span><span style="color:#000;font-weight:bold">;</span>

      <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">lock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">extend</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">duration</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">expiration</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#204a87">Date</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">extension</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">extend</span><span style="color:#000;font-weight:bold">());</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#000">signal</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#204a87">Error</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">error</span> : <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#4e9a06">${</span><span style="color:#000">error</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">controller</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">abort</span><span style="color:#000;font-weight:bold">();</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">timeout</span>: <span style="color:#204a87;font-weight:bold">undefined</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">NodeJS</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">extension</span>: <span style="color:#204a87;font-weight:bold">undefined</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">&gt;;</span>
    <span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">lock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">acquire</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resources</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">settings</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000">queue</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">routine</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">finally</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// Clean up the timer.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">clearTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000">timeout</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">undefined</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#8f5902;font-style:italic">// Wait for an in-flight extension to finish.
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">extension</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">extension</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">catch</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#8f5902;font-style:italic">// An error here doesn&#39;t matter at all, because the routine has
</span><span style="color:#8f5902;font-style:italic"></span>          <span style="color:#8f5902;font-style:italic">// already completed, and a release will be attempted regardless. The
</span><span style="color:#8f5902;font-style:italic"></span>          <span style="color:#8f5902;font-style:italic">// only reason for waiting here is to prevent possible contention
</span><span style="color:#8f5902;font-style:italic"></span>          <span style="color:#8f5902;font-style:italic">// between the extension and release.
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">});</span>
      <span style="color:#000;font-weight:bold">}</span>

      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">lock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">release</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-105d23b4f32df8923e76a7541a236534">2.4 - warlock</h1>
    
	<blockquote>
<p><a href="https://github.com/thedeveloper/warlock">https://github.com/thedeveloper/warlock</a></p>
</blockquote>
<p><a href="https://gitter.im/TheDeveloper/warlock?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="Join the chat at https://gitter.im/TheDeveloper/warlock"></a></p>
<p>Battle-hardened distributed locking using redis.</p>
<h2 id="requirements">Requirements</h2>
<ul>
<li><a href="https://github.com/mranney/node_redis">node-redis</a> compatible with <code>v0.10</code></li>
<li>Redis <code>v2.6.12</code> or above. If you&rsquo;re running a Redis version from <code>v2.6.0</code> to <code>v2.6.11</code> inclusive use <code>v0.0.7</code> of this module.</li>
</ul>
<h2 id="install">Install</h2>
<pre><code>npm install node-redis-warlock
</code></pre>
<h2 id="usage">Usage</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Warlock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;node-redis-warlock&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Establish a redis client and pass it to warlock
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createClient</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">warlock</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Warlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Set a lock
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;test-lock&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Lifetime of the lock
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">warlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Something went wrong and we weren&#39;t able to set a lock
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">unlock</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;function&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// If the lock is set successfully by this process, an unlock function is passed to our callback.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Do the work that required lock protection, and then unlock() when finished...
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// do stuff...
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Otherwise, the lock was not established by us so we must decide what to do
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Perhaps wait a bit &amp; retry...
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// set a lock optimistically
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;opt-lock&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">maxAttempts</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Max number of times to try setting the lock before erroring
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">wait</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// Time to wait before another attempt if lock already in place
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">warlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">optimistic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">maxAttempts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>

<span style="color:#8f5902;font-style:italic">// unlock using the lock id
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;test-lock-2&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">lockId</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">warlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">lockId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// each client who knows the lockId can release the lock
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">warlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lockId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// unlocked successfully
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// change a lock&#39;s ttl
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;touch-lock&#34;</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ttl</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10000</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">ttl2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">20000</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000">warlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">unlock</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">warlock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">touch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ttl2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="protips">ProTips</h2>
<ul>
<li>Read my <a href="https://engineering.gosquared.com/distributed-locks-using-redis">Distributed locks using Redis</a> article and Redis' author&rsquo;s <a href="http://antirez.com/news/77">A proposal for more reliable locks using Redis</a> to learn more about the theory of distributed locks using Redis.</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a298ae59966025b11c5d3db9e5439423">3 - ioredis</h1>
    
	<blockquote>
<p><a href="https://github.com/luin/ioredis">https://github.com/luin/ioredis</a></p>
</blockquote>
<p><a href="https://github.com/luin/ioredis"><img src="https://cdn.jsdelivr.net/gh/luin/ioredis@b5e8c74/logo.svg" alt="ioredis"></a></p>
<p><a href="https://travis-ci.org/luin/ioredis"><img src="https://travis-ci.org/luin/ioredis.svg?branch=master" alt="Build Status"></a>
<a href="https://github.com/prettier/prettier"><img src="https://img.shields.io/badge/code_style-prettier-ff69b4.svg?style=flat-square" alt="code style: prettier"></a>
<a href="https://gitter.im/luin/ioredis?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="Join the chat at https://gitter.im/luin/ioredis"></a>
<a href="http://commitizen.github.io/cz-cli/"><img src="https://img.shields.io/badge/commitizen-friendly-brightgreen.svg" alt="Commitizen friendly"></a>
<a href="https://github.com/semantic-release/semantic-release"><img src="https://img.shields.io/badge/%20%20%F0%9F%93%A6%F0%9F%9A%80-semantic--release-e10079.svg" alt="semantic-release"></a>
<a href="https://www.npmjs.com/package/ioredis"><img src="https://img.shields.io/npm/v/ioredis/latest.svg" alt="npm latest version"></a>
<a href="https://www.npmjs.com/package/ioredis"><img src="https://img.shields.io/npm/v/ioredis/next.svg" alt="npm next version"></a>
<img alt="" src=""></p>
<p>A robust, performance-focused and full-featured <a href="http://redis.io">Redis</a> client for <a href="https://nodejs.org">Node.js</a>.</p>
<p>Supports Redis &gt;= 2.6.12 and (Node.js &gt;= 6). Completely compatible with Redis 6.x.</p>
<h2 id="特性">特性</h2>
<p>ioredis is a robust, full-featured Redis client that is
used in the world&rsquo;s biggest online commerce company <a href="http://www.alibaba.com/">Alibaba</a> and many other awesome companies.</p>
<ol start="0">
<li>Full-featured. It supports <a href="http://redis.io/topics/cluster-tutorial">Cluster</a>, <a href="http://redis.io/topics/sentinel">Sentinel</a>, <a href="https://redis.io/topics/streams-intro">Streams</a>, <a href="http://redis.io/topics/pipelining">Pipelining</a> and of course <a href="http://redis.io/commands/eval">Lua scripting</a> &amp; <a href="http://redis.io/topics/pubsub">Pub/Sub</a> (with the support of binary messages).</li>
<li>High performance.</li>
<li>Delightful API. It works with Node callbacks and Native promises.</li>
<li>Transformation of command arguments and replies.</li>
<li>Transparent key prefixing.</li>
<li>Abstraction for Lua scripting, allowing you to define custom commands.</li>
<li>Support for binary data.</li>
<li>Support for TLS 🔒.</li>
<li>Support for offline queue and ready checking.</li>
<li>Support for ES6 types, such as <code>Map</code> and <code>Set</code>.</li>
<li>Support for GEO commands 📍.</li>
<li>Support for Redis ACL.</li>
<li>Sophisticated error handling strategy.</li>
<li>Support for NAT mapping.</li>
<li>Support for autopipelining</li>
</ol>
<h2 id="链接">链接</h2>
<ul>
<li><a href="API.md">API Documentation</a></li>
<li><a href="Changelog.md">Changelog</a></li>
<li><a href="https://github.com/luin/ioredis/wiki/Migrating-from-node_redis">Migrating from node_redis</a></li>
<li><a href="#error-handling">Error Handling</a></li>
</ul>
<hr>
<h2 id="赞助商">赞助商</h2>
<p><a href="https://github.com/sponsors/luin">Become a sponsor!</a></p>
<h4 id="upstash-serverless-database-for-redis">Upstash: Serverless Database for Redis</h4>
<p><a href="https://upstash.com/?utm_source=ioredis"><img align="right" width="320" src="resources/upstash.png" alt="Upstash"></a></p>
<p>Upstash is a Serverless Database with Redis/REST API and durable storage. It is the perfect database for your applications thanks to its per request pricing and low latency data.</p>
<p><a href="https://upstash.com/?utm_source=ioredis">Start for free in 30 seconds! </a></p>
<br clear="both"/>
<h4 id="medis-redis-gui-for-macos">Medis: Redis GUI for macOS</h4>
<p><a href="https://getmedis.com/"><img align="right" width="404" src="resources/medis.png" alt="Download on the App Store"></a></p>
<p>Looking for a Redis GUI for macOS, Windows and Linux? Here&rsquo;s <a href="https://getmedis.com/">Medis</a>!</p>
<p>Medis is an open-sourced, beautiful, easy-to-use Redis GUI management application.</p>
<p>Medis starts with all the basic features you need:</p>
<ul>
<li>Keys viewing/editing</li>
<li>SSH Tunnel for connecting with remote servers</li>
<li>Terminal for executing custom commands</li>
<li>And other awesome features&hellip;</li>
</ul>
<p><a href="https://github.com/luin/medis">Medis 1 is open sourced on GitHub</a></p>
<h4 id="kuber-kubernetes-dashboard-for-ios">Kuber: Kubernetes Dashboard for iOS</h4>
<p><a href="http://bit.ly/kuber-ios"><img src="resources/kuber.png" alt="Download on the App Store"></a></p>
<hr>
<h2 id="错误处理">错误处理</h2>
<p>All the errors returned by the Redis server are instances of <code>ReplyError</code>, which can be accessed via <code>Redis</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#8f5902;font-style:italic">// This command causes a reply error since the SET command requires two arguments.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplyError</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>This is the error stack of the <code>ReplyError</code>:</p>
<pre tabindex="0"><code>ReplyError: ERR wrong number of arguments for 'set' command
    at ReplyParser._parseResult (/app/node_modules/ioredis/lib/parsers/javascript.js:60:14)
    at ReplyParser.execute (/app/node_modules/ioredis/lib/parsers/javascript.js:178:20)
    at Socket.&lt;anonymous&gt; (/app/node_modules/ioredis/lib/redis/event_handler.js:99:22)
    at Socket.emit (events.js:97:17)
    at readableAddChunk (_stream_readable.js:143:16)
    at Socket.Readable.push (_stream_readable.js:106:10)
    at TCP.onread (net.js:509:20)
</code></pre><p>By default, the error stack doesn&rsquo;t make any sense because the whole stack happens in the ioredis
module itself, not in your code. So it&rsquo;s not easy to find out where the error happens in your code.
ioredis provides an option <code>showFriendlyErrorStack</code> to solve the problem. When you enable
<code>showFriendlyErrorStack</code>, ioredis will optimize the error stack for you:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">showFriendlyErrorStack</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>And the output will be:</p>
<pre tabindex="0"><code>ReplyError: ERR wrong number of arguments for 'set' command
    at Object.&lt;anonymous&gt; (/app/index.js:3:7)
    at Module._compile (module.js:446:26)
    at Object.Module._extensions..js (module.js:464:10)
    at Module.load (module.js:341:32)
    at Function.Module._load (module.js:296:12)
    at Function.Module.runMain (module.js:487:10)
    at startup (node.js:111:16)
    at node.js:799:3
</code></pre><p>This time the stack tells you that the error happens on the third line in your code. Pretty sweet!
However, it would decrease the performance significantly to optimize the error stack. So by
default, this option is disabled and can only be used for debugging purposes. You <strong>shouldn&rsquo;t</strong> use this feature in a production environment.</p>
<h2 id="插入你自己的承诺库">插入你自己的承诺库</h2>
<p>If you&rsquo;re an advanced user, you may want to plug in your own promise library like <a href="https://www.npmjs.com/package/bluebird">bluebird</a>. Just set Redis.Promise to your favorite ES6-style promise constructor and ioredis will use it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">Promise</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bluebird&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// Use bluebird
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bluebird&#34;</span><span style="color:#000;font-weight:bold">));</span>

<span style="color:#8f5902;font-style:italic">// You can change the Promise implementation at any time:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">Promise</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">global</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">global</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h2 id="运行测试">运行测试</h2>
<p>Start a Redis server on 127.0.0.1:6379, and then:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ npm <span style="color:#204a87">test</span>
</code></pre></div><p><code>FLUSH ALL</code> will be invoked after each test, so make sure there&rsquo;s no valuable data in it before running tests.</p>
<p>If your testing environment does not let you spin up a Redis server <a href="https://github.com/stipsan/ioredis-mock">ioredis-mock</a> is a drop-in replacement you can use in your tests. It aims to behave identically to ioredis connected to a Redis server so that your integration tests is easier to write and of better quality.</p>
<h2 id="调试">调试</h2>
<p>You can set the <code>DEBUG</code> env to <code>ioredis:*</code> to print debug info:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#000">DEBUG</span><span style="color:#ce5c00;font-weight:bold">=</span>ioredis:* node app.js
</code></pre></div><h2 id="加入">加入!</h2>
<p>I&rsquo;m happy to receive bug reports, fixes, documentation enhancements, and any other improvements.</p>
<p>And since I&rsquo;m not a native English speaker, if you find any grammar mistakes in the documentation, please also let me know. :)</p>
<h2 id="成为一个赞助商">成为一个赞助商</h2>
<p>Open source is hard and time-consuming. If you want to invest in ioredis&rsquo;s future you can become a sponsor and make us spend more time on this library&rsquo;s improvements and new features.</p>
<p><a href="https://opencollective.com/ioredis"><img src="https://opencollective.com/ioredis/tiers/sponsor.svg?avatarHeight=36"></a></p>
<p>Thank you for using ioredis :-)</p>
<h2 id="贡献者">贡献者</h2>
<p>这个项目的存在要感谢所有做出贡献的人:</p>
<p><a href="https://github.com/luin/ioredis/graphs/contributors"><img src="https://opencollective.com/ioredis/contributors.svg?width=890&showBtn=false" /></a></p>
<h2 id="许可证">许可证</h2>
<p>MIT</p>
<p><a href="https://app.fossa.io/projects/git%2Bgithub.com%2Fluin%2Fioredis?ref=badge_large"><img src="https://app.fossa.io/api/projects/git%2Bgithub.com%2Fluin%2Fioredis.svg?type=large" alt="FOSSA Status"></a></p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7dc15eb27b1a9435aa7d664e23fe3807">3.1 - 快速入门</h1>
    
	<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ npm install ioredis
</code></pre></div><h2 id="基本用法">基本用法</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#8f5902;font-style:italic">// uses defaults unless given configuration object
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// ioredis supports all Redis commands:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// returns promise which resolves to string, &#34;OK&#34;
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// the format is: redis[SOME_REDIS_COMMAND_IN_LOWERCASE](ARGUMENTS_ARE_JOINED_INTO_COMMAND_STRING)
</span><span style="color:#8f5902;font-style:italic">// the js: ` redis.set(&#34;mykey&#34;, &#34;Hello&#34;) ` is equivalent to the cli: ` redis&gt; SET mykey &#34;Hello&#34; `
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// ioredis supports the node.js callback style
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Promise resolves to &#34;bar&#34;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Or ioredis returns a promise if the last argument isn&#39;t a function
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Prints &#34;bar&#34;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Most responses are strings, or arrays of strings
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zadd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sortedSet&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;one&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;dos&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;quatro&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;three&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zrange</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sortedSet&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;WITHSCORES&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// Promise resolves to [&#34;one&#34;, &#34;1&#34;, &#34;dos&#34;, &#34;2&#34;, &#34;three&#34;, &#34;3&#34;] as if the command was ` redis&gt; ZRANGE sortedSet 0 2 WITHSCORES `
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// All arguments are passed directly to the redis server:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;EX&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>See the <code>examples/</code> folder for more examples.</p>
<h2 id="transparent-key-prefixing">Transparent Key Prefixing</h2>
<p>This feature allows you to specify a string that will automatically be prepended
to all the keys in a command, which makes it easier to manage your key
namespaces.</p>
<p><strong>Warning</strong> This feature won&rsquo;t apply to commands like <a href="http://redis.io/commands/KEYS">KEYS</a> and <a href="http://redis.io/commands/scan">SCAN</a> that take patterns rather than actual keys(<a href="https://github.com/luin/ioredis/issues/239">#239</a>),
and this feature also won&rsquo;t apply to the replies of commands even if they are key names (<a href="https://github.com/luin/ioredis/issues/325">#325</a>).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">fooRedis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">keyPrefix</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foo:&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">fooRedis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;baz&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Actually sends SET foo:bar baz
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">fooRedis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defineCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;echo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">numberOfKeys</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Works well with pipelining/transaction
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fooRedis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#8f5902;font-style:italic">// Sends SORT foo:list BY foo:weight_*-&gt;fieldname
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;BY&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;weight_*-&gt;fieldname&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#8f5902;font-style:italic">// Supports custom commands
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Sends EVALSHA xxx foo:k1 foo:k2 a1 a2
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a2&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><h2 id="transforming-arguments--replies">Transforming Arguments &amp; Replies</h2>
<p>Most Redis commands take one or more Strings as arguments,
and replies are sent back as a single String or an Array of Strings. However, sometimes
you may want something different. For instance, it would be more convenient if the <code>HGETALL</code>
command returns a hash (e.g. <code>{ key: val1, key2: v2 }</code>) rather than an array of key values (e.g. <code>[key1, val1, key2, val2]</code>).</p>
<p>ioredis has a flexible system for transforming arguments and replies. There are two types
of transformers, argument transformer and reply transformer:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Here&#39;s the built-in argument transformer converting
</span><span style="color:#8f5902;font-style:italic">// hmset(&#39;key&#39;, { k1: &#39;v1&#39;, k2: &#39;v2&#39; })
</span><span style="color:#8f5902;font-style:italic">// or
</span><span style="color:#8f5902;font-style:italic">// hmset(&#39;key&#39;, new Map([[&#39;k1&#39;, &#39;v1&#39;], [&#39;k2&#39;, &#39;v2&#39;]]))
</span><span style="color:#8f5902;font-style:italic">// into
</span><span style="color:#8f5902;font-style:italic">// hmset(&#39;key&#39;, &#39;k1&#39;, &#39;v1&#39;, &#39;k2&#39;, &#39;v2&#39;)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setArgumentTransformer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hmset&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">Map</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#4e9a06">&#34;undefined&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">Map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// utils is a internal module of ioredis
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]].</span><span style="color:#000">concat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">utils</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">convertMapToArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]));</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;object&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]].</span><span style="color:#000">concat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">utils</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">convertObjectToArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]));</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Here&#39;s the built-in reply transformer converting the HGETALL reply
</span><span style="color:#8f5902;font-style:italic">// [&#39;k1&#39;, &#39;v1&#39;, &#39;k2&#39;, &#39;v2&#39;]
</span><span style="color:#8f5902;font-style:italic">// into
</span><span style="color:#8f5902;font-style:italic">// { k1: &#39;v1&#39;, &#39;k2&#39;: &#39;v2&#39; }
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setReplyTransformer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hgetall&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Array</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">obj</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>There are three built-in transformers, two argument transformers for <code>hmset</code> &amp; <code>mset</code> and
a reply transformer for <code>hgetall</code>. Transformers for <code>hmset</code> and <code>hgetall</code> were mentioned
above, and the transformer for <code>mset</code> is similar to the one for <code>hmset</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mset</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">k1</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;v1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k2</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;v2&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === &#39;v1&#39;;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mset</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Map</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;k3&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;v3&#34;</span><span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;k4&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;v4&#34;</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">])</span>
<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k3&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === &#39;v3&#39;;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Another useful example of a reply transformer is one that changes <code>hgetall</code> to return array of arrays instead of objects which avoids an unwanted conversation of hash keys to strings when dealing with binary hash keys:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setReplyTransformer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hgetall&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">arr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[];</span>
  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]]);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;h1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">([</span><span style="color:#0000cf;font-weight:bold">0x01</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">([</span><span style="color:#0000cf;font-weight:bold">0x02</span><span style="color:#000;font-weight:bold">]));</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;h1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">([</span><span style="color:#0000cf;font-weight:bold">0x03</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">([</span><span style="color:#0000cf;font-weight:bold">0x04</span><span style="color:#000;font-weight:bold">]));</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hgetallBuffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;h1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === [ [ &lt;Buffer 01&gt;, &lt;Buffer 02&gt; ], [ &lt;Buffer 03&gt;, &lt;Buffer 04&gt; ] ];
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="监控">监控</h2>
<p>Redis supports the MONITOR command,
which lets you see all commands received by the Redis server across all client connections,
including from other client libraries and other computers.</p>
<p>The <code>monitor</code> method returns a monitor instance.
After you send the MONITOR command, no other commands are valid on that connection. ioredis will emit a monitor event for every new monitor message that comes across.
The callback for the monitor event takes a timestamp from the Redis server and an array of command arguments.</p>
<p>Here is a simple example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;monitor&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">database</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Here is another example illustrating an <code>async</code> function and <code>monitor.disconnect()</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">monitor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;monitor&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#8f5902;font-style:italic">// Any other tasks
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">disconnect</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><h2 id="streamify-scanning">Streamify Scanning</h2>
<p>Redis 2.8 added the <code>SCAN</code> command to incrementally iterate through the keys in the database.
It&rsquo;s different from <code>KEYS</code> in that <code>SCAN</code> only returns a small number of elements each call,
so it can be used in production without the downside of blocking the server for a long time.
However, it requires recording the cursor on the client side each time
the <code>SCAN</code> command is called in order to iterate through all the keys correctly. Since it&rsquo;s a relatively common use case, ioredis
provides a streaming interface for the <code>SCAN</code> command to make things much easier. A readable stream can be created by calling <code>scanStream</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#8f5902;font-style:italic">// Create a readable stream (object mode)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stream</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scanStream</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;data&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">resultKeys</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `resultKeys` is an array of strings representing key names.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Note that resultKeys may contain 0 keys, and that it will sometimes
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// contain duplicates due to SCAN&#39;s implementation in Redis.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">resultKeys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resultKeys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;end&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;all keys have been visited&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p><code>scanStream</code> accepts an option, with which you can specify the <code>MATCH</code> pattern, the <code>TYPE</code> filter, and the <code>COUNT</code> argument:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stream</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scanStream</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#8f5902;font-style:italic">// only returns keys following the pattern of `user:*`
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">match</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user:*&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#8f5902;font-style:italic">// only return objects that match a given type,
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// (requires Redis &gt;= 6.0)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;zset&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#8f5902;font-style:italic">// returns approximately 100 elements per call
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">count</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Just like other commands, <code>scanStream</code> has a binary version <code>scanBufferStream</code>, which returns an array of buffers. It&rsquo;s useful when
the key names are not utf8 strings.</p>
<p>There are also <code>hscanStream</code>, <code>zscanStream</code> and <code>sscanStream</code> to iterate through elements in a hash, zset and set. The interface of each is
similar to <code>scanStream</code> except the first argument is the key name:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stream</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hscanStream</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;myhash&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">match</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;age:??&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>You can learn more from the <a href="http://redis.io/commands/scan">Redis documentation</a>.</p>
<p><strong>Useful Tips</strong>
It&rsquo;s pretty common that doing an async task in the <code>data</code> handler. We&rsquo;d like the scanning process to be paused until the async task to be finished. <code>Stream#pause()</code> and <code>Stream#resume()</code> do the trick. For example if we want to migrate data in Redis to MySQL:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stream</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scanStream</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;data&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">resultKeys</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// Pause the stream from scanning more keys until we&#39;ve migrated the current keys.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pause</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resultKeys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">migrateKeyToMySQL</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Resume the stream here.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resume</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;end&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;done migration&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="离线队列">离线队列</h2>
<p>When a command can&rsquo;t be processed by Redis (being sent before the <code>ready</code> event), by default, it&rsquo;s added to the offline queue and will be
executed when it can be processed. You can disable this feature by setting the <code>enableOfflineQueue</code>
option to <code>false</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">enableOfflineQueue</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ecde650262f1a1171dd464ff05b45476">3.2 - 连接</h1>
    
	<h2 id="连接到-redis">连接到 Redis</h2>
<p>When a new <code>Redis</code> instance is created, a connection to Redis will be created at the same time.
You can specify which Redis to connect to by:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#8f5902;font-style:italic">// Connect to 127.0.0.1:6379
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6380</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// 127.0.0.1:6380
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;192.168.1.1&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// 192.168.1.1:6379
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/tmp/redis.sock&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis port
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis host
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">family</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// 4 (IPv4) or 6 (IPv6)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;auth&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>You can also specify connection options as a <a href="http://www.iana.org/assignments/uri-schemes/prov/redis"><code>redis://</code> URL</a> or <a href="https://www.iana.org/assignments/uri-schemes/prov/rediss"><code>rediss://</code> URL</a> when using <a href="#tls-options">TLS encryption</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// Connect to 127.0.0.1:6380, db 4, using password &#34;authpassword&#34;:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;redis://:authpassword@127.0.0.1:6380/4&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Username can also be passed via URI.
</span><span style="color:#8f5902;font-style:italic">// It&#39;s worth to noticing that for compatibility reasons `allowUsernameInURI`
</span><span style="color:#8f5902;font-style:italic">// need to be provided, otherwise the username part will be ignored.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#4e9a06">&#34;redis://username:authpassword@127.0.0.1:6380/4?allowUsernameInURI=true&#34;</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>See <a href="API.md#new_Redis">API Documentation</a> for all available options.</p>
<h2 id="自动连接">自动连接</h2>
<p>By default, ioredis will try to reconnect when the connection to Redis is lost except when the connection is closed manually by <code>redis.disconnect()</code> or <code>redis.quit()</code>.</p>
<p>It&rsquo;s very flexible to control how long to wait to reconnect after disconnection using the <code>retryStrategy</code> option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#8f5902;font-style:italic">// This is the default value of `retryStrategy`
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">retryStrategy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">delay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">delay</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p><code>retryStrategy</code> is a function that will be called when the connection is lost.
The argument <code>times</code> means this is the nth reconnection being made and
the return value represents how long (in ms) to wait to reconnect. When the
return value isn&rsquo;t a number, ioredis will stop trying to reconnect, and the connection
will be lost forever if the user doesn&rsquo;t call <code>redis.connect()</code> manually.</p>
<p>When reconnected, the client will auto subscribe to channels that the previous connection subscribed to.
This behavior can be disabled by setting the <code>autoResubscribe</code> option to <code>false</code>.</p>
<p>And if the previous connection has some unfulfilled commands (most likely blocking commands such as <code>brpop</code> and <code>blpop</code>),
the client will resend them when reconnected. This behavior can be disabled by setting the <code>autoResendUnfulfilledCommands</code> option to <code>false</code>.</p>
<p>By default, all pending commands will be flushed with an error every 20 retry attempts. That makes sure commands won&rsquo;t wait forever when the connection is down. You can change this behavior by setting <code>maxRetriesPerRequest</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">maxRetriesPerRequest</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Set maxRetriesPerRequest to <code>null</code> to disable this behavior, and every command will wait forever until the connection is alive again (which is the default behavior before ioredis v4).</p>
<h3 id="reconnect-on-error">Reconnect on error</h3>
<p>Besides auto-reconnect when the connection is closed, ioredis supports reconnecting on certain Redis errors using the <code>reconnectOnError</code> option. Here&rsquo;s an example that will reconnect when receiving <code>READONLY</code> error:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">reconnectOnError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">targetError</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;READONLY&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">targetError</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// Only reconnect when the error contains &#34;READONLY&#34;
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// or `return 1;`
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>This feature is useful when using Amazon ElastiCache instances with Auto-failover disabled. On these instances, test your <code>reconnectOnError</code> handler by manually promoting the replica node to the primary role using the AWS console. The following writes fail with the error <code>READONLY</code>. Using <code>reconnectOnError</code>, we can force the connection to reconnect on this error in order to connect to the new master. Furthermore, if the <code>reconnectOnError</code> returns <code>2</code>, ioredis will resend the failed command after reconnecting.</p>
<p>On ElastiCache instances with Auto-failover enabled, <code>reconnectOnError</code> does not execute. Instead of returning a Redis error, AWS closes all connections to the master endpoint until the new primary node is ready. ioredis reconnects via <code>retryStrategy</code> instead of <code>reconnectOnError</code> after about a minute. On ElastiCache instances with Auto-failover enabled, test failover events with the <code>Failover primary</code> option in the AWS console.</p>
<h2 id="connection-events">Connection Events</h2>
<p>The Redis instance will emit some events about the state of the connection to the Redis server.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Event</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">connect</td>
<td style="text-align:left">emits when a connection is established to the Redis server.</td>
</tr>
<tr>
<td style="text-align:left">ready</td>
<td style="text-align:left">If <code>enableReadyCheck</code> is <code>true</code>, client will emit <code>ready</code> when the server reports that it is ready to receive commands (e.g. finish loading data from disk).<br>Otherwise, <code>ready</code> will be emitted immediately right after the <code>connect</code> event.</td>
</tr>
<tr>
<td style="text-align:left">error</td>
<td style="text-align:left">emits when an error occurs while connecting.<br>However, ioredis emits all <code>error</code> events silently (only emits when there&rsquo;s at least one listener) so that your application won&rsquo;t crash if you&rsquo;re not listening to the <code>error</code> event.</td>
</tr>
<tr>
<td style="text-align:left">close</td>
<td style="text-align:left">emits when an established Redis server connection has closed.</td>
</tr>
<tr>
<td style="text-align:left">reconnecting</td>
<td style="text-align:left">emits after <code>close</code> when a reconnection will be made. The argument of the event is the time (in ms) before reconnecting.</td>
</tr>
<tr>
<td style="text-align:left">end</td>
<td style="text-align:left">emits after <code>close</code> when no more reconnections will be made, or the connection is failed to establish.</td>
</tr>
<tr>
<td style="text-align:left">wait</td>
<td style="text-align:left">emits when <code>lazyConnect</code> is set and will wait for the first command to be called before connecting.</td>
</tr>
</tbody>
</table>
<p>You can also check out the <code>Redis#status</code> property to get the current connection status.</p>
<p>Besides the above connection events, there are several other custom events:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Event</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">select</td>
<td style="text-align:left">emits when the database changed. The argument is the new db number.</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f69c80caa3d66b8aa309a605e9f3eac0">3.3 - TLS</h1>
    
	<h2 id="tls-选项">TLS 选项</h2>
<p>Redis doesn&rsquo;t support TLS natively, however if the redis server you want to connect to is hosted behind a TLS proxy (e.g. <a href="https://www.stunnel.org/">stunnel</a>) or is offered by a PaaS service that supports TLS connection (e.g. <a href="https://redis.com/">Redis.com</a>), you can set the <code>tls</code> option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">tls</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Refer to `tls.connect()` section in
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// https://nodejs.org/api/tls.html
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// for all supported options
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ca</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">readFileSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cert.pem&#34;</span><span style="color:#000;font-weight:bold">),</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Alternatively, specify the connection through a <a href="https://www.iana.org/assignments/uri-schemes/prov/rediss"><code>rediss://</code> URL</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rediss://redis.my-service.com&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="tls-配置文件">TLS 配置文件</h3>
<p>To make it easier to configure we provide a few pre-configured TLS profiles that can be specified by setting the <code>tls</code> option to the profile&rsquo;s name or specifying a <code>tls.profile</code> option in case you need to customize some values of the profile.</p>
<p>Profiles:</p>
<ul>
<li><code>RedisCloudFixed</code>: Contains the CA for <a href="https://redis.com/">Redis.com</a> Cloud fixed subscriptions</li>
<li><code>RedisCloudFlexible</code>: Contains the CA for <a href="https://redis.com/">Redis.com</a> Cloud flexible subscriptions</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">tls</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RedisCloudFixed&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redisWithClientCertificate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">tls</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">profile</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RedisCloudFixed&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;123&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><hr>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2343bd3dda769573f9bfbbd6acb0a7a0">3.4 - 流和二进制</h1>
    
	<h2 id="流">流</h2>
<p>Redis v5 introduces a new data type called streams. It doubles as a communication channel for building streaming architectures and as a log-like data structure for persisting data. With ioredis, the usage can be pretty straightforward. Say we have a producer publishes messages to a stream with <code>redis.xadd(&quot;mystream&quot;, &quot;*&quot;, &quot;randomValue&quot;, Math.random())</code> (You may find the <a href="https://redis.io/topics/streams-intro">official documentation of Streams</a> as a starter to understand the parameters used), to consume the messages, we&rsquo;ll have a consumer with the following code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">processMessage</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Id: %s. Data: %O&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">listenForMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lastId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;$&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `results` is an array, each element of which corresponds to a key.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Because we only listen to one key (mystream) here, `results` only contains
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// a single element. See more: https://redis.io/commands/xread#return-value
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">xread</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;block&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;STREAMS&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;mystream&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastId</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">messages</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#8f5902;font-style:italic">// `key` equals to &#34;mystream&#34;
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#000">messages</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forEach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processMessage</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// Pass the last id of the results to the next round.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">listenForMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">messages</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">messages</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">listenForMessage</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><h2 id="操作二进制文件">操作二进制文件</h2>
<p>Arguments can be buffers:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">));</span>
</code></pre></div><p>And every command has a method that returns a Buffer (by adding a suffix of &ldquo;Buffer&rdquo; to the command name).
To get a buffer instead of a utf8 string:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getBuffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result is a buffer.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cb6c8f83462149a16d76c4dd48656489">3.5 - Lua 脚本</h1>
    
	<p>ioredis supports all of the scripting commands such as <code>EVAL</code>, <code>EVALSHA</code> and <code>SCRIPT</code>.
However, it&rsquo;s tedious to use in real world scenarios since developers have to take
care of script caching and to detect when to use <code>EVAL</code> and when to use <code>EVALSHA</code>.
ioredis exposes a <code>defineCommand</code> method to make scripting much easier to use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// This will define a command echo:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defineCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;echo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">numberOfKeys</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Now `echo` can be used just like any other ordinary command,
</span><span style="color:#8f5902;font-style:italic">// and ioredis will try to use `EVALSHA` internally when possible for better performance.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === [&#39;k1&#39;, &#39;k2&#39;, &#39;a1&#39;, &#39;a2&#39;]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// `echoBuffer` is also defined automatically to return buffers instead of strings:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">echoBuffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result[0] equals to Buffer.from(&#39;k1&#39;);
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// And of course it works with pipeline:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a2&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>If the number of keys can&rsquo;t be determined when defining a command, you can
omit the <code>numberOfKeys</code> property and pass the number of keys as the first argument
when you call the command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defineCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;echoDynamicKeyNumber&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Now you have to pass the number of keys as the first argument every time
</span><span style="color:#8f5902;font-style:italic">// you invoke the `echoDynamicKeyNumber` command:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">echoDynamicKeyNumber</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === [&#39;k1&#39;, &#39;k2&#39;, &#39;a1&#39;, &#39;a2&#39;]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6b3e092823019df7e9d60d6a581cd606">3.6 - Pipelining</h1>
    
	<h2 id="pipelining">Pipelining</h2>
<p>If you want to send a batch of commands (e.g. &gt; 5), you can use pipelining to queue
the commands in memory and then send them to Redis all at once. This way the performance improves by 50%~300% (See <a href="#benchmarks">benchmark section</a>).</p>
<p><code>redis.pipeline()</code> creates a <code>Pipeline</code> instance. You can call any Redis
commands on it just like the <code>Redis</code> instance. The commands are queued in memory
and flushed to Redis by calling the <code>exec</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">pipeline</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `err` is always null, and `results` is an array of responses
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// corresponding to the sequence of queued commands.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Each response follows the format `[err, result]`.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// You can even chain the commands:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>

<span style="color:#8f5902;font-style:italic">// `exec` also returns a Promise:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">promise</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === [[null, &#39;OK&#39;], [null, &#39;bar&#39;]]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Each chained command can also have a callback, which will be invoked when the command
gets a reply:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// result === &#39;bar&#39;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// result[1][1] === &#39;bar&#39;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>In addition to adding commands to the <code>pipeline</code> queue individually, you can also pass an array of commands and arguments to the constructor:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;set&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">])</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/* ... */</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p><code>#length</code> property shows how many commands in the pipeline:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// length === 2
</span></code></pre></div><h2 id="transaction">Transaction</h2>
<p>Most of the time, the transaction commands <code>multi</code> &amp; <code>exec</code> are used together with pipeline.
Therefore, when <code>multi</code> is called, a <code>Pipeline</code> instance is created automatically by default,
so you can use <code>multi</code> just like <code>pipeline</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// results === [[null, &#39;OK&#39;], [null, &#39;bar&#39;]]
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>If there&rsquo;s a syntax error in the transaction&rsquo;s command chain (e.g. wrong number of arguments, wrong command name, etc),
then none of the commands would be executed, and an error is returned:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;new value&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// err:
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//  { [ReplyError: EXECABORT Transaction discarded because of previous errors.]
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//    name: &#39;ReplyError&#39;,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//    message: &#39;EXECABORT Transaction discarded because of previous errors.&#39;,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//    command: { name: &#39;exec&#39;, args: [] },
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//    previousErrors:
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//     [ { [ReplyError: ERR wrong number of arguments for &#39;set&#39; command]
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//         name: &#39;ReplyError&#39;,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//         message: &#39;ERR wrong number of arguments for \&#39;set\&#39; command&#39;,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//         command: [Object] } ] }
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>In terms of the interface, <code>multi</code> differs from <code>pipeline</code> in that when specifying a callback
to each chained command, the queueing state is passed to the callback instead of the result of the command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// result === &#39;QUEUED&#39;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>If you want to use transaction without pipeline, pass <code>{ pipeline: false }</code> to <code>multi</code>,
and every command will be sent to Redis immediately without waiting for an <code>exec</code> invocation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">pipeline</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === [[null, &#39;OK&#39;], [null, &#39;bar&#39;]]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>The constructor of <code>multi</code> also accepts a batch of commands:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;set&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">])</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/* ... */</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Inline transactions are supported by pipeline, which means you can group a subset of commands
in the pipeline into a transaction:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><hr>
<h2 id="autopipelining">Autopipelining</h2>
<p>In standard mode, when you issue multiple commands, ioredis sends them to the server one by one. As described in Redis pipeline documentation, this is a suboptimal use of the network link, especially when such link is not very performant.</p>
<p>The TCP and network overhead negatively affects performance. Commands are stuck in the send queue until the previous ones are correctly delivered to the server. This is a problem known as Head-Of-Line blocking (HOL).</p>
<p>ioredis supports a feature called “auto pipelining”. It can be enabled by setting the option <code>enableAutoPipelining</code> to <code>true</code>. No other code change is necessary.</p>
<p>In auto pipelining mode, all commands issued during an event loop are enqueued in a pipeline automatically managed by ioredis. At the end of the iteration, the pipeline is executed and thus all commands are sent to the server at the same time.</p>
<p>This feature can dramatically improve throughput and avoids HOL blocking. In our benchmarks, the improvement was between 35% and 50%.</p>
<p>While an automatic pipeline is executing, all new commands will be enqueued in a new pipeline which will be executed as soon as the previous finishes.</p>
<p>When using Redis Cluster, one pipeline per node is created. Commands are assigned to pipelines according to which node serves the slot.</p>
<p>A pipeline will thus contain commands using different slots but that ultimately are assigned to the same node.</p>
<p>Note that the same slot limitation within a single command still holds, as it is a Redis limitation.</p>
<h3 id="example-of-automatic-pipeline-enqueuing">Example of automatic pipeline enqueuing</h3>
<p>This sample code uses ioredis with automatic pipeline enabled.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;./built&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">http</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">db</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">enableAutoPipelining</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createServer</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">URL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;https://localhost:3000/&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">searchParams</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#4e9a06">&#34;key&#34;</span>
  <span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">writeHead</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text/plain&#34;</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>When Node receives requests, it schedules them to be processed in one or more iterations of the events loop.</p>
<p>All commands issued by requests processing during one iteration of the loop will be wrapped in a pipeline automatically created by ioredis.</p>
<p>In the example above, the pipeline will have the following contents:</p>
<pre tabindex="0"><code>GET key1
GET key2
GET key3
...
GET keyN
</code></pre><p>When all events in the current loop have been processed, the pipeline is executed and thus all commands are sent to the server at the same time.</p>
<p>While waiting for pipeline response from Redis, Node will still be able to process requests. All commands issued by request handler will be enqueued in a new automatically created pipeline. This pipeline will not be sent to the server yet.</p>
<p>As soon as a previous automatic pipeline has received all responses from the server, the new pipeline is immediately sent without waiting for the events loop iteration to finish.</p>
<p>This approach increases the utilization of the network link, reduces the TCP overhead and idle times and therefore improves throughput.</p>
<h3 id="benchmarks">Benchmarks</h3>
<p>Here&rsquo;s some of the results of our tests for a single node.</p>
<p>Each iteration of the test runs 1000 random commands on the server.</p>
<table>
<thead>
<tr>
<th></th>
<th>Samples</th>
<th>Result</th>
<th>Tolerance</th>
</tr>
</thead>
<tbody>
<tr>
<td>default</td>
<td>1000</td>
<td>174.62 op/sec</td>
<td>± 0.45 %</td>
</tr>
<tr>
<td>enableAutoPipelining=true</td>
<td>1500</td>
<td>233.33 op/sec</td>
<td>± 0.88 %</td>
</tr>
</tbody>
</table>
<p>And here&rsquo;s the same test for a cluster of 3 masters and 3 replicas:</p>
<table>
<thead>
<tr>
<th></th>
<th>Samples</th>
<th>Result</th>
<th>Tolerance</th>
</tr>
</thead>
<tbody>
<tr>
<td>default</td>
<td>1000</td>
<td>164.05 op/sec</td>
<td>± 0.42 %</td>
</tr>
<tr>
<td>enableAutoPipelining=true</td>
<td>3000</td>
<td>235.31 op/sec</td>
<td>± 0.94 %</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-10ea60f135a3f7ec97831781e6e8d908">3.7 - Pub/Sub</h1>
    
	<p>Redis provides several commands for developers to implement the <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">Publish–subscribe pattern</a>. There are two roles in this pattern: publisher and subscriber. Publishers are not programmed to send their messages to specific subscribers. Rather, published messages are characterized into channels, without knowledge of what (if any) subscribers there may be.</p>
<p>By leveraging Node.js&rsquo;s built-in events module, ioredis makes pub/sub very straightforward to use. Below is a simple example that consists of two files, one is publisher.js that publishes messages to a channel, the other is subscriber.js that listens for messages on specific channels.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// publisher.js
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">setInterval</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#8f5902;font-style:italic">// Publish to my-channel-1 or my-channel-2 randomly.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">channel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`my-channel-</span><span style="color:#4e9a06">${</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">())</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// Message can be either a string or a buffer
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Published %s to %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// subscriber.js
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my-channel-1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;my-channel-2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Just like other commands, subscribe() can fail for some reasons,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// ex network issues.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to subscribe: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// `count` represents the number of channels this client are currently subscribed to.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#4e9a06">`Subscribed successfully! This client is currently subscribed to </span><span style="color:#4e9a06">${</span><span style="color:#000">count</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> channels.`</span>
    <span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Received </span><span style="color:#4e9a06">${</span><span style="color:#000">message</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> from </span><span style="color:#4e9a06">${</span><span style="color:#000">channel</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// There&#39;s also an event called &#39;messageBuffer&#39;, which is the same as &#39;message&#39; except
</span><span style="color:#8f5902;font-style:italic">// it returns buffers instead of strings.
</span><span style="color:#8f5902;font-style:italic">// It&#39;s useful when the messages are binary data.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;messageBuffer&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// Both `channel` and `message` are buffers.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>It worth noticing that a connection (aka <code>Redis</code> instance) can&rsquo;t play both roles together. More specifically, when a client issues <code>subscribe()</code> or <code>psubscribe()</code>, it enters the &ldquo;subscriber&rdquo; mode. From that point, only commands that modify the subscription set are valid. Namely, they are: <code>subscribe</code>, <code>psubscribe</code>, <code>unsubscribe</code>, <code>punsubscribe</code>, <code>ping</code>, and <code>quit</code>. When the subscription set is empty (via <code>unsubscribe</code>/<code>punsubscribe</code>), the connection is put back into the regular mode.</p>
<p>If you want to do pub/sub in the same file/process, you should create a separate connection:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sub</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">pub</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">sub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// From now, `sub` enters the subscriber mode.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">sub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;message&#34;</span> <span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">setInterval</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `pub` can be used to publish messages, or send other regular commands (e.g. `hgetall`)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// because it&#39;s not in the subscriber mode.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">pub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><code>PSUBSCRIBE</code> is also supported in a similar way when you want to subscribe all channels whose name matches a pattern:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">psubscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pat?ern&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>

<span style="color:#8f5902;font-style:italic">// Event names are &#34;pmessage&#34;/&#34;pmessageBuffer&#34; instead of &#34;message/messageBuffer&#34;.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pmessage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pmessageBuffer&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2507e639715a46af5c576fcdae1ad5d5">3.8 - Sentinel</h1>
    
	<p>ioredis supports Sentinel out of the box. It works transparently as all features that work when
you connect to a single node also work when you connect to a sentinel group. Make sure to run Redis &gt;= 2.8.12 if you want to use this feature. Sentinels have a default port of 26379.</p>
<p>To connect using Sentinel, use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">sentinels</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">26379</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">26380</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;mymaster&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The arguments passed to the constructor are different from the ones you use to connect to a single node, where:</p>
<ul>
<li><code>name</code> identifies a group of Redis instances composed of a master and one or more slaves (<code>mymaster</code> in the example);</li>
<li><code>sentinelPassword</code> (optional) password for Sentinel instances.</li>
<li><code>sentinels</code> are a list of sentinels to connect to. The list does not need to enumerate all your sentinel instances, but a few so that if one is down the client will try the next one.</li>
<li><code>role</code> (optional) with a value of <code>slave</code> will return a random slave from the Sentinel group.</li>
<li><code>preferredSlaves</code> (optional) can be used to prefer a particular slave or set of slaves based on priority. It accepts a function or array.</li>
<li><code>enableTLSForSentinelMode</code> (optional) set to true if connecting to sentinel instances that are encrypted</li>
</ul>
<p>ioredis <strong>guarantees</strong> that the node you connected to is always a master even after a failover. When a failover happens, instead of trying to reconnect to the failed node (which will be demoted to slave when it&rsquo;s available again), ioredis will ask sentinels for the new master node and connect to it. All commands sent during the failover are queued and will be executed when the new connection is established so that none of the commands will be lost.</p>
<p>It&rsquo;s possible to connect to a slave instead of a master by specifying the option <code>role</code> with the value of <code>slave</code> and ioredis will try to connect to a random slave of the specified master, with the guarantee that the connected node is always a slave. If the current node is promoted to master due to a failover, ioredis will disconnect from it and ask the sentinels for another slave node to connect to.</p>
<p>If you specify the option <code>preferredSlaves</code> along with <code>role: 'slave'</code> ioredis will attempt to use this value when selecting the slave from the pool of available slaves. The value of <code>preferredSlaves</code> should either be a function that accepts an array of available slaves and returns a single result, or an array of slave values priorities by the lowest <code>prio</code> value first with a default value of <code>1</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// available slaves format
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">availableSlaves</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[{</span> <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;31231&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;slave&#34;</span> <span style="color:#000;font-weight:bold">}];</span>

<span style="color:#8f5902;font-style:italic">// preferredSlaves array format
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">preferredSlaves</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;31231&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prio</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;31232&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prio</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">];</span>

<span style="color:#8f5902;font-style:italic">// preferredSlaves function format
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">preferredSlaves</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">availableSlaves</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">availableSlaves</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">slave</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">availableSlaves</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">slave</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">slave</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">port</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;31234&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">slave</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#8f5902;font-style:italic">// if no preferred slaves are available a random one is used
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">sentinels</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">26379</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">26380</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;mymaster&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;slave&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">preferredSlaves</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">preferredSlaves</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Besides the <code>retryStrategy</code> option, there&rsquo;s also a <code>sentinelRetryStrategy</code> in Sentinel mode which will be invoked when all the sentinel nodes are unreachable during connecting. If <code>sentinelRetryStrategy</code> returns a valid delay time, ioredis will try to reconnect from scratch. The default value of <code>sentinelRetryStrategy</code> is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">delay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">delay</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-01b6f9e61cef026000ac5289660fd21b">3.9 - Cluster</h1>
    
	<p>Redis Cluster provides a way to run a Redis installation where data is automatically sharded across multiple Redis nodes.
You can connect to a Redis Cluster like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">([</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6380</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6381</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]);</span>

<span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// res === &#39;bar&#39;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p><code>Cluster</code> constructor accepts two arguments, where:</p>
<ol start="0">
<li>
<p>The first argument is a list of nodes of the cluster you want to connect to.
Just like Sentinel, the list does not need to enumerate all your cluster nodes,
but a few so that if one is unreachable the client will try the next one, and the client will discover other nodes automatically when at least one node is connected.</p>
</li>
<li>
<p>The second argument is the options, where:</p>
<ul>
<li>
<p><code>clusterRetryStrategy</code>: When none of the startup nodes are reachable, <code>clusterRetryStrategy</code> will be invoked. When a number is returned,
ioredis will try to reconnect to the startup nodes from scratch after the specified delay (in ms). Otherwise, an error of &ldquo;None of startup nodes is available&rdquo; will be returned.
The default value of this option is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">delay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">delay</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>It&rsquo;s possible to modify the <code>startupNodes</code> property in order to switch to another set of nodes here:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startupNodes</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[{</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6790</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;127.0.0.1&#39;</span> <span style="color:#000;font-weight:bold">}];</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div></li>
<li>
<p><code>dnsLookup</code>: Alternative DNS lookup function (<code>dns.lookup()</code> is used by default). It may be useful to override this in special cases, such as when AWS ElastiCache used with TLS enabled.</p>
</li>
<li>
<p><code>enableOfflineQueue</code>: Similar to the <code>enableOfflineQueue</code> option of <code>Redis</code> class.</p>
</li>
<li>
<p><code>enableReadyCheck</code>: When enabled, &ldquo;ready&rdquo; event will only be emitted when <code>CLUSTER INFO</code> command
reporting the cluster is ready for handling commands. Otherwise, it will be emitted immediately after &ldquo;connect&rdquo; is emitted.</p>
</li>
<li>
<p><code>scaleReads</code>: Config where to send the read queries. See below for more details.</p>
</li>
<li>
<p><code>maxRedirections</code>: When a cluster related error (e.g. <code>MOVED</code>, <code>ASK</code> and <code>CLUSTERDOWN</code> etc.) is received, the client will redirect the
command to another node. This option limits the max redirections allowed when sending a command. The default value is <code>16</code>.</p>
</li>
<li>
<p><code>retryDelayOnFailover</code>: If the target node is disconnected when sending a command,
ioredis will retry after the specified delay. The default value is <code>100</code>. You should make sure <code>retryDelayOnFailover * maxRedirections &gt; cluster-node-timeout</code>
to insure that no command will fail during a failover.</p>
</li>
<li>
<p><code>retryDelayOnClusterDown</code>: When a cluster is down, all commands will be rejected with the error of <code>CLUSTERDOWN</code>. If this option is a number (by default, it is <code>100</code>), the client
will resend the commands after the specified time (in ms).</p>
</li>
<li>
<p><code>retryDelayOnTryAgain</code>: If this option is a number (by default, it is <code>100</code>), the client
will resend the commands rejected with <code>TRYAGAIN</code> error after the specified time (in ms).</p>
</li>
<li>
<p><code>retryDelayOnMoved</code>: By default, this value is <code>0</code> (in ms), which means when a <code>MOVED</code> error is received, the client will resend
the command instantly to the node returned together with the <code>MOVED</code> error. However, sometimes it takes time for a cluster to become
state stabilized after a failover, so adding a delay before resending can prevent a ping pong effect.</p>
</li>
<li>
<p><code>redisOptions</code>: Default options passed to the constructor of <code>Redis</code> when connecting to a node.</p>
</li>
<li>
<p><code>slotsRefreshTimeout</code>: Milliseconds before a timeout occurs while refreshing slots from the cluster (default <code>1000</code>).</p>
</li>
<li>
<p><code>slotsRefreshInterval</code>: Milliseconds between every automatic slots refresh (default <code>5000</code>).</p>
</li>
</ul>
</li>
</ol>
<h3 id="read-write-splitting">Read-write splitting</h3>
<p>A typical redis cluster contains three or more masters and several slaves for each master. It&rsquo;s possible to scale out redis cluster by sending read queries to slaves and write queries to masters by setting the <code>scaleReads</code> option.</p>
<p><code>scaleReads</code> is &ldquo;master&rdquo; by default, which means ioredis will never send any queries to slaves. There are other three available options:</p>
<ol>
<li>&ldquo;all&rdquo;: Send write queries to masters and read queries to masters or slaves randomly.</li>
<li>&ldquo;slave&rdquo;: Send write queries to masters and read queries to slaves.</li>
<li>a custom <code>function(nodes, command): node</code>: Will choose the custom function to select to which node to send read queries (write queries keep being sent to master). The first node in <code>nodes</code> is always the master serving the relevant slots. If the function returns an array of nodes, a random node of that list will be selected.</li>
</ol>
<p>For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#8f5902;font-style:italic">/* nodes */</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">scaleReads</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;slave&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// This query will be sent to one of the masters.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// This query will be sent to one of the slaves.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p><strong>NB</strong> In the code snippet above, the <code>res</code> may not be equal to &ldquo;bar&rdquo; because of the lag of replication between the master and slaves.</p>
<h3 id="running-commands-to-multiple-nodes">Running commands to multiple nodes</h3>
<p>Every command will be sent to exactly one node. For commands containing keys, (e.g. <code>GET</code>, <code>SET</code> and <code>HGETALL</code>), ioredis sends them to the node that serving the keys, and for other commands not containing keys, (e.g. <code>INFO</code>, <code>KEYS</code> and <code>FLUSHDB</code>), ioredis sends them to a random node.</p>
<p>Sometimes you may want to send a command to multiple nodes (masters or slaves) of the cluster, you can get the nodes via <code>Cluster#nodes()</code> method.</p>
<p><code>Cluster#nodes()</code> accepts a parameter role, which can be &ldquo;master&rdquo;, &ldquo;slave&rdquo; and &ldquo;all&rdquo; (default), and returns an array of <code>Redis</code> instance. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// Send `FLUSHDB` command to all slaves:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">slaves</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;slave&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slaves</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">flushdb</span><span style="color:#000;font-weight:bold">()));</span>

<span style="color:#8f5902;font-style:italic">// Get keys of all the masters:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">masters</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;master&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000">masters</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">())</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// keys: [[&#39;key1&#39;, &#39;key2&#39;], [&#39;key3&#39;, &#39;key4&#39;]]
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">})</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="nat-mapping">NAT Mapping</h3>
<p>Sometimes the cluster is hosted within a internal network that can only be accessed via a NAT (Network Address Translation) instance. See <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/accessing-elasticache.html">Accessing ElastiCache from outside AWS</a> as an example.</p>
<p>You can specify nat mapping rules via <code>natMap</code> option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;203.0.113.73&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30001</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">natMap</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#4e9a06">&#34;10.0.1.230:30001&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;203.0.113.73&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30001</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#4e9a06">&#34;10.0.1.231:30001&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;203.0.113.73&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30002</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#4e9a06">&#34;10.0.1.232:30001&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;203.0.113.73&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30003</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>This option is also useful when the cluster is running inside a Docker container.</p>
<h3 id="transaction-and-pipeline-in-cluster-mode">Transaction and pipeline in Cluster mode</h3>
<p>Almost all features that are supported by <code>Redis</code> are also supported by <code>Redis.Cluster</code>, e.g. custom commands, transaction and pipeline.
However there are some differences when using transaction and pipeline in Cluster mode:</p>
<ol start="0">
<li>All keys in a pipeline should belong to slots served by the same node, since ioredis sends all commands in a pipeline to the same node.</li>
<li>You can&rsquo;t use <code>multi</code> without pipeline (aka <code>cluster.multi({ pipeline: false })</code>). This is because when you call <code>cluster.multi({ pipeline: false })</code>, ioredis doesn&rsquo;t know which node the <code>multi</code> command should be sent to.</li>
</ol>
<p>When any commands in a pipeline receives a <code>MOVED</code> or <code>ASK</code> error, ioredis will resend the whole pipeline to the specified node automatically if all of the following conditions are satisfied:</p>
<ol start="0">
<li>All errors received in the pipeline are the same. For example, we won&rsquo;t resend the pipeline if we got two <code>MOVED</code> errors pointing to different nodes.</li>
<li>All commands executed successfully are readonly commands. This makes sure that resending the pipeline won&rsquo;t have side effects.</li>
</ol>
<h3 id="pubsub">Pub/Sub</h3>
<p>Pub/Sub in cluster mode works exactly as the same as in standalone mode. Internally, when a node of the cluster receives a message, it will broadcast the message to the other nodes. ioredis makes sure that each message will only be received once by strictly subscribing one node at the same time.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">nodes</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#8f5902;font-style:italic">/* nodes */</span>
<span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">pub</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sub</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">sub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">sub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;news&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">pub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;news&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;highlights&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h3 id="events">Events</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Event</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">connect</td>
<td style="text-align:left">emits when a connection is established to the Redis server.</td>
</tr>
<tr>
<td style="text-align:left">ready</td>
<td style="text-align:left">emits when <code>CLUSTER INFO</code> reporting the cluster is able to receive commands (if <code>enableReadyCheck</code> is <code>true</code>) or immediately after <code>connect</code> event (if <code>enableReadyCheck</code> is false).</td>
</tr>
<tr>
<td style="text-align:left">error</td>
<td style="text-align:left">emits when an error occurs while connecting with a property of <code>lastNodeError</code> representing the last node error received. This event is emitted silently (only emitting if there&rsquo;s at least one listener).</td>
</tr>
<tr>
<td style="text-align:left">close</td>
<td style="text-align:left">emits when an established Redis server connection has closed.</td>
</tr>
<tr>
<td style="text-align:left">reconnecting</td>
<td style="text-align:left">emits after <code>close</code> when a reconnection will be made. The argument of the event is the time (in ms) before reconnecting.</td>
</tr>
<tr>
<td style="text-align:left">end</td>
<td style="text-align:left">emits after <code>close</code> when no more reconnections will be made.</td>
</tr>
<tr>
<td style="text-align:left">+node</td>
<td style="text-align:left">emits when a new node is connected.</td>
</tr>
<tr>
<td style="text-align:left">-node</td>
<td style="text-align:left">emits when a node is disconnected.</td>
</tr>
<tr>
<td style="text-align:left">node error</td>
<td style="text-align:left">emits when an error occurs when connecting to a node. The second argument indicates the address of the node.</td>
</tr>
</tbody>
</table>
<h3 id="password">Password</h3>
<p>Setting the <code>password</code> option to access password-protected clusters:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">redisOptions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;your-cluster-password&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>If some of nodes in the cluster using a different password, you should specify them in the first parameter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#8f5902;font-style:italic">// Use password &#34;password-for-30001&#34; for 30001
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30001</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;password-for-30001&#34;</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#8f5902;font-style:italic">// Don&#39;t use password when accessing 30002
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30002</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#8f5902;font-style:italic">// Other nodes will use &#34;fallback-password&#34;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">redisOptions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;fallback-password&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="special-note-aws-elasticache-clusters-with-tls">Special note: AWS ElastiCache Clusters with TLS</h3>
<p>AWS ElastiCache for Redis (Clustered Mode) supports TLS encryption. If you use
this, you may encounter errors with invalid certificates. To resolve this
issue, construct the <code>Cluster</code> with the <code>dnsLookup</code> option as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;clustercfg.myCluster.abcdefg.xyz.cache.amazonaws.com&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">dnsLookup</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">address</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">redisOptions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">tls</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{},</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><hr>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6167cf947d7672083e29d66e95ef4d27">4 - egg redis</h1>
    
	<p>为<code>eggjs</code>框架基于 <code>ioredis</code> Redis 客户端(支持 redis 协议)</p>
<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ npm i egg-redis --save
</code></pre></div><p>redis Plugin for egg, support egg application access to redis.</p>
<p>This plugin based on <a href="https://github.com/luin/ioredis">ioredis</a>, if you want to know specific usage, you should refer to the document of <a href="https://github.com/luin/ioredis">ioredis</a>.</p>
<h2 id="配置">配置</h2>
<p>Change <code>${app_root}/config/plugin.js</code> to enable redis plugin:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">enable</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#204a87;font-weight:bold">package</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;egg-redis&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p>Configure redis information in <code>${app_root}/config/config.default.js</code>:</p>
<p><strong>Single Client</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis port
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis host
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;auth&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p><strong>Multi Clients</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">clients</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// instanceName. See below
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis port
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis host
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;auth&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;auth&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p><strong>Sentinel</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">sentinels</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
      <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#8f5902;font-style:italic">// Sentinel instances
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">26379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Sentinel port
</span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Sentinel host
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;mymaster&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Master name
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;auth&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p><strong>No password</strong></p>
<p>Redis support no authentication access, but we are highly recommand you to use redis <code>requirepass</code> in <code>redis.conf</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">
<span style="color:#000">$vim</span> /etc/redis/redis.conf

requirepass xxxxxxxxxx  // xxxxxxxxxx is your password

</code></pre></div><p>Because it may be cause security risk, refer:</p>
<ul>
<li><a href="https://ruby-china.org/topics/28094">https://ruby-china.org/topics/28094</a></li>
<li><a href="https://zhuoroger.github.io/2016/07/29/redis-sec/">https://zhuoroger.github.io/2016/07/29/redis-sec/</a></li>
</ul>
<p>If you want to access redis with no password, use <code>password: null</code>.</p>
<p>See <a href="https://github.com/luin/ioredis/blob/master/API.md#new_Redis">ioredis API Documentation</a> for all available options.</p>
<h3 id="自定义-ioredis-版本">自定义 <code>ioredis</code> 版本</h3>
<p><code>egg-redis</code> using ioredis@4 now, if you want to use other version of ioredis, you can pass the instance by <code>config.redis.Redis</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// config/config.default.js
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">Redis</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// customize ioredis version, only set when you needed
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis port
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis host
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;auth&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><p><strong>weakDependent</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis port
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis host
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;auth&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">weakDependent</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// this redis instance won&#39;t block app start
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><h2 id="使用">使用</h2>
<p>In controller, you can use <code>app.redis</code> to get the redis instance, check <a href="https://github.com/luin/ioredis#basic-usage">ioredis</a> to see how to use.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// app/controller/home.js
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exports</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HomeController</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">app</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#8f5902;font-style:italic">// set
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#8f5902;font-style:italic">// get
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><h3 id="多客户端">多客户端</h3>
<p>If your Configure with multi clients, you can use <code>app.redis.get(instanceName)</code> to get the specific redis instance and use it like above.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// app/controller/home.js
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exports</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HomeController</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">app</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#8f5902;font-style:italic">// set
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;instance1&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#8f5902;font-style:italic">// get
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;instance1&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><h3 id="客户端依赖于-redis-集群">客户端依赖于 Redis 集群</h3>
<p>Before you start to use Redis Cluster, please checkout the <a href="https://redis.io/topics/cluster-tutorial">document</a> first, especially confirm <code>cluster-enabled yes</code> in Redis Cluster configuration file.</p>
<p>In controller, you also can use <code>app.redis</code> to get the redis instance based on Redis Cluster.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#8f5902;font-style:italic">// app/config/config.default.js
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">exports</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">cluster</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">nodes</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
      <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;6379&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">family</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;password&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;db&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;6380&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">family</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;password&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;db&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#8f5902;font-style:italic">// app/controller/home.js
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">module</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exports</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">HomeController</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Controller</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">app</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#8f5902;font-style:italic">// set
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
      <span style="color:#8f5902;font-style:italic">// get
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">body</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><h2 id="问题与建议">问题与建议</h2>
<p>Please open an issue <a href="https://github.com/eggjs/egg/issues">here</a>.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e82af8709aafd470614bebb3b2c7681c">5 - Node Redis</h1>
    
	<p>node-redis 是 Node.js 的一个现代的，高性能<a href="https://redis.io">Redis</a>客户端,内置支持 Redis 6.2 命令和模块，包括<a href="https://redisearch.io">reresearch</a>和<a href="https://redisjson.io">RedisJSON</a>。</p>
<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm install redis
</code></pre></div><blockquote>
<p>:warning: 新的接口很干净很酷，但是如果你有一个现有的代码库，你会想要阅读<a href="./docs/v3-to-v4.md">迁移指南</a>。</p>
</blockquote>
<h2 id="使用">使用</h2>
<h3 id="基本示例">基本示例</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">createClient</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createClient</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Redis Client Error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">));</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connect</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">})();</span>
</code></pre></div><p>上面的代码连接到端口 6379 上的本地主机。
连接到一个不同的主机或端口，使用格式为<code>redis[s]://[[username][:password]@][host][:port][/db-number]</code>的连接字符串:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#000">createClient</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">url</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;redis://alice:foobared@awesome.redis.server:6380&#34;</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>您还可以使用离散参数、UNIX 套接字甚至 TLS 进行连接。
详细信息请参见<a href="./docs/client-configuration.md">客户端配置指南</a>.</p>
<h3 id="redis-命令">Redis 命令</h3>
<p>内置支持所有的<a href="https://redis.io/commands">开箱即用的 Redis 命令</a>.
他们使用原始的 Redis 命令名(<code>HSET</code>, <code>HGETALL</code>, 等)和一个更友好的驼式大小写版本(<code>hSet</code>, <code>hGetAll</code>, 等):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#8f5902;font-style:italic">// raw Redis commands
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HSET</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;field&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HGETALL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// friendly JavaScript commands
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hSet</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;field&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hGetAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>命令的修饰符是使用 JavaScript 对象指定的:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">EX</span>: <span style="color:#204a87;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NX</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>回复将被转换成有用的数据结构:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hGetAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// { field1: &#39;value1&#39;, field2: &#39;value2&#39; }
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hVals</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// [&#39;value1&#39;, &#39;value2&#39;]
</span></code></pre></div><h3 id="不支持的-redis-命令">不支持的 Redis 命令</h3>
<p>如果你想运行命令和/或使用节点 Redis 不知道的参数(还!)使用<code>sendCommand</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sendCommand</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;SET&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;NX&#34;</span><span style="color:#000;font-weight:bold">]);</span> <span style="color:#8f5902;font-style:italic">// &#39;OK&#39;
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sendCommand</span><span style="color:#000;font-weight:bold">([</span><span style="color:#4e9a06">&#34;HGETALL&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">]);</span> <span style="color:#8f5902;font-style:italic">// [&#39;key1&#39;, &#39;field1&#39;, &#39;key2&#39;, &#39;field2&#39;]
</span></code></pre></div><h3 id="事务-multiexec">事务 (Multi/Exec)</h3>
<p>通过调用<code>.multi()</code>启动<a href="https://redis.io/topics/transactions">事务</a>, 然后链接你的命令.
当您完成时，调用<code>.exec()</code>，您将得到一个带有结果的数组:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;another-key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;another-value&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">setKeyReply</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">otherKeyValue</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;another-key&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#8f5902;font-style:italic">// [&#39;OK&#39;, &#39;another-value&#39;]
</span></code></pre></div><p>你也可以通过调用<code>.watch()</code>来<a href="https://redis.io/topics/transactions#optimistic-locking-using-check-and-set">查看</a>键。
如果任何被监视的键发生变化，您的事务将中止。</p>
<p>要深入了解事务，请查看<a href="./docs/isolated-execution.md">隔离执行指南</a>.</p>
<h3 id="阻塞的命令">阻塞的命令</h3>
<p>通过指定<code>isolated</code>选项，可以在新连接上运行任何命令。
当命令的<code>Promise</code>完成时，新创建的连接将关闭。</p>
<p>这种模式尤其适用于阻塞命令，例如<code>BLPOP</code>和<code>BLMOVE</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">commandOptions</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">blPopPromise</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">blPop</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">commandOptions</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">isolated</span>: <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">}),</span> <span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">lPush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#000;font-weight:bold">]);</span>

<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">blPopPromise</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// &#39;2&#39;
</span></code></pre></div><p>要了解更多关于隔离执行的信息，请查看<a href="./docs/isolated-execution.md">指南</a>.</p>
<h3 id="pubsub">Pub/Sub</h3>
<p>订阅通道需要专用的独立连接。
你可以很容易地通过<code>.duplicate()</code>得到一个现有的 Redis 连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">subscriber</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">duplicate</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connect</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>一旦你有了一个，只需按需要订阅和取消订阅:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;channel&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// &#39;message&#39;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pSubscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;channe*&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// &#39;message&#39;, &#39;channel&#39;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">unsubscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;channel&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pUnsubscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;channe*&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>在通道上发布消息:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">publisher</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;channel&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>它还支持缓冲区:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribe</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#4e9a06">&#34;channel&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// &lt;Buffer 6d 65 73 73 61 67 65&gt;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">true</span>
<span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">subscriber</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pSubscribe</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#4e9a06">&#34;channe*&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// &lt;Buffer 6d 65 73 73 61 67 65&gt;, &lt;Buffer 63 68 61 6e 6e 65 6c&gt;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#204a87;font-weight:bold">true</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="扫描迭代器">扫描迭代器</h3>
<p><a href="https://redis.io/commands/scan"><code>SCAN</code></a>结果可以使用<a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Symbol/asyncIterator">异步迭代器</a>循环:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">of</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scanIterator</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// use the key!
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>这也适用于<code>HSCAN</code>， <code>SSCAN</code>和<code>ZSCAN</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">field</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">of</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hScanIterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hash&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">member</span> <span style="color:#204a87;font-weight:bold">of</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sScanIterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;set&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#000;font-weight:bold">}</span>
<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">score</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">of</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zScanIterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sorted-set&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>您可以通过提供一个配置对象来覆盖默认选项:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scanIterator</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">TYPE</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// `SCAN` only
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">MATCH</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;patter*&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">COUNT</span>: <span style="color:#204a87;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h3 id="lua-脚本">Lua 脚本</h3>
<p>使用<a href="https://redis.io/commands/eval">Lua 脚本</a>定义新的功能在 Redis 服务器执行</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">createClient</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">defineScript</span> <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#4e9a06">&#34;redis&#34;</span><span style="color:#000;font-weight:bold">;</span>

<span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">createClient</span><span style="color:#000;font-weight:bold">({</span>
    <span style="color:#000">scripts</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">add</span>: <span style="color:#204a87;font-weight:bold">defineScript</span><span style="color:#000;font-weight:bold">({</span>
        <span style="color:#000">NUMBER_OF_KEYS</span>: <span style="color:#204a87;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">SCRIPT</span><span style="color:#ce5c00;font-weight:bold">:</span>
          <span style="color:#4e9a06">&#39;local val = redis.pcall(&#34;GET&#34;, KEYS[1]);&#39;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;return val + ARGV[1];&#34;</span><span style="color:#000;font-weight:bold">,</span>
        <span style="color:#000">transformArguments</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span>: <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">toAdd</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Array</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">toAdd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">toString</span><span style="color:#000;font-weight:bold">()];</span>
        <span style="color:#000;font-weight:bold">},</span>
        <span style="color:#000">transformReply</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">reply</span>: <span style="color:#204a87;font-weight:bold">number</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">number</span> <span style="color:#000;font-weight:bold">{</span>
          <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">reply</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#000;font-weight:bold">}),</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">});</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">connect</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;1&#34;</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// 3
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">})();</span>
</code></pre></div><h3 id="断开">断开</h3>
<p>There are two functions that disconnect a client from the Redis server.
In most scenarios you should use <code>.quit()</code> to ensure that pending commands are sent to Redis before closing a connection.</p>
<h4 id="quitquit"><code>.QUIT()</code>/<code>.quit()</code></h4>
<p>Gracefully close a client&rsquo;s connection to Redis, by sending the <a href="https://redis.io/commands/quit"><code>QUIT</code></a> command to the server. Before quitting, the client executes any remaining commands in its queue, and will receive replies from Redis for each of them.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">ping</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">quit</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">([</span>
  <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ping</span><span style="color:#000;font-weight:bold">(),</span>
  <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">),</span>
  <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">quit</span><span style="color:#000;font-weight:bold">(),</span>
<span style="color:#000;font-weight:bold">]);</span> <span style="color:#8f5902;font-style:italic">// [&#39;PONG&#39;, null, &#39;OK&#39;]
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// ClosedClient Error
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h4 id="disconnect"><code>.disconnect()</code></h4>
<p>Forcibly close a client&rsquo;s connection to Redis immediately. Calling <code>disconnect</code> will not send further pending commands to the Redis server, or wait for or parse outstanding responses.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">disconnect</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><h3 id="自动流水线">自动流水线</h3>
<p>Node Redis will automatically pipeline requests that are made during the same &ldquo;tick&rdquo;.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Tm9kZSBSZWRpcw==&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;users:1&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sAdd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users:1:tokens&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Tm9kZSBSZWRpcw==&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Of course, if you don&rsquo;t do something with your Promises you&rsquo;re certain to get <a href="https://nodejs.org/api/process.html#process_event_unhandledrejection">unhandled Promise exceptions</a>. To take advantage of auto-pipelining and handle your Promises, use <code>Promise.all()</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-typescript" data-lang="typescript"><span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">([</span>
  <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Tm9kZSBSZWRpcw==&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;users:1&#34;</span><span style="color:#000;font-weight:bold">),</span>
  <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sAdd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users:1:tokens&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Tm9kZSBSZWRpcw==&#34;</span><span style="color:#000;font-weight:bold">),</span>
<span style="color:#000;font-weight:bold">]);</span>
</code></pre></div><h3 id="聚类">聚类</h3>
<p>Check out the <a href="./docs/clustering.md">Clustering Guide</a> when using Node Redis to connect to a Redis Cluster.</p>
<h3 id="事件">事件</h3>
<p>The Node Redis client class is an Nodejs EventEmitter and it emits an event each time the network status changes:</p>
<table>
<thead>
<tr>
<th>Event name</th>
<th>Scenes</th>
<th>Parameters</th>
</tr>
</thead>
<tbody>
<tr>
<td>connect</td>
<td>The client is initiating a connection to the server.</td>
<td><em>undefined</em></td>
</tr>
<tr>
<td>ready</td>
<td>The client successfully initiated the connection to the server.</td>
<td><em>undefined</em></td>
</tr>
<tr>
<td>end</td>
<td>The client disconnected the connection to the server via <code>.quit()</code> or <code>.disconnect()</code>.</td>
<td><em>undefined</em></td>
</tr>
<tr>
<td>error</td>
<td>When a network error has occurred, such as unable to connect to the server or the connection closed unexpectedly.</td>
<td>The error object, such as <code>SocketClosedUnexpectedlyError: Socket closed unexpectedly</code> or <code>Error: connect ECONNREFUSED [IP]:[PORT]</code></td>
</tr>
<tr>
<td>reconnecting</td>
<td>The client is trying to reconnect to the server.</td>
<td><em>undefined</em></td>
</tr>
</tbody>
</table>
<p>The client will not emit any other events beyond those listed above.</p>
<h2 id="支持-redis-版本">支持 Redis 版本</h2>
<p>Node Redis is supported with the following versions of Redis:</p>
<table>
<thead>
<tr>
<th>Version</th>
<th>Supported</th>
</tr>
</thead>
<tbody>
<tr>
<td>6.2.z</td>
<td>:heavy_check_mark:</td>
</tr>
<tr>
<td>6.0.z</td>
<td>:heavy_check_mark:</td>
</tr>
<tr>
<td>5.y.z</td>
<td>:heavy_check_mark:</td>
</tr>
<tr>
<td>&lt; 5.0</td>
<td>:x:</td>
</tr>
</tbody>
</table>
<blockquote>
<p>Node Redis should work with older versions of Redis, but it is not fully tested and we cannot offer support.</p>
</blockquote>
<h2 id="包">包</h2>
<table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="./">redis</a></td>
<td><a href="https://www.npmjs.com/package/redis"><img src="https://img.shields.io/npm/dm/redis.svg" alt="Downloads"></a> <a href="https://www.npmjs.com/package/redis"><img src="https://img.shields.io/npm/v/redis.svg" alt="Version"></a></td>
</tr>
<tr>
<td><a href="./packages/client">@node-redis/client</a></td>
<td><a href="https://www.npmjs.com/package/@node-redis/client"><img src="https://img.shields.io/npm/dm/@node-redis/client.svg" alt="Downloads"></a> <a href="https://www.npmjs.com/package/@node-redis/client"><img src="https://img.shields.io/npm/v/@node-redis/client.svg" alt="Version"></a></td>
</tr>
<tr>
<td><a href="./packages/json">@node-redis/json</a></td>
<td><a href="https://www.npmjs.com/package/@node-redis/json"><img src="https://img.shields.io/npm/dm/@node-redis/json.svg" alt="Downloads"></a> <a href="https://www.npmjs.com/package/@node-redis/json"><img src="https://img.shields.io/npm/v/@node-redis/json.svg" alt="Version"></a> <a href="https://oss.redis.com/redisjson/">Redis JSON</a> commands</td>
</tr>
<tr>
<td><a href="./packages/search">@node-redis/search</a></td>
<td><a href="https://www.npmjs.com/package/@node-redis/search"><img src="https://img.shields.io/npm/dm/@node-redis/search.svg" alt="Downloads"></a> <a href="https://www.npmjs.com/package/@node-redis/search"><img src="https://img.shields.io/npm/v/@node-redis/search.svg" alt="Version"></a> <a href="https://oss.redis.com/redisearch/">Redis Search</a> commands</td>
</tr>
</tbody>
</table>
<h2 id="贡献">贡献</h2>
<p>If you&rsquo;d like to contribute, check out the <a href="CONTRIBUTING.md">contributing guide</a>.</p>
<p>Thank you to all the people who already contributed to Node Redis!</p>
<p><a href="https://github.com/redis/node-redis/graphs/contributors"><img src="https://contrib.rocks/image?repo=redis/node-redis" alt="Contributors"></a></p>
<h2 id="证书">证书</h2>
<p>This repository is licensed under the &ldquo;MIT&rdquo; license. See <a href="LICENSE">LICENSE</a>.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Docsy Authors 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/docs/lua/about/">关于</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.7380160122c24d59789a168af05fcec445fe4e5f2069dd9f3a0c991f10269ae0.js" integrity="sha256-c4AWASLCTVl4mhaK8F/OxEX&#43;Tl8gad2fOgyZHxAmmuA=" crossorigin="anonymous"></script>




  </body>
</html>
