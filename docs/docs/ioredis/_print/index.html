<!doctype html>
<html lang="zh-cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<link rel="canonical" type="text/html" href="/docs/ioredis/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/ioredis/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>ioredis | redis 文档</title>
<meta name="description" content="
https://github.com/luin/ioredis










A robust, performance-focused and full-featured Redis client for Node.js.
Supports Redis &gt;= 2.6.12 and …">
<meta property="og:title" content="ioredis" />
<meta property="og:description" content="redis 文档" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/ioredis/" /><meta property="og:site_name" content="redis 文档" />

<meta itemprop="name" content="ioredis">
<meta itemprop="description" content="redis 文档"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ioredis"/>
<meta name="twitter:description" content="redis 文档"/>




<link rel="preload" href="/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" as="style">
<link href="/scss/main.min.90983698afafd407e6b72e83a2b749ff1726e8502277108f05bd66510938dec2.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-00000000-0', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="text-uppercase font-weight-bold">redis 文档</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>博客</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"><input type="search" class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label="站内搜索…" autocomplete="off">
</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
这是本节的多页打印视图。
<a href="#" onclick="print();return false;">点击此处打印</a>.
</p><p>
<a href="/docs/ioredis/">返回本页常规视图</a>.
</p>
</div>



<h1 class="title">ioredis</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-7dc15eb27b1a9435aa7d664e23fe3807">快速入门</a></li>


    
  
    
    
	
<li>2: <a href="#pg-ecde650262f1a1171dd464ff05b45476">连接</a></li>


    
  
    
    
	
<li>3: <a href="#pg-f69c80caa3d66b8aa309a605e9f3eac0">TLS</a></li>


    
  
    
    
	
<li>4: <a href="#pg-2343bd3dda769573f9bfbbd6acb0a7a0">流和二进制</a></li>


    
  
    
    
	
<li>5: <a href="#pg-cb6c8f83462149a16d76c4dd48656489">Lua 脚本</a></li>


    
  
    
    
	
<li>6: <a href="#pg-6b3e092823019df7e9d60d6a581cd606">Pipelining</a></li>


    
  
    
    
	
<li>7: <a href="#pg-10ea60f135a3f7ec97831781e6e8d908">Pub/Sub</a></li>


    
  
    
    
	
<li>8: <a href="#pg-2507e639715a46af5c576fcdae1ad5d5">Sentinel</a></li>


    
  
    
    
	
<li>9: <a href="#pg-01b6f9e61cef026000ac5289660fd21b">Cluster</a></li>


    
  

    </ul>


<div class="content">
      <blockquote>
<p><a href="https://github.com/luin/ioredis">https://github.com/luin/ioredis</a></p>
</blockquote>
<p><a href="https://github.com/luin/ioredis"><img src="https://cdn.jsdelivr.net/gh/luin/ioredis@b5e8c74/logo.svg" alt="ioredis"></a></p>
<p><a href="https://travis-ci.org/luin/ioredis"><img src="https://travis-ci.org/luin/ioredis.svg?branch=master" alt="Build Status"></a>
<a href="https://github.com/prettier/prettier"><img src="https://img.shields.io/badge/code_style-prettier-ff69b4.svg?style=flat-square" alt="code style: prettier"></a>
<a href="https://gitter.im/luin/ioredis?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://badges.gitter.im/Join%20Chat.svg" alt="Join the chat at https://gitter.im/luin/ioredis"></a>
<a href="http://commitizen.github.io/cz-cli/"><img src="https://img.shields.io/badge/commitizen-friendly-brightgreen.svg" alt="Commitizen friendly"></a>
<a href="https://github.com/semantic-release/semantic-release"><img src="https://img.shields.io/badge/%20%20%F0%9F%93%A6%F0%9F%9A%80-semantic--release-e10079.svg" alt="semantic-release"></a>
<a href="https://www.npmjs.com/package/ioredis"><img src="https://img.shields.io/npm/v/ioredis/latest.svg" alt="npm latest version"></a>
<a href="https://www.npmjs.com/package/ioredis"><img src="https://img.shields.io/npm/v/ioredis/next.svg" alt="npm next version"></a>
<img alt="" src=""></p>
<p>A robust, performance-focused and full-featured <a href="http://redis.io">Redis</a> client for <a href="https://nodejs.org">Node.js</a>.</p>
<p>Supports Redis &gt;= 2.6.12 and (Node.js &gt;= 6). Completely compatible with Redis 6.x.</p>
<h2 id="特性">特性</h2>
<p>ioredis is a robust, full-featured Redis client that is
used in the world&rsquo;s biggest online commerce company <a href="http://www.alibaba.com/">Alibaba</a> and many other awesome companies.</p>
<ol start="0">
<li>Full-featured. It supports <a href="http://redis.io/topics/cluster-tutorial">Cluster</a>, <a href="http://redis.io/topics/sentinel">Sentinel</a>, <a href="https://redis.io/topics/streams-intro">Streams</a>, <a href="http://redis.io/topics/pipelining">Pipelining</a> and of course <a href="http://redis.io/commands/eval">Lua scripting</a> &amp; <a href="http://redis.io/topics/pubsub">Pub/Sub</a> (with the support of binary messages).</li>
<li>High performance.</li>
<li>Delightful API. It works with Node callbacks and Native promises.</li>
<li>Transformation of command arguments and replies.</li>
<li>Transparent key prefixing.</li>
<li>Abstraction for Lua scripting, allowing you to define custom commands.</li>
<li>Support for binary data.</li>
<li>Support for TLS 🔒.</li>
<li>Support for offline queue and ready checking.</li>
<li>Support for ES6 types, such as <code>Map</code> and <code>Set</code>.</li>
<li>Support for GEO commands 📍.</li>
<li>Support for Redis ACL.</li>
<li>Sophisticated error handling strategy.</li>
<li>Support for NAT mapping.</li>
<li>Support for autopipelining</li>
</ol>
<h2 id="链接">链接</h2>
<ul>
<li><a href="API.md">API Documentation</a></li>
<li><a href="Changelog.md">Changelog</a></li>
<li><a href="https://github.com/luin/ioredis/wiki/Migrating-from-node_redis">Migrating from node_redis</a></li>
<li><a href="#error-handling">Error Handling</a></li>
</ul>
<hr>
<h2 id="赞助商">赞助商</h2>
<p><a href="https://github.com/sponsors/luin">Become a sponsor!</a></p>
<h4 id="upstash-serverless-database-for-redis">Upstash: Serverless Database for Redis</h4>
<p><a href="https://upstash.com/?utm_source=ioredis"><img align="right" width="320" src="resources/upstash.png" alt="Upstash"></a></p>
<p>Upstash is a Serverless Database with Redis/REST API and durable storage. It is the perfect database for your applications thanks to its per request pricing and low latency data.</p>
<p><a href="https://upstash.com/?utm_source=ioredis">Start for free in 30 seconds! </a></p>
<br clear="both"/>
<h4 id="medis-redis-gui-for-macos">Medis: Redis GUI for macOS</h4>
<p><a href="https://getmedis.com/"><img align="right" width="404" src="resources/medis.png" alt="Download on the App Store"></a></p>
<p>Looking for a Redis GUI for macOS, Windows and Linux? Here&rsquo;s <a href="https://getmedis.com/">Medis</a>!</p>
<p>Medis is an open-sourced, beautiful, easy-to-use Redis GUI management application.</p>
<p>Medis starts with all the basic features you need:</p>
<ul>
<li>Keys viewing/editing</li>
<li>SSH Tunnel for connecting with remote servers</li>
<li>Terminal for executing custom commands</li>
<li>And other awesome features&hellip;</li>
</ul>
<p><a href="https://github.com/luin/medis">Medis 1 is open sourced on GitHub</a></p>
<h4 id="kuber-kubernetes-dashboard-for-ios">Kuber: Kubernetes Dashboard for iOS</h4>
<p><a href="http://bit.ly/kuber-ios"><img src="resources/kuber.png" alt="Download on the App Store"></a></p>
<hr>
<h2 id="错误处理">错误处理</h2>
<p>All the errors returned by the Redis server are instances of <code>ReplyError</code>, which can be accessed via <code>Redis</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#8f5902;font-style:italic">// This command causes a reply error since the SET command requires two arguments.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReplyError</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>This is the error stack of the <code>ReplyError</code>:</p>
<pre tabindex="0"><code>ReplyError: ERR wrong number of arguments for 'set' command
    at ReplyParser._parseResult (/app/node_modules/ioredis/lib/parsers/javascript.js:60:14)
    at ReplyParser.execute (/app/node_modules/ioredis/lib/parsers/javascript.js:178:20)
    at Socket.&lt;anonymous&gt; (/app/node_modules/ioredis/lib/redis/event_handler.js:99:22)
    at Socket.emit (events.js:97:17)
    at readableAddChunk (_stream_readable.js:143:16)
    at Socket.Readable.push (_stream_readable.js:106:10)
    at TCP.onread (net.js:509:20)
</code></pre><p>By default, the error stack doesn&rsquo;t make any sense because the whole stack happens in the ioredis
module itself, not in your code. So it&rsquo;s not easy to find out where the error happens in your code.
ioredis provides an option <code>showFriendlyErrorStack</code> to solve the problem. When you enable
<code>showFriendlyErrorStack</code>, ioredis will optimize the error stack for you:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">showFriendlyErrorStack</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>And the output will be:</p>
<pre tabindex="0"><code>ReplyError: ERR wrong number of arguments for 'set' command
    at Object.&lt;anonymous&gt; (/app/index.js:3:7)
    at Module._compile (module.js:446:26)
    at Object.Module._extensions..js (module.js:464:10)
    at Module.load (module.js:341:32)
    at Function.Module._load (module.js:296:12)
    at Function.Module.runMain (module.js:487:10)
    at startup (node.js:111:16)
    at node.js:799:3
</code></pre><p>This time the stack tells you that the error happens on the third line in your code. Pretty sweet!
However, it would decrease the performance significantly to optimize the error stack. So by
default, this option is disabled and can only be used for debugging purposes. You <strong>shouldn&rsquo;t</strong> use this feature in a production environment.</p>
<h2 id="插入你自己的承诺库">插入你自己的承诺库</h2>
<p>If you&rsquo;re an advanced user, you may want to plug in your own promise library like <a href="https://www.npmjs.com/package/bluebird">bluebird</a>. Just set Redis.Promise to your favorite ES6-style promise constructor and ioredis will use it.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">Promise</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bluebird&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// Use bluebird
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bluebird&#34;</span><span style="color:#000;font-weight:bold">));</span>

<span style="color:#8f5902;font-style:italic">// You can change the Promise implementation at any time:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">Promise</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">global</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">constructor</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">global</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h2 id="运行测试">运行测试</h2>
<p>Start a Redis server on 127.0.0.1:6379, and then:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ npm <span style="color:#204a87">test</span>
</code></pre></div><p><code>FLUSH ALL</code> will be invoked after each test, so make sure there&rsquo;s no valuable data in it before running tests.</p>
<p>If your testing environment does not let you spin up a Redis server <a href="https://github.com/stipsan/ioredis-mock">ioredis-mock</a> is a drop-in replacement you can use in your tests. It aims to behave identically to ioredis connected to a Redis server so that your integration tests is easier to write and of better quality.</p>
<h2 id="调试">调试</h2>
<p>You can set the <code>DEBUG</code> env to <code>ioredis:*</code> to print debug info:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ <span style="color:#000">DEBUG</span><span style="color:#ce5c00;font-weight:bold">=</span>ioredis:* node app.js
</code></pre></div><h2 id="加入">加入!</h2>
<p>I&rsquo;m happy to receive bug reports, fixes, documentation enhancements, and any other improvements.</p>
<p>And since I&rsquo;m not a native English speaker, if you find any grammar mistakes in the documentation, please also let me know. :)</p>
<h2 id="成为一个赞助商">成为一个赞助商</h2>
<p>Open source is hard and time-consuming. If you want to invest in ioredis&rsquo;s future you can become a sponsor and make us spend more time on this library&rsquo;s improvements and new features.</p>
<p><a href="https://opencollective.com/ioredis"><img src="https://opencollective.com/ioredis/tiers/sponsor.svg?avatarHeight=36"></a></p>
<p>Thank you for using ioredis :-)</p>
<h2 id="贡献者">贡献者</h2>
<p>这个项目的存在要感谢所有做出贡献的人:</p>
<p><a href="https://github.com/luin/ioredis/graphs/contributors"><img src="https://opencollective.com/ioredis/contributors.svg?width=890&showBtn=false" /></a></p>
<h2 id="许可证">许可证</h2>
<p>MIT</p>
<p><a href="https://app.fossa.io/projects/git%2Bgithub.com%2Fluin%2Fioredis?ref=badge_large"><img src="https://app.fossa.io/api/projects/git%2Bgithub.com%2Fluin%2Fioredis.svg?type=large" alt="FOSSA Status"></a></p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7dc15eb27b1a9435aa7d664e23fe3807">1 - 快速入门</h1>
    
	<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ npm install ioredis
</code></pre></div><h2 id="基本用法">基本用法</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#8f5902;font-style:italic">// uses defaults unless given configuration object
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// ioredis supports all Redis commands:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// returns promise which resolves to string, &#34;OK&#34;
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// the format is: redis[SOME_REDIS_COMMAND_IN_LOWERCASE](ARGUMENTS_ARE_JOINED_INTO_COMMAND_STRING)
</span><span style="color:#8f5902;font-style:italic">// the js: ` redis.set(&#34;mykey&#34;, &#34;Hello&#34;) ` is equivalent to the cli: ` redis&gt; SET mykey &#34;Hello&#34; `
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// ioredis supports the node.js callback style
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Promise resolves to &#34;bar&#34;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Or ioredis returns a promise if the last argument isn&#39;t a function
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Prints &#34;bar&#34;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Most responses are strings, or arrays of strings
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zadd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sortedSet&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;one&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;dos&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;quatro&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;three&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">zrange</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sortedSet&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;WITHSCORES&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">));</span> <span style="color:#8f5902;font-style:italic">// Promise resolves to [&#34;one&#34;, &#34;1&#34;, &#34;dos&#34;, &#34;2&#34;, &#34;three&#34;, &#34;3&#34;] as if the command was ` redis&gt; ZRANGE sortedSet 0 2 WITHSCORES `
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#8f5902;font-style:italic">// All arguments are passed directly to the redis server:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;key&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;EX&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>See the <code>examples/</code> folder for more examples.</p>
<h2 id="transparent-key-prefixing">Transparent Key Prefixing</h2>
<p>This feature allows you to specify a string that will automatically be prepended
to all the keys in a command, which makes it easier to manage your key
namespaces.</p>
<p><strong>Warning</strong> This feature won&rsquo;t apply to commands like <a href="http://redis.io/commands/KEYS">KEYS</a> and <a href="http://redis.io/commands/scan">SCAN</a> that take patterns rather than actual keys(<a href="https://github.com/luin/ioredis/issues/239">#239</a>),
and this feature also won&rsquo;t apply to the replies of commands even if they are key names (<a href="https://github.com/luin/ioredis/issues/325">#325</a>).</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">fooRedis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">keyPrefix</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;foo:&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">fooRedis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;baz&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// Actually sends SET foo:bar baz
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#000">fooRedis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defineCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;echo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">numberOfKeys</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Works well with pipelining/transaction
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fooRedis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#8f5902;font-style:italic">// Sends SORT foo:list BY foo:weight_*-&gt;fieldname
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;list&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;BY&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;weight_*-&gt;fieldname&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#8f5902;font-style:italic">// Supports custom commands
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Sends EVALSHA xxx foo:k1 foo:k2 a1 a2
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a2&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><h2 id="transforming-arguments--replies">Transforming Arguments &amp; Replies</h2>
<p>Most Redis commands take one or more Strings as arguments,
and replies are sent back as a single String or an Array of Strings. However, sometimes
you may want something different. For instance, it would be more convenient if the <code>HGETALL</code>
command returns a hash (e.g. <code>{ key: val1, key2: v2 }</code>) rather than an array of key values (e.g. <code>[key1, val1, key2, val2]</code>).</p>
<p>ioredis has a flexible system for transforming arguments and replies. There are two types
of transformers, argument transformer and reply transformer:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Here&#39;s the built-in argument transformer converting
</span><span style="color:#8f5902;font-style:italic">// hmset(&#39;key&#39;, { k1: &#39;v1&#39;, k2: &#39;v2&#39; })
</span><span style="color:#8f5902;font-style:italic">// or
</span><span style="color:#8f5902;font-style:italic">// hmset(&#39;key&#39;, new Map([[&#39;k1&#39;, &#39;v1&#39;], [&#39;k2&#39;, &#39;v2&#39;]]))
</span><span style="color:#8f5902;font-style:italic">// into
</span><span style="color:#8f5902;font-style:italic">// hmset(&#39;key&#39;, &#39;k1&#39;, &#39;v1&#39;, &#39;k2&#39;, &#39;v2&#39;)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setArgumentTransformer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hmset&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">Map</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#4e9a06">&#34;undefined&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#204a87;font-weight:bold">instanceof</span> <span style="color:#000">Map</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// utils is a internal module of ioredis
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]].</span><span style="color:#000">concat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">utils</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">convertMapToArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]));</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">typeof</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;object&#34;</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">!==</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]].</span><span style="color:#000">concat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">utils</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">convertObjectToArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]));</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Here&#39;s the built-in reply transformer converting the HGETALL reply
</span><span style="color:#8f5902;font-style:italic">// [&#39;k1&#39;, &#39;v1&#39;, &#39;k2&#39;, &#39;v2&#39;]
</span><span style="color:#8f5902;font-style:italic">// into
</span><span style="color:#8f5902;font-style:italic">// { k1: &#39;v1&#39;, &#39;k2&#39;: &#39;v2&#39; }
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setReplyTransformer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hgetall&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Array</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isArray</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">obj</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{};</span>
    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>There are three built-in transformers, two argument transformers for <code>hmset</code> &amp; <code>mset</code> and
a reply transformer for <code>hgetall</code>. Transformers for <code>hmset</code> and <code>hgetall</code> were mentioned
above, and the transformer for <code>mset</code> is similar to the one for <code>hmset</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mset</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">k1</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;v1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k2</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;v2&#34;</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === &#39;v1&#39;;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mset</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Map</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;k3&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;v3&#34;</span><span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;k4&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;v4&#34;</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">])</span>
<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k3&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === &#39;v3&#39;;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Another useful example of a reply transformer is one that changes <code>hgetall</code> to return array of arrays instead of objects which avoids an unwanted conversation of hash keys to strings when dealing with binary hash keys:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">setReplyTransformer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hgetall&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">arr</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[];</span>
  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push</span><span style="color:#000;font-weight:bold">([</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]]);</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;h1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">([</span><span style="color:#0000cf;font-weight:bold">0x01</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">([</span><span style="color:#0000cf;font-weight:bold">0x02</span><span style="color:#000;font-weight:bold">]));</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;h1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">([</span><span style="color:#0000cf;font-weight:bold">0x03</span><span style="color:#000;font-weight:bold">]),</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">([</span><span style="color:#0000cf;font-weight:bold">0x04</span><span style="color:#000;font-weight:bold">]));</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hgetallBuffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;h1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === [ [ &lt;Buffer 01&gt;, &lt;Buffer 02&gt; ], [ &lt;Buffer 03&gt;, &lt;Buffer 04&gt; ] ];
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="监控">监控</h2>
<p>Redis supports the MONITOR command,
which lets you see all commands received by the Redis server across all client connections,
including from other client libraries and other computers.</p>
<p>The <code>monitor</code> method returns a monitor instance.
After you send the MONITOR command, no other commands are valid on that connection. ioredis will emit a monitor event for every new monitor message that comes across.
The callback for the monitor event takes a timestamp from the Redis server and an array of command arguments.</p>
<p>Here is a simple example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;monitor&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">source</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">database</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Here is another example illustrating an <code>async</code> function and <code>monitor.disconnect()</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">async</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">monitor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;monitor&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#8f5902;font-style:italic">// Any other tasks
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">monitor</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">disconnect</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">};</span>
</code></pre></div><h2 id="streamify-scanning">Streamify Scanning</h2>
<p>Redis 2.8 added the <code>SCAN</code> command to incrementally iterate through the keys in the database.
It&rsquo;s different from <code>KEYS</code> in that <code>SCAN</code> only returns a small number of elements each call,
so it can be used in production without the downside of blocking the server for a long time.
However, it requires recording the cursor on the client side each time
the <code>SCAN</code> command is called in order to iterate through all the keys correctly. Since it&rsquo;s a relatively common use case, ioredis
provides a streaming interface for the <code>SCAN</code> command to make things much easier. A readable stream can be created by calling <code>scanStream</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#8f5902;font-style:italic">// Create a readable stream (object mode)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stream</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scanStream</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;data&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">resultKeys</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `resultKeys` is an array of strings representing key names.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Note that resultKeys may contain 0 keys, and that it will sometimes
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// contain duplicates due to SCAN&#39;s implementation in Redis.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">resultKeys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resultKeys</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;end&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;all keys have been visited&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p><code>scanStream</code> accepts an option, with which you can specify the <code>MATCH</code> pattern, the <code>TYPE</code> filter, and the <code>COUNT</code> argument:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stream</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scanStream</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#8f5902;font-style:italic">// only returns keys following the pattern of `user:*`
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">match</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user:*&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#8f5902;font-style:italic">// only return objects that match a given type,
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// (requires Redis &gt;= 6.0)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">type</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;zset&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#8f5902;font-style:italic">// returns approximately 100 elements per call
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">count</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Just like other commands, <code>scanStream</code> has a binary version <code>scanBufferStream</code>, which returns an array of buffers. It&rsquo;s useful when
the key names are not utf8 strings.</p>
<p>There are also <code>hscanStream</code>, <code>zscanStream</code> and <code>sscanStream</code> to iterate through elements in a hash, zset and set. The interface of each is
similar to <code>scanStream</code> except the first argument is the key name:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stream</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hscanStream</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;myhash&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">match</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;age:??&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>You can learn more from the <a href="http://redis.io/commands/scan">Redis documentation</a>.</p>
<p><strong>Useful Tips</strong>
It&rsquo;s pretty common that doing an async task in the <code>data</code> handler. We&rsquo;d like the scanning process to be paused until the async task to be finished. <code>Stream#pause()</code> and <code>Stream#resume()</code> do the trick. For example if we want to migrate data in Redis to MySQL:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">stream</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">scanStream</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;data&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">resultKeys</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// Pause the stream from scanning more keys until we&#39;ve migrated the current keys.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pause</span><span style="color:#000;font-weight:bold">();</span>

  <span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resultKeys</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">migrateKeyToMySQL</span><span style="color:#000;font-weight:bold">)).</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Resume the stream here.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">resume</span><span style="color:#000;font-weight:bold">();</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">stream</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;end&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;done migration&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h2 id="离线队列">离线队列</h2>
<p>When a command can&rsquo;t be processed by Redis (being sent before the <code>ready</code> event), by default, it&rsquo;s added to the offline queue and will be
executed when it can be processed. You can disable this feature by setting the <code>enableOfflineQueue</code>
option to <code>false</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">enableOfflineQueue</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">});</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ecde650262f1a1171dd464ff05b45476">2 - 连接</h1>
    
	<h2 id="连接到-redis">连接到 Redis</h2>
<p>When a new <code>Redis</code> instance is created, a connection to Redis will be created at the same time.
You can specify which Redis to connect to by:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#8f5902;font-style:italic">// Connect to 127.0.0.1:6379
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6380</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// 127.0.0.1:6380
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;192.168.1.1&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// 192.168.1.1:6379
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/tmp/redis.sock&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis port
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Redis host
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">family</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// 4 (IPv4) or 6 (IPv6)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;auth&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>You can also specify connection options as a <a href="http://www.iana.org/assignments/uri-schemes/prov/redis"><code>redis://</code> URL</a> or <a href="https://www.iana.org/assignments/uri-schemes/prov/rediss"><code>rediss://</code> URL</a> when using <a href="#tls-options">TLS encryption</a>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// Connect to 127.0.0.1:6380, db 4, using password &#34;authpassword&#34;:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;redis://:authpassword@127.0.0.1:6380/4&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#8f5902;font-style:italic">// Username can also be passed via URI.
</span><span style="color:#8f5902;font-style:italic">// It&#39;s worth to noticing that for compatibility reasons `allowUsernameInURI`
</span><span style="color:#8f5902;font-style:italic">// need to be provided, otherwise the username part will be ignored.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#4e9a06">&#34;redis://username:authpassword@127.0.0.1:6380/4?allowUsernameInURI=true&#34;</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>See <a href="API.md#new_Redis">API Documentation</a> for all available options.</p>
<h2 id="自动连接">自动连接</h2>
<p>By default, ioredis will try to reconnect when the connection to Redis is lost except when the connection is closed manually by <code>redis.disconnect()</code> or <code>redis.quit()</code>.</p>
<p>It&rsquo;s very flexible to control how long to wait to reconnect after disconnection using the <code>retryStrategy</code> option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#8f5902;font-style:italic">// This is the default value of `retryStrategy`
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">retryStrategy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">delay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">50</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">delay</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p><code>retryStrategy</code> is a function that will be called when the connection is lost.
The argument <code>times</code> means this is the nth reconnection being made and
the return value represents how long (in ms) to wait to reconnect. When the
return value isn&rsquo;t a number, ioredis will stop trying to reconnect, and the connection
will be lost forever if the user doesn&rsquo;t call <code>redis.connect()</code> manually.</p>
<p>When reconnected, the client will auto subscribe to channels that the previous connection subscribed to.
This behavior can be disabled by setting the <code>autoResubscribe</code> option to <code>false</code>.</p>
<p>And if the previous connection has some unfulfilled commands (most likely blocking commands such as <code>brpop</code> and <code>blpop</code>),
the client will resend them when reconnected. This behavior can be disabled by setting the <code>autoResendUnfulfilledCommands</code> option to <code>false</code>.</p>
<p>By default, all pending commands will be flushed with an error every 20 retry attempts. That makes sure commands won&rsquo;t wait forever when the connection is down. You can change this behavior by setting <code>maxRetriesPerRequest</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">maxRetriesPerRequest</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Set maxRetriesPerRequest to <code>null</code> to disable this behavior, and every command will wait forever until the connection is alive again (which is the default behavior before ioredis v4).</p>
<h3 id="reconnect-on-error">Reconnect on error</h3>
<p>Besides auto-reconnect when the connection is closed, ioredis supports reconnecting on certain Redis errors using the <code>reconnectOnError</code> option. Here&rsquo;s an example that will reconnect when receiving <code>READONLY</code> error:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">reconnectOnError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">targetError</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;READONLY&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">includes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">targetError</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// Only reconnect when the error contains &#34;READONLY&#34;
</span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// or `return 1;`
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>This feature is useful when using Amazon ElastiCache instances with Auto-failover disabled. On these instances, test your <code>reconnectOnError</code> handler by manually promoting the replica node to the primary role using the AWS console. The following writes fail with the error <code>READONLY</code>. Using <code>reconnectOnError</code>, we can force the connection to reconnect on this error in order to connect to the new master. Furthermore, if the <code>reconnectOnError</code> returns <code>2</code>, ioredis will resend the failed command after reconnecting.</p>
<p>On ElastiCache instances with Auto-failover enabled, <code>reconnectOnError</code> does not execute. Instead of returning a Redis error, AWS closes all connections to the master endpoint until the new primary node is ready. ioredis reconnects via <code>retryStrategy</code> instead of <code>reconnectOnError</code> after about a minute. On ElastiCache instances with Auto-failover enabled, test failover events with the <code>Failover primary</code> option in the AWS console.</p>
<h2 id="connection-events">Connection Events</h2>
<p>The Redis instance will emit some events about the state of the connection to the Redis server.</p>
<table>
<thead>
<tr>
<th style="text-align:left">Event</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">connect</td>
<td style="text-align:left">emits when a connection is established to the Redis server.</td>
</tr>
<tr>
<td style="text-align:left">ready</td>
<td style="text-align:left">If <code>enableReadyCheck</code> is <code>true</code>, client will emit <code>ready</code> when the server reports that it is ready to receive commands (e.g. finish loading data from disk).<br>Otherwise, <code>ready</code> will be emitted immediately right after the <code>connect</code> event.</td>
</tr>
<tr>
<td style="text-align:left">error</td>
<td style="text-align:left">emits when an error occurs while connecting.<br>However, ioredis emits all <code>error</code> events silently (only emits when there&rsquo;s at least one listener) so that your application won&rsquo;t crash if you&rsquo;re not listening to the <code>error</code> event.</td>
</tr>
<tr>
<td style="text-align:left">close</td>
<td style="text-align:left">emits when an established Redis server connection has closed.</td>
</tr>
<tr>
<td style="text-align:left">reconnecting</td>
<td style="text-align:left">emits after <code>close</code> when a reconnection will be made. The argument of the event is the time (in ms) before reconnecting.</td>
</tr>
<tr>
<td style="text-align:left">end</td>
<td style="text-align:left">emits after <code>close</code> when no more reconnections will be made, or the connection is failed to establish.</td>
</tr>
<tr>
<td style="text-align:left">wait</td>
<td style="text-align:left">emits when <code>lazyConnect</code> is set and will wait for the first command to be called before connecting.</td>
</tr>
</tbody>
</table>
<p>You can also check out the <code>Redis#status</code> property to get the current connection status.</p>
<p>Besides the above connection events, there are several other custom events:</p>
<table>
<thead>
<tr>
<th style="text-align:left">Event</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">select</td>
<td style="text-align:left">emits when the database changed. The argument is the new db number.</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f69c80caa3d66b8aa309a605e9f3eac0">3 - TLS</h1>
    
	<h2 id="tls-选项">TLS 选项</h2>
<p>Redis doesn&rsquo;t support TLS natively, however if the redis server you want to connect to is hosted behind a TLS proxy (e.g. <a href="https://www.stunnel.org/">stunnel</a>) or is offered by a PaaS service that supports TLS connection (e.g. <a href="https://redis.com/">Redis.com</a>), you can set the <code>tls</code> option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">tls</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Refer to `tls.connect()` section in
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// https://nodejs.org/api/tls.html
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// for all supported options
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">ca</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">fs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">readFileSync</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cert.pem&#34;</span><span style="color:#000;font-weight:bold">),</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Alternatively, specify the connection through a <a href="https://www.iana.org/assignments/uri-schemes/prov/rediss"><code>rediss://</code> URL</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;rediss://redis.my-service.com&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="tls-配置文件">TLS 配置文件</h3>
<p>To make it easier to configure we provide a few pre-configured TLS profiles that can be specified by setting the <code>tls</code> option to the profile&rsquo;s name or specifying a <code>tls.profile</code> option in case you need to customize some values of the profile.</p>
<p>Profiles:</p>
<ul>
<li><code>RedisCloudFixed</code>: Contains the CA for <a href="https://redis.com/">Redis.com</a> Cloud fixed subscriptions</li>
<li><code>RedisCloudFlexible</code>: Contains the CA for <a href="https://redis.com/">Redis.com</a> Cloud flexible subscriptions</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">tls</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RedisCloudFixed&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redisWithClientCertificate</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">tls</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">profile</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;RedisCloudFixed&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;123&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><hr>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2343bd3dda769573f9bfbbd6acb0a7a0">4 - 流和二进制</h1>
    
	<h2 id="流">流</h2>
<p>Redis v5 introduces a new data type called streams. It doubles as a communication channel for building streaming architectures and as a log-like data structure for persisting data. With ioredis, the usage can be pretty straightforward. Say we have a producer publishes messages to a stream with <code>redis.xadd(&quot;mystream&quot;, &quot;*&quot;, &quot;randomValue&quot;, Math.random())</code> (You may find the <a href="https://redis.io/topics/streams-intro">official documentation of Streams</a> as a starter to understand the parameters used), to consume the messages, we&rsquo;ll have a consumer with the following code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">processMessage</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Id: %s. Data: %O&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#204a87;font-weight:bold">async</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000">listenForMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">lastId</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;$&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `results` is an array, each element of which corresponds to a key.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Because we only listen to one key (mystream) here, `results` only contains
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// a single element. See more: https://redis.io/commands/xread#return-value
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">results</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">xread</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;block&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;STREAMS&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;mystream&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastId</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">messages</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#8f5902;font-style:italic">// `key` equals to &#34;mystream&#34;
</span><span style="color:#8f5902;font-style:italic"></span>
  <span style="color:#000">messages</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">forEach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">processMessage</span><span style="color:#000;font-weight:bold">);</span>

  <span style="color:#8f5902;font-style:italic">// Pass the last id of the results to the next round.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">await</span> <span style="color:#000">listenForMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">messages</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">messages</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]);</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#000">listenForMessage</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><h2 id="操作二进制文件">操作二进制文件</h2>
<p>Arguments can be buffers:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">from</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">));</span>
</code></pre></div><p>And every command has a method that returns a Buffer (by adding a suffix of &ldquo;Buffer&rdquo; to the command name).
To get a buffer instead of a utf8 string:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">getBuffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result is a buffer.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cb6c8f83462149a16d76c4dd48656489">5 - Lua 脚本</h1>
    
	<p>ioredis supports all of the scripting commands such as <code>EVAL</code>, <code>EVALSHA</code> and <code>SCRIPT</code>.
However, it&rsquo;s tedious to use in real world scenarios since developers have to take
care of script caching and to detect when to use <code>EVAL</code> and when to use <code>EVALSHA</code>.
ioredis exposes a <code>defineCommand</code> method to make scripting much easier to use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#8f5902;font-style:italic">// This will define a command echo:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defineCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;echo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">numberOfKeys</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Now `echo` can be used just like any other ordinary command,
</span><span style="color:#8f5902;font-style:italic">// and ioredis will try to use `EVALSHA` internally when possible for better performance.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === [&#39;k1&#39;, &#39;k2&#39;, &#39;a1&#39;, &#39;a2&#39;]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// `echoBuffer` is also defined automatically to return buffers instead of strings:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">echoBuffer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result[0] equals to Buffer.from(&#39;k1&#39;);
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// And of course it works with pipeline:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a2&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>If the number of keys can&rsquo;t be determined when defining a command, you can
omit the <code>numberOfKeys</code> property and pass the number of keys as the first argument
when you call the command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">defineCommand</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;echoDynamicKeyNumber&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">lua</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// Now you have to pass the number of keys as the first argument every time
</span><span style="color:#8f5902;font-style:italic">// you invoke the `echoDynamicKeyNumber` command:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">echoDynamicKeyNumber</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;k2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;a2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === [&#39;k1&#39;, &#39;k2&#39;, &#39;a1&#39;, &#39;a2&#39;]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6b3e092823019df7e9d60d6a581cd606">6 - Pipelining</h1>
    
	<h2 id="pipelining">Pipelining</h2>
<p>If you want to send a batch of commands (e.g. &gt; 5), you can use pipelining to queue
the commands in memory and then send them to Redis all at once. This way the performance improves by 50%~300% (See <a href="#benchmarks">benchmark section</a>).</p>
<p><code>redis.pipeline()</code> creates a <code>Pipeline</code> instance. You can call any Redis
commands on it just like the <code>Redis</code> instance. The commands are queued in memory
and flushed to Redis by calling the <code>exec</code> method:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">pipeline</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `err` is always null, and `results` is an array of responses
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// corresponding to the sequence of queued commands.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// Each response follows the format `[err, result]`.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// You can even chain the commands:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">del</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cc&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>

<span style="color:#8f5902;font-style:italic">// `exec` also returns a Promise:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">promise</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000">promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === [[null, &#39;OK&#39;], [null, &#39;bar&#39;]]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Each chained command can also have a callback, which will be invoked when the command
gets a reply:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// result === &#39;bar&#39;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// result[1][1] === &#39;bar&#39;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>In addition to adding commands to the <code>pipeline</code> queue individually, you can also pass an array of commands and arguments to the constructor:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;set&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">])</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/* ... */</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p><code>#length</code> property shows how many commands in the pipeline:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#8f5902;font-style:italic">// length === 2
</span></code></pre></div><h2 id="transaction">Transaction</h2>
<p>Most of the time, the transaction commands <code>multi</code> &amp; <code>exec</code> are used together with pipeline.
Therefore, when <code>multi</code> is called, a <code>Pipeline</code> instance is created automatically by default,
so you can use <code>multi</code> just like <code>pipeline</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// results === [[null, &#39;OK&#39;], [null, &#39;bar&#39;]]
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>If there&rsquo;s a syntax error in the transaction&rsquo;s command chain (e.g. wrong number of arguments, wrong command name, etc),
then none of the commands would be executed, and an error is returned:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;new value&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">results</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// err:
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//  { [ReplyError: EXECABORT Transaction discarded because of previous errors.]
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//    name: &#39;ReplyError&#39;,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//    message: &#39;EXECABORT Transaction discarded because of previous errors.&#39;,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//    command: { name: &#39;exec&#39;, args: [] },
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//    previousErrors:
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//     [ { [ReplyError: ERR wrong number of arguments for &#39;set&#39; command]
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//         name: &#39;ReplyError&#39;,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//         message: &#39;ERR wrong number of arguments for \&#39;set\&#39; command&#39;,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//         command: [Object] } ] }
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>In terms of the interface, <code>multi</code> differs from <code>pipeline</code> in that when specifying a callback
to each chained command, the queueing state is passed to the callback instead of the result of the command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// result === &#39;QUEUED&#39;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">})</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>If you want to use transaction without pipeline, pass <code>{ pipeline: false }</code> to <code>multi</code>,
and every command will be sent to Redis immediately without waiting for an <code>exec</code> invocation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">pipeline</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">false</span> <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// result === [[null, &#39;OK&#39;], [null, &#39;bar&#39;]]
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>The constructor of <code>multi</code> also accepts a batch of commands:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">([</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;set&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">],</span>
    <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;get&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">])</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">/* ... */</span>
  <span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Inline transactions are supported by pipeline, which means you can group a subset of commands
in the pipeline into a transaction:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">pipeline</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">multi</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">()</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">)</span>
  <span style="color:#000;font-weight:bold">.</span><span style="color:#000">exec</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><hr>
<h2 id="autopipelining">Autopipelining</h2>
<p>In standard mode, when you issue multiple commands, ioredis sends them to the server one by one. As described in Redis pipeline documentation, this is a suboptimal use of the network link, especially when such link is not very performant.</p>
<p>The TCP and network overhead negatively affects performance. Commands are stuck in the send queue until the previous ones are correctly delivered to the server. This is a problem known as Head-Of-Line blocking (HOL).</p>
<p>ioredis supports a feature called “auto pipelining”. It can be enabled by setting the option <code>enableAutoPipelining</code> to <code>true</code>. No other code change is necessary.</p>
<p>In auto pipelining mode, all commands issued during an event loop are enqueued in a pipeline automatically managed by ioredis. At the end of the iteration, the pipeline is executed and thus all commands are sent to the server at the same time.</p>
<p>This feature can dramatically improve throughput and avoids HOL blocking. In our benchmarks, the improvement was between 35% and 50%.</p>
<p>While an automatic pipeline is executing, all new commands will be enqueued in a new pipeline which will be executed as soon as the previous finishes.</p>
<p>When using Redis Cluster, one pipeline per node is created. Commands are assigned to pipelines according to which node serves the slot.</p>
<p>A pipeline will thus contain commands using different slots but that ultimately are assigned to the same node.</p>
<p>Note that the same slot limitation within a single command still holds, as it is a Redis limitation.</p>
<h3 id="example-of-automatic-pipeline-enqueuing">Example of automatic pipeline enqueuing</h3>
<p>This sample code uses ioredis with automatic pipeline enabled.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;./built&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">http</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;http&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">db</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span> <span style="color:#000">enableAutoPipelining</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">});</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">createServer</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">response</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">URL</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;https://localhost:3000/&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">searchParams</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span>
    <span style="color:#4e9a06">&#34;key&#34;</span>
  <span style="color:#000;font-weight:bold">);</span>

  <span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">writeHead</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">200</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;Content-Type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text/plain&#34;</span> <span style="color:#000;font-weight:bold">});</span>
    <span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">});</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3000</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>When Node receives requests, it schedules them to be processed in one or more iterations of the events loop.</p>
<p>All commands issued by requests processing during one iteration of the loop will be wrapped in a pipeline automatically created by ioredis.</p>
<p>In the example above, the pipeline will have the following contents:</p>
<pre tabindex="0"><code>GET key1
GET key2
GET key3
...
GET keyN
</code></pre><p>When all events in the current loop have been processed, the pipeline is executed and thus all commands are sent to the server at the same time.</p>
<p>While waiting for pipeline response from Redis, Node will still be able to process requests. All commands issued by request handler will be enqueued in a new automatically created pipeline. This pipeline will not be sent to the server yet.</p>
<p>As soon as a previous automatic pipeline has received all responses from the server, the new pipeline is immediately sent without waiting for the events loop iteration to finish.</p>
<p>This approach increases the utilization of the network link, reduces the TCP overhead and idle times and therefore improves throughput.</p>
<h3 id="benchmarks">Benchmarks</h3>
<p>Here&rsquo;s some of the results of our tests for a single node.</p>
<p>Each iteration of the test runs 1000 random commands on the server.</p>
<table>
<thead>
<tr>
<th></th>
<th>Samples</th>
<th>Result</th>
<th>Tolerance</th>
</tr>
</thead>
<tbody>
<tr>
<td>default</td>
<td>1000</td>
<td>174.62 op/sec</td>
<td>± 0.45 %</td>
</tr>
<tr>
<td>enableAutoPipelining=true</td>
<td>1500</td>
<td>233.33 op/sec</td>
<td>± 0.88 %</td>
</tr>
</tbody>
</table>
<p>And here&rsquo;s the same test for a cluster of 3 masters and 3 replicas:</p>
<table>
<thead>
<tr>
<th></th>
<th>Samples</th>
<th>Result</th>
<th>Tolerance</th>
</tr>
</thead>
<tbody>
<tr>
<td>default</td>
<td>1000</td>
<td>164.05 op/sec</td>
<td>± 0.42 %</td>
</tr>
<tr>
<td>enableAutoPipelining=true</td>
<td>3000</td>
<td>235.31 op/sec</td>
<td>± 0.94 %</td>
</tr>
</tbody>
</table>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-10ea60f135a3f7ec97831781e6e8d908">7 - Pub/Sub</h1>
    
	<p>Redis provides several commands for developers to implement the <a href="https://en.wikipedia.org/wiki/Publish%E2%80%93subscribe_pattern">Publish–subscribe pattern</a>. There are two roles in this pattern: publisher and subscriber. Publishers are not programmed to send their messages to specific subscribers. Rather, published messages are characterized into channels, without knowledge of what (if any) subscribers there may be.</p>
<p>By leveraging Node.js&rsquo;s built-in events module, ioredis makes pub/sub very straightforward to use. Below is a simple example that consists of two files, one is publisher.js that publishes messages to a channel, the other is subscriber.js that listens for messages on specific channels.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// publisher.js
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">setInterval</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">};</span>
  <span style="color:#8f5902;font-style:italic">// Publish to my-channel-1 or my-channel-2 randomly.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">channel</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">`my-channel-</span><span style="color:#4e9a06">${</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">round</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">random</span><span style="color:#000;font-weight:bold">())</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#8f5902;font-style:italic">// Message can be either a string or a buffer
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">JSON</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">stringify</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">));</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Published %s to %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// subscriber.js
</span><span style="color:#8f5902;font-style:italic"></span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;my-channel-1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;my-channel-2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// Just like other commands, subscribe() can fail for some reasons,
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// ex network issues.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Failed to subscribe: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// `count` represents the number of channels this client are currently subscribed to.
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span>
      <span style="color:#4e9a06">`Subscribed successfully! This client is currently subscribed to </span><span style="color:#4e9a06">${</span><span style="color:#000">count</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> channels.`</span>
    <span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`Received </span><span style="color:#4e9a06">${</span><span style="color:#000">message</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> from </span><span style="color:#4e9a06">${</span><span style="color:#000">channel</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#8f5902;font-style:italic">// There&#39;s also an event called &#39;messageBuffer&#39;, which is the same as &#39;message&#39; except
</span><span style="color:#8f5902;font-style:italic">// it returns buffers instead of strings.
</span><span style="color:#8f5902;font-style:italic">// It&#39;s useful when the messages are binary data.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;messageBuffer&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// Both `channel` and `message` are buffers.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>It worth noticing that a connection (aka <code>Redis</code> instance) can&rsquo;t play both roles together. More specifically, when a client issues <code>subscribe()</code> or <code>psubscribe()</code>, it enters the &ldquo;subscriber&rdquo; mode. From that point, only commands that modify the subscription set are valid. Namely, they are: <code>subscribe</code>, <code>psubscribe</code>, <code>unsubscribe</code>, <code>punsubscribe</code>, <code>ping</code>, and <code>quit</code>. When the subscription set is empty (via <code>unsubscribe</code>/<code>punsubscribe</code>), the connection is put back into the regular mode.</p>
<p>If you want to do pub/sub in the same file/process, you should create a separate connection:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sub</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">pub</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000">sub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// From now, `sub` enters the subscriber mode.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">sub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;message&#34;</span> <span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#000">setInterval</span><span style="color:#000;font-weight:bold">(()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// `pub` can be used to publish messages, or send other regular commands (e.g. `hgetall`)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// because it&#39;s not in the subscriber mode.
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">pub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">/* ... */</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">},</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p><code>PSUBSCRIBE</code> is also supported in a similar way when you want to subscribe all channels whose name matches a pattern:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">psubscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pat?ern&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>

<span style="color:#8f5902;font-style:italic">// Event names are &#34;pmessage&#34;/&#34;pmessageBuffer&#34; instead of &#34;message/messageBuffer&#34;.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pmessage&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>
<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pmessageBuffer&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pattern</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{});</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2507e639715a46af5c576fcdae1ad5d5">8 - Sentinel</h1>
    
	<p>ioredis supports Sentinel out of the box. It works transparently as all features that work when
you connect to a single node also work when you connect to a sentinel group. Make sure to run Redis &gt;= 2.8.12 if you want to use this feature. Sentinels have a default port of 26379.</p>
<p>To connect using Sentinel, use:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">sentinels</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">26379</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">26380</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;mymaster&#34;</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The arguments passed to the constructor are different from the ones you use to connect to a single node, where:</p>
<ul>
<li><code>name</code> identifies a group of Redis instances composed of a master and one or more slaves (<code>mymaster</code> in the example);</li>
<li><code>sentinelPassword</code> (optional) password for Sentinel instances.</li>
<li><code>sentinels</code> are a list of sentinels to connect to. The list does not need to enumerate all your sentinel instances, but a few so that if one is down the client will try the next one.</li>
<li><code>role</code> (optional) with a value of <code>slave</code> will return a random slave from the Sentinel group.</li>
<li><code>preferredSlaves</code> (optional) can be used to prefer a particular slave or set of slaves based on priority. It accepts a function or array.</li>
<li><code>enableTLSForSentinelMode</code> (optional) set to true if connecting to sentinel instances that are encrypted</li>
</ul>
<p>ioredis <strong>guarantees</strong> that the node you connected to is always a master even after a failover. When a failover happens, instead of trying to reconnect to the failed node (which will be demoted to slave when it&rsquo;s available again), ioredis will ask sentinels for the new master node and connect to it. All commands sent during the failover are queued and will be executed when the new connection is established so that none of the commands will be lost.</p>
<p>It&rsquo;s possible to connect to a slave instead of a master by specifying the option <code>role</code> with the value of <code>slave</code> and ioredis will try to connect to a random slave of the specified master, with the guarantee that the connected node is always a slave. If the current node is promoted to master due to a failover, ioredis will disconnect from it and ask the sentinels for another slave node to connect to.</p>
<p>If you specify the option <code>preferredSlaves</code> along with <code>role: 'slave'</code> ioredis will attempt to use this value when selecting the slave from the pool of available slaves. The value of <code>preferredSlaves</code> should either be a function that accepts an array of available slaves and returns a single result, or an array of slave values priorities by the lowest <code>prio</code> value first with a default value of <code>1</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// available slaves format
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">availableSlaves</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[{</span> <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;31231&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">flags</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;slave&#34;</span> <span style="color:#000;font-weight:bold">}];</span>

<span style="color:#8f5902;font-style:italic">// preferredSlaves array format
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">preferredSlaves</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;31231&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prio</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">ip</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;31232&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">prio</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">];</span>

<span style="color:#8f5902;font-style:italic">// preferredSlaves function format
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">preferredSlaves</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">availableSlaves</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">let</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">availableSlaves</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">length</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">slave</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">availableSlaves</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">slave</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ip</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">slave</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">port</span> <span style="color:#ce5c00;font-weight:bold">===</span> <span style="color:#4e9a06">&#34;31234&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">slave</span><span style="color:#000;font-weight:bold">;</span>
      <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#000;font-weight:bold">}</span>
  <span style="color:#8f5902;font-style:italic">// if no preferred slaves are available a random one is used
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">};</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">({</span>
  <span style="color:#000">sentinels</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">26379</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">26380</span> <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;mymaster&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">role</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;slave&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000">preferredSlaves</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">preferredSlaves</span><span style="color:#000;font-weight:bold">,</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>Besides the <code>retryStrategy</code> option, there&rsquo;s also a <code>sentinelRetryStrategy</code> in Sentinel mode which will be invoked when all the sentinel nodes are unreachable during connecting. If <code>sentinelRetryStrategy</code> returns a valid delay time, ioredis will try to reconnect from scratch. The default value of <code>sentinelRetryStrategy</code> is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">delay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1000</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">delay</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-01b6f9e61cef026000ac5289660fd21b">9 - Cluster</h1>
    
	<p>Redis Cluster provides a way to run a Redis installation where data is automatically sharded across multiple Redis nodes.
You can connect to a Redis Cluster like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>

<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">([</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6380</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6381</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">]);</span>

<span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// res === &#39;bar&#39;
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p><code>Cluster</code> constructor accepts two arguments, where:</p>
<ol start="0">
<li>
<p>The first argument is a list of nodes of the cluster you want to connect to.
Just like Sentinel, the list does not need to enumerate all your cluster nodes,
but a few so that if one is unreachable the client will try the next one, and the client will discover other nodes automatically when at least one node is connected.</p>
</li>
<li>
<p>The second argument is the options, where:</p>
<ul>
<li>
<p><code>clusterRetryStrategy</code>: When none of the startup nodes are reachable, <code>clusterRetryStrategy</code> will be invoked. When a number is returned,
ioredis will try to reconnect to the startup nodes from scratch after the specified delay (in ms). Otherwise, an error of &ldquo;None of startup nodes is available&rdquo; will be returned.
The default value of this option is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">delay</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">);</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">delay</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>It&rsquo;s possible to modify the <code>startupNodes</code> property in order to switch to another set of nodes here:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">function</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">startupNodes</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[{</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6790</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#39;127.0.0.1&#39;</span> <span style="color:#000;font-weight:bold">}];</span>
  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">Math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div></li>
<li>
<p><code>dnsLookup</code>: Alternative DNS lookup function (<code>dns.lookup()</code> is used by default). It may be useful to override this in special cases, such as when AWS ElastiCache used with TLS enabled.</p>
</li>
<li>
<p><code>enableOfflineQueue</code>: Similar to the <code>enableOfflineQueue</code> option of <code>Redis</code> class.</p>
</li>
<li>
<p><code>enableReadyCheck</code>: When enabled, &ldquo;ready&rdquo; event will only be emitted when <code>CLUSTER INFO</code> command
reporting the cluster is ready for handling commands. Otherwise, it will be emitted immediately after &ldquo;connect&rdquo; is emitted.</p>
</li>
<li>
<p><code>scaleReads</code>: Config where to send the read queries. See below for more details.</p>
</li>
<li>
<p><code>maxRedirections</code>: When a cluster related error (e.g. <code>MOVED</code>, <code>ASK</code> and <code>CLUSTERDOWN</code> etc.) is received, the client will redirect the
command to another node. This option limits the max redirections allowed when sending a command. The default value is <code>16</code>.</p>
</li>
<li>
<p><code>retryDelayOnFailover</code>: If the target node is disconnected when sending a command,
ioredis will retry after the specified delay. The default value is <code>100</code>. You should make sure <code>retryDelayOnFailover * maxRedirections &gt; cluster-node-timeout</code>
to insure that no command will fail during a failover.</p>
</li>
<li>
<p><code>retryDelayOnClusterDown</code>: When a cluster is down, all commands will be rejected with the error of <code>CLUSTERDOWN</code>. If this option is a number (by default, it is <code>100</code>), the client
will resend the commands after the specified time (in ms).</p>
</li>
<li>
<p><code>retryDelayOnTryAgain</code>: If this option is a number (by default, it is <code>100</code>), the client
will resend the commands rejected with <code>TRYAGAIN</code> error after the specified time (in ms).</p>
</li>
<li>
<p><code>retryDelayOnMoved</code>: By default, this value is <code>0</code> (in ms), which means when a <code>MOVED</code> error is received, the client will resend
the command instantly to the node returned together with the <code>MOVED</code> error. However, sometimes it takes time for a cluster to become
state stabilized after a failover, so adding a delay before resending can prevent a ping pong effect.</p>
</li>
<li>
<p><code>redisOptions</code>: Default options passed to the constructor of <code>Redis</code> when connecting to a node.</p>
</li>
<li>
<p><code>slotsRefreshTimeout</code>: Milliseconds before a timeout occurs while refreshing slots from the cluster (default <code>1000</code>).</p>
</li>
<li>
<p><code>slotsRefreshInterval</code>: Milliseconds between every automatic slots refresh (default <code>5000</code>).</p>
</li>
</ul>
</li>
</ol>
<h3 id="read-write-splitting">Read-write splitting</h3>
<p>A typical redis cluster contains three or more masters and several slaves for each master. It&rsquo;s possible to scale out redis cluster by sending read queries to slaves and write queries to masters by setting the <code>scaleReads</code> option.</p>
<p><code>scaleReads</code> is &ldquo;master&rdquo; by default, which means ioredis will never send any queries to slaves. There are other three available options:</p>
<ol>
<li>&ldquo;all&rdquo;: Send write queries to masters and read queries to masters or slaves randomly.</li>
<li>&ldquo;slave&rdquo;: Send write queries to masters and read queries to slaves.</li>
<li>a custom <code>function(nodes, command): node</code>: Will choose the custom function to select to which node to send read queries (write queries keep being sent to master). The first node in <code>nodes</code> is always the master serving the relevant slots. If the function returns an array of nodes, a random node of that list will be selected.</li>
</ol>
<p>For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#8f5902;font-style:italic">/* nodes */</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">scaleReads</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;slave&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bar&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// This query will be sent to one of the masters.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">res</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#8f5902;font-style:italic">// This query will be sent to one of the slaves.
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p><strong>NB</strong> In the code snippet above, the <code>res</code> may not be equal to &ldquo;bar&rdquo; because of the lag of replication between the master and slaves.</p>
<h3 id="running-commands-to-multiple-nodes">Running commands to multiple nodes</h3>
<p>Every command will be sent to exactly one node. For commands containing keys, (e.g. <code>GET</code>, <code>SET</code> and <code>HGETALL</code>), ioredis sends them to the node that serving the keys, and for other commands not containing keys, (e.g. <code>INFO</code>, <code>KEYS</code> and <code>FLUSHDB</code>), ioredis sends them to a random node.</p>
<p>Sometimes you may want to send a command to multiple nodes (masters or slaves) of the cluster, you can get the nodes via <code>Cluster#nodes()</code> method.</p>
<p><code>Cluster#nodes()</code> accepts a parameter role, which can be &ldquo;master&rdquo;, &ldquo;slave&rdquo; and &ldquo;all&rdquo; (default), and returns an array of <code>Redis</code> instance. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#8f5902;font-style:italic">// Send `FLUSHDB` command to all slaves:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">slaves</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;slave&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slaves</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">flushdb</span><span style="color:#000;font-weight:bold">()));</span>

<span style="color:#8f5902;font-style:italic">// Get keys of all the masters:
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">masters</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cluster</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;master&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87">Promise</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">all</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000">masters</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">map</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">())</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#000">then</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">keys</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#8f5902;font-style:italic">// keys: [[&#39;key1&#39;, &#39;key2&#39;], [&#39;key3&#39;, &#39;key4&#39;]]
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">})</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="nat-mapping">NAT Mapping</h3>
<p>Sometimes the cluster is hosted within a internal network that can only be accessed via a NAT (Network Address Translation) instance. See <a href="https://docs.aws.amazon.com/AmazonElastiCache/latest/red-ug/accessing-elasticache.html">Accessing ElastiCache from outside AWS</a> as an example.</p>
<p>You can specify nat mapping rules via <code>natMap</code> option:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;203.0.113.73&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30001</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">natMap</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#4e9a06">&#34;10.0.1.230:30001&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;203.0.113.73&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30001</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#4e9a06">&#34;10.0.1.231:30001&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;203.0.113.73&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30002</span> <span style="color:#000;font-weight:bold">},</span>
      <span style="color:#4e9a06">&#34;10.0.1.232:30001&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;203.0.113.73&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30003</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>This option is also useful when the cluster is running inside a Docker container.</p>
<h3 id="transaction-and-pipeline-in-cluster-mode">Transaction and pipeline in Cluster mode</h3>
<p>Almost all features that are supported by <code>Redis</code> are also supported by <code>Redis.Cluster</code>, e.g. custom commands, transaction and pipeline.
However there are some differences when using transaction and pipeline in Cluster mode:</p>
<ol start="0">
<li>All keys in a pipeline should belong to slots served by the same node, since ioredis sends all commands in a pipeline to the same node.</li>
<li>You can&rsquo;t use <code>multi</code> without pipeline (aka <code>cluster.multi({ pipeline: false })</code>). This is because when you call <code>cluster.multi({ pipeline: false })</code>, ioredis doesn&rsquo;t know which node the <code>multi</code> command should be sent to.</li>
</ol>
<p>When any commands in a pipeline receives a <code>MOVED</code> or <code>ASK</code> error, ioredis will resend the whole pipeline to the specified node automatically if all of the following conditions are satisfied:</p>
<ol start="0">
<li>All errors received in the pipeline are the same. For example, we won&rsquo;t resend the pipeline if we got two <code>MOVED</code> errors pointing to different nodes.</li>
<li>All commands executed successfully are readonly commands. This makes sure that resending the pipeline won&rsquo;t have side effects.</li>
</ol>
<h3 id="pubsub">Pub/Sub</h3>
<p>Pub/Sub in cluster mode works exactly as the same as in standalone mode. Internally, when a node of the cluster receives a message, it will broadcast the message to the other nodes. ioredis makes sure that each message will only be received once by strictly subscribing one node at the same time.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">nodes</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#8f5902;font-style:italic">/* nodes */</span>
<span style="color:#000;font-weight:bold">];</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">pub</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">sub</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">sub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">on</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">console</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">channel</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>

<span style="color:#000">sub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;news&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">pub</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;news&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;highlights&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><h3 id="events">Events</h3>
<table>
<thead>
<tr>
<th style="text-align:left">Event</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">connect</td>
<td style="text-align:left">emits when a connection is established to the Redis server.</td>
</tr>
<tr>
<td style="text-align:left">ready</td>
<td style="text-align:left">emits when <code>CLUSTER INFO</code> reporting the cluster is able to receive commands (if <code>enableReadyCheck</code> is <code>true</code>) or immediately after <code>connect</code> event (if <code>enableReadyCheck</code> is false).</td>
</tr>
<tr>
<td style="text-align:left">error</td>
<td style="text-align:left">emits when an error occurs while connecting with a property of <code>lastNodeError</code> representing the last node error received. This event is emitted silently (only emitting if there&rsquo;s at least one listener).</td>
</tr>
<tr>
<td style="text-align:left">close</td>
<td style="text-align:left">emits when an established Redis server connection has closed.</td>
</tr>
<tr>
<td style="text-align:left">reconnecting</td>
<td style="text-align:left">emits after <code>close</code> when a reconnection will be made. The argument of the event is the time (in ms) before reconnecting.</td>
</tr>
<tr>
<td style="text-align:left">end</td>
<td style="text-align:left">emits after <code>close</code> when no more reconnections will be made.</td>
</tr>
<tr>
<td style="text-align:left">+node</td>
<td style="text-align:left">emits when a new node is connected.</td>
</tr>
<tr>
<td style="text-align:left">-node</td>
<td style="text-align:left">emits when a node is disconnected.</td>
</tr>
<tr>
<td style="text-align:left">node error</td>
<td style="text-align:left">emits when an error occurs when connecting to a node. The second argument indicates the address of the node.</td>
</tr>
</tbody>
</table>
<h3 id="password">Password</h3>
<p>Setting the <code>password</code> option to access password-protected clusters:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nodes</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">redisOptions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;your-cluster-password&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#000;font-weight:bold">},</span>
<span style="color:#000;font-weight:bold">});</span>
</code></pre></div><p>If some of nodes in the cluster using a different password, you should specify them in the first parameter:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">Redis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">require</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ioredis&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#8f5902;font-style:italic">// Use password &#34;password-for-30001&#34; for 30001
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30001</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;password-for-30001&#34;</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#8f5902;font-style:italic">// Don&#39;t use password when accessing 30002
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">30002</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span> <span style="color:#000;font-weight:bold">},</span>
    <span style="color:#8f5902;font-style:italic">// Other nodes will use &#34;fallback-password&#34;
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">redisOptions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">password</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;fallback-password&#34;</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="special-note-aws-elasticache-clusters-with-tls">Special note: AWS ElastiCache Clusters with TLS</h3>
<p>AWS ElastiCache for Redis (Clustered Mode) supports TLS encryption. If you use
this, you may encounter errors with invalid certificates. To resolve this
issue, construct the <code>Cluster</code> with the <code>dnsLookup</code> option as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">cluster</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Redis</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cluster</span><span style="color:#000;font-weight:bold">(</span>
  <span style="color:#000;font-weight:bold">[</span>
    <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">host</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;clustercfg.myCluster.abcdefg.xyz.cache.amazonaws.com&#34;</span><span style="color:#000;font-weight:bold">,</span>
      <span style="color:#000">port</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">6379</span><span style="color:#000;font-weight:bold">,</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">],</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000">dnsLookup</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">address</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">=&gt;</span> <span style="color:#000">callback</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">address</span><span style="color:#000;font-weight:bold">),</span>
    <span style="color:#000">redisOptions</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
      <span style="color:#000">tls</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{},</span>
    <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><hr>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/twitter" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/stack" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/slack" aria-label="Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="https://example.org/mail" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2021 The Docsy Authors 保留所有权利</small>
        <small class="ml-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener">隐私政策</a></small>
	
		<p class="mt-2"><a href="/docs/lua/about/">关于</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.7380160122c24d59789a168af05fcec445fe4e5f2069dd9f3a0c991f10269ae0.js" integrity="sha256-c4AWASLCTVl4mhaK8F/OxEX&#43;Tl8gad2fOgyZHxAmmuA=" crossorigin="anonymous"></script>




  </body>
</html>
