<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Node Redlock | redis-docs</title>
<meta name="description" content="


Redlock
这是分布式 redis 锁的redlock算法的 node.js 实现。
它在单 redis 和多 redis 环境中都提供了强大的保证，并通过使用多个独立的 redis 实例或集群提供容错性。
高可用性的建议

Use at least 3 independent …">
<meta property="og:title" content="Node Redlock" />
<meta property="og:description" content="Redlock 这是分布式 redis 锁的redlock算法的 node.js 实现。 它在单 redis 和多 redis 环境中都提供了强大的保证，并通过使用多个独立的 redis 实例或集群提供容错性。
高可用性的建议  Use at least 3 independent servers or clusters Use an odd number of independent redis servers for most installations Use an odd number of independent redis clusters for massive installations When possible, distribute redis nodes across different physical machines  使用集群/哨兵 Please make sure to use a client with built-in cluster support, such as ioredis." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/docs/redlock/node-redlock/" /><meta property="article:section" content="docs" />



<meta itemprop="name" content="Node Redlock">
<meta itemprop="description" content="Redlock 这是分布式 redis 锁的redlock算法的 node.js 实现。 它在单 redis 和多 redis 环境中都提供了强大的保证，并通过使用多个独立的 redis 实例或集群提供容错性。
高可用性的建议  Use at least 3 independent servers or clusters Use an odd number of independent redis servers for most installations Use an odd number of independent redis clusters for massive installations When possible, distribute redis nodes across different physical machines  使用集群/哨兵 Please make sure to use a client with built-in cluster support, such as ioredis.">

<meta itemprop="wordCount" content="1572">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Node Redlock"/>
<meta name="twitter:description" content="Redlock 这是分布式 redis 锁的redlock算法的 node.js 实现。 它在单 redis 和多 redis 环境中都提供了强大的保证，并通过使用多个独立的 redis 实例或集群提供容错性。
高可用性的建议  Use at least 3 independent servers or clusters Use an odd number of independent redis servers for most installations Use an odd number of independent redis clusters for massive installations When possible, distribute redis nodes across different physical machines  使用集群/哨兵 Please make sure to use a client with built-in cluster support, such as ioredis."/>




<link rel="preload" href="/scss/main.scss" as="style">
<link href="/scss/main.scss" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">redis-docs</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/docs/" ><span class="active">文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/blog/" ><span>博客</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"></div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docs-li">
  <a href="/docs/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-docs"><span class="">文档</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docslua-li">
  <a href="/docs/lua/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-docslua"><span class="">lua</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsluaabout-li">
  <a href="/docs/lua/about/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsluaabout"><span class="">关于</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsluamanual-li">
  <a href="/docs/lua/manual/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-docsluamanual"><span class="">参考手册</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsluastart-li">
  <a href="/docs/lua/start/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsluastart"><span class="">入门</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsluadownload-li">
  <a href="/docs/lua/download/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsluadownload"><span class="">下载</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsluadocs-li">
  <a href="/docs/lua/docs/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsluadocs"><span class="">文档</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsluacommunity-li">
  <a href="/docs/lua/community/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsluacommunity"><span class="">社区</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-docsredlock-li">
  <a href="/docs/redlock/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-docsredlock"><span class="">Redis 锁</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-docsredlocknode-redlock-li">
  <a href="/docs/redlock/node-redlock/" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id="m-docsredlocknode-redlock"><span class="td-sidebar-nav-active-item">Node Redlock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsredlocknode-redlock5-li">
  <a href="/docs/redlock/node-redlock5/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsredlocknode-redlock5"><span class="">Node Redlock5</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsredlocknode-redlock5api-li">
  <a href="/docs/redlock/node-redlock5.api/" title="Node Redlock5 API" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsredlocknode-redlock5api"><span class="">Node Redlock5 接口</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsredlockwarlock-li">
  <a href="/docs/redlock/warlock/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsredlockwarlock"><span class="">warlock</span></a>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-docsioredis-li">
  <a href="/docs/ioredis/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-docsioredis"><span class="">ioredis</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsioredisquick-start-li">
  <a href="/docs/ioredis/quick-start/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsioredisquick-start"><span class="">快速入门</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsioredisconnection-li">
  <a href="/docs/ioredis/connection/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsioredisconnection"><span class="">连接</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsioredistls-li">
  <a href="/docs/ioredis/tls/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsioredistls"><span class="">TLS</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsioredisstreams-li">
  <a href="/docs/ioredis/streams/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsioredisstreams"><span class="">流和二进制</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsioredislua-li">
  <a href="/docs/ioredis/lua/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsioredislua"><span class="">Lua 脚本</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsioredispipelining-li">
  <a href="/docs/ioredis/pipelining/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsioredispipelining"><span class="">Pipelining</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsioredispub-sub-li">
  <a href="/docs/ioredis/pub-sub/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsioredispub-sub"><span class="">Pub/Sub</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsioredissentinel-li">
  <a href="/docs/ioredis/sentinel/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsioredissentinel"><span class="">Sentinel</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-docsiorediscluster-li">
  <a href="/docs/ioredis/cluster/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-docsiorediscluster"><span class="">Cluster</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">

</div>

            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#redlock">Redlock</a>
      <ul>
        <li><a href="#高可用性的建议">高可用性的建议</a></li>
        <li><a href="#使用集群哨兵">使用集群/哨兵</a></li>
        <li><a href="#我怎么检查东西是否上锁了">我怎么检查东西是否上锁了?</a></li>
      </ul>
    </li>
    <li><a href="#安装">安装</a></li>
    <li><a href="#配置">配置</a></li>
    <li><a href="#错误处理">错误处理</a></li>
    <li><a href="#使用承诺风格">使用(承诺风格)</a>
      <ul>
        <li><a href="#锁定与解锁">锁定与解锁</a></li>
        <li><a href="#锁定和扩展">锁定和扩展</a></li>
      </ul>
    </li>
    <li><a href="#使用碎渣机风格">使用(碎渣机风格)</a>
      <ul>
        <li><a href="#锁定与解锁-1">锁定与解锁</a></li>
        <li><a href="#锁定和扩展-1">锁定和扩展</a></li>
      </ul>
    </li>
    <li><a href="#使用回调风格">使用(回调风格)</a>
      <ul>
        <li><a href="#锁定与解锁-2">锁定与解锁</a></li>
        <li><a href="#锁定和扩展-2">锁定和扩展</a></li>
      </ul>
    </li>
    <li><a href="#锁定多个资源">锁定多个资源</a></li>
    <li><a href="#api-文档">API 文档</a>
      <ul>
        <li></li>
      </ul>
    </li>
  </ul>
</nav></div>



            

	
		



  
  

	
		



  
  

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            
  

            <nav aria-label="breadcrumb" class="td-breadcrumbs">
  <ol class="breadcrumb spb-1">
  <li class="breadcrumb-item">
    <a href="http://example.org/docs/">文档</a>
  </li>
  <li class="breadcrumb-item">
    <a href="http://example.org/docs/redlock/">Redis 锁</a>
  </li>
  <li class="breadcrumb-item active" aria-current="page">
    <a href="http://example.org/docs/redlock/node-redlock/">Node Redlock</a>
  </li>
  </ol>
</nav>
            
<div class="td-content">
	<h1>Node Redlock</h1>
	
	<header class="article-meta">
		
		
			
				


			
				


			
		
		
	</header>    
	<p><a href="https://www.npmjs.com/package/redlock"><img src="https://badge.fury.io/js/redlock.svg" alt="npm version"></a>
<a href="https://travis-ci.org/mike-marcacci/node-redlock"><img src="https://travis-ci.org/mike-marcacci/node-redlock.svg" alt="Build Status"></a>
<a href="https://coveralls.io/r/mike-marcacci/node-redlock"><img src="https://coveralls.io/repos/mike-marcacci/node-redlock/badge.svg" alt="Coverage Status"></a></p>
<h2 id="redlock">Redlock</h2>
<p>这是分布式 redis 锁的<a href="http://redis.io/topics/distlock">redlock</a>算法的 node.js 实现。
它在单 redis 和多 redis 环境中都提供了强大的保证，并通过使用多个独立的 redis 实例或集群提供容错性。</p>
<h3 id="高可用性的建议">高可用性的建议</h3>
<ul>
<li>Use at least 3 independent servers or clusters</li>
<li>Use an odd number of independent redis <strong><em>servers</em></strong> for most installations</li>
<li>Use an odd number of independent redis <strong><em>clusters</em></strong> for massive installations</li>
<li>When possible, distribute redis nodes across different physical machines</li>
</ul>
<h3 id="使用集群哨兵">使用集群/哨兵</h3>
<p><strong><em>Please make sure to use a client with built-in cluster support, such as <a href="https://github.com/luin/ioredis">ioredis</a>.</em></strong></p>
<p>It is completely possible to use a <em>single</em> redis cluster or sentinal configuration by passing one preconfigured client to redlock. While you do gain high availability and vastly increased throughput under this scheme, the failure modes are a bit different, and it becomes theoretically possible that a lock is acquired twice:</p>
<p>Assume you are using eventually-consistent redis replication, and you acquire a lock for a resource. Immediately after acquiring your lock, the redis master for that shard crashes. Redis does its thing and fails over to the slave which hasn&rsquo;t yet synced your lock. If another process attempts to acquire a lock for the same resource, it will succeed!</p>
<p>This is why redlock allows you to specify multiple independent nodes/clusters: by requiring consensus between them, we can safely take out or fail-over a minority of nodes without invalidating active locks.</p>
<p>To learn more about the the algorithm, check out the <a href="http://redis.io/topics/distlock">redis distlock page</a>.</p>
<h3 id="我怎么检查东西是否上锁了">我怎么检查东西是否上锁了?</h3>
<p>Redlock cannot tell you <em>with certainty</em> if a resource is currently locked.
For example, if you are on the smaller side of a network partition you will fail to acquire a lock, but you don&rsquo;t know if the lock exists on the other side; all you know is that you can&rsquo;t guarantee exclusivity on yours.</p>
<p>That said, for many tasks it&rsquo;s sufficient to attempt a lock with <code>retryCount=0</code>, and treat a failure as the resource being &ldquo;locked&rdquo; or (more correctly) &ldquo;unavailable&rdquo;,</p>
<p>With <code>retryCount=-1</code> there will be unlimited retries until the lock is aquired.</p>
<h2 id="安装">安装</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">npm install --save redlock
</code></pre></div><h2 id="配置">配置</h2>
<p>Redlock can use <a href="https://github.com/mranney/node_redis">node redis</a>, <a href="https://github.com/luin/ioredis">ioredis</a> or any other compatible redis library to keep its client connections.</p>
<p>A redlock object is instantiated with an array of at least one redis client and an optional <code>options</code> object. Properties of the Redlock object should NOT be changed after it is first used, as doing so could have unintended consequences for live locks.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">client1</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;redis&#34;</span>).<span style="color:#a6e22e">createClient</span>(<span style="color:#ae81ff">6379</span>, <span style="color:#e6db74">&#34;redis1.example.com&#34;</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">client2</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;redis&#34;</span>).<span style="color:#a6e22e">createClient</span>(<span style="color:#ae81ff">6379</span>, <span style="color:#e6db74">&#34;redis2.example.com&#34;</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">client3</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;redis&#34;</span>).<span style="color:#a6e22e">createClient</span>(<span style="color:#ae81ff">6379</span>, <span style="color:#e6db74">&#34;redis3.example.com&#34;</span>);
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">Redlock</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;redlock&#34;</span>);

<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">redlock</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Redlock</span>(
  <span style="color:#75715e">// you should have one client for each independent redis node
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// or cluster
</span><span style="color:#75715e"></span>  [<span style="color:#a6e22e">client1</span>, <span style="color:#a6e22e">client2</span>, <span style="color:#a6e22e">client3</span>],
  {
    <span style="color:#75715e">// the expected clock drift; for more details
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// see http://redis.io/topics/distlock
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">driftFactor</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">0.01</span>, <span style="color:#75715e">// multiplied by lock ttl to determine drift time
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// the max number of times Redlock will attempt
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// to lock a resource before erroring
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">retryCount</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span>,

    <span style="color:#75715e">// the time in ms between attempts
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">retryDelay</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>, <span style="color:#75715e">// time in ms
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// the max time in ms randomly added to retries
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// to improve performance under high contention
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// see https://www.awsarchitectureblog.com/2015/03/backoff.html
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">retryJitter</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">200</span>, <span style="color:#75715e">// time in ms
</span><span style="color:#75715e"></span>  }
);
</code></pre></div><h2 id="错误处理">错误处理</h2>
<p>Because redlock is designed for high availability,
it does not care if a minority of redis instances/clusters fail at an operation.
If you want to write logs or take another action when a redis client fails,
you can listen for the <code>clientError</code> event:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// ...
</span><span style="color:#75715e"></span><span style="color:#a6e22e">redlock</span>.<span style="color:#a6e22e">on</span>(<span style="color:#e6db74">&#34;clientError&#34;</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">err</span>) {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;A redis error has occurred:&#34;</span>, <span style="color:#a6e22e">err</span>);
});
<span style="color:#75715e">// ...
</span></code></pre></div><h2 id="使用承诺风格">使用(承诺风格)</h2>
<h3 id="锁定与解锁">锁定与解锁</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// the string identifier for the resource you want to lock
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">resource</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;locks:account:322456&#34;</span>;

<span style="color:#75715e">// the maximum amount of time you want the resource locked in milliseconds,
</span><span style="color:#75715e">// keeping in mind that you can extend the lock up until
</span><span style="color:#75715e">// the point when it expires
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ttl</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>;

<span style="color:#a6e22e">redlock</span>.<span style="color:#a6e22e">lock</span>(<span style="color:#a6e22e">resource</span>, <span style="color:#a6e22e">ttl</span>).<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">lock</span>) {
  <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// unlock your resource when you are done
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">unlock</span>().<span style="color:#66d9ef">catch</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">err</span>) {
    <span style="color:#75715e">// we weren&#39;t able to reach redis; your lock will eventually
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// expire, but you probably want to log this error
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>);
  });
});
</code></pre></div><h3 id="锁定和扩展">锁定和扩展</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">redlock</span>.<span style="color:#a6e22e">lock</span>(<span style="color:#e6db74">&#34;locks:account:322456&#34;</span>, <span style="color:#ae81ff">1000</span>).<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">lock</span>) {
  <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// if you need more time, you can continue to extend
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// the lock as long as you never let it expire
</span><span style="color:#75715e"></span>
  <span style="color:#75715e">// this will extend the lock so that it expires
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// approximitely 1s from when `extend` is called
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">extend</span>(<span style="color:#ae81ff">1000</span>).<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">lock</span>) {
    <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// unlock your resource when you are done
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">unlock</span>().<span style="color:#66d9ef">catch</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">err</span>) {
      <span style="color:#75715e">// we weren&#39;t able to reach redis; your lock will eventually
</span><span style="color:#75715e"></span>      <span style="color:#75715e">// expire, but you probably want to log this error
</span><span style="color:#75715e"></span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>);
    });
  });
});
</code></pre></div><h2 id="使用碎渣机风格">使用(碎渣机风格)</h2>
<h3 id="锁定与解锁-1">锁定与解锁</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">using</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">require</span>(<span style="color:#e6db74">&#34;bluebird&#34;</span>).<span style="color:#a6e22e">using</span>;
<span style="color:#75715e">// the string identifier for the resource you want to lock
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">resource</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;locks:account:322456&#34;</span>;
<span style="color:#75715e">// the maximum amount of time you want the resource locked,
</span><span style="color:#75715e">// keeping in mind that you can extend the lock up until
</span><span style="color:#75715e">// the point when it expires
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ttl</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>;
<span style="color:#75715e">// if we weren&#39;t able to reach redis, your lock will eventually
</span><span style="color:#75715e">// expire, but you probably want to do something like log that
</span><span style="color:#75715e">// an error occurred; if you don&#39;t pass a handler, this error
</span><span style="color:#75715e">// will be ignored
</span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">unlockErrorHandler</span>(<span style="color:#a6e22e">err</span>) {
  <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>);
}

<span style="color:#a6e22e">using</span>(<span style="color:#a6e22e">redlock</span>.<span style="color:#a6e22e">disposer</span>(<span style="color:#a6e22e">resource</span>, <span style="color:#a6e22e">ttl</span>, <span style="color:#a6e22e">unlockErrorHandler</span>), <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">lock</span>) {
  <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>}); <span style="color:#75715e">// &lt;-- unlock is automatically handled by bluebird
</span></code></pre></div><h3 id="锁定和扩展-1">锁定和扩展</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">using</span>(
  <span style="color:#a6e22e">redlock</span>.<span style="color:#a6e22e">disposer</span>(<span style="color:#e6db74">&#34;locks:account:322456&#34;</span>, <span style="color:#ae81ff">1000</span>, <span style="color:#a6e22e">unlockErrorHandler</span>),
  <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">lock</span>) {
    <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// if you need more time, you can continue to extend
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// the lock as long as you never let it expire
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// this will extend the lock so that it expires
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// approximitely 1s from when `extend` is called
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">extend</span>(<span style="color:#ae81ff">1000</span>).<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">extended</span>) {
      <span style="color:#75715e">// Note that redlock modifies the original lock,
</span><span style="color:#75715e"></span>      <span style="color:#75715e">// so the vars `lock` and `extended` point to the
</span><span style="color:#75715e"></span>      <span style="color:#75715e">// exact same object
</span><span style="color:#75715e"></span>      <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>    });
  }
); <span style="color:#75715e">// &lt;-- unlock is automatically handled by bluebird
</span></code></pre></div><h2 id="使用回调风格">使用(回调风格)</h2>
<h3 id="锁定与解锁-2">锁定与解锁</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#75715e">// the string identifier for the resource you want to lock
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">resource</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;locks:account:322456&#34;</span>;

<span style="color:#75715e">// the maximum amount of time you want the resource locked,
</span><span style="color:#75715e">// keeping in mind that you can extend the lock up until
</span><span style="color:#75715e">// the point when it expires
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">ttl</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1000</span>;

<span style="color:#a6e22e">redlock</span>.<span style="color:#a6e22e">lock</span>(<span style="color:#a6e22e">resource</span>, <span style="color:#a6e22e">ttl</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">lock</span>) {
  <span style="color:#75715e">// we failed to lock the resource
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  }

  <span style="color:#75715e">// we have the lock
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">else</span> {
    <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// unlock your resource when you are done
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">unlock</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">err</span>) {
      <span style="color:#75715e">// we weren&#39;t able to reach redis; your lock will eventually
</span><span style="color:#75715e"></span>      <span style="color:#75715e">// expire, but you probably want to log this error
</span><span style="color:#75715e"></span>      <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>);
    });
  }
});
</code></pre></div><h3 id="锁定和扩展-2">锁定和扩展</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">redlock</span>.<span style="color:#a6e22e">lock</span>(<span style="color:#e6db74">&#34;locks:account:322456&#34;</span>, <span style="color:#ae81ff">1000</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">lock</span>) {
  <span style="color:#75715e">// we failed to lock the resource
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>  }
  <span style="color:#75715e">// we have the lock
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">else</span> {
    <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// if you need more time, you can continue to extend
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// the lock as long as you never let it expire
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// this will extend the lock so that it expires
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// approximitely 1s from when `extend` is called
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">extend</span>(<span style="color:#ae81ff">1000</span>, <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">err</span>, <span style="color:#a6e22e">lock</span>) {
      <span style="color:#75715e">// we failed to extend the lock on the resource
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">err</span>) {
        <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>      }
      <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>      <span style="color:#75715e">// unlock your resource when you are done
</span><span style="color:#75715e"></span>      <span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">unlock</span>();
    });
  }
});
</code></pre></div><h2 id="锁定多个资源">锁定多个资源</h2>
<p>Multiple resources can be locked by providing an <code>Array</code> of strings to <code>Redlock.prototype.lock</code> call. Internally a single attempt is made to <code>redis</code> by evaluating script which executes lock statements. For more details about atomicity of scripts please see <a href="https://redis.io/commands/eval#atomicity-of-scripts">redis reference</a>.</p>
<p>There are however some limitations of which you need to be aware of:</p>
<ul>
<li>When requesting a lock it will fail if any of requested resources is already set</li>
<li>If lock attempt fails for any resource (due to whatever reason) an attempt for removing already set resources is made. However there are no guarantees that it will succeed (<code>redis</code> doesn&rsquo;t provide them)</li>
<li>Releasing lock will fail if any of requested resources is missing</li>
<li>Extending lock will fail if any of requested resources is missing</li>
</ul>
<p>Example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#a6e22e">redlock</span>
  .<span style="color:#a6e22e">lock</span>(
    [<span style="color:#e6db74">&#34;locks:account:322456&#34;</span>, <span style="color:#e6db74">&#34;locks:account:322457&#34;</span>, <span style="color:#e6db74">&#34;locks:account:322458&#34;</span>],
    <span style="color:#ae81ff">1000</span>
  )
  .<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">lock</span>) {
    <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// if you need more time, you can continue to extend
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// the lock as long as you never let it expire
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// this will extend the lock so that it expires
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// approximitely 1s from when `extend` is called
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">extend</span>(<span style="color:#ae81ff">1000</span>).<span style="color:#a6e22e">then</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">lock</span>) {
      <span style="color:#75715e">// ...do something here...
</span><span style="color:#75715e"></span>
      <span style="color:#75715e">// unlock your resource when you are done
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">unlock</span>().<span style="color:#66d9ef">catch</span>(<span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">err</span>) {
        <span style="color:#75715e">// we weren&#39;t able to reach redis; your lock will eventually
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// expire, but you probably want to log this error
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">console</span>.<span style="color:#a6e22e">error</span>(<span style="color:#a6e22e">err</span>);
      });
    });
  });
</code></pre></div><h2 id="api-文档">API 文档</h2>
<h4 id="redlockprototypelockresource-ttl-callback--promiselock"><code>Redlock.prototype.lock(resource, ttl, ?callback) =&gt; Promise&lt;Lock&gt;</code></h4>
<ul>
<li><code>resource (string or string[])</code> resource(s) to be locked</li>
<li><code>ttl (number)</code> time in ms until the lock expires</li>
<li><code>callback (function)</code> callback returning:
<ul>
<li><code>err (Error)</code></li>
<li><code>lock (Lock)</code></li>
</ul>
</li>
</ul>
<h4 id="redlockprototypeunlocklock-callback--promise"><code>Redlock.prototype.unlock(lock, ?callback) =&gt; Promise</code></h4>
<ul>
<li><code>lock (Lock)</code> lock to be released</li>
<li><code>callback (function)</code> callback returning:
<ul>
<li><code>err (Error)</code></li>
</ul>
</li>
</ul>
<h4 id="redlockprototypeextendlock-ttl-callback--promiselock"><code>Redlock.prototype.extend(lock, ttl, ?callback) =&gt; Promise&lt;Lock&gt;</code></h4>
<ul>
<li><code>lock (Lock)</code> lock to be extended</li>
<li><code>ttl (number)</code> time in ms to extend the lock&rsquo;s expiration</li>
<li><code>callback (function)</code> callback returning:
<ul>
<li><code>err (Error)</code></li>
<li><code>lock (Lock)</code></li>
</ul>
</li>
</ul>
<h4 id="redlockprototypedisposerresource-ttl-unlockerrorhandler"><code>Redlock.prototype.disposer(resource, ttl, ?unlockErrorHandler)</code></h4>
<ul>
<li><code>resource (string or string[])</code> resource(s) to be locked</li>
<li><code>ttl (number)</code> time in ms to extend the lock&rsquo;s expiration</li>
<li><code>callback (function)</code> error handler called with:
<ul>
<li><code>err (Error)</code></li>
</ul>
</li>
</ul>
<h4 id="redlockprototypequitcallback--promise"><code>Redlock.prototype.quit(?callback) =&gt; Promise&lt;*[]&gt;</code></h4>
<ul>
<li><code>callback (function)</code> error handler called with:
<ul>
<li><code>err (Error)</code></li>
<li><code>*[]</code> results of calling <code>.quit()</code> on each client</li>
</ul>
</li>
</ul>
<h4 id="lockprototypeunlockcallback--promise"><code>Lock.prototype.unlock(?callback) =&gt; Promise</code></h4>
<ul>
<li><code>callback (function)</code> callback returning:
<ul>
<li><code>err (Error)</code></li>
</ul>
</li>
</ul>
<h4 id="lockprototypeextendttl-callback--promiselock"><code>Lock.prototype.extend(ttl, ?callback) =&gt; Promise&lt;Lock&gt;</code></h4>
<ul>
<li><code>ttl (number)</code> time from now in ms to set as the lock&rsquo;s new expiration</li>
<li><code>callback (function)</code> callback returning:
<ul>
<li><code>err (Error)</code></li>
<li><code>lock (Lock)</code></li>
</ul>
</li>
</ul>

	
	
	
</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        
        
	
		<p class="mt-2"><a href="/docs/lua/about/">关于</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.5c6c35925cba6ccdfc94d3ef0a1ff539934a08075c0931f2c9ab70249877b310.js" integrity="sha256-XGw1kly6bM38lNPvCh/1OZNKCAdcCTHyyatwJJh3sxA=" crossorigin="anonymous"></script>




  </body>
</html>