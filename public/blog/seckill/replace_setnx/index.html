<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性 | redis-docs</title>
<meta name="description" content="
https://learnku.com/articles/39265

背景
最近公司出了一起故障，问题代码如下：
    /**
     * TRUE: 触发限流，FALSE：未触发限流
     */
    public function acquire() {
        try { …">
<meta property="og:title" content="Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性" />
<meta property="og:description" content="https://learnku.com/articles/39265
 背景 最近公司出了一起故障，问题代码如下：
/** * TRUE: 触发限流，FALSE：未触发限流 */ public function acquire() { try { $redisHandler = $this-&gt;redisInstance-&gt;getHandler(); $redisHandler-&gt;set($this-&gt;rateLimitKey, $this-&gt;tokenNum, [&#39;nx&#39;, &#39;ex&#39; =&gt; $this-&gt;expireTime]); $leftTokenNum = $redisHandler-&gt;decr($this-&gt;rateLimitKey); if ($leftTokenNum &lt; 0) { return TRUE; } return FALSE; } catch (\Exception $e) { return FALSE; } } 作者的目的是针对爆款商品的购买，使用 redis 来起到一个限流的作用，1 秒钟只允许 1 人购买。
结果上线过后不久，运营就反馈线上出故障了，该爆款商品所有人都不能购买了。
分析 上面代码的思路很简单：通过 $redis-&gt;set(&#39;key&#39;, &#39;1&#39;, [&#39;nx&#39;, &#39;ex&#39;=&gt;1]);  命令，设置值为 1 过期时间为 1 秒的计数器，基于该计数器的扣减来达到 1 秒钟放行 1 个请求的目的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/blog/seckill/replace_setnx/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-01-05T23:14:20+00:00" />
<meta property="article:modified_time" content="2020-01-05T23:14:20+00:00" />

<meta itemprop="name" content="Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性">
<meta itemprop="description" content="https://learnku.com/articles/39265
 背景 最近公司出了一起故障，问题代码如下：
/** * TRUE: 触发限流，FALSE：未触发限流 */ public function acquire() { try { $redisHandler = $this-&gt;redisInstance-&gt;getHandler(); $redisHandler-&gt;set($this-&gt;rateLimitKey, $this-&gt;tokenNum, [&#39;nx&#39;, &#39;ex&#39; =&gt; $this-&gt;expireTime]); $leftTokenNum = $redisHandler-&gt;decr($this-&gt;rateLimitKey); if ($leftTokenNum &lt; 0) { return TRUE; } return FALSE; } catch (\Exception $e) { return FALSE; } } 作者的目的是针对爆款商品的购买，使用 redis 来起到一个限流的作用，1 秒钟只允许 1 人购买。
结果上线过后不久，运营就反馈线上出故障了，该爆款商品所有人都不能购买了。
分析 上面代码的思路很简单：通过 $redis-&gt;set(&#39;key&#39;, &#39;1&#39;, [&#39;nx&#39;, &#39;ex&#39;=&gt;1]);  命令，设置值为 1 过期时间为 1 秒的计数器，基于该计数器的扣减来达到 1 秒钟放行 1 个请求的目的。"><meta itemprop="datePublished" content="2020-01-05T23:14:20+00:00" />
<meta itemprop="dateModified" content="2020-01-05T23:14:20+00:00" />
<meta itemprop="wordCount" content="560">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性"/>
<meta name="twitter:description" content="https://learnku.com/articles/39265
 背景 最近公司出了一起故障，问题代码如下：
/** * TRUE: 触发限流，FALSE：未触发限流 */ public function acquire() { try { $redisHandler = $this-&gt;redisInstance-&gt;getHandler(); $redisHandler-&gt;set($this-&gt;rateLimitKey, $this-&gt;tokenNum, [&#39;nx&#39;, &#39;ex&#39; =&gt; $this-&gt;expireTime]); $leftTokenNum = $redisHandler-&gt;decr($this-&gt;rateLimitKey); if ($leftTokenNum &lt; 0) { return TRUE; } return FALSE; } catch (\Exception $e) { return FALSE; } } 作者的目的是针对爆款商品的购买，使用 redis 来起到一个限流的作用，1 秒钟只允许 1 人购买。
结果上线过后不久，运营就反馈线上出故障了，该爆款商品所有人都不能购买了。
分析 上面代码的思路很简单：通过 $redis-&gt;set(&#39;key&#39;, &#39;1&#39;, [&#39;nx&#39;, &#39;ex&#39;=&gt;1]);  命令，设置值为 1 过期时间为 1 秒的计数器，基于该计数器的扣减来达到 1 秒钟放行 1 个请求的目的。"/>




<link rel="preload" href="/scss/main.scss" as="style">
<link href="/scss/main.scss" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">redis-docs</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/docs/" ><span>文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/blog/" ><span class="active">博客</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"></div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-blog-li">
  <a href="/blog/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-blog"><span class="">博客</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-blognews-li">
  <a href="/blog/news/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blognews"><span class="">news</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-blognewslua-li">
  <a href="/blog/news/lua/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blognewslua"><span class="">Lua News</span></a>
  <ul class="ul-3 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blognewslua2020-2021-li">
  <a href="/blog/news/lua/2020-2021/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blognewslua2020-2021"><span class="">2020-2021 Lua News</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blognewslua2010-2019-li">
  <a href="/blog/news/lua/2010-2019/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blognewslua2010-2019"><span class="">2010-2019 Lua News</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blognewslua2000-2009-li">
  <a href="/blog/news/lua/2000-2009/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blognewslua2000-2009"><span class="">2000-2009 Lua News</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blognewslua1993-1999-li">
  <a href="/blog/news/lua/1993-1999/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blognewslua1993-1999"><span class="">1993-1999 Lua News</span></a>
</li>
  </ul>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-blogseckill-li">
  <a href="/blog/seckill/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blogseckill"><span class="">秒杀</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillredlock-system-awareness-li">
  <a href="/blog/seckill/redlock-system-awareness/" title="建立对分布式锁的系统认知 - 从 Redlock 开始" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillredlock-system-awareness"><span class="">分布式锁系统认知</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillimplementation-of-redis-distributed-lock-li">
  <a href="/blog/seckill/implementation-of-redis-distributed-lock/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillimplementation-of-redis-distributed-lock"><span class="">Implementation of redis distributed lock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillexample-li">
  <a href="/blog/seckill/example/" title="一个使用 Node.js 的 Redlock 示例，关于如何锁定一个Redis上的密钥对" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillexample"><span class="">Redlok 示例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-blogseckillreplace_setnx-li">
  <a href="/blog/seckill/replace_setnx/" title="Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id="m-blogseckillreplace_setnx"><span class="td-sidebar-nav-active-item">替代 SETNX/DECR</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillnodejs-case-li">
  <a href="/blog/seckill/nodejs-case/" title="Node.js 中实践基于 Redis 的分布式锁实现" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillnodejs-case"><span class="">分布式锁实现</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillnodejs-redis-lua-li">
  <a href="/blog/seckill/nodejs-redis-lua/" title="Node.js 中实践 Redis Lua 脚本" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillnodejs-redis-lua"><span class="">Node.js Redis Lua</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillis_redlock_safe-li">
  <a href="/blog/seckill/is_redlock_safe/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillis_redlock_safe"><span class="">Is Redlock safe?</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckilldistlock-li">
  <a href="/blog/seckill/distlock/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckilldistlock"><span class="">Redis分布式锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillhow-to-do-distributed-locking-li">
  <a href="/blog/seckill/how-to-do-distributed-locking/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillhow-to-do-distributed-locking"><span class="">How to do distributed locking</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillredis_lua-li">
  <a href="/blog/seckill/redis_lua/" title="Redis&#43;Lua 解决高并发场景抢购秒杀问题" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillredis_lua"><span class="">Redis&#43;Lua秒杀</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckilldistlock-cn-li">
  <a href="/blog/seckill/distlock-cn/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckilldistlock-cn"><span class="">Redis分布式锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillaliyun-li">
  <a href="/blog/seckill/aliyun/" title="使用  搭建电商秒杀系统" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillaliyun"><span class="">Redis秒杀系统</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillredlock-controversy-li">
  <a href="/blog/seckill/redlock-controversy/" title="Redis Redlock 的争论" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillredlock-controversy"><span class="">Redlock 争论</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">

</div>

            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#背景">背景</a></li>
    <li><a href="#分析">分析</a></li>
    <li><a href="#测试">测试</a></li>
    <li><a href="#原因">原因</a></li>
    <li><a href="#问题复现">问题复现</a></li>
    <li><a href="#解决方案">解决方案</a></li>
    <li><a href="#总结">总结</a></li>
  </ul>
</nav></div>



            

	
		



  
  

	
		



  
  

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
            <a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href="http://example.org/blog/seckill/index.xml" target="_blank">
              RSS <i class="fa fa-rss ml-2 "></i>
            </a>
            
<div class="td-content">
	<h1>Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性</h1>
	
	<div class="td-byline mb-4">
		By <b>Laravel</b> |
		<time datetime="2020-01-05" class="text-muted">Sunday, January 05, 2020</time>
	</div>
	<header class="article-meta">
		
		
			
				


			
				


			
		
		
	</header>
	<blockquote>
<p><a href="https://learnku.com/articles/39265">https://learnku.com/articles/39265</a></p>
</blockquote>
<h2 id="背景">背景</h2>
<p>最近公司出了一起故障，问题代码如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">    <span style="color:#e6db74">/**
</span><span style="color:#e6db74">     * TRUE: 触发限流，FALSE：未触发限流
</span><span style="color:#e6db74">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">acquire</span>() {
        <span style="color:#66d9ef">try</span> {
            $redisHandler <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">redisInstance</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">getHandler</span>();
            $redisHandler<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rateLimitKey</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">tokenNum</span>, [<span style="color:#e6db74">&#39;nx&#39;</span>, <span style="color:#e6db74">&#39;ex&#39;</span> <span style="color:#f92672">=&gt;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">expireTime</span>]);
            $leftTokenNum <span style="color:#f92672">=</span> $redisHandler<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">decr</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rateLimitKey</span>);
            <span style="color:#66d9ef">if</span> ($leftTokenNum <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">TRUE</span>;
            }
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">FALSE</span>;
        } <span style="color:#66d9ef">catch</span> (<span style="color:#a6e22e">\Exception</span> $e) {
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">FALSE</span>;
        }
    }
</code></pre></div><p>作者的目的是针对爆款商品的购买，使用 redis 来起到一个限流的作用，1 秒钟只允许 1 人购买。</p>
<p>结果上线过后不久，运营就反馈线上出故障了，该爆款商品所有人都不能购买了。</p>
<h2 id="分析">分析</h2>
<p>上面代码的思路很简单：通过 <code>$redis-&gt;set('key', '1', ['nx', 'ex'=&gt;1]); </code> 命令，设置值为 1 过期时间为 1 秒的计数器，基于该计数器的扣减来达到 1 秒钟放行 1 个请求的目的。</p>
<h2 id="测试">测试</h2>
<p>我们简化一下上面的代码，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$redis <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Redis</span>();
$redis<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">connect</span>(<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">6379</span>);

$key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;test_redis_key&#39;</span>;
$redis<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set</span>($key, <span style="color:#e6db74">&#39;1&#39;</span>, [<span style="color:#e6db74">&#39;nx&#39;</span>, <span style="color:#e6db74">&#39;ex&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>]);
$left <span style="color:#f92672">=</span> $redis<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">decr</span>($key);

<span style="color:#66d9ef">if</span> ($left <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
    <span style="color:#75715e">// 这里通过状态码来更方便的观察
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Is-Limited:1&#39;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#ae81ff">500</span>);
} <span style="color:#66d9ef">else</span> {
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Is-Limited:0&#39;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#ae81ff">200</span>);
}
</code></pre></div><p>简化后使用 siege 模拟 100 个用户并发压测一下。</p>
<p><img src="https://cdn.learnku.com/uploads/images/202001/05/21857/RWB6IZv9Ka.gif!large" alt="Redis 执行 Lua 脚本替代 SETNX / DECR 保证原子性"></p>
<p>非常稳啊，1 秒钟通过 1 个请求。</p>
<p>我们的开发同学也就是经过了上述测试才放心把代码发上线的，咋一上线就炸了呢？</p>
<h2 id="原因">原因</h2>
<p>我们来看下面一段操作，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh"><span style="color:#f92672">[</span>root@e98dffb83384 src<span style="color:#f92672">]</span><span style="color:#75715e"># ./redis-cli</span>
127.0.0.1:6379&gt; SETNX k <span style="color:#ae81ff">1</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">1</span>
127.0.0.1:6379&gt; EXPIRE k <span style="color:#ae81ff">10</span> <span style="color:#75715e"># 为了方便演示，这里设置 10 秒过期时间</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">1</span>
127.0.0.1:6379&gt; DECR k <span style="color:#75715e"># 在过期时间内，第一次扣减成 0</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">0</span>
127.0.0.1:6379&gt; DECR k <span style="color:#75715e"># 继续扣减成 -1</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> -1
127.0.0.1:6379&gt; DECR k <span style="color:#75715e"># 继续扣减成 -2</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> -2
127.0.0.1:6379&gt; TTL k <span style="color:#75715e"># k 还有 2 秒过期</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">2</span>
127.0.0.1:6379&gt; DECR k <span style="color:#75715e"># 继续扣减成 -3</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> -3
127.0.0.1:6379&gt; TTL k <span style="color:#75715e"># 距离设置过期时间 10 秒之后，k 已经过期</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> -2
127.0.0.1:6379&gt; DECR k <span style="color:#75715e"># 这时候再扣减发现 k 的值被扣减成 -1</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> -1
127.0.0.1:6379&gt; DECR k <span style="color:#75715e"># 继续扣减成 -2</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> -2
127.0.0.1:6379&gt; TTL k <span style="color:#75715e"># 查看 k 过期时间是永不过期</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> -1
127.0.0.1:6379&gt; SETNX k <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 再设置是不成功的</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> <span style="color:#ae81ff">0</span>
127.0.0.1:6379&gt; DECR k <span style="color:#75715e"># 继续扣减成 -3</span>
<span style="color:#f92672">(</span>integer<span style="color:#f92672">)</span> -3
</code></pre></div><p>在 Redis key 未过期之前，DECR 命令都是正常扣减的。一旦 key 过期了，再执行 DECR 命令，会发现 key 的值和过期时间都变为 -1 了。</p>
<p>Redis 官网对 DECR 命令介绍里有这么一段：</p>
<pre tabindex="0"><code>Decrements the number stored at key by one.
If the key does not exist, it is set to 0 before performing the operation.
</code></pre><p>对于出问题的代码，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$redisHandler<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rateLimitKey</span>, $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">tokenNum</span>, [<span style="color:#e6db74">&#39;nx&#39;</span>, <span style="color:#e6db74">&#39;ex&#39;</span> <span style="color:#f92672">=&gt;</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">expireTime</span>]);
$leftTokenNum <span style="color:#f92672">=</span> $redisHandler<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">decr</span>($this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">rateLimitKey</span>);
</code></pre></div><p>假设在第一句 SETNX 之后第二句 DECR 之前，key 过期了，再执行 DECR 就会先生成一个永不过期值为 0 的 key。</p>
<p>之后所有请求的 SETNX 都是 fasle，一直会基于这个永不过期的 key 进行递减，所有的 $leftTokenNum 都小于 0，因此导致所有请求被限流。</p>
<h2 id="问题复现">问题复现</h2>
<p>自测时为啥发现不了问题？因为自测时设置的过期时间是 1 秒，导致 key 在两步之间过期出现的概率很小。我们只要将过期时间调的足够小，很容易复现问题。</p>
<p>把过期时间改为 5 毫秒，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$redis <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Redis</span>();
$redis<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">connect</span>(<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">6379</span>);

$key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;test_redis_key&#39;</span>;
$redis<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">set</span>($key, <span style="color:#e6db74">&#39;3&#39;</span>, [<span style="color:#e6db74">&#39;nx&#39;</span>, <span style="color:#e6db74">&#39;px&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">5</span>]); <span style="color:#75715e">// key 设置成 5 毫秒过期
</span><span style="color:#75715e"></span>$left <span style="color:#f92672">=</span> $redis<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">decr</span>($key);

<span style="color:#66d9ef">if</span> ($left <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
    <span style="color:#75715e">// 这里通过状态码来更方便的观察
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Is-Limited:1&#39;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#ae81ff">500</span>);
} <span style="color:#66d9ef">else</span> {
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Is-Limited:0&#39;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#ae81ff">200</span>);
}
</code></pre></div><p>依然使用 siege 压测：</p>
<p><img src="https://cdn.learnku.com/uploads/images/202001/05/21857/bRyFKd010f.gif!large" alt="Redis 执行 Lua 脚本替代 SETNX / DECR 保证原子性"></p>
<p>由于设置的 5 毫秒放行一个请求，因此前半部分基本上都是通过的请求，偶尔有几个限流的，这是正常的。
但是没过多久，所有请求都被限流了，也就复现了线上的故障。</p>
<h2 id="解决方案">解决方案</h2>
<p>如何改进代码来正确的实现限流呢？</p>
<p>Redis 的 <code>EVAL</code> 命令 执行 Lua 脚本时可以保证原子性。</p>
<pre tabindex="0"><code>Atomicity of scripts

Redis uses the same Lua interpreter to run all the commands. Also Redis guarantees that a script is executed in an atomic way: no other script or Redis command will be executed while a script is being executed.
</code></pre><p><code>EVAL</code> 命令的格式为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">EVAL script numkeys key <span style="color:#f92672">[</span>key ...<span style="color:#f92672">]</span> arg <span style="color:#f92672">[</span>arg ...<span style="color:#f92672">]</span>
</code></pre></div><p>例子：</p>
<pre tabindex="0"><code>&gt; eval &quot;return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}&quot; 2 key1 key2 first second

1.  &quot;key1&quot;
2.  &quot;key2&quot;
3.  &quot;first&quot;
4.  &quot;second&quot;
</code></pre><p>我们可以借助 Lua 脚本来避免 SETNX 和 DECR 之间会出现过期的尴尬情况。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php">$redis <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Redis</span>();
$redis<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">connect</span>(<span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, <span style="color:#ae81ff">6379</span>);

$key <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;test_redis_key1&#39;</span>;

$script <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;&lt;&lt;</span><span style="color:#e6db74">LUA</span><span style="color:#e6db74">
</span><span style="color:#e6db74">local max = tonumber(ARGV[1])
</span><span style="color:#e6db74">local interval_milliseconds = tonumber(ARGV[2])
</span><span style="color:#e6db74">local current = tonumber(redis.call(&#39;get&#39;, KEYS[1]) or 0)
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">if (current + 1 &gt; max) then
</span><span style="color:#e6db74">    return true
</span><span style="color:#e6db74">else
</span><span style="color:#e6db74">    redis.call(&#39;incrby&#39;, KEYS[1], 1)
</span><span style="color:#e6db74">    if (current == 0) then
</span><span style="color:#e6db74">        redis.call(&#39;pexpire&#39;, KEYS[1], interval_milliseconds)
</span><span style="color:#e6db74">    end
</span><span style="color:#e6db74">    return false
</span><span style="color:#e6db74">end
</span><span style="color:#e6db74"></span><span style="color:#e6db74">LUA</span>;

$redis<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">script</span>(<span style="color:#e6db74">&#39;load&#39;</span>, $script);
$isLimited <span style="color:#f92672">=</span> $redis<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">eval</span>($script, [$key, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">5</span>], <span style="color:#ae81ff">1</span>); <span style="color:#75715e">// key 5 毫秒过期
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">if</span> ($isLimited) {
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Is-Limited:1&#39;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#ae81ff">500</span>);
} <span style="color:#66d9ef">else</span> {
    <span style="color:#a6e22e">header</span>(<span style="color:#e6db74">&#39;Is-Limited:0&#39;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#ae81ff">200</span>);
}
</code></pre></div><p>依然使用 siege 压测，</p>
<p><img src="https://cdn.learnku.com/uploads/images/202001/05/21857/t1DULIxU6G.gif!large" alt="Redis 执行 Lua 脚本替代 SETNX / DECR 保证原子性"></p>
<p>持续压了 10 多分钟也没出现之前问题，问题得以解决。</p>
<h2 id="总结">总结</h2>
<ul>
<li>Redis 中 DECR 一个不存在的 key 会先把 key 值设置为 0 , TTL 设置为 -1 (永不过期)，再进行减 1 操作。</li>
<li>使用 SETNX 配合 DECR 实现限流，会出现 key 永不过期情况。过期时间比较小或者高并发情况下，发生概率更高。</li>
<li>在 Redis 中执行 Lua 脚本是原子操作。</li>
<li>可以通过 Redis + Lua 实现高并发下的限流。</li>
</ul>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/blog/seckill/nodejs-case/" aria-label="Previous - Node.js 中实践基于 Redis 的分布式锁实现" class="btn btn-primary"><span class="mr-1">←</span>Previous</a>
  </li>
    <a href="/blog/seckill/example/" aria-label="Next - 一个使用 Node.js 的 Redlock 示例，关于如何锁定一个Redis上的密钥对" class="btn btn-primary">Next<span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        
        
	
		<p class="mt-2"><a href="/docs/lua/about/">关于</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.5c6c35925cba6ccdfc94d3ef0a1ff539934a08075c0931f2c9ab70249877b310.js" integrity="sha256-XGw1kly6bM38lNPvCh/1OZNKCAdcCTHyyatwJJh3sxA=" crossorigin="anonymous"></script>




  </body>
</html>