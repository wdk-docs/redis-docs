<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.88.1" />
<meta name="robots" content="index, follow">


<link rel="shortcut icon" href="/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/favicons/android-192x192.png" sizes="192x192">

<title>Implementation of redis distributed lock | redis-docs</title>
<meta name="description" content="
https://developpaper.com/implementation-of-redis-distributed-lock/

Many novices will Distributed lock and Distributed transactionConfusion, personal …">
<meta property="og:title" content="Implementation of redis distributed lock" />
<meta property="og:description" content="https://developpaper.com/implementation-of-redis-distributed-lock/
 Many novices will Distributed lock and Distributed transactionConfusion, personal understanding:lock It is used to solve the concurrent contention for a shared resource by multiple programs;affair It is used to ensure the consistency of a series of operations. I’ve explained distributed transactions in several previous articles. I’m going to talk about the implementation of 2pc, TCC and asynchronous assurance schemes.
1. 定义 In the traditional monomer architecture, the most common lock is JDK lock." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/blog/seckill/implementation-of-redis-distributed-lock/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-01-08T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-01-08T00:00:00+00:00" />

<meta itemprop="name" content="Implementation of redis distributed lock">
<meta itemprop="description" content="https://developpaper.com/implementation-of-redis-distributed-lock/
 Many novices will Distributed lock and Distributed transactionConfusion, personal understanding:lock It is used to solve the concurrent contention for a shared resource by multiple programs;affair It is used to ensure the consistency of a series of operations. I’ve explained distributed transactions in several previous articles. I’m going to talk about the implementation of 2pc, TCC and asynchronous assurance schemes.
1. 定义 In the traditional monomer architecture, the most common lock is JDK lock."><meta itemprop="datePublished" content="2021-01-08T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-01-08T00:00:00+00:00" />
<meta itemprop="wordCount" content="3469">
<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Implementation of redis distributed lock"/>
<meta name="twitter:description" content="https://developpaper.com/implementation-of-redis-distributed-lock/
 Many novices will Distributed lock and Distributed transactionConfusion, personal understanding:lock It is used to solve the concurrent contention for a shared resource by multiple programs;affair It is used to ensure the consistency of a series of operations. I’ve explained distributed transactions in several previous articles. I’m going to talk about the implementation of 2pc, TCC and asynchronous assurance schemes.
1. 定义 In the traditional monomer architecture, the most common lock is JDK lock."/>




<link rel="preload" href="/scss/main.scss" as="style">
<link href="/scss/main.scss" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">
		<span class="navbar-logo"></span><span class="text-uppercase font-weight-bold">redis-docs</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="/docs/" ><span>文档</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="/blog/" ><span class="active">博客</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"></div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
            
<div id="td-sidebar-menu" class="td-sidebar__inner">
  <form class="td-sidebar__search d-flex align-items-center">
    
    <button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type="button" data-toggle="collapse" data-target="#td-section-nav" aria-controls="td-docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    </button>
  </form>
  <nav class="collapse td-sidebar-nav" id="td-section-nav">
    <ul class="td-sidebar-nav__section pr-md-3 ul-0">
      <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-blog-li">
  <a href="/blog/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id="m-blog"><span class="">博客</span></a>
  <ul class="ul-1">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-blognews-li">
  <a href="/blog/news/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blognews"><span class="">news</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id="m-blognewslua-li">
  <a href="/blog/news/lua/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blognewslua"><span class="">Lua News</span></a>
  <ul class="ul-3 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blognewslua2020-2021-li">
  <a href="/blog/news/lua/2020-2021/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blognewslua2020-2021"><span class="">2020-2021 Lua News</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blognewslua2010-2019-li">
  <a href="/blog/news/lua/2010-2019/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blognewslua2010-2019"><span class="">2010-2019 Lua News</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blognewslua2000-2009-li">
  <a href="/blog/news/lua/2000-2009/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blognewslua2000-2009"><span class="">2000-2009 Lua News</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blognewslua1993-1999-li">
  <a href="/blog/news/lua/1993-1999/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blognewslua1993-1999"><span class="">1993-1999 Lua News</span></a>
</li>
  </ul>
</li>
  </ul>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id="m-blogseckill-li">
  <a href="/blog/seckill/" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id="m-blogseckill"><span class="">秒杀</span></a>
  <ul class="ul-2 foldable">
    <li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillredlock-system-awareness-li">
  <a href="/blog/seckill/redlock-system-awareness/" title="建立对分布式锁的系统认知 - 从 Redlock 开始" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillredlock-system-awareness"><span class="">分布式锁系统认知</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id="m-blogseckillimplementation-of-redis-distributed-lock-li">
  <a href="/blog/seckill/implementation-of-redis-distributed-lock/" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id="m-blogseckillimplementation-of-redis-distributed-lock"><span class="td-sidebar-nav-active-item">Implementation of redis distributed lock</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillexample-li">
  <a href="/blog/seckill/example/" title="一个使用 Node.js 的 Redlock 示例，关于如何锁定一个Redis上的密钥对" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillexample"><span class="">Redlok 示例</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillreplace_setnx-li">
  <a href="/blog/seckill/replace_setnx/" title="Redis 使用 Lua 脚本替代 SETNX / DECR 保证原子性" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillreplace_setnx"><span class="">替代 SETNX/DECR</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillnodejs-case-li">
  <a href="/blog/seckill/nodejs-case/" title="Node.js 中实践基于 Redis 的分布式锁实现" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillnodejs-case"><span class="">分布式锁实现</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillnodejs-redis-lua-li">
  <a href="/blog/seckill/nodejs-redis-lua/" title="Node.js 中实践 Redis Lua 脚本" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillnodejs-redis-lua"><span class="">Node.js Redis Lua</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillis_redlock_safe-li">
  <a href="/blog/seckill/is_redlock_safe/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillis_redlock_safe"><span class="">Is Redlock safe?</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckilldistlock-li">
  <a href="/blog/seckill/distlock/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckilldistlock"><span class="">Redis分布式锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillhow-to-do-distributed-locking-li">
  <a href="/blog/seckill/how-to-do-distributed-locking/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillhow-to-do-distributed-locking"><span class="">How to do distributed locking</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillredis_lua-li">
  <a href="/blog/seckill/redis_lua/" title="Redis&#43;Lua 解决高并发场景抢购秒杀问题" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillredis_lua"><span class="">Redis&#43;Lua秒杀</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckilldistlock-cn-li">
  <a href="/blog/seckill/distlock-cn/" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckilldistlock-cn"><span class="">Redis分布式锁</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillaliyun-li">
  <a href="/blog/seckill/aliyun/" title="使用  搭建电商秒杀系统" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillaliyun"><span class="">Redis秒杀系统</span></a>
</li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id="m-blogseckillredlock-controversy-li">
  <a href="/blog/seckill/redlock-controversy/" title="Redis Redlock 的争论" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id="m-blogseckillredlock-controversy"><span class="">Redlock 争论</span></a>
</li>
  </ul>
</li>
  </ul>
</li>
    </ul>
  </nav>
</div>

          </aside>
          <aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
            
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">

</div>

            


<div class="td-toc"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-定义">1. 定义</a></li>
    <li><a href="#2-分布式锁的比较">2. 分布式锁的比较</a>
      <ul>
        <li><a href="#对比">对比</a></li>
        <li><a href="#锁的必要条件">锁的必要条件</a></li>
      </ul>
    </li>
    <li><a href="#3-redis-实现分布式锁">3. Redis 实现分布式锁</a>
      <ul>
        <li><a href="#31-锁">3.1. 锁</a></li>
        <li><a href="#32-解锁">3.2. 解锁</a></li>
        <li><a href="#33-lua">3.3. lua</a></li>
        <li><a href="#34-限制和改善">3.4. 限制和改善</a></li>
      </ul>
    </li>
    <li><a href="#4-oversold-示例代码">4. “Oversold” 示例代码</a>
      <ul>
        <li><a href="#41-代码">4.1. 代码</a></li>
        <li><a href="#table-structure">Table structure</a></li>
        <li><a href="#42-测试和分析">4.2. 测试和分析</a></li>
      </ul>
    </li>
  </ul>
</nav></div>



            

	
		



  
  

	
		



  
  

	

          </aside>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
            <a class="btn btn-lg -bg-orange td-rss-button d-none d-lg-block" href="http://example.org/blog/seckill/index.xml" target="_blank">
              RSS <i class="fa fa-rss ml-2 "></i>
            </a>
            
<div class="td-content">
	<h1>Implementation of redis distributed lock</h1>
	
	<div class="td-byline mb-4">
		By <b>developpaper</b> |
		<time datetime="2021-01-08" class="text-muted">Friday, January 08, 2021</time>
	</div>
	<header class="article-meta">
		
		
			
				


			
				


			
		
		
	</header>
	<blockquote>
<p><a href="https://developpaper.com/implementation-of-redis-distributed-lock/">https://developpaper.com/implementation-of-redis-distributed-lock/</a></p>
</blockquote>
<p>Many novices will Distributed lock and Distributed transactionConfusion, personal understanding:lock
It is used to solve the concurrent contention for a shared resource by multiple programs;affair
It is used to ensure the consistency of a series of operations.
I’ve explained distributed transactions in several previous articles.
I’m going to talk about the implementation of 2pc, TCC and asynchronous assurance schemes.</p>
<h2 id="1-定义">1. 定义</h2>
<p>In the traditional monomer architecture, the most common lock is JDK lock.
Because the thread is the smallest unit that the operating system can run and schedule,
in Java multithreading development, it is inevitable that different threads compete for resources in the same process.
JDK library provides us with synchronized, lock and update java.util.concurrent . * etc.
However, they all have unified restrictions. Threads competing for resources are all running in the same JVM process.
In the distributed architecture, different JVM processes cannot use the lock.</p>
<p>In order to prevent multiple processes from interfering with each other in a distributed system,
we need a distributed coordination technology to schedule these processes.
And the core of this distributed coordination technology is to achieve thisDistributed lock。</p>
<p>Take a classic example of “oversold”.
In an e-commerce project, the logic of the interface can be simply divided into:</p>
<ol>
<li>Query whether the inventory is greater than zero;</li>
<li>When the inventory is greater than zero, purchase the goods.</li>
</ol>
<p>When there is only one piece in stock, both user a and user B execute the first step at the same time,
query that the inventory is one piece, and then both execute the purchase operation.
When they finished the purchase,they found that the inventory was – 1 piece.
We can lock the operations of “inventory query” and “inventory reduction” in Java code to ensure that the requests of users a and B cannot be executed concurrently.
But if our interface service is a cluster service, and the requests of user a and user B are respectively forwarded to different JVM processes by load balancing, it will not solve the problem.</p>
<h2 id="2-分布式锁的比较">2. 分布式锁的比较</h2>
<p>From the previous examples, we can see that the resource to coordinate and solve distributed locks must not be a resource at the level of the JVM process, but a shared external resource.</p>
<p>Three ways of implementation</p>
<p>There are three common ways to implement distributed lock: 1. Database lock; 2. Zookeeper based distributed lock; 3. Redis based distributed lock.</p>
<ol>
<li><strong>Database lock</strong>:
This way is easy to think of, put the competing resources into the database,
and use the database lock to realize the resource competition.
Please refer to the previous articleDatabase transactions and locks。
For example:
<ol>
<li>Pessimistic lock implementation: the “for update” can be added to the SQL query of inventory goods to achieve exclusive lock,
and the “inventory query” and “inventory reduction” can be packaged as a transaction commit.
Before the completion of user a’s query and purchase, user B’s request will be blocked.</li>
<li>Optimistic lock implementation: add the version number field in the inventory table to control.
Or more simply, when the inventory is less than zero after each purchase, the transaction can be rolled back.</li>
</ol>
</li>
<li><strong>Distributed lock of zookeeper</strong>:
zookeeper is professional in implementing distributed locks.
It is similar to a file system. It plays the role of distributed lock by competing for file resources on the file system.
Specific implementation, please refer to the previous articleDevelopment and application of zookeeper。</li>
<li><strong>Distributed lock of redis</strong>:
the previous article talked about the development,
application and transaction of redis, but never about the distributed lock of redis,
which is also the core content of this article. In short,
throughsetnxThe value of the competing key.
“Database lock” competes for table level resources or row level resources,
“zookeeper lock” competes for file resources, “redis lock” competes for key value resources.
They all implement distributed locks by competing for shared resources outside the program.</li>
</ol>
<h3 id="对比">对比</h3>
<p>However, in the field of distributed locks, zookeeper is more professional.
In essence, redis is also a database.
All the other two schemes are “part-time” to implement distributed locking, and the effect is not as good as zookeeper.</p>
<ul>
<li>Low performance consumption: when concurrent lock competition really occurs,
the implementation of database or redis basically obtains locks by blocking or constantly retrying,
which has a certain performance consumption. The zookeeper lock registers the listener.
When a program releases the lock, the next program gets the lock after listening to the message.</li>
<li>Perfect lock release mechanism: if the client from which redis obtains the lock is bugged or hung up,
it can only release the lock after the timeout; while for ZK,
because the temporary znode is created, as long as the client hangs up, the znode will be gone,
and the lock will be released automatically.</li>
<li>Strong consistency of cluster: as we all know,
zookeeper is a typical case of implementing CP transaction,
and the transaction request is always handled by the leader node in the cluster.
Redis actually implements AP transactions. If the master node fails and the master-slave switch occurs,
the lock may be lost.</li>
</ul>
<h3 id="锁的必要条件">锁的必要条件</h3>
<p>In addition, in order to ensure the availability of distributed locks,
we should at least ensure that the implementation of locks meets the following conditions at the same time:</p>
<ul>
<li>Mutual exclusion. At any time, only one client can hold the lock.</li>
<li>There is no deadlock. Even if one client crashes while holding the lock and does not unlock it,
it can ensure that other clients can lock.</li>
<li>It is necessary to tie the bell. Locking and unlocking must be the same client.
The client can’t unlock the lock added by others.</li>
</ul>
<h2 id="3-redis-实现分布式锁">3. Redis 实现分布式锁</h2>
<h3 id="31-锁">3.1. 锁</h3>
<p>Correct locking</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisTool</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String LOCK_SUCCESS <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;OK&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SET_IF_NOT_EXIST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;NX&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SET_WITH_EXPIRE_TIME <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;PX&#34;</span><span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     *Attempt to acquire distributed lock
</span><span style="color:#75715e">     *@ param jedis redis client
</span><span style="color:#75715e">     *@ param lockkey lock
</span><span style="color:#75715e">     *@ param requestid request ID
</span><span style="color:#75715e">     *@ param expireTime
</span><span style="color:#75715e">     *Is @ return successful
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">tryGetDistributedLock</span><span style="color:#f92672">(</span>Jedis jedis<span style="color:#f92672">,</span> String lockKey<span style="color:#f92672">,</span> String requestId<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> expireTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        String result <span style="color:#f92672">=</span> jedis<span style="color:#f92672">.</span><span style="color:#a6e22e">set</span><span style="color:#f92672">(</span>lockKey<span style="color:#f92672">,</span> requestId<span style="color:#f92672">,</span> SET_IF_NOT_EXIST<span style="color:#f92672">,</span> SET_WITH_EXPIRE_TIME<span style="color:#f92672">,</span> expireTime<span style="color:#f92672">);</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>LOCK_SUCCESS<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>result<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>To see, we lock a line of code:jedis.set(String key, String value, String nxxx, String expx, int time)This set () method has five formal parameters:</p>
<ul>
<li>key: we use the key as the lock, because the key is unique.</li>
<li>value: we are passing a request ID. many children’s shoes may not understand it. It’s enough to have a key as a lock. Why use value? The reason is that when we talked about reliability above, the distributed lock needs to satisfy the fourth condition, and it needs to be released by the ringer. By assigning value to requestid, we can know which request the lock was added, and we can have a basis when unlocking. The requestid can be used UUID.randomUUID (). Tostring() method.</li>
<li>Nxxx: for this parameter, we fill in NX, which means set if not exist. That is, when the key does not exist, we perform set operation; if the key already exists, we do not perform any operation;</li>
<li>EXPX: this parameter is Px, which means that we need to add an expired setting to the key. The specific time is determined by the fifth parameter.</li>
<li>time: corresponds to the fourth parameter, representing the expiration time of the key.</li>
</ul>
<p>In general, executing the above set () method will only result in two results:</p>
<p>If there is no lock at present (the key does not exist), lock operation will be performed, and a validity period will be set for the lock. At the same time, value indicates the locked client.
There is a lock, no operation.
Not recommended locking method (not recommended!)</p>
<p>I’ve seen many blogs that use the following method to lock, that is, the combination of setnx and GetSet to manually maintain the key expiration time.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">wrongGetLock2</span><span style="color:#f92672">(</span>Jedis jedis<span style="color:#f92672">,</span> String lockKey<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> expireTime<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">long</span> expires <span style="color:#f92672">=</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> expireTime<span style="color:#f92672">;</span>
    String expiresStr <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>expires<span style="color:#f92672">);</span>

    <span style="color:#75715e">//If the current lock does not exist, return to lock success
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>jedis<span style="color:#f92672">.</span><span style="color:#a6e22e">setnx</span><span style="color:#f92672">(</span>lockKey<span style="color:#f92672">,</span> expiresStr<span style="color:#f92672">)</span> <span style="color:#f92672">==</span> 1<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">//If the lock exists, get the expiration time of the lock
</span><span style="color:#75715e"></span>    String currentValueStr <span style="color:#f92672">=</span> jedis<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>lockKey<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>currentValueStr <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> Long<span style="color:#f92672">.</span><span style="color:#a6e22e">parseLong</span><span style="color:#f92672">(</span>currentValueStr<span style="color:#f92672">)</span> <span style="color:#f92672">&lt;</span> System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//The lock has expired. Get the expiration time of the previous lock and set the expiration time of the current lock
</span><span style="color:#75715e"></span>        String oldValueStr <span style="color:#f92672">=</span> jedis<span style="color:#f92672">.</span><span style="color:#a6e22e">getSet</span><span style="color:#f92672">(</span>lockKey<span style="color:#f92672">,</span> expiresStr<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>oldValueStr <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> oldValueStr<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>currentValueStr<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">//Considering the concurrency of multiple threads, only one thread has the right to lock if its setting value is the same as the current value
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#75715e">//In other cases, the locking failure will be returned
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>On the surface, this code also implements distributed locking, and the code logic is similar to the above, but there are several problems:</p>
<p>Since the expiration time is generated by the client itself, it is mandatory that the time of each client must be synchronized in the distributed environment.
When the lock expires, if multiple clients execute it at the same time jedis.getSet () method, although only one client can lock, the expiration time of this client’s lock may be covered by other clients.
The lock does not have the owner ID, that is, any client can be unlocked.
This kind of code on the Internet may be based on the earlier versions of jedis, which had great limitations at that time. Redis 2.6.12 and above adds optional parameters to the set instruction, as mentioned abovejedis.set(String key, String value, String nxxx, String expx, int time)API, you can put theSETNXandEXPIREPackage together to execute, and release the expired key to the redis server to manage. Therefore, the actual development process, we do not use this more primitive way of locking.</p>
<h3 id="32-解锁">3.2. 解锁</h3>
<p>Correct locking</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisTool</span> <span style="color:#f92672">{</span>

    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> Long RELEASE_SUCCESS <span style="color:#f92672">=</span> 1L<span style="color:#f92672">;</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     *Release distributed lock
</span><span style="color:#75715e">     *@ param jedis redis client
</span><span style="color:#75715e">     *@ param lockkey lock
</span><span style="color:#75715e">     *@ param requestid request ID
</span><span style="color:#75715e">     *@ return is released successfully
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">releaseDistributedLock</span><span style="color:#f92672">(</span>Jedis jedis<span style="color:#f92672">,</span> String lockKey<span style="color:#f92672">,</span> String requestId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>

        String script <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&#34;</span><span style="color:#f92672">;</span>
        Object result <span style="color:#f92672">=</span> jedis<span style="color:#f92672">.</span><span style="color:#a6e22e">eval</span><span style="color:#f92672">(</span>script<span style="color:#f92672">,</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonList</span><span style="color:#f92672">(</span>lockKey<span style="color:#f92672">),</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonList</span><span style="color:#f92672">(</span>requestId<span style="color:#f92672">));</span>

        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>RELEASE_SUCCESS<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>result<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
        <span style="color:#f92672">}</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>First, get the value value corresponding to the lock, check whether it is equal to the requestid, if it is equal, delete the lock (unlock). So why use Lua? Because to ensure that the operation is atomic. BeforeThread model and transaction of redisIn this paper, we ensure the atomicity of a series of operation instructions through transaction, and Lua script can also achieve similar effect.</p>
<p>Why atomic? If a request obtains the value corresponding to the lock and verifies that the requestid is equal, it will issue a delete instruction. But because of the network and other reasons, the deletion instruction is blocked. At this time, the lock is automatically unlocked because of timeout, and B requests to acquire the lock and re lock it. At this time, a requests the deletion instruction to be executed. As a result, the lock obtained by B requests is deleted.</p>
<h3 id="33-lua">3.3. lua</h3>
<p>The computing power of redis command is not very powerful, and Lua language can make up for the deficiency of redis to a great extent. In redis, the execution of Lua language is atomic, that is to say, when redis executes Lua, it will not be interrupted and has atomicity. This feature helps redis to support the consistency of concurrent data.</p>
<p>Redis supports two ways to run scripts, one is to input some Lua language program code directly, the other is to write Lua language into a file. In practical application, some simple scripts can take the first way, and generally use the second way for those with certain logic. For simple scripts, redis supports caching scripts, but it will use SHA-1 algorithm to sign the script, and then return the SHA-1 ID, as long as it runs through this ID.</p>
<h4 id="executing-lua-in-redis">Executing Lua in redis</h4>
<p>Here is a brief introduction. The way to directly input some Lua program code can be performed in redis cli as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua">eval lua<span style="color:#f92672">-</span>script key<span style="color:#f92672">-</span>num [key1 key2 key3 ....] [value1 value2 value3 ....]

<span style="color:#75715e">--Example 1</span>
eval <span style="color:#e6db74">&#34;return &#39;Hello World&#39;&#34;</span> <span style="color:#ae81ff">0</span>
<span style="color:#75715e">--Example 2</span>
eval <span style="color:#e6db74">&#34;redis.call(&#39;set&#39;,KEYS[1],ARGV[1])&#34;</span> <span style="color:#ae81ff">1</span> lua<span style="color:#f92672">-</span>key lua<span style="color:#f92672">-</span>value
</code></pre></div><ul>
<li>evalRepresents the execution of Lua language commands.</li>
<li>lua-scriptRepresents Lua language script.</li>
<li>key-numIt indicates how many keys there are in the parameter. It should be noted that the key in redis starts from 1. If there is no key parameter, write 0.</li>
<li>[key1 key2 key3…]Key is passed to Lua as a parameter, which can be left blank, but it needs to be corresponding to the number of key num.</li>
<li>[value1 value2 value3 …]These parameters are passed to Lua language. They can be filled in or not.</li>
</ul>
<h4 id="calling-redis-in-lua">Calling redis in Lua</h4>
<p>Using in Lua redis.call Do the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua">redis.call(command,key[param1, param2<span style="color:#960050;background-color:#1e0010">…</span>])

<span style="color:#75715e">--Example 1</span>
eval <span style="color:#e6db74">&#34;return redis.call(&#39;set&#39;,&#39;foo&#39;,&#39;bar&#39;)&#34;</span> <span style="color:#ae81ff">0</span>
<span style="color:#75715e">--Example 2</span>
eval <span style="color:#e6db74">&#34;return redis.call(&#39;set&#39;,KEYS[1],&#39;bar&#39;)&#34;</span> <span style="color:#ae81ff">1</span> foo
</code></pre></div><ul>
<li>commandIs the command, including set, get, del and so on.</li>
<li>keyIs the key to be operated.</li>
<li>param1,param2…Represents the parameter given to the key.</li>
</ul>
<p>For example, implement a Lua script for GetSet</p>
<p>getset.lua</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-lua" data-lang="lua"><span style="color:#66d9ef">local</span> key <span style="color:#f92672">=</span> KEYS[<span style="color:#ae81ff">1</span>]
<span style="color:#66d9ef">local</span> newValue <span style="color:#f92672">=</span> ARGV[<span style="color:#ae81ff">1</span>]
<span style="color:#66d9ef">local</span> oldValue <span style="color:#f92672">=</span> redis.call(<span style="color:#e6db74">&#39;get&#39;</span>, key)
redis.call(<span style="color:#e6db74">&#39;set&#39;</span>, key, newValue)
<span style="color:#66d9ef">return</span> oldValue
</code></pre></div><h3 id="34-限制和改善">3.4. 限制和改善</h3>
<p>As we said earlier, there are some limitations in the implementation of distributed lock in redis cluster. It is difficult to ensure consistency when the master and slave are replaced.</p>
<h4 id="phenomenon">phenomenon</h4>
<p>In the redis sentinel cluster, we have multiple redis, and there is a master-slave relationship between them, such as one master and two slaves. The data corresponding to our set command is written to the master library, and then synchronized to the slave library. When we apply for a lock, the corresponding command is setnx MyKey myvalue. In the redis sentinel cluster, this command first falls into the main library. Suppose that the master database is down and the data has not yet been synchronized to the slave database, sentinel will elect the master database from one of the slave databases. At this time, there is no MyKey data in our new main library. If another client executes setnx MyKey hisvalue, it will also succeed, that is, it will also get the lock. This means that two clients have acquired the lock. This is not what we want to see. Although the record of this situation is very small, it will only happen when the master-slave fails over. In most cases, most systems can tolerate this flaw, but not all systems can tolerate it.</p>
<h4 id="solve">solve</h4>
<p>In order to solve the defect in the case of fail over, anterez inventedRedlock algorithm。 Using redlock algorithm, multiple redis instances are needed. When locking, it will send setex MyKey myvalue command to most nodes, as long asIf more than half of the nodes are successful, then the locking is successful。 This is very similar to the zookeeper implementation,When the leader of zookeeper cluster broadcasts the command, more than half of the followers must feed back ack to the leader before it takes effect。</p>
<p>In practical work, we can choose the existing open source implementation, which is redlock py in Python and redlock py in JavaRedisson redlock。</p>
<p>Redlock does solve the “unreliable situation” mentioned above. However, while it solves the problem, it also brings the cost. You need multiple redis instances, you need to introduce new libraries, you need to adjust the code, and the performance will be damaged. Therefore, it is true that there is no “perfect solution”. What we need more is to be able to solve the problem according to the actual situation and conditions.</p>
<h2 id="4-oversold-示例代码">4. “Oversold” 示例代码</h2>
<p>We simulate a scene of goods rush buying: a commodity has 100 pieces in stock,
and 200 people rush to buy at the same time.
Compare the rush buying situation with lock and without lock.</p>
<h3 id="41-代码">4.1. 代码</h3>
<p>The following is the code of this demo. ORM uses JPA, so the code of Dao layer and POJO is not written in this article. There is only one interface in the controller layer, which selects whether to use the lock by passing parameters.</p>
<h3 id="table-structure">Table structure</h3>
<p>Commodity listproduct</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>product<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>name<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">255</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>amount<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
)
</code></pre></div><p>Purchase recordpurchase_history</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sql" data-lang="sql"><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>purchase_history<span style="color:#f92672">`</span> (
  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> int <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
  <span style="color:#f92672">`</span>product_name<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">255</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>purchaser<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">255</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>purchase_time<span style="color:#f92672">`</span> datetime <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#f92672">`</span>amount<span style="color:#f92672">`</span> int <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span>,
  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
)
</code></pre></div><p>pom.xml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#f92672">&lt;dependencies&gt;</span>
    <span style="color:#75715e">&lt;!--web--&gt;</span>
    <span style="color:#f92672">&lt;dependency&gt;</span>
        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#75715e">&lt;!--redis--&gt;</span>
    <span style="color:#f92672">&lt;dependency&gt;</span>
        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#75715e">&lt;!--lombok--&gt;</span>
    <span style="color:#f92672">&lt;dependency&gt;</span>
        <span style="color:#f92672">&lt;groupId&gt;</span>org.projectlombok<span style="color:#f92672">&lt;/groupId&gt;</span>
        <span style="color:#f92672">&lt;artifactId&gt;</span>lombok<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#75715e">&lt;!--jpa--&gt;</span>
    <span style="color:#f92672">&lt;dependency&gt;</span>
        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-data-jpa<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#75715e">&lt;!--mysql--&gt;</span>
    <span style="color:#f92672">&lt;dependency&gt;</span>
        <span style="color:#f92672">&lt;groupId&gt;</span>mysql<span style="color:#f92672">&lt;/groupId&gt;</span>
        <span style="color:#f92672">&lt;artifactId&gt;</span>mysql-connector-java<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#75715e">&lt;!-- test--&gt;</span>
    <span style="color:#f92672">&lt;dependency&gt;</span>
        <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
        <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#f92672">&lt;/artifactId&gt;</span>
        <span style="color:#f92672">&lt;scope&gt;</span>test<span style="color:#f92672">&lt;/scope&gt;</span>
    <span style="color:#f92672">&lt;/dependency&gt;</span>
    <span style="color:#f92672">&lt;dependency&gt;</span>
        <span style="color:#f92672">&lt;groupId&gt;</span>junit<span style="color:#f92672">&lt;/groupId&gt;</span>
        <span style="color:#f92672">&lt;artifactId&gt;</span>junit<span style="color:#f92672">&lt;/artifactId&gt;</span>
    <span style="color:#f92672">&lt;/dependency&gt;</span>
<span style="color:#f92672">&lt;/dependencies&gt;</span>
</code></pre></div><p>application.yml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yml" data-lang="yml"><span style="color:#f92672">server</span>:
  <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8001</span>
<span style="color:#f92672">spring</span>:
  <span style="color:#f92672">redis</span>:
    <span style="color:#f92672">host</span>: <span style="color:#ae81ff">localhost</span>
    <span style="color:#f92672">port</span>: <span style="color:#ae81ff">6379</span>
 <span style="color:#f92672">datasource</span>:
    <span style="color:#f92672">driver-class-name</span>: <span style="color:#ae81ff">com.mysql.cj.jdbc.Driver</span>
    <span style="color:#f92672">url</span>: <span style="color:#ae81ff">jdbc:mysql://localhost:3306/demo</span>
    <span style="color:#f92672">username</span>: <span style="color:#ae81ff">root</span>
    <span style="color:#f92672">password</span>: <span style="color:#ae81ff">password</span>
</code></pre></div><p>ProductController.java</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@RestController</span>
<span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/product&#34;</span><span style="color:#f92672">)</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ProductController</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">static</span> String PRODUCT_APPLE <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;apple&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> BuyService buyService<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ProductController</span><span style="color:#f92672">(</span>BuyService buyService<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">buyService</span> <span style="color:#f92672">=</span> buyService<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Purchase goods Does @ param lock have a lock Y / N
</span><span style="color:#75715e">     */</span>
    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/buy&#34;</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">buy</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@RequestParam</span><span style="color:#f92672">(</span>value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;lock&#34;</span><span style="color:#f92672">,</span> required <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">)</span> String lock<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Y&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>lock<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
            buyService<span style="color:#f92672">.</span><span style="color:#a6e22e">buyProductWithLock</span><span style="color:#f92672">(</span>PRODUCT_APPLE<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
            buyService<span style="color:#f92672">.</span><span style="color:#a6e22e">buyProduct</span><span style="color:#f92672">(</span>PRODUCT_APPLE<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>BuyService.java</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Service</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BuyService</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> ProductDao productDao<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> PurchaseHistoryDao purchaseHistoryDao<span style="color:#f92672">;</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> LockService lockService<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">BuyService</span><span style="color:#f92672">(</span>ProductDao productDao<span style="color:#f92672">,</span> PurchaseHistoryDao purchaseHistoryDao<span style="color:#f92672">,</span> LockService lockService<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">productDao</span> <span style="color:#f92672">=</span> productDao<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">purchaseHistoryDao</span> <span style="color:#f92672">=</span> purchaseHistoryDao<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">lockService</span> <span style="color:#f92672">=</span> lockService<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Purchase: no lock
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param productName
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">buyProduct</span><span style="color:#f92672">(</span>String productName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Product product <span style="color:#f92672">=</span> productDao<span style="color:#f92672">.</span><span style="color:#a6e22e">findOneByName</span><span style="color:#f92672">(</span>productName<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>product<span style="color:#f92672">.</span><span style="color:#a6e22e">getAmount</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Inventory minus 1
</span><span style="color:#75715e"></span>            product<span style="color:#f92672">.</span><span style="color:#a6e22e">setAmount</span><span style="color:#f92672">(</span>product<span style="color:#f92672">.</span><span style="color:#a6e22e">getAmount</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
            productDao<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>product<span style="color:#f92672">);</span>
            <span style="color:#75715e">// Log
</span><span style="color:#75715e"></span>            PurchaseHistory purchaseHistory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PurchaseHistory<span style="color:#f92672">();</span>
            purchaseHistory<span style="color:#f92672">.</span><span style="color:#a6e22e">setProductName</span><span style="color:#f92672">(</span>productName<span style="color:#f92672">);</span>
            purchaseHistory<span style="color:#f92672">.</span><span style="color:#a6e22e">setAmount</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
            purchaseHistoryDao<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>purchaseHistory<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Purchase: lock
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param productName
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">buyProductWithLock</span><span style="color:#f92672">(</span>String productName<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
        String uuid <span style="color:#f92672">=</span> UUID<span style="color:#f92672">.</span><span style="color:#a6e22e">randomUUID</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
        <span style="color:#75715e">// Lock
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>lockService<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">(</span>productName<span style="color:#f92672">,</span> uuid<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
            Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span>100<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        Product product <span style="color:#f92672">=</span> productDao<span style="color:#f92672">.</span><span style="color:#a6e22e">findOneByName</span><span style="color:#f92672">(</span>productName<span style="color:#f92672">);</span>
        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>product<span style="color:#f92672">.</span><span style="color:#a6e22e">getAmount</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            <span style="color:#75715e">// Inventory minus 1
</span><span style="color:#75715e"></span>            product<span style="color:#f92672">.</span><span style="color:#a6e22e">setAmount</span><span style="color:#f92672">(</span>product<span style="color:#f92672">.</span><span style="color:#a6e22e">getAmount</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
            productDao<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>product<span style="color:#f92672">);</span>
            <span style="color:#75715e">// Log
</span><span style="color:#75715e"></span>            PurchaseHistory purchaseHistory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PurchaseHistory<span style="color:#f92672">();</span>
            purchaseHistory<span style="color:#f92672">.</span><span style="color:#a6e22e">setProductName</span><span style="color:#f92672">(</span>productName<span style="color:#f92672">);</span>
            purchaseHistory<span style="color:#f92672">.</span><span style="color:#a6e22e">setAmount</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
            purchaseHistoryDao<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>purchaseHistory<span style="color:#f92672">);</span>
        <span style="color:#f92672">}</span>
        lockService<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">(</span>productName<span style="color:#f92672">,</span> uuid<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>LockService.java</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Service</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">LockService</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> StringRedisTemplate stringRedisTemplate<span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">LockService</span><span style="color:#f92672">(</span>StringRedisTemplate stringRedisTemplate<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">stringRedisTemplate</span> <span style="color:#f92672">=</span> stringRedisTemplate<span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Lock
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param lockKey
</span><span style="color:#75715e">     * @param requestId
</span><span style="color:#75715e">     * @return
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">lock</span><span style="color:#f92672">(</span>String lockKey<span style="color:#f92672">,</span> String requestId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> stringRedisTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">opsForValue</span><span style="color:#f92672">().</span><span style="color:#a6e22e">setIfAbsent</span><span style="color:#f92672">(</span>lockKey<span style="color:#f92672">,</span> requestId<span style="color:#f92672">,</span> Duration<span style="color:#f92672">.</span><span style="color:#a6e22e">ofSeconds</span><span style="color:#f92672">(</span>3<span style="color:#f92672">));</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * Unlocking
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * @param lockKey
</span><span style="color:#75715e">     * @param requestId
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unlock</span><span style="color:#f92672">(</span>String lockKey<span style="color:#f92672">,</span> String requestId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        DefaultRedisScript<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> script <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DefaultRedisScript<span style="color:#f92672">&lt;&gt;();</span>
        script<span style="color:#f92672">.</span><span style="color:#a6e22e">setResultType</span><span style="color:#f92672">(</span>Long<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
        script<span style="color:#f92672">.</span><span style="color:#a6e22e">setScriptText</span><span style="color:#f92672">(</span>
                <span style="color:#e6db74">&#34;if redis.call(&#39;get&#39;, KEYS[1]) == ARGV[1] then return redis.call(&#39;del&#39;, KEYS[1]) else return 0 end&#34;</span><span style="color:#f92672">);</span>
        stringRedisTemplate<span style="color:#f92672">.</span><span style="color:#a6e22e">execute</span><span style="color:#f92672">(</span>script<span style="color:#f92672">,</span> Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">singletonList</span><span style="color:#f92672">(</span>lockKey<span style="color:#f92672">),</span> requestId<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="42-测试和分析">4.2. 测试和分析</h3>
<p>In the test case, the initial inventory of the product is 100 copies, and 200 users are simulated to buy it. According to the principle, only 100 copies can be purchased in the end.</p>
<p>If we want to simulate and test the difference between “locked” and “unlocked”, we must create the condition of “high parallelism”. Here, we should remember that it is “high parallelism”, not “high concurrency”. Because the purchase interface here is fast in response to a single request, in order to simulate the situation that multiple users call the interface at the same time, we should use multithreading locally.</p>
<p>I’ve tried a lot to simulate highly parallel environments. The first time is to write JUnit test cases, starting 200 threads to call the interface. The result is that the service will hang up as soon as there are many threads. Although the reason is not clear, JUnit should not use it in this way. The second time is to use postman to do concurrent interface test, but it is found that whether postman is a fake concurrent test or a single thread calls the interface 200 times in turn, there is no implementation of multithreading. Finally, JMeter was installed, which met my expectations.</p>
<p>When we start 200 threads to call the lock free and lock interface respectively, the test results are as follows:</p>
<p>contrast No lock It’s locked
Surplus stock 68 0
Purchase records 200 100
As you can see, there will be oversold in the case of no lock. Let’s take a look at the purchase code of no lock.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> *Purchase: no lock
</span><span style="color:#75715e"> * @param productName
</span><span style="color:#75715e"> */</span>
 <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">buyProduct</span><span style="color:#f92672">(</span>String productName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Product product <span style="color:#f92672">=</span> productDao<span style="color:#f92672">.</span><span style="color:#a6e22e">findOneByName</span><span style="color:#f92672">(</span>productName<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>product<span style="color:#f92672">.</span><span style="color:#a6e22e">getAmount</span><span style="color:#f92672">()</span> <span style="color:#f92672">&gt;</span> 0<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#75715e">//Inventory minus 1
</span><span style="color:#75715e"></span>        product<span style="color:#f92672">.</span><span style="color:#a6e22e">setAmount</span><span style="color:#f92672">(</span>product<span style="color:#f92672">.</span><span style="color:#a6e22e">getAmount</span><span style="color:#f92672">()</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">);</span>
        productDao<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>product<span style="color:#f92672">);</span>
        <span style="color:#75715e">//Log
</span><span style="color:#75715e"></span>        PurchaseHistory purchaseHistory <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> PurchaseHistory<span style="color:#f92672">();</span>
        purchaseHistory<span style="color:#f92672">.</span><span style="color:#a6e22e">setProductName</span><span style="color:#f92672">(</span>productName<span style="color:#f92672">);</span>
        purchaseHistory<span style="color:#f92672">.</span><span style="color:#a6e22e">setAmount</span><span style="color:#f92672">(</span>1<span style="color:#f92672">);</span>
        purchaseHistoryDao<span style="color:#f92672">.</span><span style="color:#a6e22e">save</span><span style="color:#f92672">(</span>purchaseHistory<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>When multiple requests are called at the same timeproductDao.findOneByName(productName);
The result is the same. They all think that there is still inventory.
If they go to buy, the problem of oversold will appear.
To solve this problem, if it is a single process, through thesynchronized And so on.
If it is distributed multi node, we can consider the way of this paper and use redis distributed lock implementation.</p>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/blog/seckill/example/" aria-label="Previous - 一个使用 Node.js 的 Redlock 示例，关于如何锁定一个Redis上的密钥对" class="btn btn-primary"><span class="mr-1">←</span>Previous</a>
  </li>
    <a href="/blog/seckill/redlock-system-awareness/" aria-label="Next - 建立对分布式锁的系统认知 - 从 Redlock 开始" class="btn btn-primary">Next<span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        
        
	
		<p class="mt-2"><a href="/docs/lua/about/">关于</a></p>
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.5c6c35925cba6ccdfc94d3ef0a1ff539934a08075c0931f2c9ab70249877b310.js" integrity="sha256-XGw1kly6bM38lNPvCh/1OZNKCAdcCTHyyatwJJh3sxA=" crossorigin="anonymous"></script>




  </body>
</html>